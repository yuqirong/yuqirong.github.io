<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>





<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Android,开源框架,插件化,源码解析," />





  <link rel="alternate" href="/atom.xml" title="Qirong Yu's Blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="0x00 前言：插件化的介绍阅读须知：阅读本文的童鞋最好是有过插件化框架使用经历或者对插件化框架有过了解的。前方高能，大牛绕道。
最近一直在关注 Android 插件化方面，所以今天的主题就确定是 Android 中比较热门的“插件化”了。所谓的插件化就是下载 apk 到指定目录，不需要安装该 apk ，就能利用某个已安装的 apk （即“宿主”）调用起该未安装 apk 中的 Activity 、">
<meta property="og:type" content="article">
<meta property="og:title" content="插件化框架android-pluginmgr全解析">
<meta property="og:url" content="http://yuqirong.me/2016/10/02/插件化框架android-pluginmgr全解析/index.html">
<meta property="og:site_name" content="Qirong Yu's Blog">
<meta property="og:description" content="0x00 前言：插件化的介绍阅读须知：阅读本文的童鞋最好是有过插件化框架使用经历或者对插件化框架有过了解的。前方高能，大牛绕道。
最近一直在关注 Android 插件化方面，所以今天的主题就确定是 Android 中比较热门的“插件化”了。所谓的插件化就是下载 apk 到指定目录，不需要安装该 apk ，就能利用某个已安装的 apk （即“宿主”）调用起该未安装 apk 中的 Activity 、">
<meta property="og:image" content="http://yuqirong.me/uploads/20161002/201610041161253.jpg">
<meta property="og:image" content="http://yuqirong.me/uploads/20161002/20161005183404.png">
<meta property="og:updated_time" content="2016-10-05T10:49:56.283Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="插件化框架android-pluginmgr全解析">
<meta name="twitter:description" content="0x00 前言：插件化的介绍阅读须知：阅读本文的童鞋最好是有过插件化框架使用经历或者对插件化框架有过了解的。前方高能，大牛绕道。
最近一直在关注 Android 插件化方面，所以今天的主题就确定是 Android 中比较热门的“插件化”了。所谓的插件化就是下载 apk 到指定目录，不需要安装该 apk ，就能利用某个已安装的 apk （即“宿主”）调用起该未安装 apk 中的 Activity 、">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: undefined,
      author: '博主'
    }
  };
</script>

  <title> 插件化框架android-pluginmgr全解析 | Qirong Yu's Blog </title>
  <meta name="baidu-site-verification" content="MBYnGIEEPN" />
  <meta name="baidu-site-verification" content="1Hx0jVHsgl" />
  <meta name="baidu-site-verification" content="L0MgAErI0s" />
  <meta name="google-site-verification" content="_hYRHLLoBRM6L31myWhOPTxzGtawe9z1zmCqcJ-aHA0" />
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?cb7fb9301d60e7ca4f45f2361955bd8f";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Qirong Yu's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-guestbook">
          <a href="/guestbook" rel="section">
            
              <i class="menu-item-icon fa fa-comment fa-fw"></i> <br />
            
            留言
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                插件化框架android-pluginmgr全解析
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-10-02T10:03:34+08:00" content="2016-10-02">
              2016-10-02
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Android-Blog/" itemprop="url" rel="index">
                    <span itemprop="name">Android Blog</span>
                  </a>
                </span>

					<!-- 
					�Ķ��� 
  								<span id="busuanzi_container_page_pv">&nbsp;&nbsp;|&nbsp;&nbsp;�Ķ��� <span id="busuanzi_value_page_pv"></span> ��</span>
					 
					-->

                
                

              
            </span>
          
          
           <!-- 
        �Ƿ������� 
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/02/插件化框架android-pluginmgr全解析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/02/插件化框架android-pluginmgr全解析/" itemprop="commentsCount"></span>
                </a>
              </span>
            
            
          -->

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="0x00__u524D_u8A00_uFF1A_u63D2_u4EF6_u5316_u7684_u4ECB_u7ECD"><a href="#0x00__u524D_u8A00_uFF1A_u63D2_u4EF6_u5316_u7684_u4ECB_u7ECD" class="headerlink" title="0x00 前言：插件化的介绍"></a>0x00 前言：插件化的介绍</h1><p>阅读须知：阅读本文的童鞋最好是有过插件化框架使用经历或者对插件化框架有过了解的。前方高能，大牛绕道。</p>
<p>最近一直在关注 Android 插件化方面，所以今天的主题就确定是 Android 中比较热门的“插件化”了。所谓的插件化就是下载 apk 到指定目录，不需要安装该 apk ，就能利用某个已安装的 apk （即“宿主”）调用起该未安装 apk 中的 Activity 、Service 等组件（即“插件”）。</p>
<p>Android 插件化的发展到目前为止也有一段时间了，从一开始任主席的 <a href="https://github.com/singwhatiwanna/dynamic-load-apk" target="_blank" rel="external">dynamic-load-apk</a> 到今天要分析的 <a href="https://github.com/houkx/android-pluginmgr" target="_blank" rel="external">android-pluginmgr</a> 再到360的 <a href="https://github.com/DroidPluginTeam/DroidPlugin" target="_blank" rel="external">DroidPlugin</a> ，也代表着插件化的思想从顶部的应用层向下到 Framework 层渗入。最早插件化的思想是 <a href="https://github.com/singwhatiwanna/dynamic-load-apk" target="_blank" rel="external">dynamic-load-apk</a> 实现的， <a href="https://github.com/singwhatiwanna/dynamic-load-apk" target="_blank" rel="external">dynamic-load-apk</a> 在“宿主” ProxyActivity 的生命周期中利用接口回调了“插件” PluginActivity 的“生命周期”，以此来间接实现 PluginActivity 的“生命周期”。也就是说，其实插件中的 “PluginActivity” 并不具有真正 Activity 的性质，实质就是一个普通类，只是利用接口回调了类中的生命周期方法而已。比接口回调更好的方案就是利用 ActivityThread 、Instrumentation 等去动态地 Hook 即将创建的 ProxyActivity ，也就是说表面上创建的是 ProxyActivity ，其实实际上是创建了 PluginActivity 。这种思想相比于 <a href="https://github.com/singwhatiwanna/dynamic-load-apk" target="_blank" rel="external">dynamic-load-apk</a> 而言，插件中 Activity 已经是实质上的 Activity ，具备了生命周期方法。今天我们要解析的 android-pluginmgr 插件化框架就是基于这种思想的。最后就是像 <a href="https://github.com/DroidPluginTeam/DroidPlugin" target="_blank" rel="external">DroidPlugin</a> 这种插件化框架，改动了 ActivityManagerService 、 PackageManagerService 等 Android 源码，以此来实现插件化。总之，并没有哪种插件化框架是最好的，一切都是要根据自身实际情况而决定的。</p>
<p>熟悉插件化的童鞋都知道，插件化要解决的有三个基本难题：</p>
<ol>
<li>插件中 ClassLoader 的问题；</li>
<li>插件中的资源文件访问问题；</li>
<li>插件中 Activity 组件的生命周期问题。</li>
</ol>
<p>基本上，解决了上面三个问题，就可以算是一个合格的插件化框架了。但是要注意的是，插件化远远不止这三个问题，比如还有插件中 .so 文件加载，支持 Service 插件化等问题。</p>
<p>好了，讲了这么多废话，接下来我们就来分析 <a href="https://github.com/houkx/android-pluginmgr" target="_blank" rel="external">android-pluginmgr</a> 的源码吧。</p>
<h1 id="0x01_PluginManager-init"><a href="#0x01_PluginManager-init" class="headerlink" title="0x01 PluginManager.init"></a>0x01 PluginManager.init</h1><p>注：本文分析的 <a href="https://github.com/houkx/android-pluginmgr" target="_blank" rel="external">android-pluginmgr</a> 为 master 分支，版本为0.2.2；</p>
<h2 id="android-pluginmgr_u7684_u7B80_u5355_u7528_u6CD5"><a href="#android-pluginmgr_u7684_u7B80_u5355_u7528_u6CD5" class="headerlink" title="android-pluginmgr的简单用法"></a>android-pluginmgr的简单用法</h2><p>我们先简单地来看一下 <a href="https://github.com/houkx/android-pluginmgr" target="_blank" rel="external">android-pluginmgr</a> 框架的用法（来自于 <a href="https://github.com/houkx/android-pluginmgr" target="_blank" rel="external">android-pluginmgr</a> 的 <a href="https://github.com/houkx/android-pluginmgr/blob/master/README.md" target="_blank" rel="external">README.md</a> ）：</p>
<ol>
<li><p>declare permission in your <code>AndroidManifest.xml</code>: </p>
<pre><code>&lt;uses-permission android:name=&quot;android.permission.MOUNT_UNMOUNT_FILESYSTEMS&quot; /&gt;
&lt;uses-permission android:name=&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot; /&gt;
</code></pre></li>
<li><p>regist an activity:</p>
<pre><code>&lt;activity android:name=&quot;androidx.pluginmgr.DynamicActivity&quot; /&gt;
</code></pre></li>
<li><p>init PluginMgr in your application:</p>
<pre><code>@Override
public void onCreate(){
   PluginManager.init(this);
   //...
}
</code></pre></li>
<li><p>load plugin from plug apk:</p>
<pre><code>PluginManager pluginMgr = PluginManager.getSingleton();
File myPlug = new File(&quot;/mnt/sdcard/Download/myplug.apk&quot;);
PlugInfo plug = pluginMgr.loadPlugin(myPlug).iterator().next();
</code></pre></li>
<li><p>start activity:</p>
<pre><code>mgr.startMainActivity(context, plug);
</code></pre></li>
</ol>
<p>基本的用法就像以上这五步，另外需要注意的是，“插件”中所需要的权限都要在“宿主”的 AndroidManifest.xml 中进行申明。</p>
<h2 id="PluginManager-init_28this_29_u6E90_u7801"><a href="#PluginManager-init_28this_29_u6E90_u7801" class="headerlink" title="PluginManager.init(this)源码"></a>PluginManager.init(this)源码</h2><p>下面我们来分析下 <code>PluginManager.init(this);</code> 的源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 初始化插件管理器,请不要传入易变的Context,那将造成内存泄露!</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span> context Application上下文</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (SINGLETON != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Trace.store(<span class="string">"PluginManager have been initialized, YOU needn't initialize it again!"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Trace.store(<span class="string">"init PluginManager..."</span>);</span><br><span class="line">    SINGLETON = <span class="keyword">new</span> PluginManager(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到在 <code>init(Context context)</code> 中主要创建了一个 <code>SINGLETON</code> 单例，所以我们就要追踪 <code>PluginManager</code> 构造器的源码了：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 插件管理器私有构造器</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span> context Application上下文</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">PluginManager</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!isMainThread()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalThreadStateException(<span class="string">"PluginManager must init in UI Thread!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.context = context;</span><br><span class="line">    File optimizedDexPath = context.getDir(Globals.PRIVATE_PLUGIN_OUTPUT_DIR_NAME, Context.MODE_PRIVATE);</span><br><span class="line">    dexOutputPath = optimizedDexPath.getAbsolutePath();</span><br><span class="line">    dexInternalStoragePath = context.getDir(</span><br><span class="line">            Globals.PRIVATE_PLUGIN_ODEX_OUTPUT_DIR_NAME, Context.MODE_PRIVATE</span><br><span class="line">    );</span><br><span class="line">    DelegateActivityThread delegateActivityThread = DelegateActivityThread.getSingleton();</span><br><span class="line">    Instrumentation originInstrumentation = delegateActivityThread.getInstrumentation();</span><br><span class="line">    <span class="keyword">if</span> (!(originInstrumentation <span class="keyword">instanceof</span> PluginInstrumentation)) &#123;</span><br><span class="line">        PluginInstrumentation pluginInstrumentation = <span class="keyword">new</span> PluginInstrumentation(originInstrumentation);</span><br><span class="line">        delegateActivityThread.setInstrumentation(pluginInstrumentation);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在构造器中做的事情有点多，我们一步步来看下。一开始得到插件 dex opt 输出路径 <code>dexOutputPath</code> 和私有目录中存储插件的路径 <code>dexInternalStoragePath</code> 。这些路径都是在 <code>Global</code> 类中事先定义好的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 私有目录中保存插件文件的文件夹名</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PRIVATE_PLUGIN_OUTPUT_DIR_NAME = <span class="string">"plugins-file"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * 私有目录中保存插件odex的文件夹名</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PRIVATE_PLUGIN_ODEX_OUTPUT_DIR_NAME = <span class="string">"plugins-opt"</span>;</span><br></pre></td></tr></table></figure>
<p>但是根据常量定义的名称来看，总感觉作者在 <code>context.getDir()</code> 时把这两个路径搞反了 \(╯-╰)/。</p>
<p>之后在构造器中创建了 <code>DelegateActivityThread</code> 类的单例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DelegateActivityThread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> DelegateActivityThread SINGLETON = <span class="keyword">new</span> DelegateActivityThread();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Reflect activityThreadReflect;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DelegateActivityThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        activityThreadReflect = Reflect.on(ActivityThread.currentActivityThread());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DelegateActivityThread <span class="title">getSingleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SINGLETON;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Application <span class="title">getInitialApplication</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> activityThreadReflect.get(<span class="string">"mInitialApplication"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Instrumentation <span class="title">getInstrumentation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> activityThreadReflect.get(<span class="string">"mInstrumentation"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setInstrumentation</span><span class="params">(Instrumentation newInstrumentation)</span> </span>&#123;</span><br><span class="line">        activityThreadReflect.set(<span class="string">"mInstrumentation"</span>, newInstrumentation);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>DelegateActivityThread 类的主要作用就是使用反射包装了当前的 ActivityThread ，并且一开始在 DelegateActivityThread 中使用 PluginInstrumentation 替换原始的 Instrumentation 。其实 Activity 的生命周期调用都是通过 Instrumentation 来完成的。我们来看看 PluginInstrumentation 的构造器相关代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PluginInstrumentation</span> <span class="keyword">extends</span> <span class="title">DelegateInstrumentation</span></span><br><span class="line"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 当前正在运行的插件</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> PlugInfo currentPlugin;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> mBase 真正的Instrumentation</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PluginInstrumentation</span><span class="params">(Instrumentation mBase)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(mBase);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到 PluginInstrumentation 是继承自 DelegateInstrumentation 类的，而 DelegateInstrumentation 本质上就是 Instrumentation 。 DelegateInstrumentation 类中的方法都是直接调用 Instrumentation 类的:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DelegateInstrumentation</span> <span class="keyword">extends</span> <span class="title">Instrumentation</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Instrumentation mBase;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> mBase 真正的Instrumentation</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DelegateInstrumentation</span><span class="params">(Instrumentation mBase)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mBase = mBase;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle arguments)</span> </span>&#123;</span><br><span class="line">        mBase.onCreate(arguments);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mBase.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mBase.onStart();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>好了，在 <code>PluginManager.init()</code> 方法中大概做的就是这些逻辑了。</p>
<h1 id="0x02_PluginManager-loadPlugin"><a href="#0x02_PluginManager-loadPlugin" class="headerlink" title="0x02 PluginManager.loadPlugin"></a>0x02 PluginManager.loadPlugin</h1><p>看完了上面的 <code>PluginManager.init()</code> 之后，下一步就是调用 <code>pluginManager.loadPlugin</code> 去加载插件。一起来看看相关源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 加载指定插件或指定目录下的所有插件</span><br><span class="line"> * &lt;p&gt;</span><br><span class="line"> * 都使用文件名作为Id</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span> pluginSrcDirFile - apk或apk目录</span><br><span class="line"> * <span class="doctag">@return</span> 插件集合</span><br><span class="line"> * <span class="doctag">@throws</span> Exception</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Collection&lt;PlugInfo&gt; <span class="title">loadPlugin</span><span class="params">(<span class="keyword">final</span> File pluginSrcDirFile)</span></span><br><span class="line">        <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pluginSrcDirFile == <span class="keyword">null</span> || !pluginSrcDirFile.exists()) &#123;</span><br><span class="line">        Trace.store(<span class="string">"invalidate plugin file or Directory :"</span></span><br><span class="line">                + pluginSrcDirFile);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pluginSrcDirFile.isFile()) &#123;</span><br><span class="line">        PlugInfo one = buildPlugInfo(pluginSrcDirFile, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (one != <span class="keyword">null</span>) &#123;</span><br><span class="line">            savePluginToMap(one);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Collections.singletonList(one);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//        synchronized (this) &#123;</span></span><br><span class="line"><span class="comment">//            pluginPkgToInfoMap.clear();</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line">    File[] pluginApkFiles = pluginSrcDirFile.listFiles(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">if</span> (pluginApkFiles == <span class="keyword">null</span> || pluginApkFiles.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> FileNotFoundException(<span class="string">"could not find plugins in:"</span></span><br><span class="line">                + pluginSrcDirFile);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (File pluginApk : pluginApkFiles) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            PlugInfo plugInfo = buildPlugInfo(pluginApk, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (plugInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                savePluginToMap(plugInfo);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> pluginPkgToInfoMap.values();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>loadPlugin</code> 代码的注释中，我们可以知道加载的插件可以是一个也可以是一个文件夹下的多个。因为会根据传入的 <code>pluginSrcDirFile</code> 参数去判断是文件还是文件夹，其实道理都是一样的，无非就是多了一个 for 循环而已。在这里要注意一下，PluginManager 是实现了 FileFilter 接口的，因此在加载多个插件时，调用 <code>listFiles(this)</code> 会过滤当前文件夹下非 apk 文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">accept</span><span class="params">(File pathname)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> !pathname.isDirectory() &amp;&amp; pathname.getName().endsWith(<span class="string">".apk"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>好了，我们在 <code>loadPlugin()</code> 的代码中会注意到，无论是加载单个插件还是多个插件都会调用 <code>buildPlugInfo()</code> 方法。顾名思义，就是根据传入的插件文件去加载：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> PlugInfo <span class="title">buildPlugInfo</span><span class="params">(File pluginApk, String pluginId,</span><br><span class="line">                               String targetFileName)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    PlugInfo info = <span class="keyword">new</span> PlugInfo();</span><br><span class="line">    info.setId(pluginId == <span class="keyword">null</span> ? pluginApk.getName() : pluginId);</span><br><span class="line"></span><br><span class="line">    File privateFile = <span class="keyword">new</span> File(dexInternalStoragePath,</span><br><span class="line">            targetFileName == <span class="keyword">null</span> ? pluginApk.getName() : targetFileName);</span><br><span class="line"></span><br><span class="line">    info.setFilePath(privateFile.getAbsolutePath());</span><br><span class="line">    <span class="comment">//Copy Plugin to Private Dir</span></span><br><span class="line">    <span class="keyword">if</span> (!pluginApk.getAbsolutePath().equals(privateFile.getAbsolutePath())) &#123;</span><br><span class="line">        copyApkToPrivatePath(pluginApk, privateFile);</span><br><span class="line">    &#125;</span><br><span class="line">    String dexPath = privateFile.getAbsolutePath();</span><br><span class="line">    <span class="comment">//Load Plugin Manifest</span></span><br><span class="line">    PluginManifestUtil.setManifestInfo(context, dexPath, info);</span><br><span class="line">    <span class="comment">//Load Plugin Res</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        AssetManager am = AssetManager.class.newInstance();</span><br><span class="line">        am.getClass().getMethod(<span class="string">"addAssetPath"</span>, String.class)</span><br><span class="line">                .invoke(am, dexPath);</span><br><span class="line">        info.setAssetManager(am);</span><br><span class="line">        Resources hotRes = context.getResources();</span><br><span class="line">        Resources res = <span class="keyword">new</span> Resources(am, hotRes.getDisplayMetrics(),</span><br><span class="line">                hotRes.getConfiguration());</span><br><span class="line">        info.setResources(res);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unable to create Resources&amp;Assets for "</span></span><br><span class="line">                + info.getPackageName() + <span class="string">" : "</span> + e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//Load  classLoader for Plugin</span></span><br><span class="line">    PluginClassLoader pluginClassLoader = <span class="keyword">new</span> PluginClassLoader(info, dexPath, dexOutputPath</span><br><span class="line">            , getPluginLibPath(info).getAbsolutePath(), pluginParentClassLoader);</span><br><span class="line">    info.setClassLoader(pluginClassLoader);</span><br><span class="line">    ApplicationInfo appInfo = info.getPackageInfo().applicationInfo;</span><br><span class="line">    Application app = makeApplication(info, appInfo);</span><br><span class="line">    attachBaseContext(info, app);</span><br><span class="line">    info.setApplication(app);</span><br><span class="line">    Trace.store(<span class="string">"Build pluginInfo =&gt; "</span> + info);</span><br><span class="line">    <span class="keyword">return</span> info;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面的代码中看到， <code>buildPlugInfo()</code> 方法中做的大致有四步：</p>
<ol>
<li>复制插件 apk 到指定目录；</li>
<li>加载插件 apk 的 AndroidManifest.xml 文件；</li>
<li>加载插件 apk 中的资源文件；</li>
<li>为插件 apk 设置 ClassLoader。</li>
</ol>
<h2 id="u590D_u5236_u63D2_u4EF6_apk__u5230_u6307_u5B9A_u76EE_u5F55"><a href="#u590D_u5236_u63D2_u4EF6_apk__u5230_u6307_u5B9A_u76EE_u5F55" class="headerlink" title="复制插件 apk 到指定目录"></a>复制插件 apk 到指定目录</h2><p>下面我们慢慢来分析，第一步，会把传入的插件 apk 复制到 <code>dexInternalStoragePath</code> 路径下，也就是之前在 PluginManager 的构造器中所指定的目录。这部分的代码很简单，就省略了。</p>
<h2 id="u52A0_u8F7D_u63D2_u4EF6_apk__u7684_AndroidManifest-xml__u6587_u4EF6"><a href="#u52A0_u8F7D_u63D2_u4EF6_apk__u7684_AndroidManifest-xml__u6587_u4EF6" class="headerlink" title="加载插件 apk 的 AndroidManifest.xml 文件"></a>加载插件 apk 的 AndroidManifest.xml 文件</h2><p>第二步，根据代码可知，会使用 <code>PluginManifestUtil.setManifestInfo()</code> 去加载 AndroidManifest 里的信息，那就去看下相关的代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setManifestInfo</span><span class="params">(Context context, String apkPath, PlugInfo info)</span></span><br><span class="line">		<span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">	<span class="comment">// 得到AndroidManifest文件</span></span><br><span class="line">	ZipFile zipFile = <span class="keyword">new</span> ZipFile(<span class="keyword">new</span> File(apkPath), ZipFile.OPEN_READ);</span><br><span class="line">	ZipEntry manifestXmlEntry = zipFile.getEntry(XmlManifestReader.DEFAULT_XML);</span><br><span class="line">	<span class="comment">// 解析AndroidManifest文件</span></span><br><span class="line">	String manifestXML = XmlManifestReader.getManifestXMLFromAPK(zipFile,</span><br><span class="line">			manifestXmlEntry);</span><br><span class="line">	<span class="comment">// 创建相应的packageInfo</span></span><br><span class="line">	PackageInfo pkgInfo = context.getPackageManager()</span><br><span class="line">			.getPackageArchiveInfo(</span><br><span class="line">					apkPath,</span><br><span class="line">					PackageManager.GET_ACTIVITIES</span><br><span class="line">							| PackageManager.GET_RECEIVERS<span class="comment">//</span></span><br><span class="line">							| PackageManager.GET_PROVIDERS<span class="comment">//</span></span><br><span class="line">							| PackageManager.GET_META_DATA<span class="comment">//</span></span><br><span class="line">							| PackageManager.GET_SHARED_LIBRARY_FILES<span class="comment">//</span></span><br><span class="line">							| PackageManager.GET_SERVICES<span class="comment">//</span></span><br><span class="line">			<span class="comment">// | PackageManager.GET_SIGNATURES//</span></span><br><span class="line">			);</span><br><span class="line">    <span class="keyword">if</span> (pkgInfo == <span class="keyword">null</span> || pkgInfo.activities == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> XmlPullParserException(<span class="string">"No any activity in "</span> + apkPath);</span><br><span class="line">    &#125;</span><br><span class="line">    pkgInfo.applicationInfo.publicSourceDir = apkPath;</span><br><span class="line">    pkgInfo.applicationInfo.sourceDir = apkPath;</span><br><span class="line">	<span class="comment">// 得到libDir，加载.so文件</span></span><br><span class="line">	File libDir = PluginManager.getSingleton().getPluginLibPath(info);</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (extractLibFile(zipFile, libDir)) &#123;</span><br><span class="line">			<span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.GINGERBREAD) &#123;</span><br><span class="line">				pkgInfo.applicationInfo.nativeLibraryDir = libDir.getAbsolutePath();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		zipFile.close();</span><br><span class="line">	&#125;</span><br><span class="line">    info.setPackageInfo(pkgInfo);</span><br><span class="line">    setAttrs(info, manifestXML);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在代码中，一开始会通过 apk 得到 AndroidManifest.xml 文件。然后使用 <code>XmlManifestReader</code> 去读取 AndroidManifest 中的信息。在 <code>XmlManifestReader</code> 中会使用 <code>XmlPullParser</code> 去解析 xml ， <code>XmlManifestReader</code> 相关的源码就不贴出来了，想要进一步了解的童鞋可以自己去看，<a href="https://github.com/houkx/android-pluginmgr/blob/master/android-pluginmgr/src/main/java/androidx/pluginmgr/utils/XmlManifestReader.java" target="_blank" rel="external">点击这里查看 XmlManifestReader 源码</a>。接下来根据 <code>apkPath</code> 得到相应的 <code>pkgInfo</code> ，并且若有 libDir 会去加载相应的 .so 文件。最后会调用 <code>setAttrs(info, manifestXML)</code> 这个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setAttrs</span><span class="params">(PlugInfo info, String manifestXML)</span></span><br><span class="line">		<span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">	XmlPullParserFactory factory = XmlPullParserFactory.newInstance();</span><br><span class="line">	factory.setNamespaceAware(<span class="keyword">true</span>);</span><br><span class="line">	XmlPullParser parser = factory.newPullParser();</span><br><span class="line">	parser.setInput(<span class="keyword">new</span> StringReader(manifestXML));</span><br><span class="line">	<span class="keyword">int</span> eventType = parser.getEventType();</span><br><span class="line">	String namespaceAndroid = <span class="keyword">null</span>;</span><br><span class="line">	do &#123;</span><br><span class="line">		<span class="keyword">switch</span> (eventType) &#123;</span><br><span class="line">		<span class="keyword">case</span> XmlPullParser.START_DOCUMENT: &#123;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">case</span> XmlPullParser.START_TAG: &#123;</span><br><span class="line">			String tag = parser.getName();</span><br><span class="line">			<span class="keyword">if</span> (tag.equals(<span class="string">"manifest"</span>)) &#123;</span><br><span class="line">				namespaceAndroid = parser.getNamespace(<span class="string">"android"</span>);</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"activity"</span>.equals(parser.getName())) &#123;</span><br><span class="line">				addActivity(info, namespaceAndroid, parser);</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"receiver"</span>.equals(parser.getName())) &#123;</span><br><span class="line">				addReceiver(info, namespaceAndroid, parser);</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"service"</span>.equals(parser.getName())) &#123;</span><br><span class="line">				addService(info, namespaceAndroid, parser);</span><br><span class="line">			&#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">"application"</span>.equals(parser.getName()))&#123;</span><br><span class="line">				parseApplicationInfo(info, namespaceAndroid, parser);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">case</span> XmlPullParser.END_TAG: &#123;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		eventType = parser.next();</span><br><span class="line">	&#125; <span class="keyword">while</span> (eventType != XmlPullParser.END_DOCUMENT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>setAttrs(PlugInfo info, String manifestXML)</code> 方法中，使用了 pull 方式去解析 manifest ，并且根据 activity 、 recevicer 、 service 等调用不同的 <code>addXxxx()</code> 方法。这些方法其实本质上是一样的，我们就挑 <code>addActivity()</code> 方法来看一下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addActivity</span><span class="params">(PlugInfo info, String namespace,</span><br><span class="line">		XmlPullParser parser)</span> <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> eventType = parser.getEventType();</span><br><span class="line">	String activityName = parser.getAttributeValue(namespace, <span class="string">"name"</span>);</span><br><span class="line">	String packageName = info.getPackageInfo().packageName;</span><br><span class="line">	activityName = getName(activityName, packageName);</span><br><span class="line">	ResolveInfo act = <span class="keyword">new</span> ResolveInfo();</span><br><span class="line">	act.activityInfo = info.findActivityByClassNameFromPkg(activityName);</span><br><span class="line">	do &#123;</span><br><span class="line">		<span class="keyword">switch</span> (eventType) &#123;</span><br><span class="line">		<span class="keyword">case</span> XmlPullParser.START_TAG: &#123;</span><br><span class="line">			String tag = parser.getName();</span><br><span class="line">			<span class="keyword">if</span> (<span class="string">"intent-filter"</span>.equals(tag)) &#123;</span><br><span class="line">				<span class="keyword">if</span> (act.filter == <span class="keyword">null</span>) &#123;</span><br><span class="line">					act.filter = <span class="keyword">new</span> IntentFilter();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"action"</span>.equals(tag)) &#123;</span><br><span class="line">				String actionName = parser.getAttributeValue(namespace,</span><br><span class="line">						<span class="string">"name"</span>);</span><br><span class="line">				act.filter.addAction(actionName);</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"category"</span>.equals(tag)) &#123;</span><br><span class="line">				String category = parser.getAttributeValue(namespace,</span><br><span class="line">						<span class="string">"name"</span>);</span><br><span class="line">				act.filter.addCategory(category);</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"data"</span>.equals(tag)) &#123;</span><br><span class="line">				<span class="comment">// TODO parse data</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		eventType = parser.next();</span><br><span class="line">	&#125; <span class="keyword">while</span> (!<span class="string">"activity"</span>.equals(parser.getName()));</span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	info.addActivity(act);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> <code>addActivity()</code> 代码中的逻辑比较简单，就是创建一个 <code>ResolveInfo</code> 类的对象 <code>act</code> ，把 Activity 相关的信息全部装进去，比如有 ActivityInfo 、 intent-filter 等。最后把 <code>act</code> 添加到 <code>info</code> 中。其他的 <code>addReceiver</code> 和 <code>addService</code> 也是同一个逻辑。而 <code>parseApplicationInfo</code> 也是把 Application 的相关信息封装到 <code>info</code> 中。感兴趣的同学可以看一下相关的源码，<a href="https://github.com/houkx/android-pluginmgr/blob/master/android-pluginmgr/src/main/java/androidx/pluginmgr/utils/PluginManifestUtil.java" target="_blank" rel="external">点击这里查看</a>。到这里，就把加载插件中 AndroidManifest.xml 的代码分析完了。</p>
<h2 id="u52A0_u8F7D_u63D2_u4EF6_apk__u4E2D_u7684_u8D44_u6E90_u6587_u4EF6"><a href="#u52A0_u8F7D_u63D2_u4EF6_apk__u4E2D_u7684_u8D44_u6E90_u6587_u4EF6" class="headerlink" title="加载插件 apk 中的资源文件"></a>加载插件 apk 中的资源文件</h2><p>再回到 <code>buildPlugInfo()</code> 的代码中去，接下来就是第三步，加载插件中的资源文件了。</p>
<p>为了方便，我们把相关的代码复制到这里来：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    AssetManager am = AssetManager.class.newInstance();</span><br><span class="line">    am.getClass().getMethod(<span class="string">"addAssetPath"</span>, String.class)</span><br><span class="line">            .invoke(am, dexPath);</span><br><span class="line">    info.setAssetManager(am);</span><br><span class="line">    Resources hotRes = context.getResources();</span><br><span class="line">    Resources res = <span class="keyword">new</span> Resources(am, hotRes.getDisplayMetrics(),</span><br><span class="line">            hotRes.getConfiguration());</span><br><span class="line">    info.setResources(res);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unable to create Resources&amp;Assets for "</span></span><br><span class="line">            + info.getPackageName() + <span class="string">" : "</span> + e.getMessage());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先通过反射得到 <code>AssetManager</code> 的对象 <code>am</code>，然后通过反射其 <code>addAssetPath</code> 方法传入 <code>dexPath</code> 参数来加载插件的资源文件，接下来就得到相应插件的 <code>Resource</code> 对象 <code>res</code> 了。这样就实现了访问插件中的资源文件了。那么到底  <code>addAssetPath</code> 这个方法有什么魔力呢？我们查看一下 Android 相关的源代码（<a href="https://android.googlesource.com/platform/frameworks/base/+/56a2301/core/java/android/content/res/AssetManager.java" target="_blank" rel="external">android/content/res/AssetManager.java</a>）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Add an additional set of assets to the asset manager.  This can be</span><br><span class="line"> * either a directory or ZIP file.  Not for use by applications.  Returns</span><br><span class="line"> * the cookie of the added asset, or 0 on failure.</span><br><span class="line"> * &#123;<span class="doctag">@hide</span>&#125;</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">addAssetPath</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> res = addAssetPathNative(path);</span><br><span class="line">        makeStringBlocks(mStringBlocks);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看方法的注释我们知道，这个 <code>addAssetPath()</code> 方法就是用来添加额外的资源文件到 AssetManager 中去的，但是已经被 hide 了。所以我们只能通过反射的方式来执行了。这样就解决了加载插件中的资源文件的问题了。</p>
<p>其实，大多数插件化框架都是通过反射 <code>addAssetPath()</code> 的方式来解决加载插件资源问题，基本上已经成为了标准方案了。</p>
<h2 id="u4E3A_u63D2_u4EF6_apk__u8BBE_u7F6E_ClassLoader"><a href="#u4E3A_u63D2_u4EF6_apk__u8BBE_u7F6E_ClassLoader" class="headerlink" title="为插件 apk 设置 ClassLoader"></a>为插件 apk 设置 ClassLoader</h2><p>终于到了最后一个步骤了，如何为插件设置 ClassLoader 呢？其实解决的方案就是通过 <code>DexClassLoader</code> 。我们先来看 <code>buildPlugInfo()</code> 中的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PluginClassLoader pluginClassLoader = <span class="keyword">new</span> PluginClassLoader(info, dexPath, dexOutputPath</span><br><span class="line">        , getPluginLibPath(info).getAbsolutePath(), pluginParentClassLoader);</span><br><span class="line">info.setClassLoader(pluginClassLoader);</span><br><span class="line">ApplicationInfo appInfo = info.getPackageInfo().applicationInfo;</span><br><span class="line">Application app = makeApplication(info, appInfo);</span><br><span class="line">attachBaseContext(info, app);</span><br><span class="line">info.setApplication(app);</span><br><span class="line">Trace.store(<span class="string">"Build pluginInfo =&gt; "</span> + info);</span><br></pre></td></tr></table></figure>
<p>在代码中创建了 <code>pluginClassLoader</code> 对象，而 <code>PluginClassLoader</code> 正是继承自 <code>DexClassLoader</code> 的，将 <code>dexPath</code> 、 <code>dexOutputPath</code> 等参数传入后，就可以去加载插件中的类了。 基本上所有的插件化框架都是通过 <code>DexClassLoder</code> 来作为插件 apk 的 ClassLoader 的。</p>
<p>之后在 <code>makeApplication(info, appInfo)</code> 就使用 <code>PluginClassLoader</code> 利用反射去创建插件的 Application 了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 构造插件的Application</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span> plugInfo 插件信息</span><br><span class="line"> * <span class="doctag">@param</span> appInfo 插件ApplicationInfo</span><br><span class="line"> * <span class="doctag">@return</span> 插件App</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Application <span class="title">makeApplication</span><span class="params">(PlugInfo plugInfo, ApplicationInfo appInfo)</span> </span>&#123;</span><br><span class="line">    String appClassName = appInfo.className;</span><br><span class="line">    <span class="keyword">if</span> (appClassName == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//Default Application</span></span><br><span class="line">        appClassName = Application.class.getName();</span><br><span class="line">    &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (Application) plugInfo.getClassLoader().loadClass(appClassName).newInstance();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unable to create Application for "</span></span><br><span class="line">                    + plugInfo.getPackageName() + <span class="string">": "</span></span><br><span class="line">                    + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建完插件的 Application 之后， 再调用 <code>attachBaseContext(info, app)</code> 方法把 Application 的 mBase 属性替换成 <code>PluginContext</code> 对象，<code>PluginContext</code> 类继承自 <a href="https://github.com/houkx/android-pluginmgr/blob/master/android-pluginmgr/src/main/java/androidx/pluginmgr/delegate/LayoutInflaterProxyContext.java" target="_blank" rel="external">LayoutInflaterProxyContext</a> ，里面封装了一些插件的信息，比如有插件资源、插件 ClassLoader 等。值得一提的是，在插件中 PluginContext 可以得到“宿主”的 Context ，也就是所谓的“破壳”。具体可查看<a href="https://github.com/houkx/android-pluginmgr/blob/master/android-pluginmgr/src/main/java/androidx/pluginmgr/environment/PluginContext.java" target="_blank" rel="external"> PluginContext 的源码</a>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">attachBaseContext</span><span class="params">(PlugInfo info, Application app)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Field mBase = ContextWrapper.class.getDeclaredField(<span class="string">"mBase"</span>);</span><br><span class="line">        mBase.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        mBase.set(app, <span class="keyword">new</span> PluginContext(context.getApplicationContext(), info));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>讲到这里基本上把 <code>buildPlugInfo()</code> 中的逻辑讲完了， <code>pluginManager.loadPlugin</code> 剩下的代码都比较简单，相信大家一看就懂了。 </p>
<h1 id="0x03_PluginManager-startActivity"><a href="#0x03_PluginManager-startActivity" class="headerlink" title="0x03 PluginManager.startActivity"></a>0x03 PluginManager.startActivity</h1><h2 id="startActivity"><a href="#startActivity" class="headerlink" title="startActivity"></a>startActivity</h2><p>在加载好插件 apk 之后，就可以使用插件了。和平常无异，我们使用 <code>PluginManager.startActivity</code> 来启动插件中的 Activity 。其实 <code>PluginManager</code> 有很多 startActivity 的方法：</p>
<p><img src="/uploads/20161002/201610041161253.jpg" alt="startActivity截图"></p>
<p>但是终于都会调用 <code>startActivity(Context from, PlugInfo plugInfo, ActivityInfo activityInfo, Intent intent)</code> 这个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> DynamicActivitySelector activitySelector = DefaultActivitySelector.getDefault();</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * 启动插件的指定Activity</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span> from         fromContext</span><br><span class="line"> * <span class="doctag">@param</span> plugInfo     插件信息</span><br><span class="line"> * <span class="doctag">@param</span> activityInfo 要启动的插件activity信息</span><br><span class="line"> * <span class="doctag">@param</span> intent       通过此Intent可以向插件传参, 可以为null</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Context from, PlugInfo plugInfo, ActivityInfo activityInfo, Intent intent)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (activityInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ActivityNotFoundException(<span class="string">"Cannot find ActivityInfo from plugin, could you declare this Activity in plugin?"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (intent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        intent = <span class="keyword">new</span> Intent();</span><br><span class="line">    &#125;</span><br><span class="line">    CreateActivityData createActivityData = <span class="keyword">new</span> CreateActivityData(activityInfo.name, plugInfo.getPackageName());</span><br><span class="line">    intent.setClass(from, activitySelector.selectDynamicActivity(activityInfo));</span><br><span class="line">    intent.putExtra(Globals.FLAG_ACTIVITY_FROM_PLUGIN, createActivityData);</span><br><span class="line">    from.startActivity(intent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们先来看代码， <code>CreateActivityData</code> 类是用来存储一个将要创建的插件 Activity 的数据，实现了 <code>Serializable</code> 接口，因此可以被序列化。总之， <code>CreateActivityData</code> 会存储将要创建的插件 Activity 的类名和包名，再把它放入 <code>intent</code> 中。之后， <code>intent</code> 设置要创建的 Activity 为 <code>activitySelector.selectDynamicActivity(activityInfo)</code> ，<code>activitySelector</code> 是 <code>DefaultActivitySelector</code> 类的对象，那么这 <code>DefaultActivitySelector</code> 到底是什么东西呢？一起来看看 <code>DefaultActivitySelector</code> 的源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultActivitySelector</span> <span class="keyword">implements</span> <span class="title">DynamicActivitySelector</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> DynamicActivitySelector DEFAULT = <span class="keyword">new</span> DefaultActivitySelector();</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;? extends Activity&gt; selectDynamicActivity(ActivityInfo pluginActivityInfo) &#123;</span><br><span class="line">        <span class="keyword">return</span> DynamicActivity.class;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DynamicActivitySelector <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DEFAULT;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实很简单，不管传入的 <code>pluginActivityInfo</code> 参数是什么，返回的都是 <code>DynamicActivity.class</code> 。也就是我们在介绍<a href="/2016/10/02/%E6%8F%92%E4%BB%B6%E5%8C%96%E6%A1%86%E6%9E%B6android-pluginmgr%E5%85%A8%E8%A7%A3%E6%9E%90/#android-pluginmgr_u7684_u7B80_u5355_u7528_u6CD5"> android-pluginmgr 简单用法</a>时，第二步在 AndroidManifest 中注册的那个 <code>DynamicActivity</code> 。<br>看到这里的代码，我们一定可以猜到什么。因为这里的 <code>intent</code> 中设置即将启动的 Activity 仍然为 <code>DynamicActivity</code> ，所以在后面的代码中肯定会去动态地替换掉 <code>DynamicActivity</code>。</p>
<h2 id="u52A8_u6001Hook"><a href="#u52A8_u6001Hook" class="headerlink" title="动态Hook"></a>动态Hook</h2><p>之前在 <a href="/2016/10/02/%E6%8F%92%E4%BB%B6%E5%8C%96%E6%A1%86%E6%9E%B6android-pluginmgr%E5%85%A8%E8%A7%A3%E6%9E%90/#PluginManager-init_28this_29_u6E90_u7801">PluginManager.init(this) 源码</a>这一小节中介绍了，当前 <code>ActivityThread</code> 的 <code>Instrumentation</code> 已经被替换成了 <code>PluginInstrumentation</code>。所以在创建 Activity 的时候会去调用 <code>PluginInstrumentation</code> 里面的方法。这样就可以在里面“做手脚”，实现了动态去替换 Activity 的思路。我们先来看一下 <code>PluginInstrumentation</code> 中部分方法的源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">replaceIntentTargetIfNeed</span><span class="params">(Context from, Intent intent)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!intent.hasExtra(Globals.FLAG_ACTIVITY_FROM_PLUGIN) &amp;&amp; currentPlugin != <span class="keyword">null</span>)</span><br><span class="line">	&#123;</span><br><span class="line">        ComponentName componentName = intent.getComponent();</span><br><span class="line">        <span class="keyword">if</span> (componentName != <span class="keyword">null</span>)</span><br><span class="line">		&#123;</span><br><span class="line">            String pkgName = componentName.getPackageName();</span><br><span class="line">            String activityName = componentName.getClassName();</span><br><span class="line">            <span class="keyword">if</span> (pkgName != <span class="keyword">null</span>)</span><br><span class="line">			&#123;</span><br><span class="line">                CreateActivityData createActivityData = <span class="keyword">new</span> CreateActivityData(activityName, currentPlugin.getPackageName());</span><br><span class="line">                ActivityInfo activityInfo = currentPlugin.findActivityByClassName(activityName);</span><br><span class="line">                <span class="keyword">if</span> (activityInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    intent.setClass(from, PluginManager.getSingleton().getActivitySelector().selectDynamicActivity(activityInfo));</span><br><span class="line">                    intent.putExtra(Globals.FLAG_ACTIVITY_FROM_PLUGIN, createActivityData);</span><br><span class="line">                    intent.setExtrasClassLoader(currentPlugin.getClassLoader());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ActivityResult <span class="title">execStartActivity</span><span class="params">(Context who, IBinder contextThread, IBinder token, Fragment fragment, Intent intent, <span class="keyword">int</span> requestCode)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    replaceIntentTargetIfNeed(who, intent);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.execStartActivity(who, contextThread, token, fragment, intent, requestCode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ActivityResult <span class="title">execStartActivity</span><span class="params">(Context who, IBinder contextThread, IBinder token, Fragment fragment, Intent intent, <span class="keyword">int</span> requestCode, Bundle options)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    replaceIntentTargetIfNeed(who, intent);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.execStartActivity(who, contextThread, token, fragment, intent, requestCode, options);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ActivityResult <span class="title">execStartActivity</span><span class="params">(Context who, IBinder contextThread, IBinder token, Activity target, Intent intent, <span class="keyword">int</span> requestCode)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    replaceIntentTargetIfNeed(who, intent);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.execStartActivity(who, contextThread, token, target, intent, requestCode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ActivityResult <span class="title">execStartActivity</span><span class="params">(Context who, IBinder contextThread, IBinder token, Activity target, Intent intent, <span class="keyword">int</span> requestCode, Bundle options)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    replaceIntentTargetIfNeed(who, intent);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.execStartActivity(who, contextThread, token, target, intent, requestCode, options);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们发现，在所有的 <code>execStartActivity()</code> 方法执行前，都加上了 <code>replaceIntentTargetIfNeed(Context from, Intent intent)</code> 这个方法，在方法里面 <code>intent.setClass</code> 中设置的还是 <code>DynamicActivity.class</code> ，把插件信息都检查了一遍。</p>
<p>在这之后，会去执行 <code>PluginInstrumentation.newActivity</code> 方法来创建即将要启动的Activity 。也正是在这里，对之前的 <code>DynamicActivity</code> 进行 Hook ，达到启动插件 Activity 的目的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Activity <span class="title">newActivity</span><span class="params">(ClassLoader cl, String className, Intent intent)</span> <span class="keyword">throws</span> InstantiationException, IllegalAccessException, ClassNotFoundException</span><br><span class="line"></span>&#123;</span><br><span class="line">    CreateActivityData activityData = (CreateActivityData) intent.getSerializableExtra(Globals.FLAG_ACTIVITY_FROM_PLUGIN);</span><br><span class="line">    <span class="comment">//如果activityData存在,那么说明将要创建的是插件Activity</span></span><br><span class="line">    <span class="keyword">if</span> (activityData != <span class="keyword">null</span> &amp;&amp; PluginManager.getSingleton().getPlugins().size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//这里找不到插件信息就会抛异常的,不用担心空指针</span></span><br><span class="line">        PlugInfo plugInfo;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">		&#123;</span><br><span class="line">            Log.d(getClass().getSimpleName(), <span class="string">"+++ Start Plugin Activity =&gt; "</span> + activityData.pluginPkg + <span class="string">" / "</span> + activityData.activityName);</span><br><span class="line">            <span class="comment">// 得到插件信息类</span></span><br><span class="line">            plugInfo = PluginManager.getSingleton().tryGetPluginInfo(activityData.pluginPkg);</span><br><span class="line">            <span class="comment">// 在该方法中会调用插件的Application.onCreate()</span></span><br><span class="line">            plugInfo.ensureApplicationCreated();</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="keyword">catch</span> (PluginNotFoundException e)</span><br><span class="line">		&#123;</span><br><span class="line">            PluginManager.getSingleton().dump();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalAccessException(<span class="string">"Cannot get plugin Info : "</span> + activityData.pluginPkg);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (activityData.activityName != <span class="keyword">null</span>)</span><br><span class="line">		&#123;</span><br><span class="line">            <span class="comment">// 在这里替换了className，变成了插件Activity的className</span></span><br><span class="line">            className = activityData.activityName;</span><br><span class="line">            <span class="comment">// 替换classloader</span></span><br><span class="line">            cl = plugInfo.getClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.newActivity(cl, className, intent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>newActivity()</code> 方法中，先拿到了插件信息 <code>plugInfo</code> ，然后会确保插件的 <code>Application</code> 已经创建。然后在第25行会去替换掉 <code>className</code> 和 <code>cl</code> 。这样，原本要创建的是 <code>DynamicActivity</code> 就变成了插件的 <code>Activity</code> 了，从而实现了创建插件 Activity 的目的，并且这个 Activity 是真实的 Activity 组件，具备生命周期的。</p>
<p>也许有童鞋会有疑问，如果直接在 <code>startActivity</code> 中设置要启动的 Activity 为插件 Activity ，这样不行吗？答案是肯定的，因为这样就会抛出一个异常：<code>ActivityNotFoundException:...have you declared this activity in your AndroidManifest.xml?</code>我相信这个异常大家很熟悉的吧，在刚开始学习 Android 时，大家都会犯的一个错误。所以，我想我们也明白了为什么要花这么大的一个功夫去动态地替换要创建的 Activity ，就是为了绕过这个 <code>ActivityNotFoundException</code> 异常，达到去“欺骗” Android 系统的效果。</p>
<p>既然创建好了，那么就来看看 <code>PluginInstrumentation</code> 里调用相关生命周期的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnCreate</span><span class="params">(Activity activity, Bundle icicle)</span> </span>&#123;</span><br><span class="line">    lookupActivityInPlugin(activity);</span><br><span class="line">    <span class="keyword">if</span> (currentPlugin != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//初始化插件Activity</span></span><br><span class="line">        Context baseContext = activity.getBaseContext();</span><br><span class="line">        PluginContext pluginContext = <span class="keyword">new</span> PluginContext(baseContext, currentPlugin);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//在许多设备上，Activity自身hold资源</span></span><br><span class="line">                Reflect.on(activity).set(<span class="string">"mResources"</span>, pluginContext.getResources());</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable ignored) &#123;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Field field = ContextWrapper.class.getDeclaredField(<span class="string">"mBase"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            field.set(activity, pluginContext);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Reflect.on(activity).set(<span class="string">"mApplication"</span>, currentPlugin.getApplication());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ReflectException e) &#123;</span><br><span class="line">                Trace.store(<span class="string">"Application not inject success into : "</span> + activity);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ActivityInfo activityInfo = currentPlugin.findActivityByClassName(activity.getClass().getName());</span><br><span class="line">        <span class="keyword">if</span> (activityInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//根据AndroidManifest.xml中的参数设置Theme</span></span><br><span class="line">            <span class="keyword">int</span> resTheme = activityInfo.getThemeResource();</span><br><span class="line">            <span class="keyword">if</span> (resTheme != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">boolean</span> hasNotSetTheme = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Field mTheme = ContextThemeWrapper.class</span><br><span class="line">                            .getDeclaredField(<span class="string">"mTheme"</span>);</span><br><span class="line">                    mTheme.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    hasNotSetTheme = mTheme.get(activity) == <span class="keyword">null</span>;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (hasNotSetTheme) &#123;</span><br><span class="line">                    changeActivityInfo(activityInfo, activity);</span><br><span class="line">                    activity.setTheme(resTheme);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果是三星手机，则使用包装的LayoutInflater替换原LayoutInflater</span></span><br><span class="line">        <span class="comment">// 这款手机在解析内置的布局文件时有各种错误</span></span><br><span class="line">        <span class="keyword">if</span> (android.os.Build.MODEL.startsWith(<span class="string">"GT"</span>)) &#123;</span><br><span class="line">            Window window = activity.getWindow();</span><br><span class="line">            Reflect windowRef = Reflect.on(window);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                LayoutInflater originInflater = window.getLayoutInflater();</span><br><span class="line">                <span class="keyword">if</span> (!(originInflater <span class="keyword">instanceof</span> LayoutInflaterWrapper)) &#123;</span><br><span class="line">                    windowRef.set(<span class="string">"mLayoutInflater"</span>, <span class="keyword">new</span> LayoutInflaterWrapper(originInflater));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">super</span>.callActivityOnCreate(activity, icicle);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * 检查跳转目标是不是来自插件</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span> activity Activity</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">lookupActivityInPlugin</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">    ClassLoader classLoader = activity.getClass().getClassLoader();</span><br><span class="line">    <span class="keyword">if</span> (classLoader <span class="keyword">instanceof</span> PluginClassLoader) &#123;</span><br><span class="line">        currentPlugin = ((PluginClassLoader) classLoader).getPlugInfo();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        currentPlugin = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>callActivityOnCreate()</code> 中先去检查了创建的 Activity 是否来自于插件。如果是，那么会给 Activity 设置 Context 、 设置主题等；如果不是，则直接执行父类方法。在 <code>super.callActivityOnCreate(activity, icicle)</code> 中会去调用 <code>Activity.onCreate()</code>方法。其他的生命周期方法作者没有特殊处理，这里就不讲了。</p>
<p>分析到这，我们终于把 <a href="https://github.com/houkx/android-pluginmgr" target="_blank" rel="external">android-pluginmgr</a> 插件化实现的方案完整地梳理了一遍。当然，不同的插件化框架会有不同的实现方案，具体的仍然需要自己专心研究。另外我们发现该框架还没有实现启动插件 Service 的功能，如果想要了解，可以参考下其他插件化框架。</p>
<h1 id="0x04__u603B_u7ED3"><a href="#0x04__u603B_u7ED3" class="headerlink" title="0x04 总结"></a>0x04 总结</h1><p>上面乱七八糟的流程讲了一遍，可能还有一些童鞋不太懂，所以在这里给出一张 <a href="https://github.com/houkx/android-pluginmgr" target="_blank" rel="external">android-pluginmgr</a> 的流程图。不懂的童鞋可以根据这张图再好好看一下源码，相信你会恍然大悟的。</p>
<p><img src="/uploads/20161002/20161005183404.png" alt="android-pluginmgr流程图"></p>
<p>最后，如果对本文哪里有疑问的童鞋，欢迎留言，一起交流。</p>
<h1 id="0x05_References"><a href="#0x05_References" class="headerlink" title="0x05 References"></a>0x05 References</h1><ul>
<li><a href="https://mp.weixin.qq.com/s?__biz=MjM5MDE0Mjc4MA==&amp;mid=2650993300&amp;idx=1&amp;sn=797fa87ef528cff3a50e77806cf9f675&amp;scene=1&amp;srcid=07125lNtkiWhjbu4dp8GhoAf#rd" target="_blank" rel="external">包建强：为什么我说Android插件化从入门到放弃？</a></li>
</ul>

      
    </div>
    
    <div>
      
        
      
    </div>

    <div>
      
        
<div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton", disable="enable", onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}", style="cursor: pointer; border: 0; outline: 0; border-radius: 100%; padding: 0; margin: 0; letter-spacing: normal; text-transform: none; text-indent: 0px; text-shadow: none">
    <span onmouseover="this.style.color='rgb(236,96,0)';this.style.background='rgb(204,204,204)'" onMouseOut="this.style.color='#fff';this.style.background='rgb(236,96,0)'" style="display: inline-block; width: 70px; height: 70px; border-radius: 100%; line-height: 81px; color: #fff; font: 400 35px/75px 'microsofty'; background: rgb(236,96,0)">赏</span>
  </button>
  <div id="QR" style="display: none;">
    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/uploads/avatar/20161001102756.png" alt="俞其荣 WeChat Pay" style="width: 200px; max-width: 100%; display: inline-block"/>
        <p>微信打赏</p>
      </div>
    
    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/uploads/avatar/20160428221107.jpg" alt="俞其荣 Alipay" style="width: 200px; max-width: 100%; display: inline-block"/>
        <p>支付宝打赏</p>
      </div>
    
  </div>
</div>

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag">#Android</a>
          
            <a href="/tags/开源框架/" rel="tag">#开源框架</a>
          
            <a href="/tags/插件化/" rel="tag">#插件化</a>
          
            <a href="/tags/源码解析/" rel="tag">#源码解析</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/09/25/用Java实现Android多渠道打包工具/" rel="next" title="用Java实现Android多渠道打包工具">
                <i class="fa fa-chevron-left"></i> 用Java实现Android多渠道打包工具
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/10/23/关于Gradle配置的小结/" rel="prev" title="关于Gradle配置的小结">
                关于Gradle配置的小结 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <div class="ds-share flat" data-thread-key="2016/10/02/插件化框架android-pluginmgr全解析/"
     data-title="插件化框架android-pluginmgr全解析"
     data-content=""
     data-url="http://yuqirong.me/2016/10/02/插件化框架android-pluginmgr全解析/">
  <div class="ds-share-inline">
    <ul  class="ds-share-icons-16">

      <li data-toggle="ds-share-icons-more"><a class="ds-more" href="javascript:void(0);">分享到：</a></li>
      <li><a class="ds-weibo" href="javascript:void(0);" data-service="weibo">微博</a></li>
      <li><a class="ds-qzone" href="javascript:void(0);" data-service="qzone">QQ空间</a></li>
      <li><a class="ds-qqt" href="javascript:void(0);" data-service="qqt">腾讯微博</a></li>
      <li><a class="ds-wechat" href="javascript:void(0);" data-service="wechat">微信</a></li>

    </ul>
    <div class="ds-share-icons-more">
    </div>
  </div>
</div>
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2016/10/02/插件化框架android-pluginmgr全解析/"
           data-title="插件化框架android-pluginmgr全解析" data-url="http://yuqirong.me/2016/10/02/插件化框架android-pluginmgr全解析/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar/27073358153.jpg"
               alt="俞其荣" />
          <p class="site-author-name" itemprop="name">俞其荣</p>
          <p class="site-description motion-element" itemprop="description">向前跑 迎着冷眼和嘲笑</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">50</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">20</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/yuqirong" target="_blank">
                  
                    <i class="fa fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/yyyuqirong" target="_blank">
                  
                    <i class="fa fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.instagram.com/yyyuqirong" target="_blank">
                  
                    <i class="fa fa-instagram"></i>
                  
                  Instagram
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://plus.google.com/116756215081118586533" target="_blank">
                  
                    <i class="fa fa-google-plus"></i>
                  
                  Google+
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://cn.linkedin.com/in/yuqirong" target="_blank">
                  
                    <i class="fa fa-linkedin"></i>
                  
                  LinkedIn
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.jianshu.com/users/1291f6690ea0" target="_blank">
                  
                    <i class="fa fa-globe"></i>
                  
                  简书
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/yyyuqirong" target="_blank">
                  
                    <i class="fa fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/yuqirong" target="_blank">
                  
                    <i class="fa fa-globe"></i>
                  
                  知乎
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:yqr271228943@gmail.com" target="_blank">
                  
                    <i class="fa fa-envelope"></i>
                  
                  Email
                </a>
              </span>
            
          
        </div>
        
        <div class="cc-license motion-element" itemprop="license">
            <a href="http://creativecommons.org/licenses/by-nc-sa/4.0" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons">
            </a>
          </div>

        
        

        
        <div class="links-of-blogroll motion-element">
          
        </div>

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#0x00__u524D_u8A00_uFF1A_u63D2_u4EF6_u5316_u7684_u4ECB_u7ECD"><span class="nav-number">1.</span> <span class="nav-text">0x00 前言：插件化的介绍</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x01_PluginManager-init"><span class="nav-number">2.</span> <span class="nav-text">0x01 PluginManager.init</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#android-pluginmgr_u7684_u7B80_u5355_u7528_u6CD5"><span class="nav-number">2.1.</span> <span class="nav-text">android-pluginmgr的简单用法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PluginManager-init_28this_29_u6E90_u7801"><span class="nav-number">2.2.</span> <span class="nav-text">PluginManager.init(this)源码</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x02_PluginManager-loadPlugin"><span class="nav-number">3.</span> <span class="nav-text">0x02 PluginManager.loadPlugin</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#u590D_u5236_u63D2_u4EF6_apk__u5230_u6307_u5B9A_u76EE_u5F55"><span class="nav-number">3.1.</span> <span class="nav-text">复制插件 apk 到指定目录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#u52A0_u8F7D_u63D2_u4EF6_apk__u7684_AndroidManifest-xml__u6587_u4EF6"><span class="nav-number">3.2.</span> <span class="nav-text">加载插件 apk 的 AndroidManifest.xml 文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#u52A0_u8F7D_u63D2_u4EF6_apk__u4E2D_u7684_u8D44_u6E90_u6587_u4EF6"><span class="nav-number">3.3.</span> <span class="nav-text">加载插件 apk 中的资源文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#u4E3A_u63D2_u4EF6_apk__u8BBE_u7F6E_ClassLoader"><span class="nav-number">3.4.</span> <span class="nav-text">为插件 apk 设置 ClassLoader</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x03_PluginManager-startActivity"><span class="nav-number">4.</span> <span class="nav-text">0x03 PluginManager.startActivity</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#startActivity"><span class="nav-number">4.1.</span> <span class="nav-text">startActivity</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#u52A8_u6001Hook"><span class="nav-number">4.2.</span> <span class="nav-text">动态Hook</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x04__u603B_u7ED3"><span class="nav-number">5.</span> <span class="nav-text">0x04 总结</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x05_References"><span class="nav-number">6.</span> <span class="nav-text">0x05 References</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">俞其荣
 <!--  
  &nbsp;&nbsp;|&nbsp;&nbsp;
 <script type="text/javascript">
  var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
  document.write(unescape("%3Cspan id='cnzz_stat_icon_1257390016'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s11.cnzz.com/z_stat.php%3Fid%3D1257390016' type='text/javascript'%3E%3C/script%3E"));
  </script>

  &nbsp;&nbsp;|&nbsp;&nbsp;<span><a href="/sitemap.xml">Google网站地图</a></span>
  &nbsp;&nbsp;|&nbsp;&nbsp;<span><a href="/baidusitemap.xml">百度网站地图</a></span> -->
  
  </span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

<script>
(function(){
    var bp = document.createElement('script');
    bp.src = '//push.zhanzhang.baidu.com/push.js';
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>



      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"yuqirong"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '/js/src/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  





  
  
  

  

  

</body>
</html>
