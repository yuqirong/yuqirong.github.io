<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title><![CDATA[ä¿å…¶è£çš„åšå®¢ | Qirong Yu's Blog]]></title>
  
  <link href="/atom.xml" rel="self"/>
  <link href="http://yuqirong.me/"/>
  <updated>2019-01-03T15:24:07.112Z</updated>
  <id>http://yuqirong.me/</id>
  
  <author>
    <name><![CDATA[ä¿å…¶è£]]></name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title><![CDATA[ARouteræºç è§£æï¼ˆä¸‰ï¼‰]]></title>
    <link href="http://yuqirong.me/2019/01/03/ARouter%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E4%B8%89%EF%BC%89/"/>
    <id>http://yuqirong.me/2019/01/03/ARouteræºç è§£æï¼ˆä¸‰ï¼‰/</id>
    <published>2019-01-03T13:46:43.000Z</published>
    <updated>2019-01-03T15:24:07.112Z</updated>
    <content type="html"><![CDATA[<p>arouter-api version : 1.4.1</p>
<h1 id="u524D_u8A00"><a href="#u524D_u8A00" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>åˆ°ç°åœ¨ä¸ºæ­¢ï¼ŒARouter è¿˜æœ‰æœ€åçš„ä¾èµ–æ³¨å…¥è¿˜æ²¡æœ‰è§£æè¿‡ï¼Œé‚£ä¹ˆä»Šå¤©å°±æ¥æ·±å…¥æ¢ç©¶ä¸€ä¸‹å…¶å®ç°åŸç†ã€‚</p>
<p>PS : å› ä¸ºä¾èµ–æ³¨å…¥çš„åŸç†è¿˜æ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥æœ¬ç¯‡ç¯‡å¹…ä¼šè¾ƒçŸ­ã€‚</p>
<h1 id="@Autowired_u89E3_u6790"><a href="#@Autowired_u89E3_u6790" class="headerlink" title="@Autowiredè§£æ"></a>@Autowiredè§£æ</h1><p>æƒ³è¦ç”¨ ARouter å®ç°ä¾èµ–æ³¨å…¥ï¼Œéœ€è¦åœ¨ Activity/Fragment ä¸­åŠ ä¸Š</p>
<pre><code>ARouter.getInstance().inject(this);
</code></pre><p>é‚£ä¹ˆæˆ‘ä»¬è¿™ä¸ªä»£ç å°±æˆä¸ºäº†æˆ‘ä»¬åˆ†æçš„å…¥å£äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inject</span><span class="params">(Object thiz)</span> </span>&#123;</span><br><span class="line">    _ARouter.inject(thiz);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ARouter å†…éƒ¨è¿˜æ˜¯è°ƒç”¨äº† _ARouter çš„ inject æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">inject</span><span class="params">(Object thiz)</span> </span>&#123;</span><br><span class="line">    AutowiredService autowiredService = ((AutowiredService) ARouter.getInstance().build(<span class="string">"/arouter/service/autowired"</span>).navigation());</span><br><span class="line">    <span class="comment">// å¦‚æœ autowiredService ä¸ä¸ºç©ºï¼Œå®Œæˆä¾èµ–æ³¨å…¥</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != autowiredService) &#123;</span><br><span class="line">        autowiredService.autowire(thiz);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‘ç°ä¾èµ–æ³¨å…¥å’Œæ‹¦æˆªå™¨å¾ˆç›¸ä¼¼ï¼Œéƒ½æ˜¯åˆ©ç”¨æœåŠ¡ç»„ä»¶æ¥å®Œæˆçš„ã€‚ä¾èµ–æ³¨å…¥çš„æœåŠ¡ç»„ä»¶å« AutowiredService ï¼Œè·Ÿè¸ªå¯ä»¥å‘ç°ï¼Œå®ƒçš„å®ç°ç±»æ˜¯ AutowiredServiceImpl ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Route</span>(path = <span class="string">"/arouter/service/autowired"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AutowiredServiceImpl</span> <span class="keyword">implements</span> <span class="title">AutowiredService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> LruCache&lt;String, ISyringe&gt; classCache;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; blackList;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        classCache = <span class="keyword">new</span> LruCache&lt;&gt;(<span class="number">66</span>);</span><br><span class="line">        blackList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">autowire</span><span class="params">(Object instance)</span> </span>&#123;</span><br><span class="line">        String className = instance.getClass().getName();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœ instance è¿™ä¸ªç±»è¿›å…¥é»‘åå•äº†ï¼Œå°±ä¸ä¼šå®Œæˆä¾èµ–æ³¨å…¥</span></span><br><span class="line">            <span class="keyword">if</span> (!blackList.contains(className)) &#123;</span><br><span class="line">                <span class="comment">// å…ˆä»ç¼“å­˜ä¸­å–</span></span><br><span class="line">                ISyringe autowiredHelper = classCache.get(className);</span><br><span class="line">                <span class="comment">// æ²¡æœ‰ç¼“å­˜å°±åˆ›å»ºå¯¹è±¡</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> == autowiredHelper) &#123;  <span class="comment">// No cache.</span></span><br><span class="line">                    autowiredHelper = (ISyringe) Class.forName(instance.getClass().getName() + SUFFIX_AUTOWIRED).getConstructor().newInstance();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// å®Œæˆä¾èµ–æ³¨å…¥</span></span><br><span class="line">                autowiredHelper.inject(instance);</span><br><span class="line">                <span class="comment">// æ”¾å…¥ç¼“å­˜ä¸­</span></span><br><span class="line">                classCache.put(className, autowiredHelper);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            <span class="comment">// å‡ºé”™å°±åŠ å…¥é»‘åå•ä¸­</span></span><br><span class="line">            blackList.add(className);    <span class="comment">// This instance need not autowired.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ ISyringe å°±æ˜¯ä¾èµ–æ³¨å…¥æŠ½å–å‡ºæ¥çš„æ¥å£ï¼Œ</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ISyringe</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">inject</span><span class="params">(Object <span class="keyword">target</span>)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆ ISyringe çš„å®ç°ç±»åˆæ˜¯è°å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯åœ¨ç¼–è¯‘æœŸè‡ªåŠ¨ç”Ÿæˆçš„ç±» <code>XXXX$$ARouter$$Autowired</code> ï¼Œæˆ‘ä»¬æ‰¾ demo ä¸­ç”Ÿæˆçš„ <code>Test1Activity$$ARouter$$Autowired</code> æ¥çœ‹çœ‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test1Activity</span>$$<span class="title">ARouter</span>$$<span class="title">Autowired</span> <span class="keyword">implements</span> <span class="title">ISyringe</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> SerializationService serializationService;</span><br><span class="line"></span><br><span class="line">  <span class="annotation">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inject</span><span class="params">(Object target)</span> </span>&#123;</span><br><span class="line">    serializationService = ARouter.getInstance().navigation(SerializationService.class);</span><br><span class="line">    Test1Activity substitute = (Test1Activity)target;</span><br><span class="line">    substitute.name = substitute.getIntent().getStringExtra(<span class="string">"name"</span>);</span><br><span class="line">    substitute.age = substitute.getIntent().getIntExtra(<span class="string">"age"</span>, substitute.age);</span><br><span class="line">    substitute.height = substitute.getIntent().getIntExtra(<span class="string">"height"</span>, substitute.height);</span><br><span class="line">    substitute.girl = substitute.getIntent().getBooleanExtra(<span class="string">"boy"</span>, substitute.girl);</span><br><span class="line">    substitute.ch = substitute.getIntent().getCharExtra(<span class="string">"ch"</span>, substitute.ch);</span><br><span class="line">    substitute.fl = substitute.getIntent().getFloatExtra(<span class="string">"fl"</span>, substitute.fl);</span><br><span class="line">    substitute.dou = substitute.getIntent().getDoubleExtra(<span class="string">"dou"</span>, substitute.dou);</span><br><span class="line">    substitute.ser = (com.alibaba.android.arouter.demo.testinject.TestSerializable) substitute.getIntent().getSerializableExtra(<span class="string">"ser"</span>);</span><br><span class="line">    substitute.pac = substitute.getIntent().getParcelableExtra(<span class="string">"pac"</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != serializationService) &#123;</span><br><span class="line">      substitute.obj = serializationService.parseObject(substitute.getIntent().getStringExtra(<span class="string">"obj"</span>), <span class="keyword">new</span> com.alibaba.android.arouter.facade.model.TypeWrapper&lt;TestObj&gt;()&#123;&#125;.getType());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      Log.e(<span class="string">"ARouter::"</span>, <span class="string">"You want automatic inject the field 'obj' in class 'Test1Activity' , then you should implement 'SerializationService' to support object auto inject!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != serializationService) &#123;</span><br><span class="line">      substitute.objList = serializationService.parseObject(substitute.getIntent().getStringExtra(<span class="string">"objList"</span>), <span class="keyword">new</span> com.alibaba.android.arouter.facade.model.TypeWrapper&lt;List&lt;TestObj&gt;&gt;()&#123;&#125;.getType());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      Log.e(<span class="string">"ARouter::"</span>, <span class="string">"You want automatic inject the field 'objList' in class 'Test1Activity' , then you should implement 'SerializationService' to support object auto inject!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != serializationService) &#123;</span><br><span class="line">      substitute.map = serializationService.parseObject(substitute.getIntent().getStringExtra(<span class="string">"map"</span>), <span class="keyword">new</span> com.alibaba.android.arouter.facade.model.TypeWrapper&lt;Map&lt;String, List&lt;TestObj&gt;&gt;&gt;()&#123;&#125;.getType());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      Log.e(<span class="string">"ARouter::"</span>, <span class="string">"You want automatic inject the field 'map' in class 'Test1Activity' , then you should implement 'SerializationService' to support object auto inject!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    substitute.url = substitute.getIntent().getStringExtra(<span class="string">"url"</span>);</span><br><span class="line">    substitute.helloService = ARouter.getInstance().navigation(HelloService.class);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢è‡ªåŠ¨ç”Ÿæˆçš„ä»£ç ä¸­çœ‹å‡ºæ¥ï¼Œä¾èµ–æ³¨å…¥å®é™…ä¸Šå†…éƒ¨è¿˜æ˜¯ä½¿ç”¨ <code>getIntent.getXxxExtra</code> çš„å½¢å¼æ¥èµ‹å€¼çš„ï¼ˆåŒç†ï¼ŒFragment ç”¨çš„æ˜¯<code>getArguments().getXxx()</code> ï¼‰ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ@Autowired ä¿®é¥°çš„å­—æ®µä¸èƒ½æ˜¯ private çš„ï¼Œä¸ç„¶åœ¨è‡ªåŠ¨ç”Ÿæˆä»£ç çš„æ—¶å€™ä¼šæŠ¥é”™ã€‚</p>
<p>å¦å¤–ï¼Œä¸Šé¢çš„ä»£ç ä¸­æœ‰ä¸€ä¸ª SerializationService æ˜¯ç”¨æ¥å¹²ä»€ä¹ˆçš„ï¼Ÿå…¶å® SerializationService æ˜¯ json åºåˆ—åŒ–ç”¨çš„ã€‚åœ¨ demo ä¸­å®˜æ–¹ç»™å‡ºäº†ä¸€ä¸ªå®ç°ç±» JsonServiceImpl ï¼Œå†…éƒ¨ç”¨çš„æ˜¯é˜¿é‡Œçš„ fastjson ã€‚å¦‚æœæœ‰éœ€è¦è‡ªå®šä¹‰çš„ç«¥é‹ï¼Œå¯ä»¥å‚ç…§ç€ JsonServiceImpl è‡ªå·±å»å®ç°ã€‚</p>
<h1 id="u7ED3_u675F"><a href="#u7ED3_u675F" class="headerlink" title="ç»“æŸ"></a>ç»“æŸ</h1><p>çœ‹åˆ°è¿™ï¼ŒåŸºæœ¬ä¸Š ARouter ä¾èµ–æ³¨å…¥çš„ä¸œè¥¿å°±è®²å®Œäº†ã€‚</p>
<p>è¿™ä¸€ç³»åˆ—ä¸‹æ¥ï¼ŒARouter ä»£ç å±‚é¢çš„æµç¨‹éƒ½è®²çš„å·®ä¸å¤šã€‚å‰©ä¸‹å°±æ˜¯ gradle-plugin å’Œ compiler è¿™ä¸¤ä¸ªéƒ¨åˆ†è¿˜æ²¡è§£æè¿‡ï¼Œç­‰æ—¶é—´äº†å†ç»™å¤§å®¶è®²ã€‚</p>
<p>bye bye</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>arouter-api version : 1.4.1</p>
<h1 id="u524D_u8A00"><a href="#u524D_u8A00" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>åˆ°ç°åœ¨ä¸ºæ­¢ï¼ŒARouter è¿˜æœ‰æœ€]]>
    </summary>
    
      <category term="Android" scheme="http://yuqirong.me/tags/Android/"/>
    
      <category term="å¼€æºæ¡†æ¶" scheme="http://yuqirong.me/tags/%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/"/>
    
      <category term="æºç è§£æ" scheme="http://yuqirong.me/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    
      <category term="Android Blog" scheme="http://yuqirong.me/categories/Android-Blog/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[ARouteræºç è§£æï¼ˆäºŒï¼‰]]></title>
    <link href="http://yuqirong.me/2019/01/02/ARouter%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E4%BA%8C%EF%BC%89/"/>
    <id>http://yuqirong.me/2019/01/02/ARouteræºç è§£æï¼ˆäºŒï¼‰/</id>
    <published>2019-01-02T12:16:40.000Z</published>
    <updated>2019-01-03T13:47:26.387Z</updated>
    <content type="html"><![CDATA[<p>arouter-api version : 1.4.1</p>
<h1 id="u524D_u8A00"><a href="#u524D_u8A00" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å‰å‡ å¤©å¯¹ ARouter çš„é¡µé¢è·³è½¬æºç è¿›è¡Œäº†åˆ†æï¼Œè¶ç€ä»Šå¤©æœ‰ç©ºï¼Œå°±è®²è®² ARouter é‡Œé¢çš„æ‹¦æˆªå™¨å§ã€‚</p>
<p>ARouter æ‹¦æˆªå™¨çš„ä½¿ç”¨æ–¹æ³•åœ¨è¿™å°±ä¸å¤šè¯´äº†ï¼Œä¸äº†è§£çš„åŒå­¦å¯ä»¥å» GitHub ä¸Šçœ‹çœ‹ã€‚é‚£å°±ç›´æ¥è¿›å…¥æ­£é¢˜äº†ã€‚</p>
<h1 id="u62E6_u622A_u5668_u89E3_u6790"><a href="#u62E6_u622A_u5668_u89E3_u6790" class="headerlink" title="æ‹¦æˆªå™¨è§£æ"></a>æ‹¦æˆªå™¨è§£æ</h1><p>æŠŠè§†çº¿è½¬ç§»å› ARouter çš„ init æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Application application)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!hasInit) &#123;</span><br><span class="line">        logger = _ARouter.logger;</span><br><span class="line">        _ARouter.logger.info(Consts.TAG, <span class="string">"ARouter init start."</span>);</span><br><span class="line">        hasInit = _ARouter.init(application);</span><br><span class="line">        <span class="comment">// å¦‚æœåˆå§‹åŒ–å®Œæˆäº†</span></span><br><span class="line">        <span class="keyword">if</span> (hasInit) &#123;</span><br><span class="line">            _ARouter.afterInit();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        _ARouter.logger.info(Consts.TAG, <span class="string">"ARouter init over."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ init ä¸­ï¼Œåˆ¤æ–­äº†åˆå§‹åŒ–å®Œæˆåï¼Œè°ƒç”¨äº† <code>_ARouter.afterInit()</code> æ¥åˆå§‹åŒ–æ‹¦æˆªå™¨ï¼Œè·Ÿè¿›ä»£ç å»çœ‹çœ‹ã€‚</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="function"><span class="keyword">void</span> <span class="title">afterInit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Trigger interceptor init, use byName.</span></span><br><span class="line">    interceptorService = (InterceptorService) ARouter.getInstance().build(<span class="string">"/arouter/service/interceptor"</span>).navigation();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‘ç°æœ‰ä¸ª InterceptorService ï¼ŒInterceptorService å°±æ˜¯ç”¨æ¥æ§åˆ¶æ‹¦æˆªçš„æœåŠ¡ç»„ä»¶ï¼Œæ¥çœ‹çœ‹å®ƒçš„æ¥å£æ˜¯æ€ä¹ˆå®šä¹‰çš„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">InterceptorService</span> <span class="keyword">extends</span> <span class="title">IProvider</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Do interceptions</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doInterceptions</span><span class="params">(Postcard postcard, InterceptorCallback callback)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¹‹å‰æˆ‘ä»¬åˆ†æè¿‡ï¼ŒIProvider ä¹Ÿæ˜¯å¯ä»¥ç”¨ <code>ARouter.getInstance().build(&quot;xxx&quot;).navigation()</code> çš„å½¢å¼è·å–çš„ã€‚å…³é”®çš„ä»£ç åœ¨ LogisticsCenter çš„ completion æ–¹æ³•ä¸­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Completion the postcard by route metas</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span> postcard Incomplete postcard, should complete by this method.</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">completion</span><span class="params">(Postcard postcard)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == postcard) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NoRouteFoundException(TAG + <span class="string">"No postcard!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    RouteMeta routeMeta = Warehouse.routes.get(postcard.getPath());</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == routeMeta) &#123;</span><br><span class="line">        <span class="comment">// çœç•¥ä¸€å¤§ä¸²ä»£ç </span></span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// çœç•¥ä¸€å¤§ä¸²ä»£ç </span></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (routeMeta.getType()) &#123;</span><br><span class="line">            <span class="keyword">case</span> PROVIDER:  <span class="comment">// if the route is provider, should find its instance</span></span><br><span class="line">                <span class="comment">// Its provider, so it must implement IProvider</span></span><br><span class="line">                Class&lt;? extends IProvider&gt; providerMeta = (Class&lt;? extends IProvider&gt;) routeMeta.getDestination();</span><br><span class="line">                IProvider instance = Warehouse.providers.get(providerMeta);</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> == instance) &#123; <span class="comment">// There's no instance of this provider</span></span><br><span class="line">                    IProvider provider;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        provider = providerMeta.getConstructor().newInstance();</span><br><span class="line">                        provider.init(mContext);</span><br><span class="line">                        Warehouse.providers.put(providerMeta, provider);</span><br><span class="line">                        instance = provider;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> HandlerException(<span class="string">"Init provider failed! "</span> + e.getMessage());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                postcard.setProvider(instance);</span><br><span class="line">                postcard.greenChannel();    <span class="comment">// Provider should skip all of interceptors</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FRAGMENT:</span><br><span class="line">                postcard.greenChannel();    <span class="comment">// Fragment needn't interceptors</span></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæ˜¯ PROVIDER ç±»å‹çš„ï¼Œå°±ä¼šåå°„å‡ºä¸€ä¸ªå•ä¾‹å¯¹è±¡ï¼Œå¹¶ä¸”è®¾ç½®ä¸ºç»¿è‰²é€šé“ï¼ˆå³ä¸å—æ‹¦æˆªå™¨çš„å½±å“ï¼‰ã€‚æ›´è¯¦ç»†çš„ä»£ç å°±ä¸è¿‡å¤šä»‹ç»äº†ï¼Œä¸ç†è§£çš„åŒå­¦å¯ä»¥ç»“åˆç€ä¸Šä¸€ç¯‡åšå®¢ç§ä¸‹å›å»å†çœ‹ã€‚</p>
<p>æ‰€ä»¥å…¶å®åœ¨ afterInit æ–¹æ³•ä¸­ï¼Œåªæ˜¯è·å–åˆ°äº† InterceptorService çš„å®ä¾‹å¯¹è±¡ï¼Œæˆ‘ä»¬æ ¹æ®ä¸Šé¢çš„ â€œ/arouter/service/interceptorâ€ å¯ä»¥å¾ˆè½»æ¾çš„æŸ¥åˆ°ï¼ŒInterceptorService æ¥å£çš„å®ç°ç±»å°±æ˜¯ InterceptorServiceImpl </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Route</span>(path = <span class="string">"/arouter/service/interceptor"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InterceptorServiceImpl</span> <span class="keyword">implements</span> <span class="title">InterceptorService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> interceptorHasInit;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object interceptorInitLock = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">final</span> Context context)</span> </span>&#123;</span><br><span class="line">        LogisticsCenter.executor.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (MapUtils.isNotEmpty(Warehouse.interceptorsIndex)) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (Map.Entry&lt;Integer, Class&lt;? extends IInterceptor&gt;&gt; entry : Warehouse.interceptorsIndex.entrySet()) &#123;</span><br><span class="line">                        Class&lt;? extends IInterceptor&gt; interceptorClass = entry.getValue();</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            IInterceptor iInterceptor = interceptorClass.getConstructor().newInstance();</span><br><span class="line">                            iInterceptor.init(context);</span><br><span class="line">                            Warehouse.interceptors.add(iInterceptor);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> HandlerException(TAG + <span class="string">"ARouter init interceptor error! name = ["</span> + interceptorClass.getName() + <span class="string">"], reason = ["</span> + ex.getMessage() + <span class="string">"]"</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    interceptorHasInit = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">                    logger.info(TAG, <span class="string">"ARouter interceptors init over."</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">synchronized</span> (interceptorInitLock) &#123;</span><br><span class="line">                        interceptorInitLock.notifyAll();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹ InterceptorServiceImpl çš„ init æ–¹æ³•ã€‚</p>
<p>åœ¨ init æ–¹æ³•ä¸­ï¼Œåšçš„ä¸»è¦äº‹æƒ…å°±æ˜¯éå†æ‰€æœ‰ IInterceptor class å¹¶åˆ›å»ºå‡ºå¯¹è±¡ï¼Œè°ƒç”¨å…¶ init æ–¹æ³•ï¼Œå®Œæˆåˆå§‹åŒ–æ“ä½œã€‚</p>
<p>åˆå§‹åŒ–å®Œæˆä¹‹åï¼ŒInterceptorServiceåˆæ˜¯åœ¨å“ªé‡Œè¢«ä½¿ç”¨çš„å‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬åœ¨ _ARouter çš„ navigation æ–¹æ³•é‡Œå¯ä»¥çœ‹åˆ°å®ƒçš„è¸ªè¿¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">navigation</span><span class="params">(<span class="keyword">final</span> Context context, <span class="keyword">final</span> Postcard postcard, <span class="keyword">final</span> <span class="keyword">int</span> requestCode, <span class="keyword">final</span> NavigationCallback callback)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!postcard.isGreenChannel()) &#123;   <span class="comment">// It must be run in async thread, maybe interceptor cost too mush time made ANR.</span></span><br><span class="line">        interceptorService.doInterceptions(postcard, <span class="keyword">new</span> InterceptorCallback() &#123;</span><br><span class="line">            <span class="comment">/**</span><br><span class="line">             * Continue process</span><br><span class="line">             *</span><br><span class="line">             * <span class="doctag">@param</span> postcard route meta</span><br><span class="line">             */</span></span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onContinue</span><span class="params">(Postcard postcard)</span> </span>&#123;</span><br><span class="line">                _navigation(context, postcard, requestCode, callback);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span><br><span class="line">             * Interrupt process, pipeline will be destory when this method called.</span><br><span class="line">             *</span><br><span class="line">             * <span class="doctag">@param</span> exception Reson of interrupt.</span><br><span class="line">             */</span></span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onInterrupt</span><span class="params">(Throwable exception)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> != callback) &#123;</span><br><span class="line">                    callback.onInterrupt(postcard);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                logger.info(Consts.TAG, <span class="string">"Navigation failed, termination by interceptor : "</span> + exception.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> _navigation(context, postcard, requestCode, callback);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœä¸æ˜¯ç»¿è‰²é€šé“çš„è¯ï¼Œå°±ä¼šå¯åŠ¨æ‹¦æˆªå™¨å»è¿›è¡Œæ‹¦æˆªã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doInterceptions</span><span class="params">(<span class="keyword">final</span> Postcard postcard, <span class="keyword">final</span> InterceptorCallback callback)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != Warehouse.interceptors &amp;&amp; Warehouse.interceptors.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">       checkInterceptorsInitStatus();</span><br><span class="line">       <span class="comment">// å¦‚æœæ‹¦æˆªå™¨è¿˜æ²¡æœ‰åˆå§‹åŒ–å¥½</span></span><br><span class="line">       <span class="keyword">if</span> (!interceptorHasInit) &#123;</span><br><span class="line">           callback.onInterrupt(<span class="keyword">new</span> HandlerException(<span class="string">"Interceptors initialization takes too much time."</span>));</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       LogisticsCenter.executor.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">           <span class="annotation">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               CancelableCountDownLatch interceptorCounter = <span class="keyword">new</span> CancelableCountDownLatch(Warehouse.interceptors.size());</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   _excute(<span class="number">0</span>, interceptorCounter, postcard);</span><br><span class="line">                   <span class="comment">// é˜»å¡çº¿ç¨‹ç›´åˆ°è®¡æ•°å½’0æˆ–è€…è¶…æ—¶ï¼›è¶…æ—¶æ—¶é—´ é»˜è®¤300s</span></span><br><span class="line">                   interceptorCounter.await(postcard.getTimeout(), TimeUnit.SECONDS);</span><br><span class="line">                   <span class="keyword">if</span> (interceptorCounter.getCount() &gt; <span class="number">0</span>) &#123;    <span class="comment">// å¦‚æœ count å¤§äº 0 è¯´æ˜æ˜¯æ‹¦æˆªå™¨è¶…æ—¶</span></span><br><span class="line">                       callback.onInterrupt(<span class="keyword">new</span> HandlerException(<span class="string">"The interceptor processing timed out."</span>));</span><br><span class="line">                   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">null</span> != postcard.getTag()) &#123;    <span class="comment">// è¯´æ˜æ˜¯æŸä¸ªæ‹¦æˆªå™¨ä¸­æ–­äº†ï¼Œå¯¼è‡´æ•´ä¸ªæµç¨‹ä¸­æ–­</span></span><br><span class="line">                       callback.onInterrupt(<span class="keyword">new</span> HandlerException(postcard.getTag().toString()));</span><br><span class="line">                   &#125; <span class="keyword">else</span> &#123; <span class="comment">// å¦åˆ™å°±é€šè¿‡</span></span><br><span class="line">                       callback.onContinue(postcard);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                   callback.onInterrupt(e);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123; <span class="comment">// å¦‚æœæ²¡æœ‰æ‹¦æˆªå™¨ å°±é€šè¿‡</span></span><br><span class="line">       callback.onContinue(postcard);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line">* Excute interceptor</span><br><span class="line">*</span><br><span class="line">* <span class="doctag">@param</span> index    current interceptor index</span><br><span class="line">* <span class="doctag">@param</span> counter  interceptor counter</span><br><span class="line">* <span class="doctag">@param</span> postcard routeMeta</span><br><span class="line">*/</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">_excute</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> index, <span class="keyword">final</span> CancelableCountDownLatch counter, <span class="keyword">final</span> Postcard postcard)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (index &lt; Warehouse.interceptors.size()) &#123;</span><br><span class="line">       IInterceptor iInterceptor = Warehouse.interceptors.get(index);</span><br><span class="line">       iInterceptor.process(postcard, <span class="keyword">new</span> InterceptorCallback() &#123;</span><br><span class="line">           <span class="annotation">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onContinue</span><span class="params">(Postcard postcard)</span> </span>&#123;</span><br><span class="line">               <span class="comment">// Last interceptor excute over with no exception.</span></span><br><span class="line">               counter.countDown();</span><br><span class="line">               <span class="comment">// ä¸€ä¸ªæ‹¦æˆªå™¨æ‰§è¡Œå¥½åï¼Œæ‰§è¡Œä¸‹ä¸€ä¸ª</span></span><br><span class="line">               _excute(index + <span class="number">1</span>, counter, postcard);  <span class="comment">// When counter is down, it will be execute continue ,but index bigger than interceptors size, then U know.</span></span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="annotation">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onInterrupt</span><span class="params">(Throwable exception)</span> </span>&#123;</span><br><span class="line">               <span class="comment">// Last interceptor excute over with fatal exception.</span></span><br><span class="line"></span><br><span class="line">               postcard.setTag(<span class="keyword">null</span> == exception ? <span class="keyword">new</span> HandlerException(<span class="string">"No message."</span>) : exception.getMessage());    <span class="comment">// save the exception message for backup.</span></span><br><span class="line">               <span class="comment">// å¦‚æœå…¶ä¸­ä¸€ä¸ªæ‹¦æˆªå™¨ä¸­æ–­çš„è¯ï¼Œå°±ä¸­æ–­æ•´ä¸ªæµç¨‹</span></span><br><span class="line">               counter.cancel();</span><br><span class="line">               <span class="comment">// Be attention, maybe the thread in callback has been changed,</span></span><br><span class="line">               <span class="comment">// then the catch block(L207) will be invalid.</span></span><br><span class="line">               <span class="comment">// The worst is the thread changed to main thread, then the app will be crash, if you throw this exception!</span></span><br><span class="line"><span class="comment">//                    if (!Looper.getMainLooper().equals(Looper.myLooper())) &#123;    // You shouldn't throw the exception if the thread is main thread.</span></span><br><span class="line"><span class="comment">//                        throw new HandlerException(exception.getMessage());</span></span><br><span class="line"><span class="comment">//                    &#125;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç åŸºæœ¬ä¸Šéƒ½åŠ äº†æ³¨é‡Šäº†ï¼Œè¿™é‡Œå°±ä¸å†å¤šè®²äº†ã€‚</p>
<p>åˆ°è¿™é‡Œæ•´ä¸ª ARouter æ‹¦æˆªå™¨çš„æµç¨‹å°±å·®ä¸å¤šè®²å®Œäº†ï¼Œå¦‚æœè¿˜æœ‰å“ªé‡Œä¸æ‡‚çš„åœ°æ–¹å¯ä»¥åœ¨è¯„è®ºåŒºç•™è¨€ã€‚</p>
<p>å†è§ğŸ‘‹</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>arouter-api version : 1.4.1</p>
<h1 id="u524D_u8A00"><a href="#u524D_u8A00" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å‰å‡ å¤©å¯¹ ARouter çš„é¡µé¢è·³]]>
    </summary>
    
      <category term="Android" scheme="http://yuqirong.me/tags/Android/"/>
    
      <category term="å¼€æºæ¡†æ¶" scheme="http://yuqirong.me/tags/%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/"/>
    
      <category term="æºç è§£æ" scheme="http://yuqirong.me/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    
      <category term="Android Blog" scheme="http://yuqirong.me/categories/Android-Blog/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[ARouteræºç è§£æï¼ˆä¸€ï¼‰]]></title>
    <link href="http://yuqirong.me/2018/12/24/ARouter%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%88%E4%B8%80%EF%BC%89/"/>
    <id>http://yuqirong.me/2018/12/24/ARouteræºç è§£æï¼ˆä¸€ï¼‰/</id>
    <published>2018-12-24T13:13:20.000Z</published>
    <updated>2019-01-03T13:44:30.485Z</updated>
    <content type="html"><![CDATA[<p>arouter-api version : 1.4.1</p>
<h1 id="u524D_u8A00"><a href="#u524D_u8A00" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ä¹‹å‰å¯¹ ActivityRouter çš„æºç åšäº†ä¸€æ¬¡åˆ†æï¼Œç›¸ä¿¡å¤§å®¶å¯¹è·¯ç”±æ¡†æ¶å·²ç»æœ‰ä¸€ä¸ªå¤§æ¦‚çš„ç†è§£äº†ã€‚</p>
<p>è€Œä»Šå¤©ç»™å¤§å®¶åˆ†æä¸€ä¸‹ ARouter ã€‚å¤§å®¶åœ¨é¡¹ç›®ç»„ä»¶åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ç»å¤§å¤šæ•°çš„å¼€å‘è€…éƒ½ä¼šä½¿ç”¨ ARouter æ¥ä½œä¸ºé¡¹ç›®çš„è·¯ç”±æ¡†æ¶ã€‚æ¯•ç«Ÿ ARouter æ˜¯é˜¿é‡Œå‡ºå“ï¼Œä¼˜ç‚¹è‡ªç„¶ä¸å¿…å¤šè¯´äº†ã€‚</p>
<p>æ‰€ä»¥åœ¨å¹³å¸¸ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œä¸ä»…ä»…è¦åšåˆ°ä¼šç”¨ï¼Œè¿˜è¦æ·±å…¥äº†è§£ä¸€ä¸‹ ARouter çš„å†…éƒ¨åŸç†ã€‚</p>
<p>æœ¬æ¬¡ ARouter çš„è§£æåˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š</p>
<ol>
<li>å¯¹ IRouteRoot é¡µé¢è·³è½¬è¿›è¡Œæºç è§£æï¼›</li>
<li>å¯¹ IInterceptorGroup æ‹¦æˆªå™¨è¿›è¡Œæºç è§£æï¼›</li>
<li>å¯¹ @Autowired è‡ªåŠ¨æ³¨å…¥è¿›è¡Œæºç è§£æï¼›</li>
</ol>
<p>æœ¬ç¯‡æ˜¯ ARouter ç³»åˆ—çš„ç¬¬ä¸€ç¯‡ï¼Œä¸‹é¢å°±å¯¹ IRouteRoot é¡µé¢è·³è½¬è¿›è¡Œè¯¦ç»†è§£æã€‚</p>
<h1 id="ARouter__u6E90_u7801"><a href="#ARouter__u6E90_u7801" class="headerlink" title="ARouter æºç "></a>ARouter æºç </h1><p>ä½¿ç”¨ ARouter çš„æ—¶å€™ï¼Œéƒ½éœ€è¦åˆå§‹åŒ–</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (isDebug()) &#123;          </span><br><span class="line">    ARouter.openLog();</span><br><span class="line">    ARouter.openDebug();</span><br><span class="line">&#125;</span><br><span class="line">ARouter.init(mApplication);</span><br></pre></td></tr></table></figure>
<p>æºç åˆ†æçš„å…¥å£ï¼Œå°±åœ¨ ARouter.init é‡Œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Application application)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!hasInit) &#123;</span><br><span class="line">        logger = _ARouter.logger;</span><br><span class="line">        _ARouter.logger.info(Consts.TAG, <span class="string">"ARouter init start."</span>);</span><br><span class="line">        hasInit = _ARouter.init(application);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (hasInit) &#123;</span><br><span class="line">            _ARouter.afterInit();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        _ARouter.logger.info(Consts.TAG, <span class="string">"ARouter init over."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æºç ä¸Šå¯ä»¥çœ‹åˆ°ï¼ŒARouter çš„å†…éƒ¨å…¶å®æ˜¯ _ARouter åœ¨èµ·ä½œç”¨ï¼ŒARouter åªæ˜¯æŠŠ _ARouter å†åšäº†ä¸€å±‚åŒ…è£…ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±è·Ÿè¿› _ARouter çš„ init æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">init</span><span class="params">(Application application)</span> </span>&#123;</span><br><span class="line">    mContext = application;</span><br><span class="line">    LogisticsCenter.init(mContext, executor);</span><br><span class="line">    logger.info(Consts.TAG, <span class="string">"ARouter init success!"</span>);</span><br><span class="line">    hasInit = <span class="keyword">true</span>;</span><br><span class="line">    mHandler = <span class="keyword">new</span> Handler(Looper.getMainLooper());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€é‡è¦çš„ä¸€å¥ä»£ç è¿˜æ˜¯ <code>LogisticsCenter.init(mContext, executor)</code> ï¼Œå…¶ä¸­ executor æ˜¯çº¿ç¨‹æ± ã€‚</p>
<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œ LogisticsCenter æ˜¯å¹²ä»€ä¹ˆçš„å‘¢ï¼Ÿ</p>
<pre><code>* LogisticsCenter contains all of the map.
* 
* 1. Creates instance when it is first used.
* 2. Handler Multi-Module relationship map(*)
* 3. Complex logic to solve duplicate group definition
</code></pre><p>æ ¹æ®å®˜æ–¹çš„æ³¨é‡Šï¼ŒLogisticsCenter æ˜¯åŒ…å«äº†æ‰€æœ‰çš„æ˜ å°„ï¼Œå¤„ç†è·¨æ¨¡å—çš„æ˜ å°„å…³ç³»ä»¥åŠåŒ¹é…è·¯ç”±ç­‰ã€‚</p>
<p>æ‰€ä»¥æ ¹æ®ä¹‹å‰ ActivityRouter çš„ç»éªŒçŒœæµ‹å¾—åˆ°ï¼ŒLogisticsCenter çš„ init æ–¹æ³•é‡Œé¢ï¼Œè‚¯å®šä¼šå»åŠ è½½è·¯ç”±ï¼Œå¹¶å»ºç«‹å…³ç³»ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Context context, ThreadPoolExecutor tpe)</span> <span class="keyword">throws</span> HandlerException </span>&#123;</span><br><span class="line">    mContext = context;</span><br><span class="line">    executor = tpe;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">long</span> startInit = System.currentTimeMillis();</span><br><span class="line">        <span class="comment">//billy.qi modified at 2017-12-06</span></span><br><span class="line">        <span class="comment">//load by plugin first</span></span><br><span class="line">        loadRouterMap();</span><br><span class="line">        <span class="keyword">if</span> (registerByPlugin) &#123;</span><br><span class="line">            logger.info(TAG, <span class="string">"Load router map by arouter-auto-register plugin."</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Set&lt;String&gt; routerMap;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å¦‚æœæ˜¯debugæˆ–è€…æ–°ç‰ˆæœ¬çš„è¯ï¼Œä¼šå»é‡æ–°åŠ è½½è·¯ç”±æ˜ å°„</span></span><br><span class="line">            <span class="keyword">if</span> (ARouter.debuggable() || PackageUtils.isNewVersion(context)) &#123;</span><br><span class="line">                logger.info(TAG, <span class="string">"Run with debug mode or new install, rebuild router map."</span>);</span><br><span class="line">                <span class="comment">// åŠ è½½è·¯ç”±æ˜ å°„</span></span><br><span class="line">                routerMap = ClassUtils.getFileNameByPackageName(mContext, ROUTE_ROOT_PAKCAGE);</span><br><span class="line">                <span class="comment">// ä¿å­˜æ‰€æœ‰çš„è·¯ç”±æ˜ å°„åˆ° SharedPreferences</span></span><br><span class="line">                <span class="keyword">if</span> (!routerMap.isEmpty()) &#123;</span><br><span class="line">                    context.getSharedPreferences(AROUTER_SP_CACHE_KEY, Context.MODE_PRIVATE).edit().putStringSet(AROUTER_SP_KEY_MAP, routerMap).apply();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// ä¿å­˜æ–°ç‰ˆæœ¬å·åˆ° sharedpreference</span></span><br><span class="line">                PackageUtils.updateVersion(context);    <span class="comment">// Save new version name when router map update finishes.</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// å¦åˆ™å°±ä» SharedPreferences ä¸­è¯»å–ä¹‹å‰ä¿å­˜çš„æ‰€æœ‰è·¯ç”±æ˜ å°„</span></span><br><span class="line">                logger.info(TAG, <span class="string">"Load router map from cache."</span>);</span><br><span class="line">                routerMap = <span class="keyword">new</span> HashSet&lt;&gt;(context.getSharedPreferences(AROUTER_SP_CACHE_KEY, Context.MODE_PRIVATE).getStringSet(AROUTER_SP_KEY_MAP, <span class="keyword">new</span> HashSet&lt;String&gt;()));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            logger.info(TAG, <span class="string">"Find router map finished, map size = "</span> + routerMap.size() + <span class="string">", cost "</span> + (System.currentTimeMillis() - startInit) + <span class="string">" ms."</span>);</span><br><span class="line">            startInit = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æŠŠä¸Šé¢åŠ è½½å¾—åˆ°çš„è·¯ç”±æ˜ å°„æ ¹æ®ClassNameåˆ†ä¸ºä¸‰ç§ï¼Œåˆ†åˆ«è¿›è¡Œæ³¨å†Œ</span></span><br><span class="line">            <span class="comment">// IRouteRoot é¡µé¢è·³è½¬</span></span><br><span class="line">            <span class="comment">// IInterceptorGroup æ‹¦æˆªå™¨</span></span><br><span class="line">            <span class="comment">// IProviderGroup æœåŠ¡ç»„ä»¶</span></span><br><span class="line">            <span class="keyword">for</span> (String className : routerMap) &#123;</span><br><span class="line">                <span class="keyword">if</span> (className.startsWith(ROUTE_ROOT_PAKCAGE + DOT + SDK_NAME + SEPARATOR + SUFFIX_ROOT)) &#123;</span><br><span class="line">                    <span class="comment">// This one of root elements, load root.</span></span><br><span class="line">                    ((IRouteRoot) (Class.forName(className).getConstructor().newInstance())).loadInto(Warehouse.groupsIndex);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className.startsWith(ROUTE_ROOT_PAKCAGE + DOT + SDK_NAME + SEPARATOR + SUFFIX_INTERCEPTORS)) &#123;</span><br><span class="line">                    <span class="comment">// Load interceptorMeta</span></span><br><span class="line">                    ((IInterceptorGroup) (Class.forName(className).getConstructor().newInstance())).loadInto(Warehouse.interceptorsIndex);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className.startsWith(ROUTE_ROOT_PAKCAGE + DOT + SDK_NAME + SEPARATOR + SUFFIX_PROVIDERS)) &#123;</span><br><span class="line">                    <span class="comment">// Load providerIndex</span></span><br><span class="line">                    ((IProviderGroup) (Class.forName(className).getConstructor().newInstance())).loadInto(Warehouse.providersIndex);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> HandlerException(TAG + <span class="string">"ARouter init logistics center exception! ["</span> + e.getMessage() + <span class="string">"]"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>LogisticsCenter çš„ init æ–¹æ³•çš„ä»£ç åŸºæœ¬ä¸Šéƒ½å¯ä»¥çœ‹å¾—æ‡‚ï¼Œå…¶ä¸­ <code>ClassUtils.getFileNameByPackageName</code> æ˜¯æˆ‘ä»¬å€¼å¾—æ¢ç©¶çš„åœ°æ–¹ã€‚è¿™å¥ä»£ç ä¸»è¦åšçš„äº‹æƒ…å°±æ˜¯ä» dex ä¸­éå† class æ‰¾åˆ° arouter-compiler ç”Ÿæˆçš„ç±»é›†åˆã€‚å…·ä½“çš„åˆ†ææˆ‘ä»¬åˆ°æœ€åé¢å†è®²ï¼Œè¿™é‡Œå…ˆåŸ‹ä¸ªä¼ç¬”ã€‚</p>
<p>æ¥ç€å¾€ä¸‹çœ‹ï¼Œæˆ‘ä»¬çŸ¥é“ï¼ŒrouterMap ä¸­çš„ className éƒ½æ˜¯ arouter-compiler åœ¨ç¼–è¯‘æœŸç”Ÿæˆçš„ï¼Œé‚£æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ç”Ÿæˆçš„ç±»é•¿ä»€ä¹ˆæ ·</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * DO NOT EDIT THIS FILE!!! IT WAS GENERATED BY AROUTER. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ARouter</span>$$<span class="title">Root</span>$$<span class="title">app</span> <span class="keyword">implements</span> <span class="title">IRouteRoot</span> </span>&#123;</span><br><span class="line">  <span class="annotation">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadInto</span><span class="params">(Map&lt;String, Class&lt;? extends IRouteGroup&gt;&gt; routes)</span> </span>&#123;</span><br><span class="line">    routes.put(<span class="string">"test"</span>, ARouter$$Group$$test.class);</span><br><span class="line">    routes.put(<span class="string">"yourservicegroupname"</span>, ARouter$$Group$$yourservicegroupname.class);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ARouter çš„è·¯ç”±ä¼šåˆ†ç»„åŠ è½½ï¼Œæ¯”å¦‚å½“å‰æœ‰ /test/abc å’Œ /test/def ä¸¤ä¸ªè·¯ç”±ï¼Œé‚£ä»–ä»¬åŒå±äº /test è¿™ä¸ªç»„ã€‚æ‰€ä»¥åœ¨ Warehouse.groupsIndex ä¸­å­˜æ”¾çš„ key æ˜¯è·¯ç”±ç»„åï¼Œvalue æ˜¯å¯¹åº”ç»„è·¯ç”±ç±»ã€‚æŸ¥æ‰¾è·¯ç”±çš„æ—¶å€™ä¹Ÿæ˜¯æ ¹æ®ç»„å key ï¼Œå†æ‰¾åˆ°ç»„è·¯ç”±ç±» value ä¸­æŸ¥æ‰¾åŒ¹é…çš„è·¯ç”±ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * DO NOT EDIT THIS FILE!!! IT WAS GENERATED BY AROUTER. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ARouter</span>$$<span class="title">Group</span>$$<span class="title">test</span> <span class="keyword">implements</span> <span class="title">IRouteGroup</span> </span>&#123;</span><br><span class="line">  <span class="annotation">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadInto</span><span class="params">(Map&lt;String, RouteMeta&gt; atlas)</span> </span>&#123;</span><br><span class="line">    atlas.put(<span class="string">"/test/activity1"</span>, RouteMeta.build(RouteType.ACTIVITY, Test1Activity.class, <span class="string">"/test/activity1"</span>, <span class="string">"test"</span>, <span class="keyword">new</span> java.util.HashMap&lt;String, Integer&gt;()&#123;&#123;put(<span class="string">"ser"</span>, <span class="number">9</span>); put(<span class="string">"ch"</span>, <span class="number">5</span>); put(<span class="string">"fl"</span>, <span class="number">6</span>); put(<span class="string">"dou"</span>, <span class="number">7</span>); put(<span class="string">"boy"</span>, <span class="number">0</span>); put(<span class="string">"url"</span>, <span class="number">8</span>); put(<span class="string">"pac"</span>, <span class="number">10</span>); put(<span class="string">"obj"</span>, <span class="number">11</span>); put(<span class="string">"name"</span>, <span class="number">8</span>); put(<span class="string">"objList"</span>, <span class="number">11</span>); put(<span class="string">"map"</span>, <span class="number">11</span>); put(<span class="string">"age"</span>, <span class="number">3</span>); put(<span class="string">"height"</span>, <span class="number">3</span>); &#125;&#125;, -<span class="number">1</span>, -<span class="number">2147483648</span>));</span><br><span class="line">    atlas.put(<span class="string">"/test/activity2"</span>, RouteMeta.build(RouteType.ACTIVITY, Test2Activity.class, <span class="string">"/test/activity2"</span>, <span class="string">"test"</span>, <span class="keyword">new</span> java.util.HashMap&lt;String, Integer&gt;()&#123;&#123;put(<span class="string">"key1"</span>, <span class="number">8</span>); &#125;&#125;, -<span class="number">1</span>, -<span class="number">2147483648</span>));</span><br><span class="line">    atlas.put(<span class="string">"/test/activity3"</span>, RouteMeta.build(RouteType.ACTIVITY, Test3Activity.class, <span class="string">"/test/activity3"</span>, <span class="string">"test"</span>, <span class="keyword">new</span> java.util.HashMap&lt;String, Integer&gt;()&#123;&#123;put(<span class="string">"name"</span>, <span class="number">8</span>); put(<span class="string">"boy"</span>, <span class="number">0</span>); put(<span class="string">"age"</span>, <span class="number">3</span>); &#125;&#125;, -<span class="number">1</span>, -<span class="number">2147483648</span>));</span><br><span class="line">    atlas.put(<span class="string">"/test/activity4"</span>, RouteMeta.build(RouteType.ACTIVITY, Test4Activity.class, <span class="string">"/test/activity4"</span>, <span class="string">"test"</span>, <span class="keyword">null</span>, -<span class="number">1</span>, -<span class="number">2147483648</span>));</span><br><span class="line">    atlas.put(<span class="string">"/test/fragment"</span>, RouteMeta.build(RouteType.FRAGMENT, BlankFragment.class, <span class="string">"/test/fragment"</span>, <span class="string">"test"</span>, <span class="keyword">null</span>, -<span class="number">1</span>, -<span class="number">2147483648</span>));</span><br><span class="line">    atlas.put(<span class="string">"/test/webview"</span>, RouteMeta.build(RouteType.ACTIVITY, TestWebview.class, <span class="string">"/test/webview"</span>, <span class="string">"test"</span>, <span class="keyword">null</span>, -<span class="number">1</span>, -<span class="number">2147483648</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°è·¯ç”±ç›¸å…³çš„å‚æ•°é…ç½®è¢«æ„é€ æˆäº†ä¸€ä¸ª RouteMeta å¯¹è±¡ã€‚RouteMeta ç±»å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RouteMeta</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> RouteType type;         <span class="comment">// Type of route</span></span><br><span class="line">    <span class="keyword">private</span> Element rawType;        <span class="comment">// Raw type of route</span></span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt; destination;   <span class="comment">// Destination</span></span><br><span class="line">    <span class="keyword">private</span> String path;            <span class="comment">// Path of route</span></span><br><span class="line">    <span class="keyword">private</span> String group;           <span class="comment">// Group of route</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> priority = -<span class="number">1</span>;      <span class="comment">// The smaller the number, the higher the priority</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> extra;              <span class="comment">// Extra data</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Integer&gt; paramsType;  <span class="comment">// Param type</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Autowired&gt; injectConfig;  <span class="comment">// Cache inject config.</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ°è¿™é‡Œï¼ŒåŠ è½½è·¯ç”±çš„éƒ¨åˆ†å°±å®Œæˆäº†ï¼Œå‰©ä¸‹çš„å°±æ˜¯è·³è½¬è·¯ç”±äº†ã€‚</p>
<p>è·³è½¬è·¯ç”±çš„é€šå¸¸æ“ä½œï¼š</p>
<pre><code>ARouter.getInstance().build(&quot;/test/abc&quot;).navigation();
</code></pre><p>é‚£å…ˆçœ‹ä¸€ä¸‹ ARouter çš„ build æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> Postcard <span class="title">build</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> _ARouter.getInstance().build(path);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‡Œé¢è°ƒç”¨çš„æ˜¯ _ARouter çš„ build æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Postcard <span class="title">build</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (TextUtils.isEmpty(path)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> HandlerException(Consts.TAG + <span class="string">"Parameter is invalid!"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// è·å– PathReplaceService å®ä¾‹ï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œå°±å¤„ç† path</span></span><br><span class="line">        PathReplaceService pService = ARouter.getInstance().navigation(PathReplaceService.class);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != pService) &#123;</span><br><span class="line">            path = pService.forString(path);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> build(path, extractGroup(path));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * æˆªå–è·³è½¬è·¯å¾„ä¸­çš„ç¬¬ä¸€æ®µä½œä¸ºåˆ†ç»„å</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">extractGroup</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (TextUtils.isEmpty(path) || !path.startsWith(<span class="string">"/"</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> HandlerException(Consts.TAG + <span class="string">"Extract the default group failed, the path must be start with '/' and contain more than 2 '/'!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String defaultGroup = path.substring(<span class="number">1</span>, path.indexOf(<span class="string">"/"</span>, <span class="number">1</span>));</span><br><span class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(defaultGroup)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> HandlerException(Consts.TAG + <span class="string">"Extract the default group failed! There's nothing between 2 '/'!"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> defaultGroup;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        logger.warning(Consts.TAG, <span class="string">"Failed to extract default group! "</span> + e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PathReplaceService æ˜¯å®˜æ–¹ç»™æˆ‘ä»¬é¢„ç•™çš„å£å­ï¼Œç”¨æ¥å¯¹ path åšé¢„å¤„ç†ã€‚å¦‚æœä½ æœ‰éœ€æ±‚æ¥å¯¹ path åšç»Ÿä¸€çš„é¢„å¤„ç†ï¼Œé‚£ä¹ˆç›´æ¥å®ç° PathReplaceService å³å¯ã€‚</p>
<p>æˆ‘ä»¬æ¥ç€è·Ÿè¿›ï¼Œçœ‹ä¸‹ <code>_ARouter.build(String path, String group)</code> æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Postcard <span class="title">build</span><span class="params">(String path, String group)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (TextUtils.isEmpty(path) || TextUtils.isEmpty(group)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> HandlerException(Consts.TAG + <span class="string">"Parameter is invalid!"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        PathReplaceService pService = ARouter.getInstance().navigation(PathReplaceService.class);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != pService) &#123;</span><br><span class="line">            path = pService.forString(path);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Postcard(path, group);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‘ç°åœ¨ <code>build(String path, String group)</code> ä¸­ç›´æ¥åˆ›å»ºäº†ä¸€ä¸ª Postcard å¯¹è±¡å¹¶è¿”å›ã€‚Postcard ç±»æ˜¯ç»§æ‰¿äº† RouteMeta ï¼Œé¢å¤–æ·»åŠ äº†ä¸€äº›å…¶ä»–çš„ä¿¡æ¯ã€‚</p>
<p>æœ‰äº† Postcard ä¹‹åï¼Œç›´æ¥è°ƒç”¨ navigation è¿›è¡Œè·³è½¬ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">navigation</span><span class="params">(Context context, NavigationCallback callback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ARouter.getInstance().navigation(context, <span class="keyword">this</span>, -<span class="number">1</span>, callback);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">navigation</span><span class="params">(Activity mContext, <span class="keyword">int</span> requestCode, NavigationCallback callback)</span> </span>&#123;</span><br><span class="line">    ARouter.getInstance().navigation(mContext, <span class="keyword">this</span>, requestCode, callback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Postcard çš„æ‰€æœ‰ navigation æ–¹æ³•æœ€åéƒ½ä¼šè°ƒç”¨ ARouter çš„ navigation è¿™ä¸ªæ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">navigation</span><span class="params">(Context mContext, Postcard postcard, <span class="keyword">int</span> requestCode, NavigationCallback callback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> _ARouter.getInstance().navigation(mContext, postcard, requestCode, callback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€åè¿˜æ˜¯è°ƒç”¨äº† _ARouter.navigation </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">navigation</span><span class="params">(<span class="keyword">final</span> Context context, <span class="keyword">final</span> Postcard postcard, <span class="keyword">final</span> <span class="keyword">int</span> requestCode, <span class="keyword">final</span> NavigationCallback callback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// å°† postcard ä¸è·¯ç”±è¡¨ä¸­è¿›è¡ŒåŒ¹é…ï¼Œå¹¶ä¸”å¡«å…… postcard çš„æ•°æ®</span></span><br><span class="line">        LogisticsCenter.completion(postcard);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoRouteFoundException ex) &#123;</span><br><span class="line">        logger.warning(Consts.TAG, ex.getMessage());</span><br><span class="line">        <span class="comment">// å¦‚æœ debug ï¼Œå°±æ˜¾ç¤ºåŒ¹é…é”™è¯¯</span></span><br><span class="line">        <span class="keyword">if</span> (debuggable()) &#123;</span><br><span class="line">            <span class="comment">// Show friendly tips for user.</span></span><br><span class="line">            runInMainThread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="annotation">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    Toast.makeText(mContext, <span class="string">"There's no route matched!\n"</span> +</span><br><span class="line">                            <span class="string">" Path = ["</span> + postcard.getPath() + <span class="string">"]\n"</span> +</span><br><span class="line">                            <span class="string">" Group = ["</span> + postcard.getGroup() + <span class="string">"]"</span>, Toast.LENGTH_LONG).show();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å›è°ƒè·¯ç”±åŒ¹é…å¤±è´¥</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != callback) &#123;</span><br><span class="line">            callback.onLost(postcard);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;    </span><br><span class="line">            <span class="comment">// No callback for this invoke, then we use the global degrade service.</span></span><br><span class="line">            <span class="comment">// å¦‚æœæ²¡æœ‰å›è°ƒï¼Œå°±è°ƒç”¨å…¨å±€é™çº§çš„ç­–ç•¥</span></span><br><span class="line">            DegradeService degradeService = ARouter.getInstance().navigation(DegradeService.class);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != degradeService) &#123;</span><br><span class="line">                degradeService.onLost(context, postcard);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å›è°ƒè·¯ç”±åŒ¹é…æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != callback) &#123;</span><br><span class="line">        callback.onFound(postcard);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœä¸æ˜¯ç»¿è‰²é€šé“ï¼Œå°±è°ƒç”¨æ‹¦æˆªå™¨ï¼Œæ‹¦æˆªå™¨è¿™éƒ¨åˆ†åé¢å•ç‹¬å‡ºæ¥è®²ï¼Œè¿™é‡Œå°±ä¸è®²äº†</span></span><br><span class="line">    <span class="keyword">if</span> (!postcard.isGreenChannel()) &#123;   <span class="comment">// It must be run in async thread, maybe interceptor cost too mush time made ANR.</span></span><br><span class="line">        interceptorService.doInterceptions(postcard, <span class="keyword">new</span> InterceptorCallback() &#123;</span><br><span class="line">            <span class="comment">/**</span><br><span class="line">             * Continue process</span><br><span class="line">             *</span><br><span class="line">             * <span class="doctag">@param</span> postcard route meta</span><br><span class="line">             */</span></span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onContinue</span><span class="params">(Postcard postcard)</span> </span>&#123;</span><br><span class="line">                _navigation(context, postcard, requestCode, callback);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span><br><span class="line">             * Interrupt process, pipeline will be destory when this method called.</span><br><span class="line">             *</span><br><span class="line">             * <span class="doctag">@param</span> exception Reson of interrupt.</span><br><span class="line">             */</span></span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onInterrupt</span><span class="params">(Throwable exception)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> != callback) &#123;</span><br><span class="line">                    callback.onInterrupt(postcard);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                logger.info(Consts.TAG, <span class="string">"Navigation failed, termination by interceptor : "</span> + exception.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å¦åˆ™è°ƒç”¨ _navigation è¿›è¡Œè·³è½¬</span></span><br><span class="line">        <span class="keyword">return</span> _navigation(context, postcard, requestCode, callback);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">_navigation</span><span class="params">(<span class="keyword">final</span> Context context, <span class="keyword">final</span> Postcard postcard, <span class="keyword">final</span> <span class="keyword">int</span> requestCode, <span class="keyword">final</span> NavigationCallback callback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Context currentContext = <span class="keyword">null</span> == context ? mContext : context;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (postcard.getType()) &#123;</span><br><span class="line">        <span class="keyword">case</span> ACTIVITY: <span class="comment">// å¦‚æœæ˜¯ activity çš„ï¼Œæ‰§è¡Œè·³è½¬</span></span><br><span class="line">            <span class="comment">// Build intent</span></span><br><span class="line">            <span class="keyword">final</span> Intent intent = <span class="keyword">new</span> Intent(currentContext, postcard.getDestination());</span><br><span class="line">            intent.putExtras(postcard.getExtras());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Set flags.</span></span><br><span class="line">            <span class="keyword">int</span> flags = postcard.getFlags();</span><br><span class="line">            <span class="keyword">if</span> (-<span class="number">1</span> != flags) &#123;</span><br><span class="line">                intent.setFlags(flags);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(currentContext <span class="keyword">instanceof</span> Activity)) &#123;    <span class="comment">// Non activity, need less one flag.</span></span><br><span class="line">                intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Set Actions</span></span><br><span class="line">            String action = postcard.getAction();</span><br><span class="line">            <span class="keyword">if</span> (!TextUtils.isEmpty(action)) &#123;</span><br><span class="line">                intent.setAction(action);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Navigation in main looper.</span></span><br><span class="line">            runInMainThread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="annotation">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    startActivity(requestCode, currentContext, intent, postcard, callback);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> PROVIDER: <span class="comment">// å¦‚æœæ˜¯æœåŠ¡ç»„ä»¶ï¼Œé‚£ä¹ˆç›´æ¥è¿”å›è¯¥ç»„ä»¶</span></span><br><span class="line">            <span class="keyword">return</span> postcard.getProvider();</span><br><span class="line">        <span class="keyword">case</span> BOARDCAST:</span><br><span class="line">        <span class="keyword">case</span> CONTENT_PROVIDER:</span><br><span class="line">        <span class="keyword">case</span> FRAGMENT: <span class="comment">// å¦‚æœæ˜¯ fragment çš„è¯ï¼Œè¿”å›è¯¥ fragment çš„å®ä¾‹</span></span><br><span class="line">            Class fragmentMeta = postcard.getDestination();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Object instance = fragmentMeta.getConstructor().newInstance();</span><br><span class="line">                <span class="keyword">if</span> (instance <span class="keyword">instanceof</span> Fragment) &#123;</span><br><span class="line">                    ((Fragment) instance).setArguments(postcard.getExtras());</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (instance <span class="keyword">instanceof</span> android.support.v4.app.Fragment) &#123;</span><br><span class="line">                    ((android.support.v4.app.Fragment) instance).setArguments(postcard.getExtras());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> instance;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                logger.error(Consts.TAG, <span class="string">"Fetch fragment instance error, "</span> + TextUtils.formatStackTrace(ex.getStackTrace()));</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">case</span> METHOD:</span><br><span class="line">        <span class="keyword">case</span> SERVICE:</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç åŸºæœ¬ä¸Šéƒ½å†™äº†æ³¨é‡Šï¼Œå¤§å®¶åº”è¯¥éƒ½èƒ½çœ‹æ‡‚ã€‚</p>
<p>æˆ‘ä»¬é‡ç‚¹æ¥å…³æ³¨ä¸‹ <code>LogisticsCenter.completion(postcard);</code> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">completion</span><span class="params">(Postcard postcard)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == postcard) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NoRouteFoundException(TAG + <span class="string">"No postcard!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å…ˆæ ¹æ® path å»è·å– RouteMeta</span></span><br><span class="line">    RouteMeta routeMeta = Warehouse.routes.get(postcard.getPath());</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == routeMeta) &#123;    <span class="comment">// å¦‚æœ routeMeta ä¸ºç©ºï¼Œå¯èƒ½æ˜¯ä¸å­˜åœ¨æˆ–è€…æ˜¯æœªåŠ è½½</span></span><br><span class="line">        Class&lt;? extends IRouteGroup&gt; groupMeta = Warehouse.groupsIndex.get(postcard.getGroup());  <span class="comment">// åŠ è½½åˆ†ç»„ä¸‹çš„è·¯ç”±æ˜ å°„</span></span><br><span class="line">        <span class="comment">// å¦‚æœä¸å­˜åœ¨ï¼Œå°±æŠ¥é”™</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == groupMeta) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoRouteFoundException(TAG + <span class="string">"There is no route match the path ["</span> + postcard.getPath() + <span class="string">"], in group ["</span> + postcard.getGroup() + <span class="string">"]"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Load route and cache it into memory, then delete from metas.</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (ARouter.debuggable()) &#123;</span><br><span class="line">                    logger.debug(TAG, String.format(Locale.getDefault(), <span class="string">"The group [%s] starts loading, trigger by [%s]"</span>, postcard.getGroup(), postcard.getPath()));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// å®ç°æŒ‰éœ€åŠ è½½</span></span><br><span class="line">                IRouteGroup iGroupInstance = groupMeta.getConstructor().newInstance();</span><br><span class="line">                iGroupInstance.loadInto(Warehouse.routes);</span><br><span class="line">                <span class="comment">// ç§»é™¤ groupsIndex , å¦åˆ™ä¼šé€ æˆæ­»å¾ªç¯</span></span><br><span class="line">                Warehouse.groupsIndex.remove(postcard.getGroup());</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ARouter.debuggable()) &#123;</span><br><span class="line">                    logger.debug(TAG, String.format(Locale.getDefault(), <span class="string">"The group [%s] has already been loaded, trigger by [%s]"</span>, postcard.getGroup(), postcard.getPath()));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> HandlerException(TAG + <span class="string">"Fatal exception when loading group meta. ["</span> + e.getMessage() + <span class="string">"]"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// é‡æ–°åŠ è½½ä¸€é</span></span><br><span class="line">            completion(postcard);   <span class="comment">// Reload</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// æ‰¾åˆ°å¯¹åº”çš„ routeMetaï¼Œ å¡«å…… postcard æ•°æ®</span></span><br><span class="line">        postcard.setDestination(routeMeta.getDestination());</span><br><span class="line">        postcard.setType(routeMeta.getType());</span><br><span class="line">        postcard.setPriority(routeMeta.getPriority());</span><br><span class="line">        postcard.setExtra(routeMeta.getExtra());</span><br><span class="line"></span><br><span class="line">        Uri rawUri = postcard.getUri();</span><br><span class="line">        <span class="comment">// å¦‚æœ rawUri ä¸ä¸ºç©ºï¼Œåˆ™æ˜¯ uri è·³è½¬ã€‚å°±è§£æ rawUri ä¸­çš„å‚æ•°ï¼Œæ”¾å…¥ bundle ä¸­</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != rawUri) &#123;   <span class="comment">// Try to set params into bundle.</span></span><br><span class="line">            Map&lt;String, String&gt; resultMap = TextUtils.splitQueryParameters(rawUri);</span><br><span class="line">            Map&lt;String, Integer&gt; paramsType = routeMeta.getParamsType();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (MapUtils.isNotEmpty(paramsType)) &#123;</span><br><span class="line">                <span class="comment">// Set value by its type, just for params which annotation by @Param</span></span><br><span class="line">                <span class="keyword">for</span> (Map.Entry&lt;String, Integer&gt; params : paramsType.entrySet()) &#123;</span><br><span class="line">                    setValue(postcard,</span><br><span class="line">                            params.getValue(),</span><br><span class="line">                            params.getKey(),</span><br><span class="line">                            resultMap.get(params.getKey()));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Save params name which need auto inject.</span></span><br><span class="line">                postcard.getExtras().putStringArray(ARouter.AUTO_INJECT, paramsType.keySet().toArray(<span class="keyword">new</span> String[]&#123;&#125;));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Save raw uri</span></span><br><span class="line">            postcard.withString(ARouter.RAW_URI, rawUri.toString());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯ PROVIDER å’Œ FRAGMENT ç±»å‹çš„ï¼Œå¼€å¯ç»¿è‰²é€šé“</span></span><br><span class="line">        <span class="keyword">switch</span> (routeMeta.getType()) &#123;</span><br><span class="line">            <span class="keyword">case</span> PROVIDER:  <span class="comment">// if the route is provider, should find its instance</span></span><br><span class="line">                <span class="comment">// Its provider, so it must implement IProvider</span></span><br><span class="line">                Class&lt;? extends IProvider&gt; providerMeta = (Class&lt;? extends IProvider&gt;) routeMeta.getDestination();</span><br><span class="line">                IProvider instance = Warehouse.providers.get(providerMeta);</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> == instance) &#123; <span class="comment">// There's no instance of this provider</span></span><br><span class="line">                    IProvider provider;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        provider = providerMeta.getConstructor().newInstance();</span><br><span class="line">                        provider.init(mContext);</span><br><span class="line">                        Warehouse.providers.put(providerMeta, provider);</span><br><span class="line">                        instance = provider;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> HandlerException(<span class="string">"Init provider failed! "</span> + e.getMessage());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                postcard.setProvider(instance);</span><br><span class="line">                postcard.greenChannel();    <span class="comment">// Provider should skip all of interceptors</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FRAGMENT:</span><br><span class="line">                postcard.greenChannel();    <span class="comment">// Fragment needn't interceptors</span></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è‡³æ­¤ï¼Œæ•´ä¸ªè·¯ç”±è·³è½¬çš„æµç¨‹å°±è®²å®Œäº†ï¼Œå¤§è‡´çš„æµç¨‹å¯ä»¥åˆ†ä¸º</p>
<ol>
<li>åŠ è½½è·¯ç”±æ˜ å°„</li>
<li>æ ¹æ® path æ„é€ å‡º Postcard å¯¹è±¡</li>
<li>åŒºåˆ† Postcard çš„ type æ¥å®ç°è·³è½¬</li>
</ol>
<h1 id="u756A_u5916"><a href="#u756A_u5916" class="headerlink" title="ç•ªå¤–"></a>ç•ªå¤–</h1><p>å‰é¢è¯´è¿‡ï¼ŒARouter ä¼šåœ¨ dex ä¸­å¯»æ‰¾ arouter-compiler ç”Ÿæˆçš„ç±»ã€‚é‚£æˆ‘ä»¬æœ€åæ¥çœ‹çœ‹æ˜¯æ€ä¹ˆå®ç°çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Set&lt;String&gt; <span class="title">getFileNameByPackageName</span><span class="params">(Context context, <span class="keyword">final</span> String packageName)</span> <span class="keyword">throws</span> PackageManager.NameNotFoundException, IOException, InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Set&lt;String&gt; classNames = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">    <span class="comment">// è·å– dex æ–‡ä»¶å­˜æ”¾çš„è·¯å¾„</span></span><br><span class="line">    List&lt;String&gt; paths = getSourcePaths(context);</span><br><span class="line">    <span class="keyword">final</span> CountDownLatch parserCtl = <span class="keyword">new</span> CountDownLatch(paths.size());</span><br><span class="line">    <span class="comment">// éå†æ‰€æœ‰ dex æ–‡ä»¶çš„è·¯å¾„</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">final</span> String path : paths) &#123;</span><br><span class="line">        DefaultPoolExecutor.getInstance().execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                DexFile dexfile = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// æ ¹æ®è·¯å¾„åŠ è½½ dex æ–‡ä»¶</span></span><br><span class="line">                    <span class="keyword">if</span> (path.endsWith(EXTRACTED_SUFFIX)) &#123;</span><br><span class="line">                        <span class="comment">//NOT use new DexFile(path), because it will throw "permission error in /data/dalvik-cache"</span></span><br><span class="line">                        dexfile = DexFile.loadDex(path, path + <span class="string">".tmp"</span>, <span class="number">0</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        dexfile = <span class="keyword">new</span> DexFile(path);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// éå† dexfile çš„ä¸­æ‰€æœ‰ className å¦‚æœæ˜¯ arouter æŠ¥åå¼€å¤´çš„ï¼Œå°±åŠ å…¥åˆ° classNames ä¸­</span></span><br><span class="line">                    Enumeration&lt;String&gt; dexEntries = dexfile.entries();</span><br><span class="line">                    <span class="keyword">while</span> (dexEntries.hasMoreElements()) &#123;</span><br><span class="line">                        String className = dexEntries.nextElement();</span><br><span class="line">                        <span class="keyword">if</span> (className.startsWith(packageName)) &#123;</span><br><span class="line">                            classNames.add(className);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable ignore) &#123;</span><br><span class="line">                    Log.e(<span class="string">"ARouter"</span>, <span class="string">"Scan map file in dex files made error."</span>, ignore);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">null</span> != dexfile) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            dexfile.close();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Throwable ignore) &#123;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    parserCtl.countDown();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    parserCtl.await();</span><br><span class="line"></span><br><span class="line">    Log.d(Consts.TAG, <span class="string">"Filter "</span> + classNames.size() + <span class="string">" classes by packageName &lt;"</span> + packageName + <span class="string">"&gt;"</span>);</span><br><span class="line">    <span class="keyword">return</span> classNames;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å†æ¥çœ‹ä¸‹ getSourcePaths æ–¹æ³•ï¼Œçœ‹çœ‹å®ƒæ˜¯æ€ä¹ˆæ‰¾ dex æ–‡ä»¶è·¯å¾„çš„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">getSourcePaths</span><span class="params">(Context context)</span> <span class="keyword">throws</span> PackageManager.NameNotFoundException, IOException </span>&#123;</span><br><span class="line">        ApplicationInfo applicationInfo = context.getPackageManager().getApplicationInfo(context.getPackageName(), <span class="number">0</span>);</span><br><span class="line">        File sourceApk = <span class="keyword">new</span> File(applicationInfo.sourceDir);</span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; sourcePaths = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        sourcePaths.add(applicationInfo.sourceDir); <span class="comment">//add the default apk path</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//the prefix of extracted file, ie: test.classes</span></span><br><span class="line">        String extractedFilePrefix = sourceApk.getName() + EXTRACTED_NAME_EXT;</span><br><span class="line"></span><br><span class="line"><span class="comment">//        å¦‚æœVMå·²ç»æ”¯æŒäº†MultiDexï¼Œå°±ä¸è¦å»Secondary FolderåŠ è½½ Classesx.zipäº†ï¼Œé‚£é‡Œå·²ç»ä¹ˆæœ‰äº†</span></span><br><span class="line"><span class="comment">//        é€šè¿‡æ˜¯å¦å­˜åœ¨spä¸­çš„multidex.versionæ˜¯ä¸å‡†ç¡®çš„ï¼Œå› ä¸ºä»ä½ç‰ˆæœ¬å‡çº§ä¸Šæ¥çš„ç”¨æˆ·ï¼Œæ˜¯åŒ…å«è¿™ä¸ªspé…ç½®çš„</span></span><br><span class="line">        <span class="keyword">if</span> (!isVMMultidexCapable()) &#123;</span><br><span class="line">            <span class="comment">//the total dex numbers</span></span><br><span class="line">            <span class="keyword">int</span> totalDexNumber = getMultiDexPreferences(context).getInt(KEY_DEX_NUMBER, <span class="number">1</span>);</span><br><span class="line">            File dexDir = <span class="keyword">new</span> File(applicationInfo.dataDir, SECONDARY_FOLDER_NAME);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> secondaryNumber = <span class="number">2</span>; secondaryNumber &lt;= totalDexNumber; secondaryNumber++) &#123;</span><br><span class="line">                <span class="comment">//for each dex file, ie: test.classes2.zip, test.classes3.zip...</span></span><br><span class="line">                String fileName = extractedFilePrefix + secondaryNumber + EXTRACTED_SUFFIX;</span><br><span class="line">                File extractedFile = <span class="keyword">new</span> File(dexDir, fileName);</span><br><span class="line">                <span class="keyword">if</span> (extractedFile.isFile()) &#123;</span><br><span class="line">                    sourcePaths.add(extractedFile.getAbsolutePath());</span><br><span class="line">                    <span class="comment">//we ignore the verify zip part</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Missing extracted secondary dex file '"</span> + extractedFile.getPath() + <span class="string">"'"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯debugçš„ï¼Œé‚£ä¹ˆé¢å¤–å»åŠ è½½ä¸‹ instant run ä¸­çš„dexæ–‡ä»¶è·¯å¾„</span></span><br><span class="line">        <span class="keyword">if</span> (ARouter.debuggable()) &#123; <span class="comment">// Search instant run support only debuggable</span></span><br><span class="line">            sourcePaths.addAll(tryLoadInstantRunDexFile(applicationInfo));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sourcePaths;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>æ›´å¤šçš„ç»†èŠ‚æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·±å›å»çœ‹ï¼Œè¿™é‡Œå› ä¸ºç¯‡å¹…çš„åŸå› å°±ä¸è¿‡å¤šè®²è¿™äº›äº†ã€‚</p>
<p>é‚£ä¹ˆä»Šå¤©å°±åˆ°è¿™é‡Œç»“æŸäº†ï¼Œå…³äº ARouter ç³»åˆ—çš„æ›´å¤šæºç è§£æï¼Œå¯ä»¥çœ‹æ¥ä¸‹æ¥çš„ä¸¤ç¯‡åšå®¢ã€‚</p>
<p>bye</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>arouter-api version : 1.4.1</p>
<h1 id="u524D_u8A00"><a href="#u524D_u8A00" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ä¹‹å‰å¯¹ ActivityRoute]]>
    </summary>
    
      <category term="Android" scheme="http://yuqirong.me/tags/Android/"/>
    
      <category term="å¼€æºæ¡†æ¶" scheme="http://yuqirong.me/tags/%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/"/>
    
      <category term="æºç è§£æ" scheme="http://yuqirong.me/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    
      <category term="Android Blog" scheme="http://yuqirong.me/categories/Android-Blog/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[ä»SVNè¿ç§»åˆ°GitLab]]></title>
    <link href="http://yuqirong.me/2018/11/15/%E4%BB%8ESVN%E8%BF%81%E7%A7%BB%E5%88%B0GitLab/"/>
    <id>http://yuqirong.me/2018/11/15/ä»SVNè¿ç§»åˆ°GitLab/</id>
    <published>2018-11-15T14:43:46.000Z</published>
    <updated>2018-11-15T15:04:08.674Z</updated>
    <content type="html"><![CDATA[<p>ä¹‹å‰å…¬å¸ä»£ç ç‰ˆæœ¬ç®¡ç†ç”¨çš„éƒ½æ˜¯ SVN ï¼Œæœ€è¿‘æ­äº† GitLab ã€‚æ‰€ä»¥æƒ³æŠŠä»£ç ä» SVN è¿ç§»åˆ° GitLab ä¸Šã€‚ä½†æ˜¯ SVN çš„æäº¤è®°å½•åˆä¸èƒ½ä¸¢ï¼Œä¹Ÿè¦è·Ÿç€ä¸€èµ·è¿ç§»ï¼Œæ‰€ä»¥æœ¬ç¯‡è®°å½•ä¸€ä¸‹è¿ç§»çš„æ–¹æ³•ã€‚</p>
<pre><code>yum install -y git-svn
</code></pre><p>å®‰è£… git-svn ï¼Œå¯ä»¥å¸®åŠ©ä½ å¾ˆè½»æ¾çš„ä» SVN è½¬åˆ° GitLab ä¸Šã€‚</p>
<p>ç„¶å cd åˆ°è¦è¿ç§»åˆ° SVN é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹</p>
<pre><code>svn log --xml | grep author | sort -u | perl -pe &apos;s/.&gt;(.?)&lt;./$1 = /&apos;
</code></pre><p>è¿™æ¡å‘½ä»¤ä¼šè¾“å‡º SVN æ‰€æœ‰æäº¤è¿‡çš„äººçš„åå­—ï¼Œæ¯”å¦‚</p>
<author>xiaoming</author><br><author>xiaowang</author><br><author>xiaohong</author>

<p>ç„¶åæ–°å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œç”¨äºä¿å­˜è¯¥è®°å½•</p>
<pre><code>touch svn-history.txt
</code></pre><p>å†ç„¶åæˆ‘ä»¬å°±è¦å¯¹è¿™ä¸ªè®°å½•åšä¸€äº›å¤„ç†ï¼Œèƒ½è®© Git è¯†åˆ«è¿™äº›ä»£ç æäº¤è€…</p>
<pre><code>vi svn-history.txt
</code></pre><p>æŠŠå†…å®¹æ”¹æˆå¦‚ä¸‹ï¼š</p>
<p>xiaoming = xiaoming  <a href="&#109;&#97;&#x69;&#108;&#116;&#x6f;&#58;&#x78;&#105;&#97;&#111;&#109;&#105;&#110;&#103;&#64;&#49;&#54;&#x33;&#x2e;&#99;&#111;&#109;">&#x78;&#105;&#97;&#111;&#109;&#105;&#110;&#103;&#64;&#49;&#54;&#x33;&#x2e;&#99;&#111;&#109;</a><br>xiaowang = xiaowang  <a href="&#109;&#97;&#105;&#x6c;&#x74;&#111;&#x3a;&#120;&#x69;&#x61;&#x6f;&#119;&#x61;&#110;&#103;&#64;&#113;&#113;&#46;&#99;&#x6f;&#109;">&#120;&#x69;&#x61;&#x6f;&#119;&#x61;&#110;&#103;&#64;&#113;&#113;&#46;&#99;&#x6f;&#109;</a><br>xiaohong = xiaohong  <a href="&#109;&#x61;&#105;&#x6c;&#x74;&#111;&#58;&#x78;&#105;&#97;&#111;&#104;&#111;&#110;&#x67;&#x40;&#x71;&#x71;&#46;&#99;&#x6f;&#x6d;">&#x78;&#105;&#97;&#111;&#104;&#111;&#110;&#x67;&#x40;&#x71;&#x71;&#46;&#99;&#x6f;&#x6d;</a></p>
<p>ä¿å­˜å¥½åï¼Œè¾“å…¥å‘½ä»¤</p>
<pre><code>git svn clone  svn://svn.yoursvnaddress.com/XXXX/  --no-metadata  --authors-file=svn-history.txt
</code></pre><p>è¿™æ¡å‘½ä»¤ä¼šåœ¨å½“å‰ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ª XXXX é¡¹ç›®ï¼Œè¿™ä¸ª XXXX é¡¹ç›®æ˜¯ç”¨ Git çš„ã€‚</p>
<pre><code>cd XXXX
git remote add origin git@yougitaddress:xxx/XXXX.git
git push origin --all
</code></pre><p>è¿™æ ·å°±å®Œæˆäº†ä» SVN åˆ° GitLab çš„è¿ç§»ï¼Œå¹¶ä¸”æ˜¯åŒ…å«äº† SVN æäº¤è®°å½•çš„ã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>ä¹‹å‰å…¬å¸ä»£ç ç‰ˆæœ¬ç®¡ç†ç”¨çš„éƒ½æ˜¯ SVN ï¼Œæœ€è¿‘æ­äº† GitLab ã€‚æ‰€ä»¥æƒ³æŠŠä»£ç ä» SVN è¿ç§»åˆ° GitLab ä¸Šã€‚ä½†æ˜¯ SVN çš„æäº¤è®°å½•åˆä¸èƒ½ä¸¢ï¼Œä¹Ÿè¦è·Ÿç€ä¸€èµ·è¿ç§»ï¼Œæ‰€ä»¥æœ¬ç¯‡è®°å½•ä¸€ä¸‹è¿ç§»çš„æ–¹æ³•ã€‚</p>
<pre><code>yum install -y git-svn
]]>
    </summary>
    
      <category term="Git" scheme="http://yuqirong.me/tags/Git/"/>
    
      <category term="GitLab" scheme="http://yuqirong.me/tags/GitLab/"/>
    
      <category term="Android Blog" scheme="http://yuqirong.me/categories/Android-Blog/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Linuxä¸Šå®‰è£…GitLabå’ŒJenkins]]></title>
    <link href="http://yuqirong.me/2018/11/13/Linux%E4%B8%8A%E5%AE%89%E8%A3%85GitLab%E5%92%8CJenkins/"/>
    <id>http://yuqirong.me/2018/11/13/Linuxä¸Šå®‰è£…GitLabå’ŒJenkins/</id>
    <published>2018-11-13T14:17:39.000Z</published>
    <updated>2018-11-13T15:01:46.571Z</updated>
    <content type="html"><![CDATA[<p>ä¹‹å‰åœ¨å…¬å¸çš„æœåŠ¡å™¨ä¸Šæ­å»ºäº† GitLab å’Œ Jenkins ï¼Œæ‰€ä»¥æ‰“ç®—æŠŠè¿™è¿‡ç¨‹è®°å½•ä¸‹ï¼Œä»¥ä¾¿ä¸‹æ¬¡æœ‰éœ€è¦æ—¶å¯ä»¥å¤ç”¨ã€‚</p>
<h1 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h1><p>åœ¨æ­å»º GitLab ä¹‹å‰ï¼Œè‚¯å®šè¦å…ˆå®‰è£… Git ã€‚</p>
<p>åœ¨ <a href="https://github.com/git/git/releases" target="_blank" rel="external">https://github.com/git/git/releases</a> ä¸­é€‰æ‹©æœ€æ–°ç‰ˆæœ¬çš„ Gitï¼Œç„¶å</p>
<pre><code>wget https://github.com/git/git/archive/v2.19.1.tar.gz
</code></pre><p>ä¸‹è½½ä¸‹æ¥åï¼Œæˆ‘ä»¬è¿›è¡Œè§£å‹</p>
<pre><code>tar -zxvf v2.19.1.tar.gz
</code></pre><p>è¿›å…¥è§£å‹åçš„æ–‡ä»¶å¤¹</p>
<pre><code>cd git-2.19.1
</code></pre><p>ä¹‹åæˆ‘ä»¬éœ€è¦ç¼–è¯‘ Git çš„æºç ï¼Œåœ¨è¿™ä¹‹å‰æˆ‘ä»¬å…ˆå®‰è£…ç¼–è¯‘éœ€è¦çš„ä¾èµ–ï¼Œè¿™é‡Œå¯èƒ½æç¤ºéœ€è¦ su æƒé™æ‰èƒ½å®‰è£…</p>
<pre><code>yum install curl-devel expat-devel gettext-devel openssl-devel zlib-devel gcc perl-ExtUtils-MakeMaker
</code></pre><p>å®‰è£…å¥½åæˆ‘ä»¬è¿›è¡Œç¼–è¯‘</p>
<pre><code>make prefix=/usr/local/git all
</code></pre><p>ä¹‹åæˆ‘ä»¬å®‰è£… Git åˆ° /usr/local/git è·¯å¾„</p>
<pre><code>make prefix=/usr/local/git install
</code></pre><p>å®‰è£…å®Œæˆå Git ä¼šè‡ªåŠ¨å°†é…ç½®æ·»åŠ åˆ°ç¯å¢ƒå˜é‡ PATH ä¸­ï¼Œå¦‚æœæ²¡æœ‰çš„è¯éœ€è¦æ‰‹åŠ¨æ·»åŠ ï¼Œå¯ä»¥è‡ªè¡Œç™¾åº¦</p>
<p>æœ€åè¾“å…¥</p>
<pre><code>git --version
</code></pre><p>æŸ¥çœ‹ Git æ˜¯å¦å®‰è£…æˆåŠŸã€‚</p>
<h1 id="GitLab"><a href="#GitLab" class="headerlink" title="GitLab"></a>GitLab</h1><p>å®‰è£…ä¾èµ–</p>
<pre><code>//é…ç½®ç³»ç»Ÿé˜²ç«å¢™,æŠŠHTTPå’ŒSSHç«¯å£å¼€æ”¾.
sudo yum install curl openssh-server postfix cronie
sudo service postfix start
sudo lokkit -s http -s ssh
sudo chkconfig postfix on
</code></pre><p>å¦‚æœæç¤ºæ— æ³•æ‰¾åˆ° lokkit å‘½ä»¤ï¼Œé‚£ä¹ˆéœ€è¦è¿è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£…</p>
<pre><code>yum install lokkit
</code></pre><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ lokkit ä¼šæŠŠ iptables æ‰“å¼€ï¼Œå¦‚æœä¸æƒ³è¦ iptables çš„è¯ï¼Œå¯ä»¥è¿›è¡Œå…³é—­</p>
<pre><code>service iptables stop
</code></pre><p>ç¬¬äºŒæ­¥ï¼Œå°±æ˜¯ä¸‹è½½ GitLab å®‰è£…åŒ…ã€‚ä¸‹è½½åœ°å€ï¼š<a href="https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7" target="_blank" rel="external">https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7</a></p>
<pre><code>wget https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/gitlab-ce-11.4.5-ce.0.el7.x86_64.rpm
</code></pre><p>ä¸‹è½½å¥½åï¼Œè¿›è¡Œå®‰è£…</p>
<pre><code>rpm -Uvh gitlab-ce-11.4.5-ce.0.el7.x86_64.rpm
</code></pre><p>ä¿®æ”¹ GitLab é…ç½®æ–‡ä»¶æŒ‡å®šæœåŠ¡å™¨ipå’Œè‡ªå®šä¹‰ç«¯å£</p>
<pre><code>vim  /etc/gitlab/gitlab.rb
</code></pre><p>æŒ‡å®šè®¿é—®ipåŠç«¯å£ç”¨å·</p>
<p>external-url â€˜<a href="http://www.xxx.com" target="_blank" rel="external">http://www.xxx.com</a>â€˜</p>
<p>ä¿å­˜å¹¶é€€å‡ºï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ›´æ–°é…ç½®ã€‚</p>
<pre><code>sudo gitlab-ctl reconfigure
</code></pre><p>æœ€åï¼Œæ ¹æ®ä¸Šé¢é…ç½®çš„ external-url å°±å¯ä»¥è®¿é—® GitLab äº†ã€‚</p>
<h1 id="Jenkins"><a href="#Jenkins" class="headerlink" title="Jenkins"></a>Jenkins</h1><p>å®‰è£… Jenkins æ˜¯éœ€è¦ Java ç¯å¢ƒçš„ï¼Œè¿™é‡Œå°±ä¸è®² Linux ç³»ç»Ÿå®‰è£… Java äº†ï¼Œæœ‰éœ€è¦çš„å¯ä»¥è‡ªè¡Œç™¾åº¦ã€‚</p>
<p>Jenkins å®‰è£…æ•™ç¨‹ï¼š<a href="https://wiki.jenkins.io/display/JENKINS/Installing+Jenkins+on+Red+Hat+distributions#InstallingJenkinson" target="_blank" rel="external">https://wiki.jenkins.io/display/JENKINS/Installing+Jenkins+on+Red+Hat+distributions#InstallingJenkinson</a></p>
<p>é€‰æ‹©æœ€æ–°ç‰ˆ ï¼Œä½¿ç”¨ yum æ–¹å¼ä¸‹è½½å®‰è£…</p>
<pre><code>sudo wget -O /etc/yum.repos.d/jenkins.repo http://pkg.jenkins-ci.org/redhat/jenkins.repo
sudo rpm --import https://jenkins-ci.org/redhat/jenkins-ci.org.key
sudo yum install jenkins
</code></pre><p>æ¥ä¸‹æ¥é…ç½® Jenkins ç«¯å£</p>
<pre><code>vi /etc/sysconfig/jenkins
</code></pre><p>æŸ¥æ‰¾/JENKINS_PORTï¼Œä¿®æ”¹JENKINS_PORT=â€8080â€ï¼Œé»˜è®¤ä¸ºâ€œ8080â€ï¼Œæˆ‘ä¿®æ”¹ä¸ºäº†9090ã€‚/JENKINS_LISTEN_ADDRESS æ˜¯å¯¹åº” Jenkins çš„ ip ï¼Œé»˜è®¤æ˜¯ 0.0.0.0 ã€‚</p>
<p>å¯åŠ¨ Jenkins</p>
<pre><code>service jenkins restart
</code></pre><p>åœ¨æµè§ˆå™¨ä¸­è¾“å…¥ Jenkins çš„ç½‘å€ï¼Œå°±å¯ä»¥ä½¿ç”¨äº†ã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>ä¹‹å‰åœ¨å…¬å¸çš„æœåŠ¡å™¨ä¸Šæ­å»ºäº† GitLab å’Œ Jenkins ï¼Œæ‰€ä»¥æ‰“ç®—æŠŠè¿™è¿‡ç¨‹è®°å½•ä¸‹ï¼Œä»¥ä¾¿ä¸‹æ¬¡æœ‰éœ€è¦æ—¶å¯ä»¥å¤ç”¨ã€‚</p>
<h1 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h1><p>åœ¨]]>
    </summary>
    
      <category term="Android" scheme="http://yuqirong.me/tags/Android/"/>
    
      <category term="Android Blog" scheme="http://yuqirong.me/categories/Android-Blog/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[ActivityRouteræºç è§£æ]]></title>
    <link href="http://yuqirong.me/2018/07/22/ActivityRouter%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <id>http://yuqirong.me/2018/07/22/ActivityRouteræºç è§£æ/</id>
    <published>2018-07-22T14:32:15.000Z</published>
    <updated>2018-12-16T15:40:11.706Z</updated>
    <content type="html"><![CDATA[<p>ActivityRouter ï¼š<a href="https://github.com/mzule/ActivityRouter" target="_blank" rel="external">https://github.com/mzule/ActivityRouter</a></p>
<h1 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h1><p>åœ¨å¦‚ä»Šçš„ Android ç»„ä»¶åŒ–å¼€å‘ä¸­ï¼Œä¸€æ¬¾å¥½çš„è·¯ç”±æ¡†æ¶æ˜¯ä¸å¯æˆ–ç¼ºçš„ã€‚æ¯”å¦‚ç›®å‰é˜¿é‡Œçš„ ARouter ã€ç¾å›¢çš„ WMRouter ç­‰ã€‚è·¯ç”±æ¡†æ¶å¯ä»¥é™ä½ Activity ä¹‹é—´çš„è€¦åˆï¼Œä»è€Œåœ¨ä¸éœ€è¦å…³å¿ƒç›®æ ‡ Activity çš„å…·ä½“å®ç°ç±»ï¼Œ åˆ©ç”¨åè®®å®Œæˆè·³è½¬ã€‚</p>
<h1 id="ActivityRouter_u4F7F_u7528_u65B9_u6CD5"><a href="#ActivityRouter_u4F7F_u7528_u65B9_u6CD5" class="headerlink" title="ActivityRouterä½¿ç”¨æ–¹æ³•"></a>ActivityRouterä½¿ç”¨æ–¹æ³•</h1><p>åœ¨AndroidManifest.xmlé…ç½®</p>
<pre><code>&lt;activity
    android:name=&quot;com.github.mzule.activityrouter.router.RouterActivity&quot;
    android:theme=&quot;@android:style/Theme.NoDisplay&quot;&gt;
    &lt;intent-filter&gt;
        &lt;action android:name=&quot;android.intent.action.VIEW&quot; /&gt;
        &lt;category android:name=&quot;android.intent.category.DEFAULT&quot; /&gt;
        &lt;category android:name=&quot;android.intent.category.BROWSABLE&quot; /&gt;
        &lt;data android:scheme=&quot;mzule&quot; /&gt;&lt;!--æ”¹æˆè‡ªå·±çš„scheme--&gt;
    &lt;/intent-filter&gt;
&lt;/activity&gt;
</code></pre><p>åœ¨éœ€è¦é…ç½®çš„Activityä¸Šæ·»åŠ æ³¨è§£</p>
<pre><code>@Router(&quot;main&quot;)
public class MainActivity extends Activity {
    ...
}
</code></pre><p>æƒ³è¦è·³è½¬åˆ° MainActivity ï¼Œåªè¦è°ƒç”¨ä»¥ä¸‹ä»£ç å³å¯</p>
<pre><code>Routers.open(context, &quot;mzule://main&quot;)
</code></pre><p>å¦‚æœæƒ³ç”¨ @Router æ¥è°ƒç”¨æ–¹æ³•</p>
<pre><code>@Router(&quot;logout&quot;)
public static void logout(Context context, Bundle bundle) {
    Toast.makeText(context, &quot;logout&quot;, Toast.LENGTH_SHORT).show();
}
</code></pre><h1 id="u6E90_u7801_u89E3_u6790"><a href="#u6E90_u7801_u89E3_u6790" class="headerlink" title="æºç è§£æ"></a>æºç è§£æ</h1><p>ActivityRouter å·¥ç¨‹çš„ç»“æ„å¦‚ä¸‹</p>
<p><img src="/uploads/20180722/20181216160032.png" alt="ActivityRouter"></p>
<ul>
<li>activityrouter: è·¯ç”±è·³è½¬çš„å…·ä½“å®ç°ä»£ç </li>
<li>annotaition: è·¯ç”±æ³¨è§£</li>
<li>app: è·¯ç”± demo</li>
<li>app_module: è·¯ç”± demo module</li>
<li>compiler: æ³¨è§£å¤„ç†</li>
<li>stub: å£³ module</li>
</ul>
<h2 id="annotation"><a href="#annotation" class="headerlink" title="annotation"></a>annotation</h2><p>å…ˆæ¥çœ‹çœ‹ Router çš„æ³¨è§£</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Target</span>(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span><br><span class="line"><span class="annotation">@Retention</span>(RetentionPolicy.CLASS)</span><br><span class="line"><span class="keyword">public</span> <span class="annotation">@interface</span> Router &#123;</span><br><span class="line"></span><br><span class="line">    String[] value();</span><br><span class="line"></span><br><span class="line">    String[] stringParams() <span class="keyword">default</span> <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    String[] intParams() <span class="keyword">default</span> <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    String[] longParams() <span class="keyword">default</span> <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    String[] booleanParams() <span class="keyword">default</span> <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    String[] shortParams() <span class="keyword">default</span> <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    String[] floatParams() <span class="keyword">default</span> <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    String[] doubleParams() <span class="keyword">default</span> <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    String[] byteParams() <span class="keyword">default</span> <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    String[] charParams() <span class="keyword">default</span> <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    String[] transfer() <span class="keyword">default</span> <span class="string">""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>@Router å®šä¹‰äº†è¯¥ Activity è·¯ç”±çš„åå­—ä»¥åŠä¸€äº›å‚æ•°ï¼Œè¿™é‡Œå¯ä»¥æ³¨æ„åˆ° @Retention æ˜¯ CLASS ï¼Œæ‰€ä»¥åé¢è‚¯å®šåœ¨ç¼–è¯‘æœŸé—´åˆ©ç”¨ Processor æ¥è§£æ @Router ç”Ÿæˆè·¯ç”±è¡¨çš„ã€‚</p>
<p>å¦å¤–ï¼Œçœ‹åˆ° @Target æ˜¯ ElementType.TYPE å’Œ ElementType.METHOD ï¼Œå…¶å® @Router é™¤äº†è·³è½¬ Activity ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªåŠŸèƒ½å°±æ˜¯å¯ä»¥æ‰§è¡Œæ–¹æ³•ï¼Œåªè¦åœ¨æ–¹æ³•åŠ ä¸Š @Router å³å¯ã€‚</p>
<p>è·¯ç”±è¡¨çš„ç”Ÿæˆæºç æˆ‘ä»¬åˆ°åé¢å†è®²ï¼Œå…ˆæ¥çœ‹çœ‹æœ‰äº†åè®®ä¹‹åï¼ŒRouters æ˜¯å¦‚ä½•å®ç°è·³è½¬ Activity çš„ã€‚</p>
<h2 id="activityrouter"><a href="#activityrouter" class="headerlink" title="activityrouter"></a>activityrouter</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Routers</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">open</span><span class="params">(Context context, String url)</span> </span>&#123;</span><br><span class="line">	    <span class="keyword">return</span> open(context, Uri.parse(url));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">open</span><span class="params">(Context context, String url, RouterCallback callback)</span> </span>&#123;</span><br><span class="line">	    <span class="keyword">return</span> open(context, Uri.parse(url), callback);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">open</span><span class="params">(Context context, Uri uri)</span> </span>&#123;</span><br><span class="line">	    <span class="keyword">return</span> open(context, uri, getGlobalCallback(context));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">open</span><span class="params">(Context context, Uri uri, RouterCallback callback)</span> </span>&#123;</span><br><span class="line">	    <span class="keyword">return</span> open(context, uri, -<span class="number">1</span>, callback);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">openForResult</span><span class="params">(Activity activity, String url, <span class="keyword">int</span> requestCode)</span> </span>&#123;</span><br><span class="line">	    <span class="keyword">return</span> openForResult(activity, Uri.parse(url), requestCode);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">openForResult</span><span class="params">(Activity activity, String url, <span class="keyword">int</span> requestCode, RouterCallback callback)</span> </span>&#123;</span><br><span class="line">	    <span class="keyword">return</span> openForResult(activity, Uri.parse(url), requestCode, callback);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">openForResult</span><span class="params">(Activity activity, Uri uri, <span class="keyword">int</span> requestCode)</span> </span>&#123;</span><br><span class="line">	    <span class="keyword">return</span> openForResult(activity, uri, requestCode, getGlobalCallback(activity));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">openForResult</span><span class="params">(Activity activity, Uri uri, <span class="keyword">int</span> requestCode, RouterCallback callback)</span> </span>&#123;</span><br><span class="line">	    <span class="keyword">return</span> open(activity, uri, requestCode, callback);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ä¸åŒçš„ open openForResult æ–¹æ³•é‡è½½ï¼Œæœ€åéƒ½æ˜¯è°ƒç”¨äº† <code>open(Context context, Uri uri, int requestCode, RouterCallback callback)</code> ã€‚é‚£ä¹ˆæ¥ç€è·Ÿè¸ªï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">open</span><span class="params">(Context context, Uri uri, <span class="keyword">int</span> requestCode, RouterCallback callback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">// å¦‚æœæœ‰ callback åœ¨è·³è½¬å‰å›è°ƒ </span></span><br><span class="line">    <span class="keyword">if</span> (callback != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (callback.beforeOpen(context, uri)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ‰§è¡Œè·¯ç”±è·³è½¬</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        success = doOpen(context, uri, requestCode);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">if</span> (callback != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// é”™è¯¯å›è°ƒ</span></span><br><span class="line">            callback.error(context, uri, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æˆåŠŸæˆ–å¤±è´¥å›è°ƒ</span></span><br><span class="line">    <span class="keyword">if</span> (callback != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (success) &#123;</span><br><span class="line">            callback.afterOpen(context, uri);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            callback.notFound(context, uri);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> success;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>open æ–¹æ³•ä¸­æœ‰å¾ˆå¤šéƒ½æ˜¯ä¸åŒçŠ¶æ€ä¸‹ callback çš„å›è°ƒï¼ŒçœŸæ­£è·³è½¬çš„é€»è¾‘æ”¾åœ¨äº† doOpen æ–¹æ³•ä¸­ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">doOpen</span><span class="params">(Context context, Uri uri, <span class="keyword">int</span> requestCode)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœæ²¡æœ‰åˆå§‹åŒ–çš„è¯ï¼Œè°ƒç”¨ Router.init è¿›è¡Œåˆå§‹åŒ–è·¯ç”±è¡¨</span></span><br><span class="line">    initIfNeed();</span><br><span class="line">    <span class="comment">// è§£æ uri å¾—åˆ°å¯¹åº”çš„ path</span></span><br><span class="line">    Path path = Path.create(uri);</span><br><span class="line">    <span class="comment">// æ ¹æ® path å»æŸ¥æ‰¾ä¸ä¹‹å¯¹åº”åŒ¹é…çš„ mapping ï¼Œç„¶åå®ç°è·³è½¬</span></span><br><span class="line">    <span class="keyword">for</span> (Mapping mapping : mappings) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mapping.match(path)) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœ activity æ˜¯ç©ºçš„ï¼Œå°±è¯´æ˜æ˜¯æ‰§è¡Œæ–¹æ³•çš„</span></span><br><span class="line">            <span class="keyword">if</span> (mapping.getActivity() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mapping.getMethod().invoke(context, mapping.parseExtras(uri));</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¦åˆ™å°±æ˜¯åˆ©ç”¨ intent æ¥è·³è½¬ activity</span></span><br><span class="line">            Intent intent = <span class="keyword">new</span> Intent(context, mapping.getActivity());</span><br><span class="line">            intent.putExtras(mapping.parseExtras(uri));</span><br><span class="line">            intent.putExtra(KEY_RAW_URL, uri.toString());</span><br><span class="line">            <span class="keyword">if</span> (!(context <span class="keyword">instanceof</span> Activity)) &#123;</span><br><span class="line">                intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (requestCode &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (context <span class="keyword">instanceof</span> Activity) &#123;</span><br><span class="line">                    ((Activity) context).startActivityForResult(intent, requestCode);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"can not startActivityForResult context "</span> + context);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                context.startActivity(intent);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä¸€æ­¥æ­¥æ¥åˆ†æ doOpen ä¸­çš„å…·ä½“æ­¥éª¤ã€‚å…ˆä» <code>Path path = Path.create(uri);</code> å¼€å§‹çœ‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Path <span class="title">create</span><span class="params">(Uri uri)</span> </span>&#123;</span><br><span class="line">    Path path = <span class="keyword">new</span> Path(uri.getScheme().concat(<span class="string">"://"</span>));</span><br><span class="line">    String urlPath = uri.getPath();</span><br><span class="line">    <span class="keyword">if</span> (urlPath == <span class="keyword">null</span>) &#123;</span><br><span class="line">        urlPath = <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (urlPath.endsWith(<span class="string">"/"</span>)) &#123;</span><br><span class="line">        urlPath = urlPath.substring(<span class="number">0</span>, urlPath.length() - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    parse(path, uri.getHost() + urlPath);</span><br><span class="line">    <span class="keyword">return</span> path;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">parse</span><span class="params">(Path scheme, String s)</span> </span>&#123;</span><br><span class="line">    String[] components = s.split(<span class="string">"/"</span>);</span><br><span class="line">    Path curPath = scheme;</span><br><span class="line">    <span class="keyword">for</span> (String component : components) &#123;</span><br><span class="line">        Path temp = <span class="keyword">new</span> Path(component);</span><br><span class="line">        curPath.next = temp;</span><br><span class="line">        curPath = temp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç çœ‹å®Œå¯èƒ½ä¼šè®©æœ‰äº›åŒå­¦æ„Ÿè§‰å¾ˆç»•ï¼Œç®€å•åœ°è§£é‡Šä¸‹ã€‚ä¸Šé¢è¿™æ®µä»£ç ä¸»è¦åšçš„äº‹æƒ…å°±æ˜¯æŠŠä¼ å…¥çš„ uri è§£æï¼Œç”Ÿæˆäº†ä¸€ä¸ª Path å¯¹è±¡ã€‚è¯¥ Path å¯¹è±¡ä¸»è¦åŒ…å«äº† uri ä¸­çš„ scheme ã€host ã€path è¿™ä¸‰éƒ¨åˆ†ï¼Œåˆ©ç”¨å•é“¾è¡¨çš„ç‰¹ç‚¹æŠŠè¿™ä¸‰éƒ¨åˆ†ä¸²è¿èµ·æ¥ã€‚è¿™ä¸ª Path ä¹Ÿå°±æ˜¯åé¢ç”¨æ¥åŒ¹é…è·¯ç”±è¡¨ç”¨çš„ã€‚</p>
<p>å¯èƒ½è¿˜æœ‰ä¸€äº›åŒå­¦å¯¹ uri çš„ scheme ã€ host ç­‰ä¸äº†è§£ï¼Œåœ¨è¿™é‡Œå°±ç®€å•åœ°æ™®åŠä¸‹ã€‚</p>
<p>æ¯”å¦‚ç°åœ¨æœ‰ä¸€ä¸ª uri </p>
<pre><code>mzule://main/home/login?username=tom
</code></pre><p>è¿™ä¸ª uri å°±å¯ä»¥åˆ†è§£ä¸º</p>
<p>scheme ï¼šmzule ï¼Œå°±æ˜¯ â€œ://â€ å‰é¢çš„å­—ç¬¦ä¸²<br>host ï¼šmain ï¼Œâ€œ://â€ åé¢çš„å­—ç¬¦ä¸²<br>path ï¼šhome å’Œ login éƒ½å±äº pathï¼Œå°±æ˜¯ â€œ/â€ ä¸ â€œ/â€ ä¹‹é—´çš„å­—ç¬¦ä¸²<br>query ï¼šå‚æ•°ï¼Œå¯ä»¥ç†è§£æˆé”®å€¼å¯¹ï¼Œå¤šä¸ªä¹‹é—´ç”¨ &amp; è¿æ¥ã€‚è·å– username è¿™ä¸ªå‚æ•°ï¼Œå¯¹åº”çš„å€¼å°±æ˜¯ tom</p>
<p>ç”Ÿæˆå¥½äº† Path ä¹‹åï¼Œå°±æ˜¯éå†è·¯ç”±è¡¨è¿›è¡ŒåŒ¹é…äº†ã€‚</p>
<p>æ‰€è°“çš„è·¯ç”±è¡¨å…¶å®å°±æ˜¯ä¸€ä¸ª List </p>
<pre><code>private static List&lt;Mapping&gt; mappings = new ArrayList&lt;&gt;();
</code></pre><p>åœ¨è°ƒç”¨ RouterInit.init æ—¶å€™ä¼šæŠŠè·¯ç”±æ•°æ®æ·»åŠ åˆ° List ä¸­ã€‚å‡†ç¡®çš„è¯´ï¼Œ RouterInit.init ä¸­è°ƒç”¨äº† Router.map æ–¹æ³•æ¥å®ç°æ·»åŠ çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(String format, Class&lt;? extends Activity&gt; activity, MethodInvoker method, ExtraTypes extraTypes)</span> </span>&#123;</span><br><span class="line">    mappings.add(<span class="keyword">new</span> Mapping(format, activity, method, extraTypes));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ Mapping çš„ç»“æ„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Mapping</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String format;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;? extends Activity&gt; activity;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MethodInvoker method;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExtraTypes extraTypes;</span><br><span class="line">    <span class="keyword">private</span> Path formatPath;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>format å°±æ˜¯æˆ‘ä»¬ä¼ å…¥çš„ uri</li>
<li>activity å°±æ˜¯è·¯ç”±å¯¹åº”çš„ activity</li>
<li>method è¡¨ç¤ºæ˜¯å¦æ˜¯æ‰§è¡Œæ–¹æ³•</li>
<li>extraTypes æ˜¯æ‰€æºå¸¦çš„å‚æ•°ç±»å‹</li>
<li>formatPath å°±æ˜¯ uri å¯¹åº”çš„ Path</li>
</ul>
<p>å…·ä½“çš„ Mapping åˆå§‹åŒ–æ˜¯åœ¨ Processor ç”Ÿæˆçš„ä»£ç ä¸­å®Œæˆçš„ï¼Œæˆ‘ä»¬åˆ°åé¢å†è®²ã€‚</p>
<p>åœ¨å›è¿‡å¤´æ¥çœ‹ doOpen æ–¹æ³•ï¼Œåœ¨ mapping.match(path) æ–¹æ³•ä¸­ç”¨æ¥åˆ¤æ–­è¯¥ path æœ‰æ²¡æœ‰åŒ¹é…è·¯ç”±è¡¨ä¸­çš„è·¯ç”±</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">match</span><span class="params">(Path fullLink)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (formatPath.isHttp()) &#123;</span><br><span class="line">        <span class="keyword">return</span> Path.match(formatPath, fullLink);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// fullLink without host</span></span><br><span class="line">        <span class="keyword">boolean</span> match = Path.match(formatPath.next(), fullLink.next());</span><br><span class="line">        <span class="keyword">if</span> (!match &amp;&amp; fullLink.next() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// fullLink with host</span></span><br><span class="line">            match = Path.match(formatPath.next(), fullLink.next().next());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> match;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Mapping çš„ match æ–¹æ³•å°±æ˜¯æŠŠè‡ªèº«çš„ formatPath å’Œ fullLink è¿›è¡Œæ¯”è¾ƒï¼Œæœ€ç»ˆè°ƒç”¨çš„è¿˜æ˜¯ Path.match æ–¹æ³•ï¼Œæœ¬è´¨å°±æ˜¯æŠŠ Path é“¾è¡¨ä¸­çš„æ¯ä¸€é¡¹è¿›è¡Œæ¯”è¾ƒï¼Œæ¥åˆ¤æ–­ä¸¤ä¸ª Path æ˜¯å¦ç›¸ç­‰ã€‚è¿™é‡Œå°±ä¸å±•ç¤ºå…·ä½“æºç äº†ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·±å›å»çœ‹ã€‚</p>
<p>å†åé¢çš„å°±æ˜¯åˆ¤æ–­ activity ï¼Œå¦‚æœæ˜¯ç©ºçš„ï¼Œå°±è®¤ä¸ºæ˜¯æ‰§è¡Œæ–¹æ³•ï¼Œå¦åˆ™å°±æ„é€  Intent æ¥å®ç°è·³è½¬ï¼Œå†åˆ©ç”¨ requestCode æ¥åˆ¤æ–­æ˜¯ startActivity è¿˜æ˜¯ startActivityForResult ã€‚å…¶ä¸­æ‰§è¡Œæ–¹æ³•ä¸»è¦è°ƒç”¨äº† MethodInvoker.invoke æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MethodInvoker</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Context context, Bundle bundle)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å†é‡ç‚¹å…³æ³¨ä¸‹ mapping.parseExtras(uri) è¿™å¥ä»£ç ã€‚è¿™é‡Œä¸»è¦åšçš„äº‹æƒ…å°±æ˜¯æ„é€  Bundle ä¼ å…¥ uri çš„å‚æ•°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Bundle <span class="title">parseExtras</span><span class="params">(Uri uri)</span> </span>&#123;</span><br><span class="line">    Bundle bundle = <span class="keyword">new</span> Bundle();</span><br><span class="line">    <span class="comment">// path segments // ignore scheme</span></span><br><span class="line">    Path p = formatPath.next();</span><br><span class="line">    Path y = Path.create(uri).next();</span><br><span class="line">    <span class="keyword">while</span> (p != <span class="keyword">null</span>) &#123;</span><br><span class="line">    		<span class="comment">// æ˜¯å¦æ˜¯Â path ä¸­ä¼ é€’å‚æ•°</span></span><br><span class="line">        <span class="keyword">if</span> (p.isArgument()) &#123;</span><br><span class="line">            put(bundle, p.argument(), y.value());</span><br><span class="line">        &#125;</span><br><span class="line">        p = p.next();</span><br><span class="line">        y = y.next();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è§£æ uri ä¸­çš„å‚æ•°ï¼Œæ”¾å…¥ bundle ä¸­</span></span><br><span class="line">    Set&lt;String&gt; names = UriCompact.getQueryParameterNames(uri);</span><br><span class="line">    <span class="keyword">for</span> (String name : names) &#123;</span><br><span class="line">        String value = uri.getQueryParameter(name);</span><br><span class="line">        put(bundle, name, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bundle;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æœ¬æ–¹æ³•ä¸»è¦åšçš„äº‹æƒ…å°±æ˜¯æ ¹æ®å‚æ•°åæ¥åˆ¤æ–­å‚æ•°ç±»å‹</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(Bundle bundle, String name, String value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> type = extraTypes.getType(name);</span><br><span class="line">    name = extraTypes.transfer(name);</span><br><span class="line">    <span class="keyword">if</span> (type == ExtraTypes.STRING) &#123;</span><br><span class="line">        type = extraTypes.getType(name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">        <span class="keyword">case</span> ExtraTypes.INT:</span><br><span class="line">            bundle.putInt(name, Integer.parseInt(value));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ExtraTypes.LONG:</span><br><span class="line">            bundle.putLong(name, Long.parseLong(value));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ExtraTypes.BOOL:</span><br><span class="line">            bundle.putBoolean(name, Boolean.parseBoolean(value));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ExtraTypes.SHORT:</span><br><span class="line">            bundle.putShort(name, Short.parseShort(value));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ExtraTypes.FLOAT:</span><br><span class="line">            bundle.putFloat(name, Float.parseFloat(value));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ExtraTypes.DOUBLE:</span><br><span class="line">            bundle.putDouble(name, Double.parseDouble(value));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ExtraTypes.BYTE:</span><br><span class="line">            bundle.putByte(name, Byte.parseByte(value));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ExtraTypes.CHAR:</span><br><span class="line">            bundle.putChar(name, value.charAt(<span class="number">0</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            bundle.putString(name, value);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä»£ç å¾ˆç®€å•ï¼ŒåŸºæœ¬ä¸Šéƒ½åŠ äº†æ³¨é‡Šï¼Œç›¸ä¿¡å¤§å®¶éƒ½çœ‹å¾—æ‡‚ï¼Œå°±ä¸è®²å’¯ã€‚</p>
<p>åˆ°è¿™é‡Œï¼Œæ•´ä¸ª ActivityRouter çš„æµç¨‹å°±è®²å®Œå•¦ã€‚</p>
<p>å‰©ä¸‹çš„ï¼Œå°±æ˜¯ Processor è§£ææ³¨è§£ç”Ÿæˆä»£ç äº†ã€‚</p>
<h2 id="compiler"><a href="#compiler" class="headerlink" title="compiler"></a>compiler</h2><p>å…ˆå‘Šè¯‰å¤„ç†å™¨æ”¯æŒçš„æ³¨è§£</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSupportedAnnotationTypes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Set&lt;String&gt; ret = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">    ret.add(Modules.class.getCanonicalName());</span><br><span class="line">    ret.add(Module.class.getCanonicalName());</span><br><span class="line">    ret.add(Router.class.getCanonicalName());</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‰©ä¸‹ä¸»è¦çœ‹ RouterProcessor çš„ process æ–¹æ³•ã€‚</p>
<p>æ–¹æ³•çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;</span><br><span class="line">    debug(<span class="string">"process apt with "</span> + annotations.toString());</span><br><span class="line">    <span class="keyword">if</span> (annotations.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">boolean</span> hasModule = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> hasModules = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">// module</span></span><br><span class="line">    String moduleName = <span class="string">"RouterMapping"</span>;</span><br><span class="line">    Set&lt;? extends Element&gt; moduleList = roundEnv.getElementsAnnotatedWith(Module.class);</span><br><span class="line">    <span class="keyword">if</span> (moduleList != <span class="keyword">null</span> &amp;&amp; moduleList.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        Module annotation = moduleList.iterator().next().getAnnotation(Module.class);</span><br><span class="line">        moduleName = moduleName + <span class="string">"_"</span> + annotation.value();</span><br><span class="line">        hasModule = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// modules</span></span><br><span class="line">    String[] moduleNames = <span class="keyword">null</span>;</span><br><span class="line">    Set&lt;? extends Element&gt; modulesList = roundEnv.getElementsAnnotatedWith(Modules.class);</span><br><span class="line">    <span class="keyword">if</span> (modulesList != <span class="keyword">null</span> &amp;&amp; modulesList.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        Element modules = modulesList.iterator().next();</span><br><span class="line">        moduleNames = modules.getAnnotation(Modules.class).value();</span><br><span class="line">        hasModules = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// RouterInit</span></span><br><span class="line">    <span class="keyword">if</span> (hasModules) &#123;</span><br><span class="line">        debug(<span class="string">"generate modules RouterInit"</span>);</span><br><span class="line">        generateModulesRouterInit(moduleNames);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!hasModule) &#123;</span><br><span class="line">        debug(<span class="string">"generate default RouterInit"</span>);</span><br><span class="line">        generateDefaultRouterInit();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// RouterMapping</span></span><br><span class="line">    <span class="keyword">return</span> handleRouter(moduleName, roundEnv);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>process æ–¹æ³•ä¸­çš„é€»è¾‘å¯ä»¥åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š</p>
<ul>
<li>åˆ¤æ–­æ˜¯å¦æœ‰ @module å’Œ @modules ï¼Œå³æ˜¯å¦æ˜¯ç»„ä»¶åŒ–å¼€å‘çš„</li>
<li>ç”Ÿæˆ RouterInit</li>
<li>ç”Ÿæˆ RouterMapping</li>
</ul>
<p>é‚£æˆ‘ä»¬æ…¢æ…¢åˆ†æï¼Œå…ˆæ¥çœ‹ç¬¬ä¸€éƒ¨åˆ†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// module</span></span><br><span class="line">String moduleName = <span class="string">"RouterMapping"</span>;</span><br><span class="line">Set&lt;? extends Element&gt; moduleList = roundEnv.getElementsAnnotatedWith(Module.class);</span><br><span class="line"><span class="keyword">if</span> (moduleList != <span class="keyword">null</span> &amp;&amp; moduleList.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    Module annotation = moduleList.iterator().next().getAnnotation(Module.class);</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯å¤š module ç»„ä»¶åŒ–å¼€å‘çš„è¯ï¼Œæ¯ä¸ª module éœ€è¦æ ‡æ³¨ @module ï¼Œè¿™æ ·æ¯ä¸ªmoduleéƒ½ä¼šç”Ÿæˆä¸€ä¸ªå±äºè‡ªå·±çš„ RouterMapping ï¼Œé˜²æ­¢é‡å¤</span></span><br><span class="line">    <span class="comment">// æ¯”å¦‚ @Module("abc") moduleName å°±æ˜¯ RouterMapping_abc</span></span><br><span class="line">    moduleName = moduleName + <span class="string">"_"</span> + annotation.value();</span><br><span class="line">    hasModule = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// @Modules çš„ä½œç”¨å°±æ˜¯æŠŠä¸Šé¢ç”Ÿæˆçš„å„ä¸ª RouterMapping ç»™æ±‡æ€»èµ·æ¥ï¼Œç»Ÿä¸€åˆ° RouterInit é‡Œé¢ï¼Œè¿™æ ·åªè¦è°ƒç”¨ RouterInit.init æ–¹æ³•å°±å®Œæˆäº†å„æ¨¡å—çš„è·¯ç”±åˆå§‹åŒ–</span></span><br><span class="line">String[] moduleNames = <span class="keyword">null</span>;</span><br><span class="line">Set&lt;? extends Element&gt; modulesList = roundEnv.getElementsAnnotatedWith(Modules.class);</span><br><span class="line"><span class="keyword">if</span> (modulesList != <span class="keyword">null</span> &amp;&amp; modulesList.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    Element modules = modulesList.iterator().next();</span><br><span class="line">    <span class="comment">// æ¯”å¦‚@Modules("abc","def") , moduleNames å°±æ˜¯ [â€œabcâ€, "def"]</span></span><br><span class="line">    moduleNames = modules.getAnnotation(Modules.class).value();</span><br><span class="line">    hasModules = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥å°±æ˜¯ç”Ÿæˆ RouterInit ç±»</p>
<figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (hasModules) &#123;</span><br><span class="line">    <span class="keyword">debug</span>(<span class="string">"generate modules RouterInit"</span>);</span><br><span class="line">    generateModulesRouterInit(moduleNames);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!hasModule) &#123;</span><br><span class="line">    <span class="keyword">debug</span>(<span class="string">"generate default RouterInit"</span>);</span><br><span class="line">    generateDefaultRouterInit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ˜¯å¤š module ç»„ä»¶åŒ–å¼€å‘ï¼Œæœ€ç»ˆä¼šè°ƒç”¨ generateModulesRouterInit ï¼Œå¦åˆ™è°ƒç”¨çš„å°±æ˜¯é»˜è®¤çš„ generateDefaultRouterInit ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬å°±çœ‹ generateModulesRouterInit çš„ä»£ç å§ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">generateModulesRouterInit</span><span class="params">(String[] moduleNames)</span> </span>&#123;</span><br><span class="line">    MethodSpec.Builder initMethod = MethodSpec.methodBuilder(<span class="string">"init"</span>)</span><br><span class="line">            .addModifiers(Modifier.PUBLIC, Modifier.FINAL, Modifier.STATIC);</span><br><span class="line">    <span class="keyword">for</span> (String module : moduleNames) &#123;</span><br><span class="line">        initMethod.addStatement(<span class="string">"RouterMapping_"</span> + module + <span class="string">".map()"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    TypeSpec routerInit = TypeSpec.classBuilder(<span class="string">"RouterInit"</span>)</span><br><span class="line">            .addModifiers(Modifier.PUBLIC, Modifier.FINAL)</span><br><span class="line">            .addMethod(initMethod.build())</span><br><span class="line">            .build();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        JavaFile.builder(<span class="string">"com.github.mzule.activityrouter.router"</span>, routerInit)</span><br><span class="line">                .build()</span><br><span class="line">                .writeTo(filer);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œåˆ©ç”¨äº† javapoet æ¥ç”Ÿæˆ java ä»£ç ï¼Œè¿™ä»£ç å¾ˆç®€å•ï¼Œå°±ä¸ç”¨å¤šè®²å•¦ï¼Œç›´æ¥æ¥çœ‹ä¸‹æœ€åç”Ÿæˆ RouterInit ç±»çš„ä»£ç å§</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.github.mzule.activityrouter.router;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RouterInit</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    RouterMapping_app.map();</span><br><span class="line">    RouterMapping_sdk.map();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>RouterInit ç”Ÿæˆå¥½ä¹‹åï¼Œæœ€åçš„å·¥ä½œå°±æ˜¯ç”Ÿæˆå¯¹åº”çš„ RouterMapping_app å’Œ RouterMapping_sdk è¿™ä¸¤ä¸ªç±»äº†ã€‚</p>
<p>ç”Ÿæˆçš„å…¥å£å°±æ˜¯ handleRouter(moduleName, roundEnv) æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">handleRouter</span><span class="params">(String genClassName, RoundEnvironment roundEnv)</span> </span>&#123;</span><br><span class="line">    Set&lt;? extends Element&gt; elements = roundEnv.getElementsAnnotatedWith(Router.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®šä¹‰æ–¹æ³• public static final void map()</span></span><br><span class="line">    MethodSpec.Builder mapMethod = MethodSpec.methodBuilder(<span class="string">"map"</span>)</span><br><span class="line">            .addModifiers(Modifier.PUBLIC, Modifier.FINAL, Modifier.STATIC)</span><br><span class="line">            .addStatement(<span class="string">"java.util.Map&lt;String,String&gt; transfer = null"</span>)</span><br><span class="line">            .addStatement(<span class="string">"com.github.mzule.activityrouter.router.ExtraTypes extraTypes"</span>)</span><br><span class="line">            .addCode(<span class="string">"\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éå† @Router ä¿®é¥°çš„ element</span></span><br><span class="line">    <span class="keyword">for</span> (Element element : elements) &#123;</span><br><span class="line">        Router router = element.getAnnotation(Router.class);</span><br><span class="line">        <span class="comment">// åˆ¤æ–­ @Router ä¸­æœ‰æ²¡æœ‰ transfer</span></span><br><span class="line">        String[] transfer = router.transfer();</span><br><span class="line">        <span class="keyword">if</span> (transfer.length &gt; <span class="number">0</span> &amp;&amp; !<span class="string">""</span>.equals(transfer[<span class="number">0</span>])) &#123;</span><br><span class="line">            mapMethod.addStatement(<span class="string">"transfer = new java.util.HashMap&lt;String, String&gt;()"</span>);</span><br><span class="line">            <span class="keyword">for</span> (String s : transfer) &#123;</span><br><span class="line">                String[] components = s.split(<span class="string">"=&gt;"</span>);</span><br><span class="line">                <span class="keyword">if</span> (components.length != <span class="number">2</span>) &#123;</span><br><span class="line">                    error(<span class="string">"transfer `"</span> + s + <span class="string">"` not match a=&gt;b format"</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                mapMethod.addStatement(<span class="string">"transfer.put($S, $S)"</span>, components[<span class="number">0</span>], components[<span class="number">1</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mapMethod.addStatement(<span class="string">"transfer = null"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è§£æè·¯ç”±å‚æ•°ç±»å‹</span></span><br><span class="line">        mapMethod.addStatement(<span class="string">"extraTypes = new com.github.mzule.activityrouter.router.ExtraTypes()"</span>);</span><br><span class="line">        mapMethod.addStatement(<span class="string">"extraTypes.setTransfer(transfer)"</span>);</span><br><span class="line"></span><br><span class="line">        addStatement(mapMethod, <span class="keyword">int</span>.class, router.intParams());</span><br><span class="line">        addStatement(mapMethod, <span class="keyword">long</span>.class, router.longParams());</span><br><span class="line">        addStatement(mapMethod, <span class="keyword">boolean</span>.class, router.booleanParams());</span><br><span class="line">        addStatement(mapMethod, <span class="keyword">short</span>.class, router.shortParams());</span><br><span class="line">        addStatement(mapMethod, <span class="keyword">float</span>.class, router.floatParams());</span><br><span class="line">        addStatement(mapMethod, <span class="keyword">double</span>.class, router.doubleParams());</span><br><span class="line">        addStatement(mapMethod, <span class="keyword">byte</span>.class, router.byteParams());</span><br><span class="line">        addStatement(mapMethod, <span class="keyword">char</span>.class, router.charParams());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// éå† @Router ç”Ÿæˆæ‰€æœ‰è·¯ç”±çš„è§£æä»£ç </span></span><br><span class="line">        <span class="keyword">for</span> (String format : router.value()) &#123;</span><br><span class="line">            ClassName className;</span><br><span class="line">            Name methodName = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (element.getKind() == ElementKind.CLASS) &#123;</span><br><span class="line">                className = ClassName.get((TypeElement) element);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (element.getKind() == ElementKind.METHOD) &#123;</span><br><span class="line">                className = ClassName.get((TypeElement) element.getEnclosingElement());</span><br><span class="line">                methodName = element.getSimpleName();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"unknow type"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (format.startsWith(<span class="string">"/"</span>)) &#123;</span><br><span class="line">                error(<span class="string">"Router#value can not start with '/'. at ["</span> + className + <span class="string">"]@Router(\""</span> + format + <span class="string">"\")"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (format.endsWith(<span class="string">"/"</span>)) &#123;</span><br><span class="line">                error(<span class="string">"Router#value can not end with '/'. at ["</span> + className + <span class="string">"]@Router(\""</span> + format + <span class="string">"\")"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¦‚æœ @Router æ˜¯ä¿®é¥°ç±»çš„ å°±æ˜¯è·¯ç”±è·³è½¬çš„</span></span><br><span class="line">            <span class="keyword">if</span> (element.getKind() == ElementKind.CLASS) &#123;</span><br><span class="line">                mapMethod.addStatement(<span class="string">"com.github.mzule.activityrouter.router.Routers.map($S, $T.class, null, extraTypes)"</span>, format, className);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// å¦åˆ™å°±æ˜¯è·¯ç”±è°ƒç”¨æ–¹æ³•çš„ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¼ å…¥ MethodInvoker å¯¹è±¡</span></span><br><span class="line">                mapMethod.addStatement(<span class="string">"com.github.mzule.activityrouter.router.Routers.map($S, null, "</span> +</span><br><span class="line">                        <span class="string">"new MethodInvoker() &#123;\n"</span> +</span><br><span class="line">                        <span class="string">"   public void invoke(android.content.Context context, android.os.Bundle bundle) &#123;\n"</span> +</span><br><span class="line">                        <span class="string">"       $T.$N(context, bundle);\n"</span> +</span><br><span class="line">                        <span class="string">"   &#125;\n"</span> +</span><br><span class="line">                        <span class="string">"&#125;, "</span> +</span><br><span class="line">                        <span class="string">"extraTypes)"</span>, format, className, methodName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mapMethod.addCode(<span class="string">"\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    TypeSpec routerMapping = TypeSpec.classBuilder(genClassName)</span><br><span class="line">            .addModifiers(Modifier.PUBLIC, Modifier.FINAL)</span><br><span class="line">            .addMethod(mapMethod.build())</span><br><span class="line">            .build();</span><br><span class="line">    <span class="comment">// ç”Ÿæˆ RouterMapping_xxx ç±»</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        JavaFile.builder(<span class="string">"com.github.mzule.activityrouter.router"</span>, routerMapping)</span><br><span class="line">                .build()</span><br><span class="line">                .writeTo(filer);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”Ÿæˆ extraTypes å‚æ•°ç±»å‹è®¾ç½®ä»£ç </span></span><br><span class="line"><span class="comment">// æ¯”å¦‚ </span></span><br><span class="line"><span class="comment">// extraTypes.setLongExtra("id,updateTime".split(","));</span></span><br><span class="line"><span class="comment">// extraTypes.setBooleanExtra("web".split(","));</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addStatement</span><span class="params">(MethodSpec.Builder mapMethod, Class typeClz, String[] args)</span> </span>&#123;</span><br><span class="line">    String extras = join(args);</span><br><span class="line">    <span class="keyword">if</span> (extras.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        String typeName = typeClz.getSimpleName();</span><br><span class="line">        String s = typeName.substring(<span class="number">0</span>, <span class="number">1</span>).toUpperCase() + typeName.replaceFirst(<span class="string">"\\w"</span>, <span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">        mapMethod.addStatement(<span class="string">"extraTypes.set"</span> + s + <span class="string">"Extra($S.split(\",\"))"</span>, extras);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¥çœ‹ä¸€ä¸‹æœ€åç”Ÿæˆçš„ RouterMapping_xxx çš„ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RouterMapping_app</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    java.util.Map&lt;String,String&gt; transfer = <span class="keyword">null</span>;</span><br><span class="line">    com.github.mzule.activityrouter.router.ExtraTypes extraTypes;</span><br><span class="line"></span><br><span class="line">    transfer = <span class="keyword">null</span>;</span><br><span class="line">    extraTypes = <span class="keyword">new</span> com.github.mzule.activityrouter.router.ExtraTypes();</span><br><span class="line">    extraTypes.setTransfer(transfer);</span><br><span class="line">    com.github.mzule.activityrouter.router.Routers.map(<span class="string">"user/:userId"</span>, UserActivity.class, <span class="keyword">null</span>, extraTypes);</span><br><span class="line">    com.github.mzule.activityrouter.router.Routers.map(<span class="string">"user/:nickname/city/:city/gender/:gender/age/:age"</span>, UserActivity.class, <span class="keyword">null</span>, extraTypes);</span><br><span class="line"></span><br><span class="line">    transfer = <span class="keyword">new</span> java.util.HashMap&lt;String, String&gt;();</span><br><span class="line">    transfer.put(<span class="string">"web"</span>, <span class="string">"fromWeb"</span>);</span><br><span class="line">    extraTypes = <span class="keyword">new</span> com.github.mzule.activityrouter.router.ExtraTypes();</span><br><span class="line">    extraTypes.setTransfer(transfer);</span><br><span class="line">    extraTypes.setLongExtra(<span class="string">"id,updateTime"</span>.split(<span class="string">","</span>));</span><br><span class="line">    extraTypes.setBooleanExtra(<span class="string">"web"</span>.split(<span class="string">","</span>));</span><br><span class="line">    com.github.mzule.activityrouter.router.Routers.map(<span class="string">"http://mzule.com/main"</span>, MainActivity.class, <span class="keyword">null</span>, extraTypes);</span><br><span class="line">    com.github.mzule.activityrouter.router.Routers.map(<span class="string">"main"</span>, MainActivity.class, <span class="keyword">null</span>, extraTypes);</span><br><span class="line">    com.github.mzule.activityrouter.router.Routers.map(<span class="string">"home"</span>, MainActivity.class, <span class="keyword">null</span>, extraTypes);</span><br><span class="line"></span><br><span class="line">    transfer = <span class="keyword">null</span>;</span><br><span class="line">    extraTypes = <span class="keyword">new</span> com.github.mzule.activityrouter.router.ExtraTypes();</span><br><span class="line">    extraTypes.setTransfer(transfer);</span><br><span class="line">    com.github.mzule.activityrouter.router.Routers.map(<span class="string">"with_host"</span>, HostActivity.class, <span class="keyword">null</span>, extraTypes);</span><br><span class="line"></span><br><span class="line">    transfer = <span class="keyword">null</span>;</span><br><span class="line">    extraTypes = <span class="keyword">new</span> com.github.mzule.activityrouter.router.ExtraTypes();</span><br><span class="line">    extraTypes.setTransfer(transfer);</span><br><span class="line">    com.github.mzule.activityrouter.router.Routers.map(<span class="string">"home/:homeName"</span>, HomeActivity.class, <span class="keyword">null</span>, extraTypes);</span><br><span class="line"></span><br><span class="line">    transfer = <span class="keyword">null</span>;</span><br><span class="line">    extraTypes = <span class="keyword">new</span> com.github.mzule.activityrouter.router.ExtraTypes();</span><br><span class="line">    extraTypes.setTransfer(transfer);</span><br><span class="line">    com.github.mzule.activityrouter.router.Routers.map(<span class="string">"logout"</span>, <span class="keyword">null</span>, <span class="keyword">new</span> MethodInvoker() &#123;</span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(android.content.Context context, android.os.Bundle bundle)</span> </span>&#123;</span><br><span class="line">               NonUIActions.logout(context, bundle);</span><br><span class="line">           &#125;</span><br><span class="line">        &#125;, extraTypes);</span><br><span class="line"></span><br><span class="line">    transfer = <span class="keyword">null</span>;</span><br><span class="line">    extraTypes = <span class="keyword">new</span> com.github.mzule.activityrouter.router.ExtraTypes();</span><br><span class="line">    extraTypes.setTransfer(transfer);</span><br><span class="line">    com.github.mzule.activityrouter.router.Routers.map(<span class="string">"upload"</span>, <span class="keyword">null</span>, <span class="keyword">new</span> MethodInvoker() &#123;</span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(android.content.Context context, android.os.Bundle bundle)</span> </span>&#123;</span><br><span class="line">               NonUIActions.uploadLog(context, bundle);</span><br><span class="line">           &#125;</span><br><span class="line">        &#125;, extraTypes);</span><br><span class="line"></span><br><span class="line">    transfer = <span class="keyword">null</span>;</span><br><span class="line">    extraTypes = <span class="keyword">new</span> com.github.mzule.activityrouter.router.ExtraTypes();</span><br><span class="line">    extraTypes.setTransfer(transfer);</span><br><span class="line">    com.github.mzule.activityrouter.router.Routers.map(<span class="string">"user/collection"</span>, UserCollectionActivity.class, <span class="keyword">null</span>, extraTypes);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è‡³æ­¤ï¼ŒActivityRouter æ‰€æœ‰çš„æµç¨‹éƒ½å·²ç»è®²å®Œå•¦ï¼ï¼ï¼</p>
<h2 id="RouterActivity"><a href="#RouterActivity" class="headerlink" title="RouterActivity"></a>RouterActivity</h2><p>å¯¹å•¦ï¼Œè¿˜æœ‰ä¸€ç‚¹ï¼ŒActivityRouter æ”¯æŒä»å¤–éƒ¨å”¤èµ· Activity ã€‚</p>
<p>åœ¨ AndroidManifest.xml ä¸­å£°æ˜ RouterActivity ï¼Œå¡«å†™å¯¹åº” scheme å’Œ host ã€‚</p>
<pre><code>&lt;activity
    android:name=&quot;com.github.mzule.activityrouter.router.RouterActivity&quot;
    android:theme=&quot;@android:style/Theme.NoDisplay&quot;&gt;
    ...
    &lt;intent-filter&gt;
        &lt;action android:name=&quot;android.intent.action.VIEW&quot; /&gt;
        &lt;category android:name=&quot;android.intent.category.DEFAULT&quot; /&gt;
        &lt;category android:name=&quot;android.intent.category.BROWSABLE&quot; /&gt;
        &lt;data android:scheme=&quot;http&quot; android:host=&quot;mzule.com&quot; /&gt;
    &lt;/intent-filter&gt;
&lt;/activity&gt;
</code></pre><p>å…¶å®å…ˆå”¤èµ·çš„æ˜¯ RouterActivity ï¼Œç„¶ååœ¨ RouterActivity ä¸­æ ¹æ® uri å†è·³è½¬åˆ°å¯¹åº”çš„ Activity ï¼Œè¿™ç‚¹å¯ä»¥ä» RouterActivity çš„ä»£ç ä¸­å°è¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RouterActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line"></span><br><span class="line">        RouterCallback callback = getRouterCallback();</span><br><span class="line"></span><br><span class="line">        Uri uri = getIntent().getData();</span><br><span class="line">        <span class="keyword">if</span> (uri != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Routers.open(<span class="keyword">this</span>, uri, callback);</span><br><span class="line">        &#125;</span><br><span class="line">        finish();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> RouterCallback <span class="title">getRouterCallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (getApplication() <span class="keyword">instanceof</span> RouterCallbackProvider) &#123;</span><br><span class="line">            <span class="keyword">return</span> ((RouterCallbackProvider) getApplication()).provideRouterCallback();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸‹çœŸçš„æ˜¯è®²å®Œå•¦</p>
<p>è®²å®Œå•¦</p>
<p>å®Œå•¦</p>
<p>å•¦</p>
<h1 id="Footer"><a href="#Footer" class="headerlink" title="Footer"></a>Footer</h1><p>å…¶å®ç°åœ¨å¸‚é¢çš„è·¯ç”±æ¡†æ¶åŸºæœ¬ä¸Šéƒ½æ˜¯è¿™ç§å¥—è·¯ï¼Œäº†è§£å…¶ä¸­çš„å¥¥ä¹‰å¯ä»¥æ›´å¥½åœ°ä½¿ç”¨å®ƒã€‚</p>
<p>æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å†å»çœ‹ä¸‹ ARouter ä¹‹ç±»çš„æºç ï¼Œç›¸ä¿¡æ”¶è·ä¼šæ›´å¤§ï¼</p>
<p>å†è§ğŸ‘‹</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>ActivityRouter ï¼š<a href="https://github.com/mzule/ActivityRouter" target="_blank" rel="external">https://github.com/mzule/ActivityRouter<]]>
    </summary>
    
      <category term="Android" scheme="http://yuqirong.me/tags/Android/"/>
    
      <category term="æºç è§£æ" scheme="http://yuqirong.me/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    
      <category term="Android Blog" scheme="http://yuqirong.me/categories/Android-Blog/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Android Architecture Componentä¹‹Lifecycleè§£æ]]></title>
    <link href="http://yuqirong.me/2018/07/15/Android%20Architecture%20Component%E4%B9%8BLifecycle%E8%A7%A3%E6%9E%90/"/>
    <id>http://yuqirong.me/2018/07/15/Android Architecture Componentä¹‹Lifecycleè§£æ/</id>
    <published>2018-07-14T16:29:11.000Z</published>
    <updated>2018-11-11T12:07:49.022Z</updated>
    <content type="html"><![CDATA[<h1 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h1><p>ç»ˆäºåˆ°äº†æœ€åçš„å…³å¤´ï¼ŒAndroid Architecture Component ç³»åˆ—çš„æœ€åä¸€èŠ‚å†…å®¹ã€‚ä»Šå¤©ç»™å¤§å®¶å¸¦æ¥çš„å°±æ˜¯ Lifecycle çš„è§£æã€‚</p>
<p>è‡³äº Lifecycle çš„ä½œç”¨å°±ä¸è¿‡å¤šä»‹ç»ï¼Œç®€å•çš„æ¥è¯´å°±æ˜¯è®©ä½ è‡ªå·±å®šä¹‰çš„ä¸œè¥¿å¯ä»¥æ„ŸçŸ¥ç”Ÿå‘½å‘¨æœŸã€‚æ¯”å¦‚ä½ æƒ³è®¾è®¡äº†ä¸€ä¸ª GPS ä½ç½®ç›‘å¬å™¨ï¼Œæ‰“ç®—åœ¨ Activity å¯äº¤äº’çŠ¶æ€ä¸‹å‘é€åœ°å€ä½ç½®ï¼Œé‚£ä¹ˆå°±å¯ä»¥åˆ©ç”¨ Lifecycle æ¥åšè¿™ä»¶äº‹ï¼Œè¿™æ ·å’Œ Activity çš„è€¦åˆæ€§å°±å‡å°‘äº†å¾ˆå¤šã€‚</p>
<p>åºŸè¯ä¸å¤šè¯´äº†ï¼Œå°±æ¥çœ‹çœ‹ Lifecycle å†…éƒ¨çš„å®ç°åŸç†å§ã€‚</p>
<h1 id="Lifecycle"><a href="#Lifecycle" class="headerlink" title="Lifecycle"></a>Lifecycle</h1><h1 id="Part_1"><a href="#Part_1" class="headerlink" title="Part 1"></a>Part 1</h1><h2 id="LifecycleOwner"><a href="#LifecycleOwner" class="headerlink" title="LifecycleOwner"></a>LifecycleOwner</h2><p>å…ˆæ¥çœ‹ LifecycleOwner æ¥å£ï¼Œè¿™ä¸ªæ¥å£å®šä¹‰å°±è¯´æ˜äº†æŸæ ·ä¸œè¥¿æ˜¯å…·æœ‰ç”Ÿå‘½å‘¨æœŸçš„ã€‚getLifecycle() æ–¹æ³•è¿”å›ç”Ÿå‘½å‘¨æœŸã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LifecycleOwner</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Returns the Lifecycle of the provider.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> The lifecycle of the provider.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="annotation">@NonNull</span></span><br><span class="line">    <span class="function">Lifecycle <span class="title">getLifecycle</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®˜æ–¹å»ºè®®é™¤äº† Activity å’Œ Fragment ä¹‹å¤–ï¼Œå…¶ä»–çš„ä»£ç éƒ½ä¸åº”è¯¥å®ç° LifecycleOwner è¿™ä¸ªæ¥å£ã€‚</p>
<p>ç›®å‰ SupportActivity å’Œ Fragment éƒ½å®ç°äº†è¯¥æ¥å£ã€‚</p>
<h2 id="Lifecycle-1"><a href="#Lifecycle-1" class="headerlink" title="Lifecycle"></a>Lifecycle</h2><p>åœ¨ä¸Šé¢æˆ‘ä»¬çœ‹åˆ° LifecycleOwner æ¥å£çš„ getLifecycle() æ–¹æ³•è¿”å›äº† Lifecycle ã€‚Lifecycle ä»£è¡¨ç€ç”Ÿå‘½å‘¨æœŸï¼Œé‚£ä¹ˆæ¥çœ‹çœ‹ Lifecycle æ˜¯æ€ä¹ˆå®šä¹‰çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Lifecycle</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@MainThread</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">addObserver</span><span class="params">(@NonNull LifecycleObserver observer)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@MainThread</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">removeObserver</span><span class="params">(@NonNull LifecycleObserver observer)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@MainThread</span></span><br><span class="line">    <span class="annotation">@NonNull</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> State <span class="title">getCurrentState</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@SuppressWarnings</span>(<span class="string">"WeakerAccess"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> Event &#123;</span><br><span class="line">        <span class="comment">/**</span><br><span class="line">         * Constant for onCreate event of the &#123;<span class="doctag">@link</span> LifecycleOwner&#125;.</span><br><span class="line">         */</span></span><br><span class="line">        ON_CREATE,</span><br><span class="line">        <span class="comment">/**</span><br><span class="line">         * Constant for onStart event of the &#123;<span class="doctag">@link</span> LifecycleOwner&#125;.</span><br><span class="line">         */</span></span><br><span class="line">        ON_START,</span><br><span class="line">        <span class="comment">/**</span><br><span class="line">         * Constant for onResume event of the &#123;<span class="doctag">@link</span> LifecycleOwner&#125;.</span><br><span class="line">         */</span></span><br><span class="line">        ON_RESUME,</span><br><span class="line">        <span class="comment">/**</span><br><span class="line">         * Constant for onPause event of the &#123;<span class="doctag">@link</span> LifecycleOwner&#125;.</span><br><span class="line">         */</span></span><br><span class="line">        ON_PAUSE,</span><br><span class="line">        <span class="comment">/**</span><br><span class="line">         * Constant for onStop event of the &#123;<span class="doctag">@link</span> LifecycleOwner&#125;.</span><br><span class="line">         */</span></span><br><span class="line">        ON_STOP,</span><br><span class="line">        <span class="comment">/**</span><br><span class="line">         * Constant for onDestroy event of the &#123;<span class="doctag">@link</span> LifecycleOwner&#125;.</span><br><span class="line">         */</span></span><br><span class="line">        ON_DESTROY,</span><br><span class="line">        <span class="comment">/**</span><br><span class="line">         * An &#123;<span class="doctag">@link</span> Event Event&#125; constant that can be used to match all events.</span><br><span class="line">         */</span></span><br><span class="line">        ON_ANY</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@SuppressWarnings</span>(<span class="string">"WeakerAccess"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> State &#123;</span><br><span class="line">        <span class="comment">/**</span><br><span class="line">         * Destroyed state for a LifecycleOwner. After this event, this Lifecycle will not dispatch</span><br><span class="line">         * any more events. For instance, for an &#123;<span class="doctag">@link</span> android.app.Activity&#125;, this state is reached</span><br><span class="line">         * &lt;b&gt;right before&lt;/b&gt; Activity's &#123;<span class="doctag">@link</span> android.app.Activity#onDestroy() onDestroy&#125; call.</span><br><span class="line">         */</span></span><br><span class="line">        DESTROYED,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span><br><span class="line">         * Initialized state for a LifecycleOwner. For an &#123;<span class="doctag">@link</span> android.app.Activity&#125;, this is</span><br><span class="line">         * the state when it is constructed but has not received</span><br><span class="line">         * &#123;<span class="doctag">@link</span> android.app.Activity#onCreate(android.os.Bundle) onCreate&#125; yet.</span><br><span class="line">         */</span></span><br><span class="line">        INITIALIZED,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span><br><span class="line">         * Created state for a LifecycleOwner. For an &#123;<span class="doctag">@link</span> android.app.Activity&#125;, this state</span><br><span class="line">         * is reached in two cases:</span><br><span class="line">         * &lt;ul&gt;</span><br><span class="line">         *     &lt;li&gt;after &#123;<span class="doctag">@link</span> android.app.Activity#onCreate(android.os.Bundle) onCreate&#125; call;</span><br><span class="line">         *     &lt;li&gt;&lt;b&gt;right before&lt;/b&gt; &#123;<span class="doctag">@link</span> android.app.Activity#onStop() onStop&#125; call.</span><br><span class="line">         * &lt;/ul&gt;</span><br><span class="line">         */</span></span><br><span class="line">        CREATED,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span><br><span class="line">         * Started state for a LifecycleOwner. For an &#123;<span class="doctag">@link</span> android.app.Activity&#125;, this state</span><br><span class="line">         * is reached in two cases:</span><br><span class="line">         * &lt;ul&gt;</span><br><span class="line">         *     &lt;li&gt;after &#123;<span class="doctag">@link</span> android.app.Activity#onStart() onStart&#125; call;</span><br><span class="line">         *     &lt;li&gt;&lt;b&gt;right before&lt;/b&gt; &#123;<span class="doctag">@link</span> android.app.Activity#onPause() onPause&#125; call.</span><br><span class="line">         * &lt;/ul&gt;</span><br><span class="line">         */</span></span><br><span class="line">        STARTED,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span><br><span class="line">         * Resumed state for a LifecycleOwner. For an &#123;<span class="doctag">@link</span> android.app.Activity&#125;, this state</span><br><span class="line">         * is reached after &#123;<span class="doctag">@link</span> android.app.Activity#onResume() onResume&#125; is called.</span><br><span class="line">         */</span></span><br><span class="line">        RESUMED;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span><br><span class="line">         * Compares if this State is greater or equal to the given &#123;<span class="doctag">@code</span> state&#125;.</span><br><span class="line">         *</span><br><span class="line">         * <span class="doctag">@param</span> state State to compare with</span><br><span class="line">         * <span class="doctag">@return</span> true if this State is greater or equal to the given &#123;<span class="doctag">@code</span> state&#125;</span><br><span class="line">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAtLeast</span><span class="params">(@NonNull State state)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> compareTo(state) &gt;= <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Lifecycle æ˜¯ä¸ªæŠ½è±¡ç±»ï¼Œå…¶ä¸­å®šä¹‰äº†ï¼š</p>
<ul>
<li>addObserver ï¼šå¢åŠ è§‚å¯Ÿè€…ï¼Œè§‚å¯Ÿè€…å¯ä»¥è§‚å¯Ÿåˆ°è¯¥ç”Ÿå‘½å‘¨æœŸçš„å˜åŒ–ï¼Œå…·ä½“çš„è§‚å¯Ÿè€…å°±æ˜¯ LifecycleObserver ï¼›</li>
<li>removeObserver ï¼šç§»é™¤è§‚å¯Ÿè€… LifecycleObserver ï¼›</li>
<li>getCurrentState ï¼šè¿”å›å½“å‰ç”Ÿå‘½å‘¨æœŸçš„çŠ¶æ€ï¼›</li>
<li>Event ï¼šç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼›</li>
<li>State ï¼šç”Ÿå‘½å‘¨æœŸçŠ¶æ€ï¼›</li>
</ul>
<p>è‡³äº Event å’Œ State çš„å…³ç³»æˆ‘ä»¬ç­‰åˆ°äº†ä¸‹é¢å†è®²ã€‚</p>
<p>åˆ°è¿™ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ SupportActivity å’Œ Fragment åœ¨ getLifecycle æ–¹æ³•ä¸­è¿”å›äº†ä»€ä¹ˆï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Lifecycle <span class="title">getLifecycle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mLifecycleRegistry;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‘ç°è¿”å›çš„æ˜¯ LifecycleRegistry çš„ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œ LifecycleRegistry å°±æ˜¯ Lifecycle çš„å®ç°ç±»ã€‚</p>
<p>æˆ‘ä»¬å…ˆæŠŠå¯¹ LifecycleRegistry çš„è§£ææ”¾ä¸€æ”¾ï¼Œå…ˆæ¥çœ‹çœ‹ç”Ÿå‘½å‘¨æœŸè§‚å¯Ÿè€… LifecycleObserver ã€‚</p>
<h2 id="LifecycleObserver"><a href="#LifecycleObserver" class="headerlink" title="LifecycleObserver"></a>LifecycleObserver</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@SuppressWarnings</span>(<span class="string">"WeakerAccess"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LifecycleObserver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>LifecycleObserver æ˜¯ä¸ªç©ºæ¥å£ï¼Œé‡Œé¢ä»€ä¹ˆéƒ½æ²¡æœ‰ã€‚é‚£æˆ‘ä»¬è‡ªå·±å®šä¹‰ä¸€ä¸ªç±» MyLifecycleObserver æ¥å®ç° LifecycleObserver æ¥å£ï¼Œä»¥è¾¾åˆ°è§‚å¯Ÿç”Ÿå‘½å‘¨æœŸçš„ç›®çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyLifecycleObserver</span> <span class="keyword">implements</span> <span class="title">LifecycleObserver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@OnLifecycleEvent</span>(Lifecycle.Event.ON_ANY)</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">onAny</span><span class="params">(LifecycleOwner owner, Lifecycle.Event event)</span> </span>&#123;</span><br><span class="line">	    System.out.println(<span class="string">"onAny:"</span> + event.name());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@OnLifecycleEvent</span>(Lifecycle.Event.ON_CREATE)</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	    System.out.println(<span class="string">"onCreate"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@OnLifecycleEvent</span>(Lifecycle.Event.ON_DESTROY)</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	    System.out.println(<span class="string">"onDestroy"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶ååœ¨ MainActivity é‡Œé¢æ·»åŠ æˆ‘ä»¬çš„ MyLifecycleObserver è§‚å¯Ÿè€…ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_main);</span><br><span class="line">    getLifecycle().addObserver(<span class="keyword">new</span> MyLifecycleObserver());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ä¹‹å‰åˆ†æçš„ä»£ç æˆ‘ä»¬å¯ä»¥è§‚å¯Ÿåˆ°ï¼ŒgetLifecycle() è¿”å›çš„å°±æ˜¯ LifecycleRegistry å¯¹è±¡ã€‚æ‰€ä»¥å…¶å®è°ƒç”¨çš„å°±æ˜¯ LifecycleRegistry çš„ addObserver æ–¹æ³•æ¥æ·»åŠ è§‚å¯Ÿè€…çš„ã€‚</p>
<h2 id="LifecycleRegistry"><a href="#LifecycleRegistry" class="headerlink" title="LifecycleRegistry"></a>LifecycleRegistry</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addObserver</span><span class="params">(@NonNull LifecycleObserver observer)</span> </span>&#123;</span><br><span class="line">    State initialState = mState == DESTROYED ? DESTROYED : INITIALIZED;</span><br><span class="line">    ObserverWithState statefulObserver = <span class="keyword">new</span> ObserverWithState(observer, initialState);</span><br><span class="line">    ObserverWithState previous = mObserverMap.putIfAbsent(observer, statefulObserver);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (previous != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    LifecycleOwner lifecycleOwner = mLifecycleOwner.get();</span><br><span class="line">    <span class="keyword">if</span> (lifecycleOwner == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// it is null we should be destroyed. Fallback quickly</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> isReentrance = mAddingObserverCounter != <span class="number">0</span> || mHandlingEvent;</span><br><span class="line">    State targetState = calculateTargetState(observer);</span><br><span class="line">    mAddingObserverCounter++;</span><br><span class="line">    <span class="keyword">while</span> ((statefulObserver.mState.compareTo(targetState) &lt; <span class="number">0</span></span><br><span class="line">            &amp;&amp; mObserverMap.contains(observer))) &#123;</span><br><span class="line">        pushParentState(statefulObserver.mState);</span><br><span class="line">        statefulObserver.dispatchEvent(lifecycleOwner, upEvent(statefulObserver.mState));</span><br><span class="line">        popParentState();</span><br><span class="line">        <span class="comment">// mState / subling may have been changed recalculate</span></span><br><span class="line">        targetState = calculateTargetState(observer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isReentrance) &#123;</span><br><span class="line">        <span class="comment">// we do sync only on the top level.</span></span><br><span class="line">        sync();</span><br><span class="line">    &#125;</span><br><span class="line">    mAddingObserverCounter--;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸€å¼€å§‹ï¼Œé’ˆå¯¹æ¯ä¸ª LifecycleObserver å¯¹è±¡è®¾ç½®äº†ä¸€ä¸ªåˆå§‹çŠ¶æ€ initialState ï¼Œç„¶åç»“åˆåˆå§‹çŠ¶æ€ initialState å’Œ observer ï¼ŒæŠŠå®ƒä¿©åŒ…è£…æˆä¸€ä¸ª ObserverWithState å¯¹è±¡ã€‚å¹¶ä¿å­˜åˆ° mObserverMap ä¸­ã€‚ mObserverMap ç¼“å­˜äº†æ‰€æœ‰çš„ç”Ÿå‘½å‘¨æœŸè§‚å¯Ÿè€…ã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹ ObserverWithState é‡Œé¢çš„æ“ä½œã€‚</p>
<h2 id="ObserverWithState"><a href="#ObserverWithState" class="headerlink" title="ObserverWithState"></a>ObserverWithState</h2><p>ObserverWithState æ˜¯ LifecycleRegistry çš„é™æ€å†…éƒ¨ç±»ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ObserverWithState</span> </span>&#123;</span><br><span class="line">    State mState;</span><br><span class="line">    GenericLifecycleObserver mLifecycleObserver;</span><br><span class="line"></span><br><span class="line">    ObserverWithState(LifecycleObserver observer, State initialState) &#123;</span><br><span class="line">        mLifecycleObserver = Lifecycling.getCallback(observer);</span><br><span class="line">        mState = initialState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dispatchEvent</span><span class="params">(LifecycleOwner owner, Event event)</span> </span>&#123;</span><br><span class="line">        State newState = getStateAfter(event);</span><br><span class="line">        mState = min(mState, newState);</span><br><span class="line">        mLifecycleObserver.onStateChanged(owner, event);</span><br><span class="line">        mState = newState;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ ObserverWithState ä¸­ï¼Œæˆ‘ä»¬æœ‰ç‚¹è¹Šè··ï¼ŒmLifecycleObserver çš„ç±»å‹æ˜¯ GenericLifecycleObserver ï¼Œä½†æ˜¯æˆ‘ä»¬ä¼ å…¥çš„æ˜¯ LifecycleObserver ç±»å‹ã€‚æ‰€ä»¥åœ¨ Lifecycling.getCallback(observer) è¿™å¥ä»£ç ä¸­åšçš„äº‹æƒ…å°±æ˜¯æŠŠ LifecycleObserver è½¬åŒ–æˆ GenericLifecycleObserver ï¼Œæˆ‘ä»¬æ·±å…¥äº†è§£ä¸‹ã€‚</p>
<h2 id="Lifecycling"><a href="#Lifecycling" class="headerlink" title="Lifecycling"></a>Lifecycling</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@NonNull</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> GenericLifecycleObserver <span class="title">getCallback</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (object <span class="keyword">instanceof</span> FullLifecycleObserver) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FullLifecycleObserverAdapter((FullLifecycleObserver) object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (object <span class="keyword">instanceof</span> GenericLifecycleObserver) &#123;</span><br><span class="line">        <span class="keyword">return</span> (GenericLifecycleObserver) object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Class&lt;?&gt; klass = object.getClass();</span><br><span class="line">    <span class="keyword">int</span> type = getObserverConstructorType(klass);</span><br><span class="line">    <span class="keyword">if</span> (type == GENERATED_CALLBACK) &#123;</span><br><span class="line">        List&lt;Constructor&lt;? extends GeneratedAdapter&gt;&gt; constructors =</span><br><span class="line">                sClassToAdapters.get(klass);</span><br><span class="line">        <span class="keyword">if</span> (constructors.size() == <span class="number">1</span>) &#123;</span><br><span class="line">            GeneratedAdapter generatedAdapter = createGeneratedAdapter(</span><br><span class="line">                    constructors.get(<span class="number">0</span>), object);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SingleGeneratedAdapterObserver(generatedAdapter);</span><br><span class="line">        &#125;</span><br><span class="line">        GeneratedAdapter[] adapters = <span class="keyword">new</span> GeneratedAdapter[constructors.size()];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; constructors.size(); i++) &#123;</span><br><span class="line">            adapters[i] = createGeneratedAdapter(constructors.get(i), object);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CompositeGeneratedAdaptersObserver(adapters);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ReflectiveGenericLifecycleObserver(object);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ ¹æ®ä»£ç å¯ä»¥å¤§æ¦‚çŸ¥é“ï¼Œåœ¨ getCallback ä¸­ä¸»è¦åšçš„äº‹æƒ…å°±æ˜¯åˆ©ç”¨é€‚é…å™¨ Adapter æŠŠ LifeObserver è½¬åŒ–æˆ GenericLifecycleObserver ã€‚</p>
<p>ä¹‹å‰æˆ‘ä»¬å®šä¹‰çš„ MyLifecycleObserver æ˜¯ç›´æ¥å®ç° LifecycleObserver æ¥å£çš„ï¼Œæ‰€ä»¥å®ƒä¸å±äº FullLifecycleObserver æˆ–è€… FullLifecycleObserver ï¼Œå› æ­¤å®ƒä¼šå»æ‰§è¡Œ getObserverConstructorType(klass) æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getObserverConstructorType</span><span class="params">(Class&lt;?&gt; klass)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœä¹‹å‰è§£æè¿‡äº†ï¼Œç›´æ¥è¿”å›ç¼“å­˜</span></span><br><span class="line">    <span class="keyword">if</span> (sCallbackCache.containsKey(klass)) &#123;</span><br><span class="line">        <span class="keyword">return</span> sCallbackCache.get(klass);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦åˆ™è°ƒç”¨ resolveObserverCallbackType è¿›è¡Œè§£æç±»å‹</span></span><br><span class="line">    <span class="keyword">int</span> type = resolveObserverCallbackType(klass);</span><br><span class="line">    sCallbackCache.put(klass, type);</span><br><span class="line">    <span class="keyword">return</span> type;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ getObserverConstructorType ä¸­ï¼Œä¸»è¦è¿˜æ˜¯è¦çœ‹ resolveObserverCallbackType æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">resolveObserverCallbackType</span><span class="params">(Class&lt;?&gt; klass)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// anonymous class bug:35073837</span></span><br><span class="line">    <span class="keyword">if</span> (klass.getCanonicalName() == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> REFLECTIVE_CALLBACK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨æ„è¿™é‡Œè°ƒç”¨äº† generatedConstructor æ¥ç”Ÿæˆäº† GeneratedAdapter çš„æ„é€ å™¨</span></span><br><span class="line">    Constructor&lt;? extends GeneratedAdapter&gt; constructor = generatedConstructor(klass);</span><br><span class="line">    <span class="keyword">if</span> (constructor != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¾—åˆ°æ„é€ å™¨åè¿›è¡Œç¼“å­˜</span></span><br><span class="line">        sClassToAdapters.put(klass, Collections</span><br><span class="line">                .&lt;Constructor&lt;? extends GeneratedAdapter&gt;&gt;singletonList(constructor));</span><br><span class="line">        <span class="keyword">return</span> GENERATED_CALLBACK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> hasLifecycleMethods = ClassesInfoCache.sInstance.hasLifecycleMethods(klass);</span><br><span class="line">    <span class="keyword">if</span> (hasLifecycleMethods) &#123;</span><br><span class="line">        <span class="keyword">return</span> REFLECTIVE_CALLBACK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt; superclass = klass.getSuperclass();</span><br><span class="line">    List&lt;Constructor&lt;? extends GeneratedAdapter&gt;&gt; adapterConstructors = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (isLifecycleParent(superclass)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (getObserverConstructorType(superclass) == REFLECTIVE_CALLBACK) &#123;</span><br><span class="line">            <span class="keyword">return</span> REFLECTIVE_CALLBACK;</span><br><span class="line">        &#125;</span><br><span class="line">        adapterConstructors = <span class="keyword">new</span> ArrayList&lt;&gt;(sClassToAdapters.get(superclass));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; intrface : klass.getInterfaces()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isLifecycleParent(intrface)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (getObserverConstructorType(intrface) == REFLECTIVE_CALLBACK) &#123;</span><br><span class="line">            <span class="keyword">return</span> REFLECTIVE_CALLBACK;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (adapterConstructors == <span class="keyword">null</span>) &#123;</span><br><span class="line">            adapterConstructors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        adapterConstructors.addAll(sClassToAdapters.get(intrface));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (adapterConstructors != <span class="keyword">null</span>) &#123;</span><br><span class="line">        sClassToAdapters.put(klass, adapterConstructors);</span><br><span class="line">        <span class="keyword">return</span> GENERATED_CALLBACK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> REFLECTIVE_CALLBACK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>resolveObserverCallbackType æ–¹æ³•ä¸­è°ƒç”¨ generatedConstructor æ¥ç”Ÿæˆ MyLifecycleObserver çš„ GeneratedAdapter æ„é€ å™¨ã€‚çœ‹åˆ°è¿™é‡Œå¯èƒ½å¾ˆå¤šäººä¼šæ‡µé€¼ï¼Œä»€ä¹ˆæ˜¯ GeneratedAdapter ï¼Ÿ</p>
<h2 id="GeneratedAdapter"><a href="#GeneratedAdapter" class="headerlink" title="GeneratedAdapter"></a>GeneratedAdapter</h2><p>å…¶å® GeneratedAdapter å¯ä»¥ç†è§£ä¸ºç³»ç»Ÿä¸ºæˆ‘ä»¬çš„ MyLifecycleObserver è€Œè®¾è®¡é€‚é…å™¨ã€‚</p>
<p>æ¯”å¦‚ï¼Œæˆ‘ä»¬åœ¨ MyLifecycleObserver é‡Œè®¾è®¡äº† onCreate æ–¹æ³•åœ¨ç”Ÿå‘½å‘¨æœŸçš„åˆ›å»ºçŠ¶æ€æ¥å›è°ƒï¼Œä½†æ˜¯ç³»ç»Ÿå¹¶ä¸çŸ¥é“è¿™ä¸ª onCreate æ–¹æ³•ã€‚æ‰€ä»¥éœ€è¦è®¾è®¡å‡ºä¸€å¥—é€‚é…å™¨æ¥é€‚é…æˆ‘ä»¬çš„ MyLifecycleObserver ã€‚</p>
<p>é‚£ä¹ˆè¿™ä¸ªé€‚é…å™¨çš„ä»£ç ä¹Ÿéœ€è¦æˆ‘ä»¬æ¥å†™å—ï¼Ÿä¸éœ€è¦ï¼Œåœ¨ç¼–è¯‘æœŸæ—¶ apt è‡ªåŠ¨å¸®æˆ‘ä»¬ç”Ÿæˆå¥½äº†ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ build/generated/source/apt ç›®å½•ä¸‹æ‰¾åˆ°è‡ªåŠ¨ç”Ÿæˆçš„ GeneratedAdapter ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyLifecycleObserver_LifecycleAdapter</span> <span class="keyword">implements</span> <span class="title">GeneratedAdapter</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> MyLifecycleObserver mReceiver;</span><br><span class="line"></span><br><span class="line">  MyLifecycleObserver_LifecycleAdapter(MyLifecycleObserver receiver) &#123;</span><br><span class="line">    <span class="keyword">this</span>.mReceiver = receiver;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="annotation">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callMethods</span><span class="params">(LifecycleOwner owner, Lifecycle.Event event, <span class="keyword">boolean</span> onAny,</span><br><span class="line">      MethodCallsLogger logger)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> hasLogger = logger != <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (onAny) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!hasLogger || logger.approveCall(<span class="string">"onAny"</span>, <span class="number">4</span>)) &#123;</span><br><span class="line">        mReceiver.onAny(owner,event);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (event == Lifecycle.Event.ON_CREATE) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!hasLogger || logger.approveCall(<span class="string">"onCreate"</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">        mReceiver.onCreate();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (event == Lifecycle.Event.ON_DESTROY) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!hasLogger || logger.approveCall(<span class="string">"onDestroy"</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">        mReceiver.onDestroy();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ°è¿™é‡Œå°±çœŸç›¸å¤§ç™½äº†å§ï¼Œæ‰€ä»¥åœ¨ generatedConstructor æ–¹æ³•ä¸­ç”Ÿæˆçš„å°±æ˜¯ MyLifecycleObserver_LifecycleAdapter çš„æ„é€ å™¨ã€‚</p>
<p>å…·ä½“ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Nullable</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Constructor&lt;? extends GeneratedAdapter&gt; generatedConstructor(Class&lt;?&gt; klass) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Package aPackage = klass.getPackage();</span><br><span class="line">        String name = klass.getCanonicalName();</span><br><span class="line">        <span class="keyword">final</span> String fullPackage = aPackage != <span class="keyword">null</span> ? aPackage.getName() : <span class="string">""</span>;</span><br><span class="line">        <span class="comment">// è·å–aptè‡ªåŠ¨ç”Ÿæˆçš„GeneratedAdapterçš„ç±»åï¼Œåœ¨è¿™é‡Œå°±æ˜¯ MyLifecycleObserver_LifecycleAdapter</span></span><br><span class="line">        <span class="keyword">final</span> String adapterName = getAdapterName(fullPackage.isEmpty() ? name :</span><br><span class="line">                name.substring(fullPackage.length() + <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@SuppressWarnings</span>(<span class="string">"unchecked"</span>) <span class="keyword">final</span> Class&lt;? extends GeneratedAdapter&gt; aClass =</span><br><span class="line">                (Class&lt;? extends GeneratedAdapter&gt;) Class.forName(</span><br><span class="line">                        fullPackage.isEmpty() ? adapterName : fullPackage + <span class="string">"."</span> + adapterName);</span><br><span class="line">        Constructor&lt;? extends GeneratedAdapter&gt; constructor =</span><br><span class="line">                aClass.getDeclaredConstructor(klass);</span><br><span class="line">        <span class="keyword">if</span> (!constructor.isAccessible()) &#123;</span><br><span class="line">            constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> constructor;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">        <span class="comment">// this should not happen</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å†å›åˆ° resolveObserverCallbackType æ–¹æ³•ï¼Œè·å–åˆ° MyLifecycleObserver_LifecycleAdapter æ„é€ å™¨åï¼Œç›´æ¥è¿”å›äº† GENERATED_CALLBACK ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Constructor&lt;? extends GeneratedAdapter&gt; constructor = generatedConstructor(klass);</span><br><span class="line"><span class="keyword">if</span> (constructor != <span class="keyword">null</span>) &#123;</span><br><span class="line">    sClassToAdapters.put(klass, Collections</span><br><span class="line">            .&lt;Constructor&lt;? extends GeneratedAdapter&gt;&gt;singletonList(constructor));</span><br><span class="line">    <span class="keyword">return</span> GENERATED_CALLBACK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶ååœ¨ getCallback æ–¹æ³•ä¸­ä¼šæ‰§è¡Œï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (type == GENERATED_CALLBACK) &#123;</span><br><span class="line">    List&lt;Constructor&lt;? extends GeneratedAdapter&gt;&gt; constructors =</span><br><span class="line">            sClassToAdapters.get(klass);</span><br><span class="line">    <span class="comment">// MyLifecycleObserver_LifecycleAdapter çš„æ„é€ å™¨åªæœ‰ä¸€ä¸ªï¼Œæ‰€ä»¥é€‚é…åˆ›å»ºå‡ºæ¥çš„æ˜¯ SingleGeneratedAdapterObserver</span></span><br><span class="line">    <span class="keyword">if</span> (constructors.size() == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// è¿™é‡Œçš„ generatedAdapter å°±æ˜¯ MyLifecycleObserver_LifecycleAdapter</span></span><br><span class="line">        GeneratedAdapter generatedAdapter = createGeneratedAdapter(</span><br><span class="line">                constructors.get(<span class="number">0</span>), object);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å•ä¸ªæ„é€ å™¨</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SingleGeneratedAdapterObserver(generatedAdapter);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è‡³äºä»€ä¹ˆæ—¶å€™ MyLifecycleObserver_LifecycleAdapter ä¼šæœ‰å¤šä¸ªæ„é€ å™¨ç›®å‰æˆ‘è¿˜ä¸æ¸…æ¥šï¼Œå¦‚æœæœ‰å¤§ç¥çŸ¥é“çš„è¯è¯·å‘ŠçŸ¥æˆ‘ä¸‹</span></span><br><span class="line">    GeneratedAdapter[] adapters = <span class="keyword">new</span> GeneratedAdapter[constructors.size()];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; constructors.size(); i++) &#123;</span><br><span class="line">        adapters[i] = createGeneratedAdapter(constructors.get(i), object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤šä¸ªæ„é€ å™¨</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> CompositeGeneratedAdaptersObserver(adapters);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› ä¸º MyLifecycleObserver_LifecycleAdapter çš„æ„é€ å™¨å°±åªæœ‰ä¸€ä¸ªï¼Œæ‰€ä»¥ LifecycleObserver è½¬åŒ–æˆäº† SingleGeneratedAdapterObserver ã€‚</p>
<h2 id="SingleGeneratedAdapterObserver"><a href="#SingleGeneratedAdapterObserver" class="headerlink" title="SingleGeneratedAdapterObserver"></a>SingleGeneratedAdapterObserver</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@RestrictTo</span>(RestrictTo.Scope.LIBRARY_GROUP)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleGeneratedAdapterObserver</span> <span class="keyword">implements</span> <span class="title">GenericLifecycleObserver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GeneratedAdapter mGeneratedAdapter;</span><br><span class="line"></span><br><span class="line">    SingleGeneratedAdapterObserver(GeneratedAdapter generatedAdapter) &#123;</span><br><span class="line">        mGeneratedAdapter = generatedAdapter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStateChanged</span><span class="params">(LifecycleOwner source, Lifecycle.Event event)</span> </span>&#123;</span><br><span class="line">        mGeneratedAdapter.callMethods(source, event, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">        mGeneratedAdapter.callMethods(source, event, <span class="keyword">true</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SingleGeneratedAdapterObserver æ˜¯å®ç°äº† GenericLifecycleObserver è¿™ä¸ªæ¥å£çš„ã€‚ç»è¿‡ä¸Šé¢çš„ä¸€ç³»åˆ—æ“ä½œï¼Œæˆ‘ä»¬çš„ MyLifecycleObserver å°±è¢«é€‚é…æˆäº† SingleGeneratedAdapterObserver ã€‚</p>
<h2 id="ObserverWithState-1"><a href="#ObserverWithState-1" class="headerlink" title="ObserverWithState"></a>ObserverWithState</h2><p>å…¶å®åœ¨ ObserverWithState è¿˜æœ‰ä¸€ä¸ªæ–¹æ³• ï¼š dispatchEvent ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatchEvent</span><span class="params">(LifecycleOwner owner, Event event)</span> </span>&#123;</span><br><span class="line">    State newState = getStateAfter(event);</span><br><span class="line">    mState = min(mState, newState);</span><br><span class="line">    <span class="comment">// mLifecycleObserver å°±æ˜¯ä¸Šé¢çš„ SingleGeneratedAdapterObserver</span></span><br><span class="line">    mLifecycleObserver.onStateChanged(owner, event);</span><br><span class="line">    mState = newState;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>dispatchEvent ä¼šåœ¨ç”Ÿå‘½å‘¨æœŸå‘ç”Ÿæ”¹å˜æ—¶ï¼Œç„¶åé€šçŸ¥è§‚å¯Ÿè€…çš„æ—¶å€™è°ƒç”¨ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç†ä¸€ç†è°ƒç”¨é“¾ï¼š</p>
<p>ç”Ÿå‘½å‘¨æœŸå‘ç”Ÿæ”¹å˜ -&gt; ObserverWithState.dispatchEvent -&gt; SingleGeneratedAdapterObserver.onStateChanged -&gt; MyLifecycleObserver_LifecycleAdapter.callMethods -&gt; MyLifecycleObserver.onCreate/onAny/onDestroy</p>
<p>çœ‹å®Œæœ‰æ²¡æœ‰ä¸€ç§åŸæ¥å¦‚æ­¤ã€æç„¶å¤§æ‚Ÿçš„æ„Ÿè§‰ï¼Ÿ</p>
<h1 id="Part_2"><a href="#Part_2" class="headerlink" title="Part 2"></a>Part 2</h1><p>é‚£ä¹ˆä»€ä¹ˆæ—¶å€™ä¼šå»è°ƒç”¨ ObserverWithState.dispatchEvent çš„æ–¹æ³•å‘¢ï¼Ÿ</p>
<p>ç­”æ¡ˆå°±æ˜¯åœ¨ LifecycleRegistry.handleLifecycleEvent ã€‚ handleLifecycleEvent æ–¹æ³•å°±æ˜¯è¢«è®¾è®¡ä¸ºè®¾ç½®ç”Ÿå‘½å‘¨æœŸçŠ¶æ€å¹¶é€šçŸ¥è§‚å¯Ÿè€…çš„ã€‚</p>
<h2 id="LifecycleRegistry-1"><a href="#LifecycleRegistry-1" class="headerlink" title="LifecycleRegistry"></a>LifecycleRegistry</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleLifecycleEvent</span><span class="params">(@NonNull Lifecycle.Event event)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ ¹æ® event æ¥å¾—åˆ°ä¸‹ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸçš„çŠ¶æ€å€¼</span></span><br><span class="line">    State next = getStateAfter(event);</span><br><span class="line">    <span class="comment">// å°†å½“å‰ç”Ÿå‘½å‘¨æœŸçŠ¶æ€å€¼æ”¹æˆ next ï¼Œå¹¶é€šçŸ¥è§‚å¯Ÿè€…</span></span><br><span class="line">    moveToState(next);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨è¿™é‡Œæ­£å¥½æŠŠ event å’Œ state çš„å…³ç³»æ‹ä¸€æ‹ï¼Œè¿™æ˜¯å®˜æ–¹ç»™å‡ºçš„å‚è€ƒå›¾ï¼Œç®€æ˜æ‰¼è¦ã€‚</p>
<p><img src="/uploads/20180715/20180715050357.png" alt="event and state"></p>
<p>ä¸‹é¢å°±æ¥çœ‹çœ‹ moveToState æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">moveToState</span><span class="params">(State next)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mState == next) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mState = next;</span><br><span class="line">    <span class="keyword">if</span> (mHandlingEvent || mAddingObserverCounter != <span class="number">0</span>) &#123;</span><br><span class="line">        mNewEventOccurred = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">// we will figure out what to do on upper level.</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mHandlingEvent = <span class="keyword">true</span>;</span><br><span class="line">    sync();</span><br><span class="line">    mHandlingEvent = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœå½“å‰ç”Ÿå‘½å‘¨æœŸçš„çŠ¶æ€å·²ç»åŒæ­¥å®Œæˆäº†ï¼Œå°±ç›´æ¥ return æ‰ã€‚å¦åˆ™å°±ä¼šåŒæ­¥å¹¶è°ƒç”¨ sync æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    LifecycleOwner lifecycleOwner = mLifecycleOwner.get();</span><br><span class="line">    <span class="keyword">if</span> (lifecycleOwner == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Log.w(LOG_TAG, <span class="string">"LifecycleOwner is garbage collected, you shouldn't try dispatch "</span></span><br><span class="line">                + <span class="string">"new events from it."</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (!isSynced()) &#123;</span><br><span class="line">        mNewEventOccurred = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// no need to check eldest for nullability, because isSynced does it for us.</span></span><br><span class="line">        <span class="keyword">if</span> (mState.compareTo(mObserverMap.eldest().getValue().mState) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            backwardPass(lifecycleOwner);</span><br><span class="line">        &#125;</span><br><span class="line">        Entry&lt;LifecycleObserver, ObserverWithState&gt; newest = mObserverMap.newest();</span><br><span class="line">        <span class="keyword">if</span> (!mNewEventOccurred &amp;&amp; newest != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; mState.compareTo(newest.getValue().mState) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            forwardPass(lifecycleOwner);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mNewEventOccurred = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸»è¦åšçš„äº‹æƒ…å°±æ˜¯æ¯”è¾ƒå½“å‰ç”Ÿå‘½å‘¨æœŸçš„çŠ¶æ€å’Œæˆ‘ä»¬å­˜æ”¾åœ¨ mObserverMap ä¸­æœ€æ—©æˆ–æœ€æ–°æ”¾å…¥çš„è§‚å¯Ÿè€…çš„çŠ¶æ€ï¼Œé€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“æ˜¯ ObserverWithState é‡Œé¢ä¸€å¼€å§‹æœ‰æˆ‘ä»¬æ·»åŠ è§‚å¯Ÿè€…æ—¶çš„åˆå§‹çŠ¶æ€ã€‚</p>
<p>å‡å¦‚ç”Ÿå‘½å‘¨æœŸå½“å‰çŠ¶æ€ mState æ˜¯ STARTED ,è€Œè§‚å¯Ÿè€…çš„çŠ¶æ€æ˜¯ CREATEDï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦é€šè¿‡ forwardPass() é€šçŸ¥æ‰€æœ‰çš„è§‚å¯Ÿè€…å½“å‰ç”Ÿå‘½å‘¨æœŸçš„çŠ¶æ€æ”¹å˜åˆ°äº† STARTED ï¼Œè¯·åŒæ­¥ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">forwardPass</span><span class="params">(LifecycleOwner lifecycleOwner)</span> </span>&#123;</span><br><span class="line">    Iterator&lt;Entry&lt;LifecycleObserver, ObserverWithState&gt;&gt; ascendingIterator =</span><br><span class="line">            mObserverMap.iteratorWithAdditions();</span><br><span class="line">    <span class="keyword">while</span> (ascendingIterator.hasNext() &amp;&amp; !mNewEventOccurred) &#123;</span><br><span class="line">        Entry&lt;LifecycleObserver, ObserverWithState&gt; entry = ascendingIterator.next();</span><br><span class="line">        ObserverWithState observer = entry.getValue();</span><br><span class="line">        <span class="keyword">while</span> ((observer.mState.compareTo(mState) &lt; <span class="number">0</span> &amp;&amp; !mNewEventOccurred</span><br><span class="line">                &amp;&amp; mObserverMap.contains(entry.getKey()))) &#123;</span><br><span class="line">            pushParentState(observer.mState);</span><br><span class="line">            observer.dispatchEvent(lifecycleOwner, upEvent(observer.mState));</span><br><span class="line">            popParentState();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆå¾ªåéå†å­˜å‚¨äº†æ‰€æœ‰è§‚å¯Ÿè€…çš„ mObserverMap ï¼Œç¬¬äºŒä¸ª while æ˜¯è¦åˆ†å‘å¤„ç†å„ä¸ªçŠ¶æ€ç»è¿‡çš„ event ã€‚</p>
<p>æ¯”å¦‚å½“å‰çŠ¶æ€ mState æ˜¯ RESUMED ï¼Œè€Œ ObserverWithState ä¸­çš„ state æ˜¯ INITIALIZED ã€‚é‚£ä¹ˆè°ƒç”¨ ObserverWithState çš„ dispatchEvent æ–¹æ³•å°±è¦åˆ†å‘ ON_CREATE ï¼ŒON_START ï¼ŒON_RESUME äº†ã€‚</p>
<h1 id="Part_3"><a href="#Part_3" class="headerlink" title="Part 3"></a>Part 3</h1><p>é—®é¢˜åˆæ¥äº†ï¼Œåˆ°åº•æ˜¯è°è°ƒç”¨äº† handleLifecycleEvent å‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬å¯ä»¥åœ¨æœ€ç»ˆ merge å¥½çš„ AndroidManifest ä¸­å»å¯»æ‰¾ç­”æ¡ˆã€‚</p>
<p>æˆ‘ä»¬å‘ç°äº†è¿™è´§ ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">provider</span></span><br><span class="line">    <span class="attribute">android:name</span>=<span class="value">"android.arch.lifecycle.ProcessLifecycleOwnerInitializer"</span></span><br><span class="line">    <span class="attribute">android:authorities</span>=<span class="value">"com.yuqirong.multiscrolllayout.lifecycle-trojan"</span></span><br><span class="line">    <span class="attribute">android:exported</span>=<span class="value">"false"</span></span><br><span class="line">    <span class="attribute">android:multiprocess</span>=<span class="value">"true"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>è¿› ProcessLifecycleOwnerInitializer é‡Œçœ‹çœ‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@RestrictTo</span>(RestrictTo.Scope.LIBRARY_GROUP)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProcessLifecycleOwnerInitializer</span> <span class="keyword">extends</span> <span class="title">ContentProvider</span> </span>&#123;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        LifecycleDispatcher.init(getContext());</span><br><span class="line">        ProcessLifecycleOwner.init(getContext());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‡Œé¢æœ‰ä¸ª LifecycleDispatcher ï¼Œä¸€å¬åå­—ä¸Šå°±çŒœåˆ°å®ƒåšçš„æ˜¯ç”Ÿå‘½å‘¨æœŸåˆ†å‘çš„å·¥ä½œã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LifecycleDispatcher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String REPORT_FRAGMENT_TAG = <span class="string">"android.arch.lifecycle"</span></span><br><span class="line">            + <span class="string">".LifecycleDispatcher.report_fragment_tag"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> AtomicBoolean sInitialized = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (sInitialized.getAndSet(<span class="keyword">true</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ³¨å†Œäº†ActivityLifecycleCallbacks</span></span><br><span class="line">        ((Application) context.getApplicationContext())</span><br><span class="line">                .registerActivityLifecycleCallbacks(<span class="keyword">new</span> DispatcherActivityCallback());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@SuppressWarnings</span>(<span class="string">"WeakerAccess"</span>)</span><br><span class="line">    <span class="annotation">@VisibleForTesting</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DispatcherActivityCallback</span> <span class="keyword">extends</span> <span class="title">EmptyActivityLifecycleCallbacks</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> FragmentCallback mFragmentCallback;</span><br><span class="line"></span><br><span class="line">        DispatcherActivityCallback() &#123;</span><br><span class="line">            mFragmentCallback = <span class="keyword">new</span> FragmentCallback();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityCreated</span><span class="params">(Activity activity, Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// æ³¨å†Œäº†ä¸€ä¸ªFragmentLifecycleCallbacksï¼Œè¿™ä¸ªæ˜¯ç›‘æ§fragmentçš„ç”Ÿå‘½å‘¨æœŸå›è°ƒ</span></span><br><span class="line">            <span class="keyword">if</span> (activity <span class="keyword">instanceof</span> FragmentActivity) &#123;</span><br><span class="line">                ((FragmentActivity) activity).getSupportFragmentManager()</span><br><span class="line">                        .registerFragmentLifecycleCallbacks(mFragmentCallback, <span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// è¿™å¥ä»£ç å¾ˆå…³é”® </span></span><br><span class="line">            ReportFragment.injectIfNeededIn(activity);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityStopped</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (activity <span class="keyword">instanceof</span> FragmentActivity) &#123;</span><br><span class="line">                markState((FragmentActivity) activity, CREATED);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivitySaveInstanceState</span><span class="params">(Activity activity, Bundle outState)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (activity <span class="keyword">instanceof</span> FragmentActivity) &#123;</span><br><span class="line">                markState((FragmentActivity) activity, CREATED);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‘ç°æœ‰ä¸€ä¸ª ReportFragment.injectIfNeededIn(activity); è¿›è¿™é‡Œé¢çœ‹çœ‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@RestrictTo</span>(RestrictTo.Scope.LIBRARY_GROUP)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReportFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String REPORT_FRAGMENT_TAG = <span class="string">"android.arch.lifecycle"</span></span><br><span class="line">            + <span class="string">".LifecycleDispatcher.report_fragment_tag"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">injectIfNeededIn</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ProcessLifecycleOwner should always correctly work and some activities may not extend</span></span><br><span class="line">        <span class="comment">// FragmentActivity from support lib, so we use framework fragments for activities</span></span><br><span class="line">        android.app.FragmentManager manager = activity.getFragmentManager();</span><br><span class="line">        <span class="keyword">if</span> (manager.findFragmentByTag(REPORT_FRAGMENT_TAG) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            manager.beginTransaction().add(<span class="keyword">new</span> ReportFragment(), REPORT_FRAGMENT_TAG).commit();</span><br><span class="line">            <span class="comment">// Hopefully, we are the first to make a transaction.</span></span><br><span class="line">            manager.executePendingTransactions();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> ReportFragment <span class="title">get</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (ReportFragment) activity.getFragmentManager().findFragmentByTag(</span><br><span class="line">                REPORT_FRAGMENT_TAG);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ActivityInitializationListener mProcessListener;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatchCreate</span><span class="params">(ActivityInitializationListener listener)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</span><br><span class="line">            listener.onCreate();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatchStart</span><span class="params">(ActivityInitializationListener listener)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</span><br><span class="line">            listener.onStart();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatchResume</span><span class="params">(ActivityInitializationListener listener)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</span><br><span class="line">            listener.onResume();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityCreated</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onActivityCreated(savedInstanceState);</span><br><span class="line">        dispatchCreate(mProcessListener);</span><br><span class="line">        dispatch(Lifecycle.Event.ON_CREATE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onStart();</span><br><span class="line">        dispatchStart(mProcessListener);</span><br><span class="line">        dispatch(Lifecycle.Event.ON_START);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onResume();</span><br><span class="line">        dispatchResume(mProcessListener);</span><br><span class="line">        dispatch(Lifecycle.Event.ON_RESUME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onPause();</span><br><span class="line">        dispatch(Lifecycle.Event.ON_PAUSE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onStop();</span><br><span class="line">        dispatch(Lifecycle.Event.ON_STOP);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">        dispatch(Lifecycle.Event.ON_DESTROY);</span><br><span class="line">        <span class="comment">// just want to be sure that we won't leak reference to an activity</span></span><br><span class="line">        mProcessListener = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatch</span><span class="params">(Lifecycle.Event event)</span> </span>&#123;</span><br><span class="line">        Activity activity = getActivity();</span><br><span class="line">        <span class="keyword">if</span> (activity <span class="keyword">instanceof</span> LifecycleRegistryOwner) &#123;</span><br><span class="line">            ((LifecycleRegistryOwner) activity).getLifecycle().handleLifecycleEvent(event);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (activity <span class="keyword">instanceof</span> LifecycleOwner) &#123;</span><br><span class="line">            Lifecycle lifecycle = ((LifecycleOwner) activity).getLifecycle();</span><br><span class="line">            <span class="keyword">if</span> (lifecycle <span class="keyword">instanceof</span> LifecycleRegistry) &#123;</span><br><span class="line">                ((LifecycleRegistry) lifecycle).handleLifecycleEvent(event);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setProcessListener</span><span class="params">(ActivityInitializationListener processListener)</span> </span>&#123;</span><br><span class="line">        mProcessListener = processListener;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">ActivityInitializationListener</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æŠŠ ReportFragment åŠ å…¥åˆ° Activity ä¸­,ç„¶ååœ¨å…¶å„ä¸ªç”Ÿå‘½å‘¨æœŸä¸­éƒ½ä¼šè°ƒç”¨ dispatch() æ–¹æ³•ã€‚è€Œ dispatch æ–¹æ³•æœ€åè°ƒç”¨äº† LifecycleRegistry.RehandleLifecycleEvent ã€‚</p>
<p>è‡³æ­¤ï¼ŒLifecycle çš„æ•´ä¸ªæµç¨‹éƒ½æ¢³ç†å®Œæˆäº†ã€‚</p>
<h1 id="Footer"><a href="#Footer" class="headerlink" title="Footer"></a>Footer</h1><p>æˆ‘ä»¬ç»ˆäºå®Œæˆäº†å¯¹ Android Architecture Component çš„æ•´ä½“æºç è§£æï¼Œå…¶ä¸­æ¶‰åŠåˆ°äº† LiveData ã€ ViewModel å’Œ Lifecycle ã€‚å½“ç„¶å‡ºæ­¤ä¹‹å¤–è¿˜æœ‰ Room å’Œ Paging Library ç­‰ä¹Ÿæ˜¯ä¸é”™çš„é€‰æ‹©ï¼Œæš‚æ—¶å°±å‘Šä¸€æ®µè½äº†ã€‚è‡³äº Room ç­‰æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥ä¸‹å»è‡ªå·±ç ”ç©¶ä¸‹ï¼Œæ‹œæ‹œï¼</p>
<p>bye ~~</p>
]]></content>
    <summary type="html">
    <![CDATA[<h1 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h1><p>ç»ˆäºåˆ°äº†æœ€åçš„å…³å¤´ï¼ŒAndroid Architecture Component ç³»åˆ—çš„æœ€åä¸€èŠ‚å†…å®¹ã€‚ä»Šå¤©ç»™]]>
    </summary>
    
      <category term="Android" scheme="http://yuqirong.me/tags/Android/"/>
    
      <category term="Android Architecture Component" scheme="http://yuqirong.me/tags/Android-Architecture-Component/"/>
    
      <category term="å¼€æºæ¡†æ¶" scheme="http://yuqirong.me/tags/%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/"/>
    
      <category term="æºç è§£æ" scheme="http://yuqirong.me/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    
      <category term="Android Blog" scheme="http://yuqirong.me/categories/Android-Blog/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Android Architecture Componentä¹‹ViewModelè§£æ]]></title>
    <link href="http://yuqirong.me/2018/07/09/Android%20Architecture%20Component%E4%B9%8BViewModel%E8%A7%A3%E6%9E%90/"/>
    <id>http://yuqirong.me/2018/07/09/Android Architecture Componentä¹‹ViewModelè§£æ/</id>
    <published>2018-07-09T14:52:33.000Z</published>
    <updated>2018-11-11T12:22:46.628Z</updated>
    <content type="html"><![CDATA[<h1 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h1><p>ä¹‹å‰ç»™å¤§å®¶åˆ†æè¿‡äº† LiveData ï¼Œä»Šå¤©å°±æ¥çœ‹çœ‹ ViewModel ã€‚</p>
<p>ViewModel çš„ä½œç”¨å°±ç›¸å½“äº MVP ä¸­çš„ Presenter ï¼Œæ˜¯ç”¨æ¥è¡”æ¥ Model å’Œ View çš„ã€‚é€šå¸¸æŠŠä¸€äº›ä¸ View æ— å…³çš„ä¸šåŠ¡é€»è¾‘å†™åœ¨ ViewModel é‡Œé¢ã€‚ViewModel å†…éƒ¨åˆ›å»ºå‡º LiveData å¯¹è±¡ï¼Œåˆ©ç”¨ LiveData å¯¹è±¡æ¥ä¼ é€’æ•°æ®ç»™ View ã€‚</p>
<p>ViewModel ç›¸å¯¹äº Presenter è€Œè¨€ï¼Œæœ‰ä»¥ä¸‹å‡ ä¸ªå¥½å¤„ï¼š</p>
<ol>
<li>ViewModel å¹¶ä¸ç›´æ¥æŒæœ‰ View ï¼Œæ‰€ä»¥åœ¨ ViewModel é”€æ¯æ—¶ä¸éœ€è¦åƒ Presenter ä¸€æ ·åœ°å»æ‰‹åŠ¨è§£é™¤ View çš„ç»‘å®šï¼Œä¹Ÿå°±ä¸ä¼šé€ æˆæŒæœ‰ View å¯¼è‡´çš„å†…å­˜æ³„æ¼ï¼›</li>
<li>æ¯”å¦‚ Activity é…ç½®æ”¹å˜çš„æƒ…å†µä¸‹ï¼ŒViewModel ä¼šä¿å­˜ä¸ä¼šä¸¢å¤±æ•°æ®ï¼›</li>
<li>ViewModel å¯ä»¥åšåˆ°åœ¨åŒä¸€ä¸ª Activity çš„æƒ…å†µä¸‹ï¼Œå¤šä¸ª Fragment å…±äº«æ•°æ®ï¼›</li>
</ol>
<p>ä¸‹é¢æ˜¯å®˜æ–¹ç»™å‡ºçš„ ViewModel ç”Ÿå‘½å‘¨æœŸå›¾ï¼Œå¤§å®¶éšæ„æ„Ÿå—ä¸€ä¸‹ï¼š</p>
<p><img src="/uploads/20180709/20180709221953.png" alt="ViewModel Lifecycle"></p>
<p>é‚£ä¹ˆå°±å¼€å§‹è¿›å…¥æ­£é¢˜å§ã€‚</p>
<p>æœ¬æ¬¡è§£æçš„ ViewModel æºç åŸºäº <code>android.arch.lifecycle:extensions:1.1.1</code></p>
<h1 id="ViewModel"><a href="#ViewModel" class="headerlink" title="ViewModel"></a>ViewModel</h1><p>å…ˆæ¥çœ‹çœ‹ ViewModel æ˜¯æ€ä¹ˆè¢«åˆ›å»ºå‡ºæ¥çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XXXViewModel xxxViewModel = ViewModelProviders.of(activity).get(XXXViewModel.class)</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ° ViewModel å¹¶ä¸æ˜¯ç®€å•åœ° new å‡ºæ¥çš„ï¼Œè¿™å…¶ä¸­çš„é€»è¾‘è¦éœ€è¦æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æ…¢æ…¢æ­å¼€ã€‚</p>
<p>é‚£ä¹ˆ ViewModel æ˜¯æ€æ ·è¢«å®šä¹‰çš„å‘¢ï¼Ÿ</p>
<h2 id="ViewModel-1"><a href="#ViewModel-1" class="headerlink" title="ViewModel"></a>ViewModel</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewModel</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * This method will be called when this ViewModel is no longer used and will be destroyed.</span><br><span class="line">     * &lt;p&gt;</span><br><span class="line">     * It is useful when ViewModel observes some data and you need to clear this subscription to</span><br><span class="line">     * prevent a leak of this ViewModel.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="annotation">@SuppressWarnings</span>(<span class="string">"WeakerAccess"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCleared</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŸæ¥ ViewModel æ˜¯ä¸ªæŠ½è±¡ç±»ï¼Œé‡Œé¢åªæœ‰ä¸€ä¸ª onCleared() æ–¹æ³•ã€‚ onCleared() ä¼šåœ¨ ViewModel è¢«é”€æ¯æ—¶å›è°ƒï¼Œæ‰€ä»¥å¯ä»¥åœ¨ onCleared() é‡Œé¢åšä¸€äº›é‡Šæ”¾èµ„æºã€æ¸…ç†å†…å­˜çš„æ“ä½œã€‚</p>
<p>å¦å¤–ï¼ŒViewModel è¿˜æœ‰ä¸€ä¸ªå­ç±»ï¼š AndroidViewModel ã€‚AndroidViewModel åœ¨ ViewModel çš„åŸºç¡€ä¸Šå†…éƒ¨åŒ…å«äº† application ã€‚</p>
<h2 id="ViewModelProviders"><a href="#ViewModelProviders" class="headerlink" title="ViewModelProviders"></a>ViewModelProviders</h2><p>æˆ‘ä»¬å°±æ¥æŠ½ä¸å‰¥èŒ§äº†ï¼Œå…ˆä» ViewModelProviders å…¥æ‰‹ã€‚åˆ›å»º ViewModel æ—¶åœ¨ ViewModelProviders ä¸­è°ƒç”¨äº† of æ–¹æ³•ã€‚</p>
<h3 id="of"><a href="#of" class="headerlink" title="of"></a>of</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@NonNull</span></span><br><span class="line"><span class="annotation">@MainThread</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ViewModelProvider <span class="title">of</span><span class="params">(@NonNull FragmentActivity activity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> of(activity, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@NonNull</span></span><br><span class="line"><span class="annotation">@MainThread</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ViewModelProvider <span class="title">of</span><span class="params">(@NonNull Fragment fragment)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> of(fragment, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@NonNull</span></span><br><span class="line"><span class="annotation">@MainThread</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ViewModelProvider <span class="title">of</span><span class="params">(@NonNull Fragment fragment, @Nullable Factory factory)</span> </span>&#123;</span><br><span class="line">    Application application = checkApplication(checkActivity(fragment));</span><br><span class="line">    <span class="keyword">if</span> (factory == <span class="keyword">null</span>) &#123;</span><br><span class="line">        factory = ViewModelProvider.AndroidViewModelFactory.getInstance(application);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ViewModelProvider(ViewModelStores.of(fragment), factory);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@NonNull</span></span><br><span class="line"><span class="annotation">@MainThread</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ViewModelProvider <span class="title">of</span><span class="params">(@NonNull FragmentActivity activity,</span><br><span class="line">        @Nullable Factory factory)</span> </span>&#123;</span><br><span class="line">    Application application = checkApplication(activity);</span><br><span class="line">    <span class="keyword">if</span> (factory == <span class="keyword">null</span>) &#123;</span><br><span class="line">        factory = ViewModelProvider.AndroidViewModelFactory.getInstance(application);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ViewModelProvider(ViewModelStores.of(activity), factory);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>of æ–¹æ³•å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªå…¥å£ï¼Œåˆ†åˆ«å¯¹åº”ç€ Fragment å’Œ Activity ã€‚è¿™ä¹Ÿè¯´æ˜äº† ViewModel çš„ä½œç”¨åŸŸå…¶å®æ˜¯åˆ†ä¸ºä¸¤ä¸ªç»´åº¦çš„ã€‚ä½†æ˜¯è¿™ä¸¤ä¸ªæ–¹æ³•å†…éƒ¨çš„ä»£ç å¾ˆåƒï¼Œé€»è¾‘åŸºæœ¬éƒ½æ˜¯ï¼š</p>
<ol>
<li>å…ˆå»è·å– application ï¼›</li>
<li>åˆ›å»º factory ï¼›</li>
<li>åˆ›å»º ViewModelProvider ï¼ŒViewModelProvider é¡¾åæ€ä¹‰å°±æ˜¯æä¾› ViewModel çš„ï¼›</li>
</ol>
<p>ç¬¬ä¸€æ­¥å°±ä¸ç”¨è¯´äº†ï¼Œç›´æ¥è¿›å…¥ç¬¬äºŒæ­¥å§ã€‚</p>
<h2 id="Factory"><a href="#Factory" class="headerlink" title="Factory"></a>Factory</h2><p>Factory æ˜¯ä»€ä¹ˆä¸œä¸œå‘¢ï¼Œè¯´ç™½äº†å°±æ˜¯ ViewModel çš„åˆ¶é€ å·¥å‚ã€‚æ‰€æœ‰çš„ ViewModel éƒ½æ˜¯ç”± Factory æ¥åˆ›å»ºå‡ºæ¥çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Factory</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Creates a new instance of the given &#123;<span class="doctag">@code</span> Class&#125;.</span><br><span class="line">     * &lt;p&gt;</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> modelClass a &#123;<span class="doctag">@code</span> Class&#125; whose instance is requested</span><br><span class="line">     * <span class="doctag">@param</span> &lt;T&gt;        The type parameter for the ViewModel.</span><br><span class="line">     * <span class="doctag">@return</span> a newly created ViewModel</span><br><span class="line">     */</span></span><br><span class="line">    <span class="annotation">@NonNull</span></span><br><span class="line">    &lt;T extends ViewModel&gt; <span class="function">T <span class="title">create</span><span class="params">(@NonNull Class&lt;T&gt; modelClass)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Factory æ˜¯ä¸ªæ¥å£ï¼Œé‡Œé¢å®šä¹‰äº† create æ–¹æ³•æ¥åˆ›å»º ViewModel ã€‚æ¥çœ‹çœ‹å®ƒçš„å®ç°ç±» NewInstanceFactory ã€‚</p>
<h3 id="NewInstanceFactory"><a href="#NewInstanceFactory" class="headerlink" title="NewInstanceFactory"></a>NewInstanceFactory</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Simple factory, which calls empty constructor on the give class.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">NewInstanceFactory</span> <span class="keyword">implements</span> <span class="title">Factory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@SuppressWarnings</span>(<span class="string">"ClassNewInstance"</span>)</span><br><span class="line">    <span class="annotation">@NonNull</span></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T extends ViewModel&gt; <span class="function">T <span class="title">create</span><span class="params">(@NonNull Class&lt;T&gt; modelClass)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//noinspection TryWithIdenticalCatches</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> modelClass.newInstance();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Cannot create an instance of "</span> + modelClass, e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Cannot create an instance of "</span> + modelClass, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶å®æ²¡å•¥å¥½è¯´çš„ï¼Œå°±æ˜¯åˆ©ç”¨åå°„æ¥åˆ›å»ºå®ä¾‹äº†ï¼Œæ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„å®ç°ç±»ã€‚NewInstanceFactory å…¶å®æ˜¯åˆ›å»ºæ™®é€š ViewModel çš„å·¥å‚ï¼Œè€Œå¦‚æœæƒ³åˆ›å»º AndroidViewModel çš„è¯ï¼Œå·¥å‚å°±è¦é€‰æ‹© AndroidViewModelFactory äº†ã€‚</p>
<h3 id="AndroidViewModelFactory"><a href="#AndroidViewModelFactory" class="headerlink" title="AndroidViewModelFactory"></a>AndroidViewModelFactory</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * &#123;<span class="doctag">@link</span> Factory&#125; which may create &#123;<span class="doctag">@link</span> AndroidViewModel&#125; and</span><br><span class="line"> * &#123;<span class="doctag">@link</span> ViewModel&#125;, which have an empty constructor.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AndroidViewModelFactory</span> <span class="keyword">extends</span> <span class="title">ViewModelProvider</span>.<span class="title">NewInstanceFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> AndroidViewModelFactory sInstance;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Retrieve a singleton instance of AndroidViewModelFactory.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> application an application to pass in &#123;<span class="doctag">@link</span> AndroidViewModel&#125;</span><br><span class="line">     * <span class="doctag">@return</span> A valid &#123;<span class="doctag">@link</span> AndroidViewModelFactory&#125;</span><br><span class="line">     */</span></span><br><span class="line">    <span class="annotation">@NonNull</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AndroidViewModelFactory <span class="title">getInstance</span><span class="params">(@NonNull Application application)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (sInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            sInstance = <span class="keyword">new</span> AndroidViewModelFactory(application);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sInstance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Application mApplication;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Creates a &#123;<span class="doctag">@code</span> AndroidViewModelFactory&#125;</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> application an application to pass in &#123;<span class="doctag">@link</span> AndroidViewModel&#125;</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AndroidViewModelFactory</span><span class="params">(@NonNull Application application)</span> </span>&#123;</span><br><span class="line">        mApplication = application;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@NonNull</span></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T extends ViewModel&gt; <span class="function">T <span class="title">create</span><span class="params">(@NonNull Class&lt;T&gt; modelClass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (AndroidViewModel.class.isAssignableFrom(modelClass)) &#123;</span><br><span class="line">            <span class="comment">//noinspection TryWithIdenticalCatches</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> modelClass.getConstructor(Application.class).newInstance(mApplication);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Cannot create an instance of "</span> + modelClass, e);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Cannot create an instance of "</span> + modelClass, e);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Cannot create an instance of "</span> + modelClass, e);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Cannot create an instance of "</span> + modelClass, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.create(modelClass);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‘ç°åœ¨ AndroidViewModelFactory çš„ create æ–¹æ³•ä¸­ï¼Œå¯¹åˆ›å»º ViewModel çš„æ–¹æ¡ˆåšäº†å…¼å®¹ï¼Œæ‰€ä»¥ AndroidViewModelFactory æ˜¯åŒæ—¶é€‚ç”¨äºåˆ›å»º ViewModel å’Œ AndroidViewModel çš„ã€‚å¹¶ä¸” AndroidViewModelFactory æ˜¯å•ä¾‹å·¥å‚ï¼Œé˜²æ­¢å¤šæ¬¡åˆ›å»ºæµªè´¹å†…å­˜ã€‚</p>
<p>é¢å¤–è¡¥å……ä¸€ç‚¹ï¼Œåœ¨ ViewModelProviders ä¸­æœ‰ä¸€ä¸ªå†…éƒ¨ç±» DefaultFactory ï¼Œç°åœ¨å·²ç»è¢«æ‰“ä¸ŠåºŸå¼ƒçš„æ ‡ç­¾äº†ï¼Œå¯ä»¥çŒœå‡ºè¿™ä¸ª DefaultFactory åº”è¯¥æ˜¯æ—©æœŸç‰ˆæœ¬çš„é»˜è®¤å·¥å‚ç±»ï¼Œç°åœ¨å·²ç»è¢« AndroidViewModelFactory ä»£æ›¿äº†ã€‚</p>
<h2 id="ViewModelStores"><a href="#ViewModelStores" class="headerlink" title="ViewModelStores"></a>ViewModelStores</h2><p>åˆ°è¿™é‡Œ Factory å°±æœ‰äº†ï¼Œé‚£ä¹ˆå°±é‡ç‚¹æ¥çœ‹çœ‹ <code>ViewModelStores.of(activity)</code> è¿™æ®µä»£ç äº†ã€‚ViewModelStores æ˜¯æ ¹æ®ä½œç”¨åŸŸç”¨æ¥æä¾› ViewModelStore çš„ï¼Œè€Œ ViewModelStore çš„ä½œç”¨å°±æ˜¯å­˜å‚¨ ViewModel ï¼Œå†…éƒ¨æ˜¯åˆ©ç”¨ key/value å°† ViewModel ä¿å­˜åœ¨ HashMap ä¸­ï¼Œæ–¹ä¾¿è¯»å†™ï¼Œè¿™é‡Œå°±ä¸å±•ç¤º ViewModelStore çš„æºç äº†ï¼Œå¤§å®¶å¯ä»¥æŠŠ ViewModelStore å½“ä½œ HashMap å°±è¡Œã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Factory methods for &#123;<span class="doctag">@link</span> ViewModelStore&#125; class.</span><br><span class="line"> */</span></span><br><span class="line"><span class="annotation">@SuppressWarnings</span>(<span class="string">"WeakerAccess"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewModelStores</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ViewModelStores</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Returns the &#123;<span class="doctag">@link</span> ViewModelStore&#125; of the given activity.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> activity an activity whose &#123;<span class="doctag">@code</span> ViewModelStore&#125; is requested</span><br><span class="line">     * <span class="doctag">@return</span> a &#123;<span class="doctag">@code</span> ViewModelStore&#125;</span><br><span class="line">     */</span></span><br><span class="line">    <span class="annotation">@NonNull</span></span><br><span class="line">    <span class="annotation">@MainThread</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ViewModelStore <span class="title">of</span><span class="params">(@NonNull FragmentActivity activity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (activity <span class="keyword">instanceof</span> ViewModelStoreOwner) &#123;</span><br><span class="line">            <span class="keyword">return</span> ((ViewModelStoreOwner) activity).getViewModelStore();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> holderFragmentFor(activity).getViewModelStore();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Returns the &#123;<span class="doctag">@link</span> ViewModelStore&#125; of the given fragment.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> fragment a fragment whose &#123;<span class="doctag">@code</span> ViewModelStore&#125; is requested</span><br><span class="line">     * <span class="doctag">@return</span> a &#123;<span class="doctag">@code</span> ViewModelStore&#125;</span><br><span class="line">     */</span></span><br><span class="line">    <span class="annotation">@NonNull</span></span><br><span class="line">    <span class="annotation">@MainThread</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ViewModelStore <span class="title">of</span><span class="params">(@NonNull Fragment fragment)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (fragment <span class="keyword">instanceof</span> ViewModelStoreOwner) &#123;</span><br><span class="line">            <span class="keyword">return</span> ((ViewModelStoreOwner) fragment).getViewModelStore();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> holderFragmentFor(fragment).getViewModelStore();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ ¹æ® ViewModelProviders çš„æ€è·¯ï¼ŒViewModelStores ä¹Ÿæ˜¯åˆ†ä¸ºäº†ä¸¤ä¸ªæ–¹æ³•ï¼Œå¯¹åº”ç€ Fragment å’Œ Activity ã€‚</p>
<ol>
<li>å¦‚æœ Activity å’Œ Fragment å®ç°äº† ViewModelStoreOwner çš„æ¥å£ï¼Œé‚£ä¹ˆç›´æ¥è¿”å›å†…éƒ¨çš„ ViewModelStore å°±è¡Œäº†ï¼›</li>
<li>å¦‚æœæ˜¯ä¹‹å‰è€æ—©ç‰ˆæœ¬çš„ Activity æˆ–è€… Fragment ï¼Œé‚£ä¹ˆå®ƒä»¬è‚¯å®šæ˜¯æ²¡æœ‰å®ç° ViewModelStoreOwner æ¥å£çš„ï¼Œé‚£è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿå¾ˆç®€å•ï¼Œæ–°åˆ›å»ºä¸€ä¸ª Fragment æ¥å…³è” ViewModelStoreOwner å°±å¥½äº†å•Šï¼</li>
</ol>
<p>æ‰€ä»¥å°±æœ‰äº† holderFragmentFor(activity) å’Œ holderFragmentFor(fragment) è¿™æ®µäº†ã€‚</p>
<h2 id="HolderFragment"><a href="#HolderFragment" class="headerlink" title="HolderFragment"></a>HolderFragment</h2><p>HolderFragment å®ç°äº† ViewModelStoreOwner æ¥å£ï¼Œæ‰€ä»¥ HolderFragment çš„ä½œç”¨å°±æ˜¯ä»£æ›¿äº†é‚£äº›ä¹‹å‰æ²¡æœ‰å®ç° ViewModelStoreOwner æ¥å£çš„ Activity/Fragment ã€‚è¿™æ ·ï¼ŒActivity/Fragment ä¹Ÿé—´æ¥åœ°æ‹¥æœ‰äº† ViewModelStore ã€‚</p>
<p>HolderFragment çš„ä»£ç æˆ‘ä»¬å°±åªçœ‹ holderFragmentFor(activity) è¿™ä¸€æ®µå§ï¼ŒholderFragmentFor(fragment) ä¹Ÿæ˜¯ç±»ä¼¼çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * <span class="doctag">@hide</span></span><br><span class="line"> */</span></span><br><span class="line"><span class="annotation">@RestrictTo</span>(RestrictTo.Scope.LIBRARY_GROUP)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HolderFragment <span class="title">holderFragmentFor</span><span class="params">(FragmentActivity activity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sHolderFragmentManager.holderFragmentFor(activity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">HolderFragmentManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">	</span><br><span class="line">    <span class="function">HolderFragment <span class="title">holderFragmentFor</span><span class="params">(FragmentActivity activity)</span> </span>&#123;</span><br><span class="line">        FragmentManager fm = activity.getSupportFragmentManager();</span><br><span class="line">        HolderFragment holder = findHolderFragment(fm);</span><br><span class="line">        <span class="keyword">if</span> (holder != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> holder;</span><br><span class="line">        &#125;</span><br><span class="line">        holder = mNotCommittedActivityHolders.get(activity);</span><br><span class="line">        <span class="keyword">if</span> (holder != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> holder;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!mActivityCallbacksIsAdded) &#123;</span><br><span class="line">            mActivityCallbacksIsAdded = <span class="keyword">true</span>;</span><br><span class="line">            activity.getApplication().registerActivityLifecycleCallbacks(mActivityCallbacks);</span><br><span class="line">        &#125;</span><br><span class="line">        holder = createHolderFragment(fm);</span><br><span class="line">        mNotCommittedActivityHolders.put(activity, holder);</span><br><span class="line">        <span class="keyword">return</span> holder;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶å®å°±æ˜¯æŠŠ HolderFragment æ·»åŠ è¿› Activity é‡Œé¢ï¼Œè¿™æ · HolderFragment å°±å’Œ Activity çš„ç”Ÿå‘½å‘¨æœŸå…³è”åœ¨ä¸€èµ·äº†ã€‚å®é™…ä¸Šè·å–çš„å°±æ˜¯ HolderFragment é‡Œé¢çš„ ViewModelStore ã€‚æ¯ä¸ª Activity é‡Œé¢åªæœ‰ä¸€ä¸ª HolderFragment ã€‚</p>
<p>Fragment ä¹Ÿæ˜¯åŒç†ï¼Œåˆ©ç”¨ getChildFragmentManager() æ¥å¾€é‡Œæ·»åŠ  HolderFragment ã€‚è¿™é‡Œå°±ä¸è®²äº†ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·±å›å»çœ‹çœ‹æºç ã€‚</p>
<p>è‡³æ­¤ï¼Œç”¨æ¥åˆ›å»º ViewModelProvider çš„ä¸¤ä¸ªå…¥å‚ ViewModelStore å’Œ Factory éƒ½è®²å®Œäº†ã€‚</p>
<h2 id="ViewModelProvider"><a href="#ViewModelProvider" class="headerlink" title="ViewModelProvider"></a>ViewModelProvider</h2><p>åˆ›å»ºå‡º ViewModelProvider åï¼Œæœ€åä¸€æ­¥å°±æ˜¯è°ƒç”¨å®ƒçš„ get æ–¹æ³•è¿”å› ViewModel äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@NonNull</span></span><br><span class="line"><span class="annotation">@MainThread</span></span><br><span class="line"><span class="keyword">public</span> &lt;T extends ViewModel&gt; <span class="function">T <span class="title">get</span><span class="params">(@NonNull Class&lt;T&gt; modelClass)</span> </span>&#123;</span><br><span class="line">    String canonicalName = modelClass.getCanonicalName();</span><br><span class="line">    <span class="keyword">if</span> (canonicalName == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Local and anonymous classes can not be ViewModels"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> get(DEFAULT_KEY + <span class="string">":"</span> + canonicalName, modelClass);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@NonNull</span></span><br><span class="line"><span class="annotation">@MainThread</span></span><br><span class="line"><span class="keyword">public</span> &lt;T extends ViewModel&gt; <span class="function">T <span class="title">get</span><span class="params">(@NonNull String key, @NonNull Class&lt;T&gt; modelClass)</span> </span>&#123;</span><br><span class="line">    ViewModel viewModel = mViewModelStore.get(key);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (modelClass.isInstance(viewModel)) &#123;</span><br><span class="line">        <span class="comment">//noinspection unchecked</span></span><br><span class="line">        <span class="keyword">return</span> (T) viewModel;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//noinspection StatementWithEmptyBody</span></span><br><span class="line">        <span class="keyword">if</span> (viewModel != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> log a warning.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    viewModel = mFactory.create(modelClass);</span><br><span class="line">    mViewModelStore.put(key, viewModel);</span><br><span class="line">    <span class="comment">//noinspection unchecked</span></span><br><span class="line">    <span class="keyword">return</span> (T) viewModel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>get æ–¹æ³•å¾ˆ easy ï¼Œå°±æ˜¯åˆ©ç”¨ class çš„ canonicalName ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ key ï¼Œç„¶ååˆ©ç”¨ key å» mViewModelStore ä¸­è·å–ã€‚å¦‚æœæœ‰å€¼å°±è¿”å›ï¼Œå¦åˆ™å°±åˆ©ç”¨ factory åˆ›å»ºæ–°çš„ ViewModel ï¼Œç„¶åä¿å­˜åˆ° mViewModelStore ä¸­å¹¶è¿”å›ã€‚</p>
<p>æ•´ä¸ª ViewModel çš„æºç æµç¨‹åŸºæœ¬ä¸Šå°±è®²å®Œäº†ï¼Œå…¶å®å¹¶ä¸å¤æ‚ã€‚å›å»å¤šå¤šä½“ä¼šï¼Œæ€»èƒ½æ˜ç™½å…¶ä¸­çš„å¥¥ç§˜ã€‚</p>
<p>ä¸‹é¢ï¼Œé¢å¤–ç»™å¤§å®¶è¡¥å……å‡ ä¸ªå°ç‚¹ï¼ŒåŠ ä¸ªé¸¡è…¿ã€‚</p>
<h1 id="Tip"><a href="#Tip" class="headerlink" title="Tip"></a>Tip</h1><h2 id="ViewModel_u7684onCleared_u4EC0_u4E48_u65F6_u5019_u56DE_u8C03"><a href="#ViewModel_u7684onCleared_u4EC0_u4E48_u65F6_u5019_u56DE_u8C03" class="headerlink" title="ViewModelçš„onClearedä»€ä¹ˆæ—¶å€™å›è°ƒ"></a>ViewModelçš„onClearedä»€ä¹ˆæ—¶å€™å›è°ƒ</h2><p>ä¹‹å‰è¯´è¿‡ï¼ŒViewModel æ˜¯ä¿å­˜åœ¨ ViewModelStore é‡Œé¢çš„ï¼Œæ‰€ä»¥ ViewModel çš„é”€æ¯ä¸€å®šæ˜¯åœ¨ ViewModelStore é‡Œé¢æ“ä½œçš„ã€‚</p>
<h3 id="ViewModelStore"><a href="#ViewModelStore" class="headerlink" title="ViewModelStore"></a>ViewModelStore</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> *  Clears internal storage and notifies ViewModels that they are no longer used.</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (ViewModel vm : mMap.values()) &#123;</span><br><span class="line">        vm.onCleared();</span><br><span class="line">    &#125;</span><br><span class="line">    mMap.clear();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ° ViewModelStore çš„ clear() æ–¹æ³•å†…éƒ¨è°ƒç”¨ ViewModel çš„ onCleared() æ–¹æ³•ã€‚é‚£ä¹ˆå“ªé‡Œè°ƒç”¨äº† ViewModelStore çš„ clear() æ–¹æ³•å‘¢ï¼Ÿ</p>
<h3 id="Fragment"><a href="#Fragment" class="headerlink" title="Fragment"></a>Fragment</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Called when the fragment is no longer in use.  This is called</span><br><span class="line"> * after &#123;<span class="doctag">@link</span> #onStop()&#125; and before &#123;<span class="doctag">@link</span> #onDetach()&#125;.</span><br><span class="line"> */</span></span><br><span class="line"><span class="annotation">@CallSuper</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mCalled = <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">// Use mStateSaved instead of isStateSaved() since we're past onStop()</span></span><br><span class="line">    <span class="keyword">if</span> (mViewModelStore != <span class="keyword">null</span> &amp;&amp; !mHost.mFragmentManager.mStateSaved) &#123;</span><br><span class="line">        mViewModelStore.clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥ä»ä»£ç ä¸Šçœ‹åˆ°ï¼ŒFragment çš„é”€æ¯æ“ä½œè°ƒç”¨æ˜¯åœ¨ onDestroy() ä¸­ã€‚</p>
<p>å¦å¤–ï¼Œå¦‚æœçŠ¶æ€ä¿å­˜æ ‡è®°å€¼ mStateSaved ä¸º true çš„æƒ…å†µä¸‹ï¼Œæ˜¯ä¸ä¼šå»æ¸…é™¤ ViewModel çš„ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¸Šé¢ä¸­è®²çš„é…ç½®æ”¹å˜çš„æƒ…å†µä¸‹ï¼Œæ•°æ®å¾—ä»¥ä¿æŒä½çš„åŸå› ã€‚</p>
<h3 id="FragmentActivity"><a href="#FragmentActivity" class="headerlink" title="FragmentActivity"></a>FragmentActivity</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Destroy all fragments.</span><br><span class="line"> */</span></span><br><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onDestroy();</span><br><span class="line"></span><br><span class="line">    doReallyStop(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mViewModelStore != <span class="keyword">null</span> &amp;&amp; !mRetaining) &#123;</span><br><span class="line">        mViewModelStore.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mFragments.dispatchDestroy();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŒç†ï¼Œ Activity çš„é”€æ¯æ“ä½œä¹Ÿæ˜¯åœ¨ onDestroy() å®Œæˆçš„ã€‚</p>
<h1 id="Footer"><a href="#Footer" class="headerlink" title="Footer"></a>Footer</h1><p>ç»ˆäºæŠŠ LiveData å’Œ ViewModel éƒ½åˆ†æäº†ä¸€éï¼Œç°åœ¨è¿˜å·®ä¸€ä¸ª Lifecycle ã€‚</p>
<p>é‚£ä¹ˆç­‰æœ‰æ—¶é—´å†å†™å§ï¼Œbye byeï¼</p>
]]></content>
    <summary type="html">
    <![CDATA[<h1 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h1><p>ä¹‹å‰ç»™å¤§å®¶åˆ†æè¿‡äº† LiveData ï¼Œä»Šå¤©å°±æ¥çœ‹çœ‹ ViewModel ã€‚</p>
<p>ViewMode]]>
    </summary>
    
      <category term="Android" scheme="http://yuqirong.me/tags/Android/"/>
    
      <category term="Android Architecture Component" scheme="http://yuqirong.me/tags/Android-Architecture-Component/"/>
    
      <category term="å¼€æºæ¡†æ¶" scheme="http://yuqirong.me/tags/%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/"/>
    
      <category term="æºç è§£æ" scheme="http://yuqirong.me/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    
      <category term="Android Blog" scheme="http://yuqirong.me/categories/Android-Blog/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Android Architecture Componentä¹‹LiveDataè§£æ]]></title>
    <link href="http://yuqirong.me/2018/06/20/Android%20Architecture%20Component%E4%B9%8BLiveData%E8%A7%A3%E6%9E%90/"/>
    <id>http://yuqirong.me/2018/06/20/Android Architecture Componentä¹‹LiveDataè§£æ/</id>
    <published>2018-06-20T14:07:08.000Z</published>
    <updated>2018-07-14T16:30:33.283Z</updated>
    <content type="html"><![CDATA[<h1 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h1><p>Android Architecture Component æ˜¯ Google åœ¨ 2017 å¹´æ¨å‡ºçš„ä¸€å¥—å¸®åŠ©å¼€å‘è€…è§£å†³ Android æ¶æ„è®¾è®¡çš„æ–¹æ¡ˆã€‚é‡Œé¢æœ‰ä¼—å¤šå¸å¼•äººçš„äº®ç‚¹ï¼Œæ¯”å¦‚ Lifecycleã€ViewModel å’Œ LiveData ç­‰ç»„ä»¶çš„è®¾è®¡ï¼Œç¡®å®æ˜¯ä¸€æ¬¾ç‰›é€¼çš„æ¶æ„ã€‚</p>
<p>ç›¸ä¿¡å¾ˆå¤šåŒå­¦éƒ½ç”¨è¿‡è¿™ä¸ªæ¶æ„äº†ï¼Œåœ¨è¿™å°±ä¸å¤šä»‹ç»äº†ã€‚ä»Šå¤©å°±ç»™å¤§å®¶æ¥è§£æä¸€ä¸‹å…¶ä¸­çš„ LiveData æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚</p>
<p>LiveData è¡¨ç¤ºçš„æ˜¯åŠ¨æ€çš„æ•°æ®ï¼Œæ¯”å¦‚æˆ‘ä»¬ä»ç½‘ç»œä¸Šè·å–çš„æ•°æ®ï¼Œæˆ–è€…ä»æ•°æ®åº“ä¸­è·å–çš„æ•°æ®ç­‰ï¼Œéƒ½å¯ä»¥ç”¨ LiveData æ¥æ¦‚æ‹¬ã€‚å…¶ä¸­ setValue æ–¹æ³•æ˜¯éœ€è¦è¿è¡Œåœ¨ä¸»çº¿ç¨‹ä¸­çš„ï¼Œè€Œ postValue æ–¹æ³•æ˜¯å¯ä»¥åœ¨å­çº¿ç¨‹è¿è¡Œçš„ã€‚</p>
<p>PS: æœ¬æ¬¡æºç è§£æåŸºäº android.arch.lifecycle:extensions:1.1.1</p>
<h1 id="LiveData"><a href="#LiveData" class="headerlink" title="LiveData"></a>LiveData</h1><h2 id="Observer"><a href="#Observer" class="headerlink" title="Observer"></a>Observer</h2><p>LiveData åº”ç”¨çš„ä¸»è¦æ˜¯è§‚å¯Ÿè€…æ¨¡å¼ï¼Œå› ä¸ºæ•°æ®æ˜¯å¤šå˜çš„ï¼Œæ‰€ä»¥è‚¯å®šéœ€è¦è§‚å¯Ÿè€…æ¥è§‚å¯Ÿã€‚è€Œè§‚å¯Ÿè€…å’Œæ•°æ®æºå»ºç«‹è¿æ¥å°±æ˜¯é€šè¿‡ observe æ–¹æ³•æ¥å®ç°çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> SafeIterableMap&lt;Observer&lt;T&gt;, ObserverWrapper&gt; mObservers = <span class="keyword">new</span> SafeIterableMap&lt;&gt;();</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ª LiveData çš„æ‰€æœ‰è§‚å¯Ÿè€… Observer éƒ½ä¼šè¢«ä¿å­˜åœ¨ mObservers è¿™ä¸ª map é‡Œé¢ã€‚é‚£ä¹ˆå¯¹åº”çš„ value å€¼ ObserverWrapper åˆæ˜¯ä»€ä¹ˆä¸œè¥¿å‘¢ï¼Ÿ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ObserverWrapper</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Observer&lt;T&gt; mObserver;</span><br><span class="line">        <span class="keyword">boolean</span> mActive;</span><br><span class="line">        <span class="keyword">int</span> mLastVersion = START_VERSION;</span><br><span class="line"></span><br><span class="line">        ObserverWrapper(Observer&lt;T&gt; observer) &#123;</span><br><span class="line">            mObserver = observer;</span><br><span class="line">        &#125;</span><br><span class="line">		</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">activeStateChanged</span><span class="params">(<span class="keyword">boolean</span> newActive)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (newActive == mActive) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// immediately set active state, so we'd never dispatch anything to inactive</span></span><br><span class="line">            <span class="comment">// owner</span></span><br><span class="line">            mActive = newActive;</span><br><span class="line">            <span class="keyword">boolean</span> wasInactive = LiveData.<span class="keyword">this</span>.mActiveCount == <span class="number">0</span>;</span><br><span class="line">            LiveData.<span class="keyword">this</span>.mActiveCount += mActive ? <span class="number">1</span> : -<span class="number">1</span>;</span><br><span class="line">            <span class="comment">// å¦‚æœç°åœ¨ç¬¬ä¸€æ¬¡æ–°å¢æ´»è·ƒçš„è§‚å¯Ÿè€…ï¼Œé‚£ä¹ˆå›è°ƒ onActive ï¼ŒonActive æ˜¯ä¸ªç©ºæ–¹æ³•</span></span><br><span class="line">            <span class="keyword">if</span> (wasInactive &amp;&amp; mActive) &#123;</span><br><span class="line">                onActive();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¦‚æœç°åœ¨æ²¡æœ‰æ´»è·ƒçš„è§‚å¯Ÿè€…äº†ï¼Œé‚£ä¹ˆå›è°ƒ onInactive ï¼ŒonInactive æ˜¯ä¸ªç©ºæ–¹æ³•</span></span><br><span class="line">            <span class="keyword">if</span> (LiveData.<span class="keyword">this</span>.mActiveCount == <span class="number">0</span> &amp;&amp; !mActive) &#123;</span><br><span class="line">                onInactive();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å‘è§‚å¯Ÿè€…å‘é€ LiveData çš„å€¼</span></span><br><span class="line">            <span class="keyword">if</span> (mActive) &#123;</span><br><span class="line">                dispatchingValue(<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ObserverWrapper æ˜¯ Observer çš„åŒ…è£…ç±»ï¼Œåœ¨ Observer çš„åŸºç¡€ä¸Šå¢åŠ äº† mActive å’Œ mLastVersion ã€‚mActive ç”¨æ¥æ ‡è¯†è§‚å¯Ÿè€…æ˜¯å¦æ˜¯æ´»è·ƒï¼Œä¹Ÿå°±æ˜¯è¯´æ˜¯å¦æ˜¯åœ¨å¯ç”¨çš„ç”Ÿå‘½å‘¨æœŸå†…ã€‚</p>
<p>ä½†æ˜¯ ObserverWrapper æ˜¯ä¸ªæŠ½è±¡ç±»å•Šï¼Œåˆ°åº•æ˜¯è°æ¥å®ç°å®ƒçš„å‘¢ï¼Ÿç­”æ¡ˆæœ‰ä¸¤ä¸ªã€‚</p>
<ul>
<li>LifecycleBoundObserver</li>
<li>AlwaysActiveObserver</li>
</ul>
<p>æˆ‘ä»¬é‡ç‚¹æ¥è®²è®² LifecycleBoundObserver ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LifecycleBoundObserver</span> <span class="keyword">extends</span> <span class="title">ObserverWrapper</span> <span class="keyword">implements</span> <span class="title">GenericLifecycleObserver</span> </span>&#123;</span><br><span class="line">    <span class="annotation">@NonNull</span> <span class="keyword">final</span> LifecycleOwner mOwner;</span><br><span class="line"></span><br><span class="line">    LifecycleBoundObserver(<span class="annotation">@NonNull</span> LifecycleOwner owner, Observer&lt;T&gt; observer) &#123;</span><br><span class="line">        <span class="keyword">super</span>(observer);</span><br><span class="line">        mOwner = owner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">shouldBeActive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mOwner.getLifecycle().getCurrentState().isAtLeast(STARTED);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStateChanged</span><span class="params">(LifecycleOwner source, Lifecycle.Event event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mOwner.getLifecycle().getCurrentState() == DESTROYED) &#123;</span><br><span class="line">            <span class="comment">// ç§»é™¤è§‚å¯Ÿè€…ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­ä¼šç§»é™¤ç”Ÿå‘½å‘¨æœŸç›‘å¬å¹¶å›è°ƒactiveStateChanged æ–¹æ³•</span></span><br><span class="line">            removeObserver(mObserver);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        activeStateChanged(shouldBeActive());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isAttachedTo</span><span class="params">(LifecycleOwner owner)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mOwner == owner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">detachObserver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mOwner.getLifecycle().removeObserver(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡ºï¼ŒLifecycleBoundObserver æ˜¯æŠŠ ObserverWrapper å’Œ Lifecycle ç›¸ç»“åˆäº†ã€‚è¿™æ ·ï¼Œåœ¨ LiveData é‡Œå°±å¯ä»¥è·å–åˆ°è§‚å¯Ÿè€…çš„ç”Ÿå‘½å‘¨æœŸäº†ã€‚å½“è§‚å¯Ÿè€…çš„ç”Ÿå‘½å‘¨æœŸå¯ç”¨æ—¶ï¼ŒLiveData ä¼šæŠŠæ•°æ®å‘é€ç»™è§‚å¯Ÿè€…ï¼Œè€Œå½“è§‚å¯Ÿè€…ç”Ÿå‘½å‘¨æœŸä¸å¯ç”¨çš„æ—¶å€™ï¼Œå³ <code>mOwner.getLifecycle().getCurrentState() == DESTROYED</code> ï¼ŒLiveData å°±ä¼šé€‰æ‹©ä¸å‘é€ï¼Œå¹¶ä¸”è‡ªåŠ¨è§£ç»‘ï¼Œé˜²æ­¢é€ æˆå†…å­˜æ³„æ¼ç­‰é—®é¢˜ã€‚</p>
<p>æœ€åè¡¥å……ä¸€ä¸‹ï¼ŒLiveData è®¤ä¸ºè§‚å¯Ÿè€…ç”Ÿå‘½å‘¨æœŸå¯ç”¨çš„ä¾æ®å°±æ˜¯åœ¨ onStart è°ƒç”¨ä¹‹åï¼Œåœ¨ onPause è°ƒç”¨ä¹‹å‰ã€‚</p>
<p>å¹³æ—¶ä½¿ç”¨ observe çš„å°±æ˜¯ç›´æ¥åˆ©ç”¨çš„æ˜¯ LifecycleBoundObserver ï¼Œè€Œå¦ä¸€ä¸ª AlwaysActiveObserver é¡¾åæ€ä¹‰å°±æ˜¯ä¸€ç›´æ˜¯æ´»è·ƒçš„ï¼Œå’Œè§‚å¯Ÿè€…çš„ç”Ÿå‘½å‘¨æœŸæ— å…³äº†ã€‚æˆ‘ä»¬è°ƒç”¨ observeForever æ–¹æ³•å†…éƒ¨ä½¿ç”¨çš„å°±æ˜¯ AlwaysActiveObserver ã€‚</p>
<h2 id="observe"><a href="#observe" class="headerlink" title="observe"></a>observe</h2><p>é¡ºä¾¿ï¼Œæˆ‘ä»¬æŠŠ observe æ–¹æ³•ä¹Ÿä¸€èµ·çœ‹äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@MainThread</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">observe</span><span class="params">(@NonNull LifecycleOwner owner, @NonNull Observer&lt;T&gt; observer)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (owner.getLifecycle().getCurrentState() == DESTROYED) &#123;</span><br><span class="line">        <span class="comment">// ignore</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    LifecycleBoundObserver wrapper = <span class="keyword">new</span> LifecycleBoundObserver(owner, observer);</span><br><span class="line">    ObserverWrapper existing = mObservers.putIfAbsent(observer, wrapper);</span><br><span class="line">    <span class="keyword">if</span> (existing != <span class="keyword">null</span> &amp;&amp; !existing.isAttachedTo(owner)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Cannot add the same observer"</span></span><br><span class="line">                + <span class="string">" with different lifecycles"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (existing != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    owner.getLifecycle().addObserver(wrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯åˆ©ç”¨äº†ä¹‹å‰æˆ‘ä»¬åˆ†æçš„ LifecycleBoundObserver ï¼Œå†æŠŠå®ƒä¿å­˜åˆ° map ä¸­ã€‚<br>æœ€åï¼Œå°† LifecycleBoundObserver çš„ç”Ÿå‘½å‘¨æœŸç›‘å¬æ³¨å†Œå¥½ï¼ŒOKï¼Œä¸‡äº‹å…·å¤‡ã€‚</p>
<p>è¿˜æœ‰ï¼Œå¦å¤–ä¸€ä¸ª observeForever æ–¹æ³•å°±ä¸çœ‹äº†ï¼Œå’Œ observe æ–¹æ³•å·®ä¸å¤šã€‚</p>
<h2 id="setData_or_postData"><a href="#setData_or_postData" class="headerlink" title="setData or postData"></a>setData or postData</h2><p>setData æˆ–è€… postData æ˜¯å½“æ•°æ®æ”¹å˜åå‘è§‚å¯Ÿè€…ä¼ é€’å€¼çš„ã€‚postData æœ€åä¹Ÿä¼šè°ƒç”¨ setData ï¼Œæ‰€ä»¥åœ¨è¿™æˆ‘ä»¬å°±åªçœ‹ setData äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@MainThread</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">    assertMainThread(<span class="string">"setValue"</span>);</span><br><span class="line">    mVersion++;</span><br><span class="line">    <span class="comment">// mData ä¿å­˜çš„å°±æ˜¯æ”¹å˜åçš„æ•°æ®</span></span><br><span class="line">    mData = value;</span><br><span class="line">    dispatchingValue(<span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‘ç°è¿™ä¸ª setData çš„ä»£ç ä¸­åˆ¤æ–­äº†æ˜¯å¦æ˜¯ä¸»çº¿ç¨‹ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•åªèƒ½åœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨äº†ã€‚å¦å¤–ï¼Œè°ƒç”¨åç›¸åº”çš„ç‰ˆæœ¬ä¹Ÿä¼šè‡ªå¢ã€‚æœ€åå°±æ˜¯è°ƒç”¨ dispatchingValue æ–¹æ³•å»åˆ†å‘è¿™ä¸ªæ•°æ® mData äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatchingValue</span><span class="params">(@Nullable ObserverWrapper initiator)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mDispatchingValue) &#123;</span><br><span class="line">        mDispatchInvalidated = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mDispatchingValue = <span class="keyword">true</span>;</span><br><span class="line">    do &#123;</span><br><span class="line">        mDispatchInvalidated = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (initiator != <span class="keyword">null</span>) &#123;</span><br><span class="line">            considerNotify(initiator);</span><br><span class="line">            initiator = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (Iterator&lt;Map.Entry&lt;Observer&lt;T&gt;, ObserverWrapper&gt;&gt; iterator =</span><br><span class="line">                    mObservers.iteratorWithAdditions(); iterator.hasNext(); ) &#123;</span><br><span class="line">                considerNotify(iterator.next().getValue());</span><br><span class="line">                <span class="keyword">if</span> (mDispatchInvalidated) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (mDispatchInvalidated);</span><br><span class="line">    mDispatchingValue = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ dispatchingValue å°±æ˜¯å¾ªç¯éå† mObservers è¿™ä¸ª map ï¼Œå‘æ¯ä¸€ä¸ªè§‚å¯Ÿè€…éƒ½å‘é€æ–°çš„æ•°æ®ã€‚å…·ä½“çš„ä»£ç åœ¨ considerNotify æ–¹æ³•ä¸­ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">considerNotify</span><span class="params">(ObserverWrapper observer)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!observer.mActive) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Check latest state b4 dispatch. Maybe it changed state but we didn't get the event yet.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// we still first check observer.active to keep it as the entrance for events. So even if</span></span><br><span class="line">    <span class="comment">// the observer moved to an active state, if we've not received that event, we better not</span></span><br><span class="line">    <span class="comment">// notify for a more predictable notification order.</span></span><br><span class="line">    <span class="keyword">if</span> (!observer.shouldBeActive()) &#123;</span><br><span class="line">        observer.activeStateChanged(<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (observer.mLastVersion &gt;= mVersion) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    observer.mLastVersion = mVersion;</span><br><span class="line">    <span class="comment">//noinspection unchecked</span></span><br><span class="line">    <span class="comment">// è°ƒç”¨ Observer çš„ onChanged æ–¹æ³•å®ç°å›è°ƒ</span></span><br><span class="line">    observer.mObserver.onChanged((T) mData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¥½å•¦ï¼Œåˆ°è¿™é‡Œå°±æŠŠ LiveData æ•´ä¸ªæµç¨‹è®²çš„å·®ä¸å¤šäº†ã€‚å½“ç„¶è¿˜æœ‰ä¸€äº›ç»†èŠ‚æ²¡è®²åˆ°ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å°±è‡ªå·±å›å»çœ‹çœ‹æºç å§ã€‚</p>
<h1 id="Footer"><a href="#Footer" class="headerlink" title="Footer"></a>Footer</h1><p>LiveData è®²å®Œäº†ï¼Œå†è¯´ä¸€ç‚¹ï¼Œæˆ‘ä»¬åœ¨å®é™…çš„ä½¿ç”¨ä¸­ç”¨çš„éƒ½æ˜¯ LiveData çš„å®ç°ç±» MutableLiveData ã€‚</p>
<p>å‰©ä¸‹çš„å°±ä¸å¤šè¯´äº†ï¼Œé‚£ä¹ˆå°±é™é™ç­‰å¾…è§£æ ViewModel å’Œ Lifecycle å§ã€‚</p>
<p>bye ~~</p>
]]></content>
    <summary type="html">
    <![CDATA[<h1 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h1><p>Android Architecture Component æ˜¯ Google åœ¨ 2017 å¹´æ¨å‡ºçš„ä¸€å¥—å¸®]]>
    </summary>
    
      <category term="Android" scheme="http://yuqirong.me/tags/Android/"/>
    
      <category term="Android Architecture Component" scheme="http://yuqirong.me/tags/Android-Architecture-Component/"/>
    
      <category term="å¼€æºæ¡†æ¶" scheme="http://yuqirong.me/tags/%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/"/>
    
      <category term="æºç è§£æ" scheme="http://yuqirong.me/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    
      <category term="Android Blog" scheme="http://yuqirong.me/categories/Android-Blog/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Android Data Bindingå…¥é—¨]]></title>
    <link href="http://yuqirong.me/2018/05/30/Android%20Data%20Binding%E5%85%A5%E9%97%A8/"/>
    <id>http://yuqirong.me/2018/05/30/Android Data Bindingå…¥é—¨/</id>
    <published>2018-05-30T14:16:27.000Z</published>
    <updated>2018-05-30T14:38:46.262Z</updated>
    <content type="html"><![CDATA[<h2 id="u914D_u7F6E"><a href="#u914D_u7F6E" class="headerlink" title="é…ç½®"></a>é…ç½®</h2><p>æ–°å»ºä¸€ä¸ª Projectï¼Œç¡®ä¿é¡¹ç›® build.gradle ä¸­çš„ Gradle æ’ä»¶ç‰ˆæœ¬ä¸ä½äº 1.5.0-alpha1ï¼Œæ¯”å¦‚æˆ‘çš„ Demo æ˜¯ 3.1.2 ç‰ˆæœ¬çš„ï¼š</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">buildscript</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        google()</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">dependencies</span> &#123;</span><br><span class="line">        <span class="keyword">classpath</span> <span class="string">'com.android.tools.build:gradle:3.1.2'</span></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> Do not place your application dependencies here; they belong</span></span><br><span class="line">        <span class="comment">// in the individual module build.gradle files</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶åä¿®æ”¹å¯¹åº” app æ¨¡å—çš„ build.gradle ï¼š</p>
<figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="name">android</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  dataBinding &#123;</span><br><span class="line">      <span class="literal">enabled</span> <span class="keyword">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="User"><a href="#User" class="headerlink" title="User"></a>User</h2><p>å…ˆå®šä¹‰ä¸€ä¸ª User ç±»ï¼Œä»£è¡¨ç”¨æˆ·ã€‚è¿™ä¹Ÿæ˜¯æˆ‘ä»¬é¡¹ç›®ä¸­çš„ Model ã€‚<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> User &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> username;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> password;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> nickName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">String</span> getUsername() &#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> setUsername(<span class="built_in">String</span> username) &#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">String</span> getPassword() &#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> setPassword(<span class="built_in">String</span> password) &#123;</span><br><span class="line">        <span class="keyword">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">String</span> getNickName() &#123;</span><br><span class="line">        <span class="keyword">return</span> nickName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> setNickName(<span class="built_in">String</span> nickName) &#123;</span><br><span class="line">        <span class="keyword">this</span>.nickName = nickName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="layout"><a href="#layout" class="headerlink" title="layout"></a>layout</h2><p>å®šä¹‰å¥½ User ç±»ä¹‹åï¼Œæˆ‘ä»¬è¦åœ¨ layout å¸ƒå±€æ–‡ä»¶ä¸­å°† View å’ŒModel è¿›è¡Œç»‘å®š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="pi">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">layout</span> <span class="attribute">xmlns:android</span>=<span class="value">"http://schemas.android.com/apk/res/android"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">data</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">variable</span></span><br><span class="line">            <span class="attribute">name</span>=<span class="value">"user"</span></span><br><span class="line">            <span class="attribute">type</span>=<span class="value">"me.yuqirong.myapplication.User"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">data</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--åŸå…ˆçš„æ ¹èŠ‚ç‚¹ï¼ˆRoot Elementï¼‰--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">LinearLayout</span> <span class="attribute">xmlns:app</span>=<span class="value">"http://schemas.android.com/apk/res-auto"</span></span><br><span class="line">        <span class="attribute">xmlns:tools</span>=<span class="value">"http://schemas.android.com/tools"</span></span><br><span class="line">        <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">        <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span></span><br><span class="line">        <span class="attribute">android:orientation</span>=<span class="value">"vertical"</span></span><br><span class="line">        <span class="attribute">tools:context</span>=<span class="value">".MainActivity"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="title">TextView</span></span><br><span class="line">            <span class="attribute">android:layout_width</span>=<span class="value">"wrap_content"</span></span><br><span class="line">            <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span></span><br><span class="line">            <span class="attribute">android:text</span>=<span class="value">"@&#123;user.username&#125;"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="title">TextView</span></span><br><span class="line">            <span class="attribute">android:layout_width</span>=<span class="value">"wrap_content"</span></span><br><span class="line">            <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span></span><br><span class="line">            <span class="attribute">android:text</span>=<span class="value">"@&#123;user.password&#125;"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="title">TextView</span></span><br><span class="line">            <span class="attribute">android:layout_width</span>=<span class="value">"wrap_content"</span></span><br><span class="line">            <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span></span><br><span class="line">            <span class="attribute">android:text</span>=<span class="value">"@&#123;user.nickName&#125;"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="title">LinearLayout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">layout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>åœ¨dataå†…æè¿°äº†ä¸€ä¸ªåä¸ºuserçš„å˜é‡å±æ€§ï¼Œä½¿å…¶å¯ä»¥åœ¨è¿™ä¸ªlayoutä¸­ä½¿ç”¨ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">variable</span> <span class="attribute">name</span>=<span class="value">"user"</span> <span class="attribute">type</span>=<span class="value">"me.yuqirong.myapplication.User"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>åœ¨layoutçš„å±æ€§è¡¨è¾¾å¼å†™ä½œ @{xxx.xxxx} ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªTextViewçš„textè®¾ç½®ä¸ºuserçš„ username å±æ€§ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">TextView</span> </span><br><span class="line">     <span class="attribute">android:layout_width</span>=<span class="value">"wrap_content"</span></span><br><span class="line">     <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span></span><br><span class="line">     <span class="attribute">android:text</span>=<span class="value">"@&#123;user.username&#125;"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="MainActivity"><a href="#MainActivity" class="headerlink" title="MainActivity"></a>MainActivity</h2><p>å•å•åœ¨ layout å¸ƒå±€æ–‡ä»¶ä¸­å°† view å’Œ model ç»‘å®šè¿˜ä¸å¤Ÿï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“è¦ç»‘å®šçš„æ˜¯å“ªä¸ª user ç±»çš„å¯¹è±¡ã€‚æ‰€ä»¥æˆ‘ä»¬è¿˜è¦åœ¨ MainActivity ä¸­å†™ä»£ç ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        ActivityMainBinding dataBinding = DataBindingUtil.setContentView(<span class="keyword">this</span>, R.layout.activity_main);</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setNickName(<span class="string">"tom"</span>);</span><br><span class="line">        user.setUsername(<span class="string">"tom123"</span>);</span><br><span class="line">        user.setPassword(<span class="string">"abc123456"</span>);</span><br><span class="line">        dataBinding.setUser(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·ï¼Œå°±å®Œæˆäº†ä¸€ä¸ªç®€å•çš„ Data Binding Demo äº†ã€‚</p>
<h2 id="Data_Binding__u7684_u5C0F_u6280_u5DE7"><a href="#Data_Binding__u7684_u5C0F_u6280_u5DE7" class="headerlink" title="Data Binding çš„å°æŠ€å·§"></a>Data Binding çš„å°æŠ€å·§</h2><ul>
<li><p>è·å– Activity çš„ View</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ActivityMainBinding dataBinding = DataBindingUtil.setContentView(<span class="keyword">this</span>, R.layout.activity_main);</span><br><span class="line">View view = dataBinding.getRoot();<span class="comment">//è·å–å¯¹åº”çš„View</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ä½¿ç”¨æŸä¸ªå­ Viewï¼Œå…¶ä¸­ tvName å¯¹åº”ç€ android:id=â€@+id/tv_nameâ€ çš„ TextView </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dataBinding.tvName.setText(<span class="string">"Hello World"</span>);</span><br></pre></td></tr></table></figure></li>
</ul>
]]></content>
    <summary type="html">
    <![CDATA[<h2 id="u914D_u7F6E"><a href="#u914D_u7F6E" class="headerlink" title="é…ç½®"></a>é…ç½®</h2><p>æ–°å»ºä¸€ä¸ª Projectï¼Œç¡®ä¿é¡¹ç›® build.gradle ä¸­çš„ Gradle æ’ä»¶ç‰ˆæœ¬ä¸ä½äº 1.5]]>
    </summary>
    
      <category term="Android" scheme="http://yuqirong.me/tags/Android/"/>
    
      <category term="Android Blog" scheme="http://yuqirong.me/categories/Android-Blog/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[è®°è‡ªå·±2018å¹´ä¸‰æœˆä»½çš„é¢è¯•ç»å†]]></title>
    <link href="http://yuqirong.me/2018/04/01/%E8%AE%B0%E8%87%AA%E5%B7%B12018%E5%B9%B4%E4%B8%89%E6%9C%88%E4%BB%BD%E7%9A%84%E9%9D%A2%E8%AF%95%E7%BB%8F%E5%8E%86/"/>
    <id>http://yuqirong.me/2018/04/01/è®°è‡ªå·±2018å¹´ä¸‰æœˆä»½çš„é¢è¯•ç»å†/</id>
    <published>2018-04-01T15:03:24.000Z</published>
    <updated>2018-04-10T13:23:42.422Z</updated>
    <content type="html"><![CDATA[<h1 id="u70E6_u70E6_u70E6_u70E6"><a href="#u70E6_u70E6_u70E6_u70E6" class="headerlink" title="çƒ¦çƒ¦çƒ¦çƒ¦"></a>çƒ¦çƒ¦çƒ¦çƒ¦</h1><p>è¿‡å®Œå¹´åï¼Œåˆæ˜¯ä¸€æ³¢æ‹›è˜çƒ­å­£ï¼Œå„ç§å¥½å…¬å¸ã€å¥½å²—ä½éƒ½åœ¨æ‹¼å‘½æ‹›æ½äººæ‰ã€‚è‡ªå·±ä¹Ÿè€ƒè™‘åˆ°ä»¥åçš„å‘å±•å’Œæ›´å¥½çš„å·¥ä½œè¿˜æœ‰æœªæ¥ï¼Œæ•´å¤©å¤„äºç„¦è™‘å’Œçƒ¦æ¼çš„çŠ¶æ€ï¼Œçœ‹çœ‹è‡ªå·±ç°åœ¨æ‹¿åˆ°çš„å·¥èµ„ï¼Œä¸å¤šã€‚æ‰€ä»¥ä¸ºäº†æ”¹å˜è¿™å±€é¢ï¼Œæ‰“ç®—ä¸‹æµ·è¯•è¯•æ°´ã€‚</p>
<p>å…ˆè®²ä¸€ä¸‹è‡ªå·±çš„æƒ…å†µï¼Œ2016 å¹´æœ¬ç§‘æ¯•ä¸šï¼Œåœ¨ç›®å‰è¿™å®¶å…¬å¸åŸºæœ¬ä¸Šå·²ç»åœ¨èŒä¸€å¹´åŠå¤šäº†ã€‚è€Œæœ€è¿‘å¤§åŠå¹´åœ¨å…¬å¸éƒ½æ˜¯åš Java å¼€å‘ï¼Œå¤„äºå¤§ç™½é˜¶æ®µï¼Œä¼šå†™ä»£ç ï¼Œä½†æ˜¯æ²¡æœ‰æ·±å…¥åˆ°æ¡†æ¶æºç ã€‚</p>
<p>æ‰€ä»¥æƒ³è¦å»å¸‚åœºä¸Šåº”è˜ Android å²—ä½ï¼Œè¿˜éœ€è¦å¥½å¥½å¤ä¹ ä¸€ç•ªï¼Œå› ä¸ºåŠå¹´æ²¡æœ‰ç¢° Android äº†ã€‚ç»“æœè¿˜æ˜¯å‘ç°æœ‰äº›çŸ¥è¯†ç‚¹åœ¨é¢è¯•çš„è¿‡ç¨‹ä¸­å·²ç»è®°ä¸æ¸…äº†ï¼Œç”Ÿç–äº†ã€‚</p>
<p>ç”±äºè‡ªå·±æ˜¯åœ¨èŒï¼Œè€ƒè™‘æ›´å¥½çš„å‘å±•æœºä¼šï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰ç–¯ç‹‚æµ·æŠ•ç®€å†ï¼Œè€Œæ˜¯å…ˆæ‰¾äº†è‡ªå·±çš„åŒå­¦æœ‹å‹å†…æ¨äº†ä¸€æ³¢ï¼Œä¹‹åæŠ•äº†å‡ å®¶è‡ªå·±å–œæ¬¢çš„å…¬å¸ã€‚ä¸‹é¢æˆ‘å°±å¼€å§‹è®²è®²è‡ªå·±çš„ç»å†ã€‚</p>
<h1 id="u9762_u8BD5_u7684_u51E0_u5BB6_u516C_u53F8"><a href="#u9762_u8BD5_u7684_u51E0_u5BB6_u516C_u53F8" class="headerlink" title="é¢è¯•çš„å‡ å®¶å…¬å¸"></a>é¢è¯•çš„å‡ å®¶å…¬å¸</h1><h2 id="u4EBF_u5496_u901A"><a href="#u4EBF_u5496_u901A" class="headerlink" title="äº¿å’–é€š"></a>äº¿å’–é€š</h2><p>å…ˆè”ç³»äº†è‡ªå·±çš„åŒå­¦ A ï¼Œæ­£å¥½ä»–ä»¬å…¬å¸ä¹Ÿåœ¨æ‹› Android å¼€å‘ï¼Œæ‰€ä»¥å…ˆæ‰“ç®—è¯•è¯•æ°´ã€‚</p>
<p>é¢è¯•æ—¶äº†è§£åˆ°ï¼Œè¯¥å…¬å¸æ˜¯åœ¨è½¦è½½è®¾å¤‡ä¸Šå¼€å‘ APP çš„ï¼Œå¬ä¸Šå»å¥½åƒå¾ˆé«˜å¤§ä¸Šï¼Œæ˜¯ç”±å‰åˆ©æŠ•èµ„çš„ã€‚</p>
<p>é¢è¯•ä¸€å¼€å§‹ï¼Œè®²äº†è‡ªå·±ç°åœ¨å…¬å¸åšçš„æ˜¯ Java å¼€å‘ï¼Œç»“æœå‰ä¸¤ä¸ªé¢è¯•å®˜é—®æˆ‘çš„éƒ½æ˜¯ä¸€äº› Java é—®é¢˜ï¼Œæœ‰ç‚¹è™šâ€¦å¹¸å¥½ç¬¬ä¸‰ä¸ªé¢è¯•å®˜æ˜¯ Android å¼€å‘ï¼Œä¸ç„¶çœŸæ‰›ä¸ä½ï¼Œå“ˆå“ˆã€‚</p>
<ul>
<li>MyBatis å’Œ Hibernate çš„ç›¸åŒå’Œä¸åŒå¤„ï¼Œä»¥åŠå®ç”¨åœºæ™¯ï¼›</li>
<li>Redis å­˜å‚¨å’Œæ•°æ®åº“å­˜å‚¨çš„åŒºåˆ«ï¼›</li>
<li>MVP æ¶æ„æ¨¡å¼çš„ä¼˜ç‚¹å’Œç¼ºç‚¹ï¼Œä¸ MVC çš„æ¯”è¾ƒï¼›</li>
<li>Android å¤šè¿›ç¨‹é€šä¿¡ï¼›</li>
<li>ç›®å‰åœ¨èŒå…¬å¸çš„äº§å“ä»‹ç»å’Œè‡ªå·±è´Ÿè´£çš„æ¨¡å—ï¼›</li>
<li>Android å†…å­˜æ³„éœ²ï¼Œä¸¾ä¾‹å‡ ä¸ªå®¹æ˜“å‘ç”Ÿå†…å­˜æ³„éœ²çš„åœºæ™¯ï¼›</li>
<li>Android æ’ä»¶åŒ–çš„åŸç†ï¼›</li>
<li>OKHttp çš„æºç å’ŒåŸç†</li>
<li>Retrofit çš„æºç å’ŒåŸç†ï¼›</li>
<li>RecyclerView ä¸­çš„ LayoutManager ;</li>
<li>å‰©ä¸‹çš„ä¸è®°å¾—äº†ï¼Œæ—¶é—´æœ‰ç‚¹ä¹…è¿œã€‚ã€‚ã€‚</li>
</ul>
<p>Android çš„é—®é¢˜åŸºæœ¬ä¸Šéƒ½å›ç­”å‡ºæ¥äº†ï¼Œä½†æ˜¯ä¸€äº›ç»†èŠ‚ä¸Šé¢æœ‰äº›é—å¿˜ï¼Œå› ä¸ºçœŸçš„å¥½ä¹…æ²¡å†™è¿‡ Android ä»£ç äº†ã€‚é¢è¯•å®Œåï¼Œé¢è¯•å®˜è¯´è‡ªå·±çš„ Android æŠ€æœ¯æ°´å¹³æ²¡æˆ‘å¥½ï¼Œæˆ‘æ–¹äº†ã€‚</p>
<p>æœ€åï¼Œå¾ˆé—æ†¾æ²¡æœ‰æ‹¿åˆ°è¯¥å…¬å¸çš„ offer ï¼Œå¥½åƒæ˜¯å› ä¸ºä»–ä»¬å…¬å¸ Android å¼€å‘æ‹›æ»¡äº†ï¼Œæ²¡æœ‰åé¢äº†ã€‚</p>
<h2 id="u6D77_u5EB7_u5A01_u89C6"><a href="#u6D77_u5EB7_u5A01_u89C6" class="headerlink" title="æµ·åº·å¨è§†"></a>æµ·åº·å¨è§†</h2><p>å¸å–äº†ä¹‹å‰é¢è¯•å¤±è´¥çš„æ•™è®­ï¼Œæ‰€ä»¥åˆè®©åŒå­¦ B ç»™æˆ‘å†…æ¨äº†æµ·åº·å¨è§†ï¼Œæ­£å¥½ä¹Ÿåœ¨æ‹› Android å¼€å‘ã€‚</p>
<p>æµ·åº·å¨è§†æ˜¯åšè§†é¢‘ç›‘æ§ã€å®‰é˜²è¿™ä¸€å—çš„ï¼Œæ˜¯ä¸€å®¶å¾ˆç‰›é€¼çš„å…¬å¸ï¼Œæ‰€ä»¥è‡ªå·±å¿ƒé‡Œåœ¨æƒ³è¦å¥½å¥½å¤ä¹ ï¼ŒæŠŠæ¡æœºä¼šï¼Œä¸€å—å»æ»¨æ±Ÿå¼€æ‹“äº‹ä¸šã€‚(/æ–œçœ¼ç¬‘)</p>
<p>é¢è¯•çš„è¿‡ç¨‹å’Œä¸¤ä½é¢è¯•å®˜èŠçš„å¾ˆæ„‰å¿«ï¼Œè½»è½»æ¾æ¾ã€‚é¢è¯•å®˜é—®çš„é—®é¢˜ä¹Ÿä¸éš¾ï¼Œæ‰€ä»¥æŠ€æœ¯é¢ easy å°±è¿‡äº†ã€‚ä»¥ä¸‹é¢è¯•ä¸­é—®åˆ°çš„å‡ ä¸ªé—®é¢˜ï¼Œå¯èƒ½è®°å½•ä¸å…¨ï¼Œä¸€éƒ¨åˆ†å·²ç»å¿˜äº†ã€‚</p>
<ul>
<li>è‡ªæˆ‘ä»‹ç»ï¼Œå…¬å¸äº§å“ä»‹ç»ï¼Œè´Ÿè´£å“ªä¸€å—ï¼›</li>
<li>å†™åšå®¢çš„æ„ä¹‰ï¼Œä¸ºä»€ä¹ˆå¼€å§‹å†™åšå®¢ï¼Œè¿˜é—®äº†â€œç®€ä¹¦ç¨‹åºå‘˜ä¼˜ç§€ä½œè€…â€è¿™ä¸ª title æ€ä¹ˆæåˆ°çš„ï¼Œå“ˆå“ˆå“ˆï¼›</li>
<li>Kotlin å’Œ Java ç›¸æ¯”ï¼Œæœ‰å“ªäº›ä¼˜ç‚¹ï¼Œæœ‰æ²¡æœ‰åœ¨å®é™…é¡¹ç›®ä¸­ä½¿ç”¨ï¼›</li>
<li>MVC ã€MVP å’Œ MVVM ä¸‰ç§æ¶æ„çš„åŒºåˆ«å’Œä¼˜ç‚¹ï¼›</li>
<li>Vue.js æ•°æ®å’Œè§†å›¾åŒå‘ç»‘å®šçš„åŸç†ï¼Œemmmmmmï¼Œè¿™ä¸ªçœŸçš„ä¸çŸ¥é“ï¼ŒåªçŸ¥é“æœ‰ä¸ª v-bind è¿™ä¸œä¸œï¼›</li>
<li>Retrofit æ¡†æ¶çš„æºç ä»¥åŠåŸç†ï¼›</li>
<li>Android æ’ä»¶åŒ–æ¡†æ¶çš„åŸç†ï¼›</li>
<li>çƒ­æ›´æ–°æ¡†æ¶çš„åŸç†ï¼›</li>
<li>HTTPS çš„åŸç†ï¼›</li>
<li>ç›®å‰åœ¨èŒå…¬å¸ Java å¼€å‘çš„æ¶æ„ï¼›</li>
<li>Android å†…å­˜æ³„éœ²ï¼Œä¸¾ä¾‹å‡ ä¸ªå®¹æ˜“å‘ç”Ÿå†…å­˜æ³„éœ²çš„åœºæ™¯ï¼›</li>
<li>Android Native å’Œ JS é€šä¿¡æœ‰å‡ ç§æ–¹å¼ï¼Œæœ‰æ²¡æœ‰ç”¨åˆ°ä»€ä¹ˆæ¡†æ¶ä¹‹ç±»çš„ï¼›</li>
<li>Android å¸ƒå±€ä¼˜åŒ–ç›¸å…³çš„é—®é¢˜ï¼Œå°±å›ç­”äº† include ã€ merge æ ‡ç­¾å’Œ ViewStub ä»¥åŠé™ä½ View å±‚çº§ä¹‹ç±»çš„ï¼›</li>
<li>æœ‰æ²¡æœ‰äº†è§£è¿‡ React Native æˆ–è€… Weex ï¼›</li>
<li>æ¥ä¸æ¥å—å¤§å°å‘¨ï¼Œæ¥ä¸æ¥å—æ™š ä¸ŠåŠ ç­åŠ çš„æ™šï¼Œæ¥ä¸æ¥å—å¶å°”å‡ºå·®ï¼Œé‚£æˆ‘è‚¯å®šéƒ½è¯´æ¥å—å•Šï¼Œå“ˆå“ˆå“ˆå“ˆï¼›</li>
<li>å‰©ä¸‹çš„ä¹Ÿè®°ä¸æ¸…äº†ï¼Œåæ­£é—®çš„é—®é¢˜ä¸æ˜¯ç‰¹åˆ«éš¾ï¼Œå’Œé¢è¯•å®˜è¯´è¯´ç¬‘ç¬‘å°±è¿‡äº†ï¼›</li>
</ul>
<p>å› ä¸ºå’Œä¸¤ä¸ªé¢è¯•å®˜èŠçš„æ¯”è¾ƒå¼€å¿ƒï¼Œè½»æ¾æ„‰å¿«ã€‚æ‰€ä»¥æŠ€æœ¯é¢é¡ºåˆ©åœ°é€šè¿‡äº†ã€‚æ„Ÿè§‰æˆ‘ä¼šçš„ä¸œè¥¿æ¯”è¾ƒæ‚ï¼Œå³ä¼š Android ï¼Œåˆä¼šå†™ Java ï¼Œè¿˜è‡ªå­¦è¿‡ Vue.js ã€‚</p>
<p>ä¹‹åå°±å«æˆ‘ç­‰å¾… HR é¢è¯•ï¼Œæ­¤æ—¶æ­¤åˆ»ï¼Œæˆ‘ä»¥ä¸ºæˆ‘å·²ç»ç¨³äº†ï¼Œç»“æœæˆ‘ GG äº†ã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œèƒ½åˆ° HR é¢ï¼Œå¯ä»¥è¯´åªè¦åˆ«è„‘æŠ½çŠ¯å‚»ï¼Œoffer å·²ç»æ˜¯æ¢å›Šå–ç‰©äº†ã€‚</p>
<p>å’Œ HR é¢è¯•ä¹Ÿä¸å¤šè¯´äº†ï¼Œå°±æ˜¯é—®åˆ°çš„æ–¹é¢æ¶‰åŠå¾ˆå¤šå¾ˆæ‚ï¼Œå·¥ä½œã€ç”Ÿæ´»å’Œæˆé•¿ç­‰éƒ½æœ‰ï¼Œè‡ªå·±ä¹Ÿå›ç­”å¾—ä¸é”™ã€‚ç»“æœåˆ°æœ€åæ‰äº†é“¾å­ï¼Œå½“ HR é—®åˆ°æˆ‘è‡ªå·±çš„æœŸæœ›è–ªèµ„æ˜¯å¤šå°‘ï¼ŒæŠ¥äº†ä¸€ä¸ªè¾ƒé«˜çš„æ•°å­—ã€‚ç»“æœ HR ä¸€å¬é©¬ä¸Šå°±é—®æˆ‘æœ€ä½èƒ½æ¥å—å¤šå°‘ï¼Ÿæˆ‘è„‘æŠ½åœ°å›ç­”æœ€ä½å°±æ˜¯è¿™ä¸ªæ•°å­—äº†ã€‚ç»“æœï¼Œemmmmmmmmmmï¼Œä¸€é¦–å‡‰å‡‰é€ç»™è‡ªå·±ã€‚</p>
<p>ç°åœ¨å›æƒ³èµ·æ¥ï¼Œä¸çŸ¥é“å½“æ—¶è‡ªå·±å—‘äº†ä»€ä¹ˆè¯ï¼Œå®Œç¾åœ°è‘¬é€äº†ä¸€ä¸ª offer ã€‚</p>
<h2 id="u5F53_u8D1D_u7F51_u7EDC"><a href="#u5F53_u8D1D_u7F51_u7EDC" class="headerlink" title="å½“è´ç½‘ç»œ"></a>å½“è´ç½‘ç»œ</h2><p>è¿™å®¶å…¬å¸æ˜¯è‡ªå·±åœ¨ BOSS ç›´è˜ä¸ŠæŠ•çš„ï¼ˆæ²¡æœ‰æ‰“å¹¿å‘Šï¼‰ï¼Œä¹‹åæ”¶åˆ°é¢è¯•é€šçŸ¥ï¼Œçº¦åœ¨äº†å·¥ä½œæ—¥çš„æ™šä¸Šï¼Œæ‰“ç®—ä¸‹ç­äº†èµ¶è¿‡å»é¢è¯•ã€‚</p>
<p>ä¹‹åäº†è§£åˆ°è¿™å®¶å…¬å¸ä¸“æ³¨äºæ™ºèƒ½ç”µè§†å¹³å°çš„ï¼Œæ——ä¸‹æœ‰ä¸ºæ™ºèƒ½ç”µè§†å’Œå®‰å“ç”µè§†ç›’æ‰“é€ çš„åº”ç”¨å¸‚åœº,å°±åƒæ‰‹æœºé‡Œçš„åº”ç”¨å®ã€è±Œè±†èšä¸€æ ·ï¼Œå¥½åƒåœ¨å›½å†…çš„æ™ºèƒ½ç”µè§†å¸‚åœºé‡Œå¾ˆå‰å®³ï¼Œæ˜¯å¤„äºé¢†å…ˆåœ°ä½ã€‚</p>
<p>å¥½äº†ï¼Œè®²å›é¢è¯•å§ã€‚å› ä¸ºé¢è¯•çš„æ—¶é—´æ¯”è¾ƒç´§æ€¥ï¼Œæ‰€ä»¥ä¹Ÿæ²¡æœ‰å¥½å¥½å‡†å¤‡ï¼Œç»“æœè¢«é¢è¯•å®˜ç»™è™èœäº†ã€‚ä¸Šé¢è¯•é¢˜ï¼š</p>
<ul>
<li>å•å…ƒæµ‹è¯•æœ‰æ²¡æœ‰åšè¿‡ï¼Œè¯´è¯´ç†Ÿæ‚‰çš„å•å…ƒæµ‹è¯•æ¡†æ¶ï¼›</li>
<li>Retrofit æ¡†æ¶çš„åŸï¼Œé‡Œé¢ä½¿ç”¨åˆ°çš„æ³¨è§£æ˜¯ç¼–è¯‘æ—¶æ³¨è§£è¿˜æ˜¯è¿è¡Œæ—¶æ³¨è§£ï¼›</li>
<li>RxJava æ“ä½œç¬¦ï¼Œmap å’Œ flatMap çš„åŒºåˆ«ï¼›</li>
<li>Fragment åœ¨ ViewPager é‡Œé¢çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ»‘åŠ¨ ViewPager çš„é¡µé¢æ—¶ Fragment çš„ç”Ÿå‘½å‘¨æœŸçš„å˜åŒ–ï¼›</li>
<li>å†…å­˜æ³„æ¼ã€‚ä¸¾ä¾‹æœ‰å“ªäº›æƒ…å†µä¼šå‘ç”Ÿå†…å­˜æ³„æ¼ï¼›</li>
<li>Gradle æ‰“åŒ…ï¼›</li>
<li>AOP IOC çš„å¥½å¤„ä»¥åŠåœ¨ Android å¼€å‘ä¸­çš„åº”ç”¨ï¼›</li>
<li>View è§¦æ‘¸äº‹ä»¶åˆ†å‘æœºåˆ¶ï¼›</li>
<li>JavaåŸºç¡€ï¼š static å’Œ final å…³é”®å­—çš„ç”¨æ³•ï¼›</li>
<li>ArrayList å’Œ LinkedList çš„åŒºåˆ«å’Œä½¿ç”¨åœºæ™¯ï¼›</li>
<li>MVC ã€MVP å’Œ MVVM ä¸‰ç§æ¶æ„çš„åŒºåˆ«å’Œä¼˜ç‚¹ï¼›</li>
<li>Dagger2 æ¡†æ¶ä¸­ @module å’Œ @component çš„åŒºåˆ«ï¼›</li>
<li>Kotlin ç‰¹æ€§ï¼Œå’Œ Java ç›¸æ¯”æœ‰ä»€ä¹ˆä¸åŒçš„åœ°æ–¹ï¼›</li>
<li>MVP æ¶æ„ä¸­ Presenter å®šä¹‰ä¸ºæ¥å£æœ‰ä»€ä¹ˆå¥½å¤„ï¼›</li>
<li>JenkinsæŒç»­é›†æˆï¼›</li>
<li>Android æ’ä»¶åŒ–çš„åŸç†ï¼›</li>
<li>Handler ã€MessageQueue ã€Looperä¸‰è€…çš„å…³ç³»å’ŒåŸç†ï¼›</li>
<li>å¯¹äº Android å¼€å‘ï¼Œè‡ªå·±æ“…é•¿å“ªæ–¹é¢ï¼›</li>
<li>JavaåŠ¨æ€ä»£ç†çš„ä½¿ç”¨ï¼ŒInvocationHandler æœ‰ä»€ä¹ˆç”¨ï¼›</li>
<li>ä¸ºä»€ä¹ˆ Google ä¼šæ¨å‡ºFragment ï¼Œæœ‰ä»€ä¹ˆå¥½å¤„å’Œç”¨é€”ï¼Ÿ ç›´æ¥ç”¨ View ä»£æ›¿ä¸è¡Œä¹ˆï¼Ÿ</li>
</ul>
<p>è¿™æ¬¡é¢è¯•æœ‰å¥½å‡ é¢˜éƒ½å›ç­”ä¸ä¸Šæ¥ï¼Œæœ‰äº›åœ°æ–¹ä¸å¤Ÿæ·±å…¥ã€‚é—®äº†ä¸€ä¸‹é¢è¯•å®˜ï¼Œä»–å·²ç»åšäº†å…­å¹´çš„ Android å¼€å‘äº†ï¼Œå‰å®³å‰å®³ã€‚</p>
<p>æœ¬æ¥å›å»çš„è·¯ä¸Šæ„Ÿè§‰è¿™æ¬¡é¢è¯•è‚¯å®šæŒ‚äº†ï¼Œç»“æœå‡ºä¹æ„æ–™åœ°ç¬¬äºŒå¤© HR æ‰“ç»™æˆ‘ç”µè¯è¯´æˆ‘çš„æŠ€æœ¯é¢é€šè¿‡äº†ã€‚ä¹‹åå› ä¸ºè·¯é€”å¤ªé¥è¿œï¼Œæ‰€ä»¥ HR é¢ç›´æ¥åœ¨ç”µè¯é‡Œé¢è¯•äº†ã€‚</p>
<p>æœ€ååœ¨è°ˆè–ªèµ„çš„æ—¶å€™æ„Ÿè§‰è‡ªå·±å¯¹è¿™ä»½ offer æä¾›çš„è–ªèµ„ä¸å¤ªæ»¡æ„ï¼Œæ‰€ä»¥è€ƒè™‘äº†å‡ å¤©æ‹’ç»äº†è¿™ä»½ offer ã€‚ä¹‹åå°±åˆå¼€å§‹å¯»æ‰¾æœ‰æ²¡æœ‰æ›´å¥½çš„æœºä¼šäº†ã€‚</p>
<h2 id="u6709_u8D5E"><a href="#u6709_u8D5E" class="headerlink" title="æœ‰èµ"></a>æœ‰èµ</h2><p>æœ‰èµè¿™å®¶å…¬å¸ä¹Ÿæ˜¯æˆ‘åœ¨ BOSS ä¸ŠæŠ•çš„ï¼ˆçœŸçš„æ²¡æœ‰æ‰“å¹¿å‘Šï¼‰ï¼ŒæŠ•å®Œä¹‹åï¼Œä¸¤ä¸‰å¤©å†…ä¸€ç‚¹æ¶ˆæ¯éƒ½æ²¡æœ‰ï¼Œæˆ‘ä»¥ä¸ºæ˜¯çœ‹ä¸ä¸Šæˆ‘äº†ã€‚ç»“æœä¹‹åå‘çŸ­ä¿¡ç»™æˆ‘è¯´éœ€è¦ç”µè¯é¢è¯•æˆ‘ï¼Œé‚£å°±æ¥å§æ¥å§ï¼Œæ²¡å•¥å¥½è™šçš„ã€‚</p>
<p>æœ‰èµä¹‹å‰è¿˜æ˜¯äº†è§£è¿‡çš„ï¼Œæ˜¯ä¸€å®¶æ¯”è¾ƒæ³¨é‡æŠ€æœ¯çš„å…¬å¸ï¼Œåœ¨æ­å·ä¹Ÿæ˜¯æ¯”è¾ƒæœ‰åæ°”çš„ã€‚æ‰€ä»¥æƒ³å¥½å¥½å‘æŒ¥ï¼Œæ‹¿åˆ° offer ã€‚</p>
<p>æœ‰èµæŠ€æœ¯é¢æˆ‘ä¸€å…±é¢äº†ä¸‰è½®ï¼Œåˆ†åˆ«æ˜¯ï¼šç”µè¯é¢è¯•ã€ç°åœºé¢è¯•ã€Android ç»„ Leader é¢è¯•ã€‚é‚£ä¹ˆæˆ‘å°±æŠŠè¿™ä¸‰è½®çš„é¢è¯•é¢˜ä¸€è½®ä¸€è½®åœ°è¯´ã€‚</p>
<h3 id="u7B2C_u4E00_u8F6E_u7535_u8BDD_u9762_u8BD5"><a href="#u7B2C_u4E00_u8F6E_u7535_u8BDD_u9762_u8BD5" class="headerlink" title="ç¬¬ä¸€è½®ç”µè¯é¢è¯•"></a>ç¬¬ä¸€è½®ç”µè¯é¢è¯•</h3><ul>
<li>é¡¹ç›®ä»‹ç»ï¼Œè‡ªå·±è´Ÿè´£å“ªäº›å†…å®¹ï¼›</li>
<li>å®‰å“å®‰å…¨æ–¹é¢äº†è§£è¿‡å—ï¼Œåç¼–è¯‘ã€åŠ å£³ä¹‹ç±»çš„ï¼›</li>
<li>MVC ã€MVP å’Œ MVVM ä¸‰ç§æ¶æ„çš„åŒºåˆ«å’Œä¼˜ç‚¹ï¼›</li>
<li>Retrofitæ¡†æ¶çš„åŸç†ï¼Œæ„Ÿè§‰è¿™ä¸ªæ¯æ¬¡éƒ½ä¼šè¢«é—®åˆ°ã€‚ã€‚ã€‚ï¼›</li>
<li>HTTPS æ¡æ‰‹çš„æ­¥éª¤å’Œè¿‡ç¨‹ï¼›</li>
<li>Jenkins è‡ªåŠ¨æ„å»ºï¼›</li>
<li>Android Studio 3.0 ä¸­ Gradle çš„ api å’Œ implementation æœ‰ä»€ä¹ˆåŒºåˆ«ï¼›</li>
<li>HandlerThread çš„åŸç†å’Œä½¿ç”¨åœºæ™¯ï¼›</li>
<li>AsnycTask çš„åŸç†å’Œä½¿ç”¨åœºæ™¯ï¼›</li>
<li>Handler ã€MessageQueue ã€Looperä¸‰è€…çš„å…³ç³»å’ŒåŸç†ï¼›</li>
<li>Android æ’ä»¶åŒ–çš„åŸç†ï¼›</li>
<li>çƒ­ä¿®å¤çš„åŸç†ï¼›</li>
<li>åº”ç”¨ç¨‹åºå´©æºƒç»Ÿè®¡ä»¥åŠæ•°æ®åˆ†æï¼›</li>
</ul>
<p>ç”µè¯é¢è¯•çš„å†…å®¹å·®ä¸å¤šå°±è¿™äº›ï¼Œé¢å®Œååˆè¿‡äº†ä¸‰å¤©æ‰ç»™æˆ‘é€šçŸ¥è¯´æœ‰ä¸‹ä¸€è½®é¢è¯•ï¼Œåœ¨æ­¤æœŸé—´æˆ‘ä»¥ä¸ºæˆ‘ç”µè¯é¢è¯•æŒ‚äº†å‘¢ã€‚ã€‚ã€‚</p>
<h3 id="u7B2C_u4E8C_u8F6E_u73B0_u573A_u9762_u8BD5"><a href="#u7B2C_u4E8C_u8F6E_u73B0_u573A_u9762_u8BD5" class="headerlink" title="ç¬¬äºŒè½®ç°åœºé¢è¯•"></a>ç¬¬äºŒè½®ç°åœºé¢è¯•</h3><ul>
<li>Android æ’ä»¶åŒ–çš„åŸç†ï¼›</li>
<li>çƒ­ä¿®å¤çš„åŸç†ï¼›</li>
<li>Java GC å›æ”¶ï¼Œå¦‚ä½•åˆ¤æ–­å¯¹è±¡å­˜æ´»ï¼›</li>
<li>Java GC ç®—æ³•ï¼›</li>
<li>AsyncTask ã€HandlerThread ã€IntentService çš„åŸç†å’Œä½¿ç”¨åœºæ™¯ï¼›</li>
<li>ä¼šå“ªäº› RxJava æ“ä½œç¬¦ï¼Œmap å’Œ flatMap çš„åŒºåˆ«ï¼›</li>
<li>Retrofitæ¡†æ¶çš„åŸç†ï¼Œemmmmmm ï¼Œåˆæ˜¯è¿™ä¸ªï¼›</li>
<li>Bitmap ä¼˜åŒ–ï¼›</li>
<li>RecyclerView å’Œ ListView çš„ç›¸åŒå’Œä¸åŒç‚¹ï¼Œåœ¨ item å›æ”¶ä¸Šæœ‰ä»€ä¹ˆä¸åŒï¼›</li>
<li>View äº‹ä»¶åˆ†å‘æœºåˆ¶ï¼›</li>
<li>è¯´è¯´ apk æ‰“åŒ…æµç¨‹ï¼›</li>
<li>æœ‰æ²¡æœ‰åšè¿‡ apk å¤šæ¸ é“æ‰“åŒ…ï¼›</li>
<li>Android ç»„ä»¶åŒ–çš„åŸç†ï¼Œè¿˜æœ‰ä¸€äº›ç»„ä»¶åŒ–å¹³æ—¶ä½¿ç”¨çš„é—®é¢˜ï¼›</li>
<li>Binder æœ‰æ²¡æœ‰äº†è§£è¿‡ï¼›</li>
<li>HashMap çš„å­˜å‚¨åŸç†ï¼›</li>
<li>Kotlin ç‰¹æ€§ï¼Œå’Œ Java ç›¸æ¯”æœ‰ä»€ä¹ˆä¸åŒçš„åœ°æ–¹ï¼›</li>
<li>Android Frameworkå±‚æœ‰æ²¡æœ‰äº†è§£è¿‡ï¼Œè¯´è¯´ Window çª—å£æ·»åŠ çš„è¿‡ç¨‹ï¼›</li>
<li>Window Activity View ä¸‰è€…çš„å…³ç³»ï¼›</li>
<li>æ¶ˆæ¯æ¨é€æœ‰æ²¡æœ‰åšè¿‡ï¼Œæ¨é€åˆ°è¾¾ç‡çš„é—®é¢˜ï¼›</li>
<li>Android åˆ†äº« SDK æœ‰æ²¡æœ‰åšè¿‡ï¼›</li>
</ul>
<p>ç¬¬äºŒè½®çš„é¢è¯•ä¹Ÿé€šè¿‡äº†ï¼Œä¸è¿‡å› ä¸ºçº¦åœ¨äº†æ™šä¸Šï¼Œæ‰€ä»¥ HR å·²ç»ä¸‹ç­äº†ï¼Œæ‰€ä»¥è·Ÿæˆ‘è¯´ä¹‹åä¼šè”ç³»æˆ‘çš„ã€‚</p>
<h3 id="u7B2C_u4E09_u8F6E_u73B0_u573A_u9762_u8BD5"><a href="#u7B2C_u4E09_u8F6E_u73B0_u573A_u9762_u8BD5" class="headerlink" title="ç¬¬ä¸‰è½®ç°åœºé¢è¯•"></a>ç¬¬ä¸‰è½®ç°åœºé¢è¯•</h3><p>è¿‡äº†ä¸€å¤©ï¼Œæœ‰äººåŠ æˆ‘å¾®ä¿¡ï¼Œè¯´å†çº¦ä¸€æ¬¡æŠ€æœ¯é¢ï¼Œæ˜¯å›¢é˜Ÿé‡Œé¢çš„ Leader æ¥é¢è¯•æˆ‘ã€‚æ²¡åŠæ³•ï¼Œç»§ç»­å¹²ï¼Œåˆçº¦åœ¨äº†å·¥ä½œæ—¥æ™šä¸Šé¢è¯•ã€‚</p>
<ul>
<li>é¡¹ç›®ä»‹ç»ï¼Œè´Ÿè´£å†…å®¹ç­‰ï¼›</li>
<li>HTTPS çš„åŸç†ï¼›</li>
<li>HTTP 2.0 æœ‰æ²¡æœ‰äº†è§£è¿‡ï¼›</li>
<li>è®¨è®ºæŠ€æœ¯å’Œä¸šåŠ¡å“ªä¸ªé‡è¦ï¼›</li>
<li>Android çƒ­ä¿®å¤åŸç†ï¼›</li>
<li>å‰©ä¸‹çš„è®°ä¸ä½äº†â€¦</li>
</ul>
<p>å› ä¸ºæŠ€æœ¯é¢ä¹‹å‰å·²ç»é¢äº†ä¸€è½®ï¼Œæ‰€ä»¥è¿™æ¬¡ Leader é¢è¯•æŠ€æœ¯é—®é¢˜æé—®æ¯”è¾ƒå°‘ï¼Œå¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨äº’ç›¸è®¨è®ºèŠå¤©ï¼Œå½“ç„¶ç»“æœä¹Ÿæ˜¯å¾ˆæ„‰å¿«åœ°ç»“æŸäº†ã€‚ä¹‹åå«æˆ‘ç­‰ä¸€ä¸‹ï¼ŒHR æ¥é¢è¯•æˆ‘ã€‚</p>
<p>å› ä¸ºä¹‹å‰æµ·åº· HR é¢è¿˜è®©æˆ‘å¿ƒæœ‰ä½™æ‚¸ï¼Œæ‰€ä»¥è¿™æ¬¡ HR é¢è¯•ä¹Ÿæ˜¯æ ¼å¤–è°¨æ…ã€‚å¹¸å¥½ï¼ŒHR é¢è¯•æ²¡å‡ºä»€ä¹ˆå¤§é—®é¢˜ï¼Œå«æˆ‘å›å»ç­‰é€šçŸ¥ã€‚ </p>
<p>æœ€åï¼Œç­‰äº†å››å¤©è¿™æ ·å­ï¼Œæœ‰èµ HR ç»™æˆ‘æ‰“ç”µè¯è¯´é¡ºåˆ©é€šè¿‡é¢è¯•äº†ï¼Œç»™æˆ‘å‘äº† offer ï¼Œå¤§åŠŸå‘Šæˆäº†ã€‚</p>
<h1 id="u5199_u5728_u7ED3_u5C3E"><a href="#u5199_u5728_u7ED3_u5C3E" class="headerlink" title="å†™åœ¨ç»“å°¾"></a>å†™åœ¨ç»“å°¾</h1><p>ç°åœ¨å›å¤´çœ‹çœ‹ï¼Œè‡ªå·±é¢è¯•çš„å…¬å¸ä¹Ÿåªæœ‰ä¸‰å››å®¶ï¼Œä¸ç®—å¤šï¼Œä¹Ÿæ˜¯å› ä¸ºè‡ªå·±è¿˜åœ¨èŒçš„åŸå› å§ã€‚</p>
<p>è‡³äºç»“æœä¹Ÿè¿˜ç®—æ»¡æ„ï¼Œæ‹¿åˆ°æœ‰èµçš„ offer ï¼Œåˆè¦å¼€å¯ä¸€æ®µæ–°çš„å¾ç¨‹äº†ã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<h1 id="u70E6_u70E6_u70E6_u70E6"><a href="#u70E6_u70E6_u70E6_u70E6" class="headerlink" title="çƒ¦çƒ¦çƒ¦çƒ¦"></a>çƒ¦çƒ¦çƒ¦çƒ¦</h1><p>è¿‡å®Œå¹´åï¼Œåˆæ˜¯ä¸€æ³¢æ‹›è˜çƒ­å­£ï¼Œå„ç§å¥½å…¬å¸ã€å¥½å²—ä½éƒ½]]>
    </summary>
    
      <category term="Android" scheme="http://yuqirong.me/tags/Android/"/>
    
      <category term="å²æœˆå¦‚æ­Œ" scheme="http://yuqirong.me/tags/%E5%B2%81%E6%9C%88%E5%A6%82%E6%AD%8C/"/>
    
      <category term="Android Blog" scheme="http://yuqirong.me/categories/Android-Blog/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[HTTPSåŠ å¯†åŸç†]]></title>
    <link href="http://yuqirong.me/2018/03/03/HTTPS%E5%8A%A0%E5%AF%86%E5%8E%9F%E7%90%86/"/>
    <id>http://yuqirong.me/2018/03/03/HTTPSåŠ å¯†åŸç†/</id>
    <published>2018-03-03T07:54:24.000Z</published>
    <updated>2018-03-03T12:29:57.518Z</updated>
    <content type="html"><![CDATA[<h1 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h1><p>HTTPã€HTTPSåœ¨æˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­æ˜¯ç»å¸¸ä¼šæ¥è§¦åˆ°çš„ã€‚</p>
<p>æˆ‘ä»¬ä¹Ÿéƒ½çŸ¥é“ï¼Œä¸€èˆ¬ Android åº”ç”¨å¼€å‘ï¼Œåœ¨è¯·æ±‚ API ç½‘ç»œæ¥å£çš„æ—¶å€™ï¼Œå¾ˆå¤šä½¿ç”¨çš„éƒ½æ˜¯ HTTP åè®®ï¼›ä½¿ç”¨æµè§ˆå™¨æ‰“å¼€ç½‘é¡µï¼Œä¹Ÿæ˜¯åˆ©ç”¨ HTTP åè®®ã€‚çœ‹æ¥ HTTP çœŸæ˜¯ä½¿ç”¨å¹¿æ³›å•Šï¼Œä½†æ˜¯ï¼ŒHTTP æ˜¯ä¸å®‰å…¨çš„ã€‚åˆ©ç”¨ç½‘ç»œæŠ“åŒ…å·¥å…·å°±å¯ä»¥çŸ¥é“ä¼ è¾“ä¸­çš„å†…å®¹ï¼Œä¸€è§ˆæ— ä½™ã€‚æ¯”å¦‚æˆ‘ç»å¸¸ä¼šä½¿ç”¨ Fiddler æ¥æŠ“åŒ…ï¼Œæœé›†ä¸€äº›æœ‰è¶£çš„ API æ¥å£ã€‚</p>
<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå¦‚ä½•ä¿è¯ HTTP çš„å®‰å…¨æ€§å‘¢ï¼ŸåŸºæœ¬ä¸Šæ‰€æœ‰çš„äººéƒ½ä¼šè„±å£è€Œå‡ºï¼šä½¿ç”¨ HTTPS åè®®ã€‚99.9% çš„äººéƒ½çŸ¥é“ HTTPS ä¼šå°†ä¼ è¾“çš„å†…å®¹è¿›è¡ŒåŠ å¯†ï¼Œä½†æ˜¯æ¥ç€é—®å…·ä½“åŠ å¯†çš„è¿‡ç¨‹å’Œæ­¥éª¤ï¼Œå¾ˆå¤šäººå°±å“‘å£æ— è¨€äº†ã€‚</p>
<p>ä¸ºäº†é˜²æ­¢å‡ºç°è¿™ç§å°´å°¬çš„å±€é¢ï¼Œæ‰€ä»¥ä»Šå¤©ä½ å°±è¦å¥½å¥½çœ‹çœ‹è¿™ç¯‡çš„å†…å®¹äº†ã€‚ä»¥åå°±å¯ä»¥è£…ä¸ªé€¼ï¼Œå“ˆå“ˆï¼</p>
<h1 id="Body"><a href="#Body" class="headerlink" title="Body"></a>Body</h1><h2 id="u52A0_u5BC6_u7C7B_u578B"><a href="#u52A0_u5BC6_u7C7B_u578B" class="headerlink" title="åŠ å¯†ç±»å‹"></a>åŠ å¯†ç±»å‹</h2><p>å…ˆç§‘æ™®ä¸€ä¸‹ï¼ŒåŠ å¯†ç®—æ³•çš„ç±»å‹åŸºæœ¬ä¸Šåˆ†ä¸ºäº†ä¸¤ç§ï¼š</p>
<ul>
<li>å¯¹ç§°åŠ å¯†ï¼Œæ¯”è¾ƒæœ‰ä»£è¡¨æ€§çš„å°±æ˜¯ AES åŠ å¯†ç®—æ³•ï¼›</li>
<li>éå¯¹ç§°åŠ å¯†ï¼Œç»å¸¸ä½¿ç”¨åˆ°çš„ RSA åŠ å¯†ç®—æ³•å°±æ˜¯éå¯¹ç§°åŠ å¯†çš„ï¼›</li>
</ul>
<p>å¯¹ç§°åŠ å¯†çš„æ„æ€å°±æ˜¯è¯´åŒæ–¹éƒ½æœ‰ä¸€ä¸ªå…±åŒçš„å¯†é’¥ï¼Œç„¶åé€šè¿‡è¿™ä¸ªå¯†é’¥å®ŒæˆåŠ å¯†å’Œè§£å¯†ï¼Œè¿™ç§åŠ å¯†æ–¹å¼é€Ÿåº¦å¿«ï¼Œä½†æ˜¯å®‰å…¨æ€§ä¸å¦‚éå¯¹ç§°åŠ å¯†å¥½ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œç°åœ¨å­¦éœ¸å°æ˜è¿™é‡Œæœ‰ä¸€é“æ•°å­¦é¢˜çš„ç­”æ¡ˆï¼š123 ã€‚ä»–æƒ³æŠŠç­”æ¡ˆä¼ ç»™è‡ªå·±ä¸€ç›´æš—æ‹çš„å°çº¢ã€‚æ‰€ä»¥ä»–ä»¬åŒæ–¹åœ¨è€ƒè¯•å¼€è€ƒå‰ï¼Œçº¦å®šäº†ä¸€æŠŠå¯†é’¥ï¼š456 ã€‚é‚£ä¹ˆå°æ˜å°±æŠŠç­”æ¡ˆå†…å®¹ç»è¿‡å¯†é’¥åŠ å¯†ï¼Œå³ 123 + 456 =  579 ï¼Œå°† 579 å†™åœ¨å°çº¸æ¡ä¸Šæ‰”ç»™å°çº¢ã€‚å¦‚æœæ­¤æ—¶åˆ«äººæ¡åˆ°äº†å°çº¸æ¡ï¼Œä¸çŸ¥é“ä»–ä»¬æ˜¯åŠ å¯†ä¼ è¾“çš„ï¼Œçœ‹åˆ°ä¸Šé¢çš„ 579 ï¼Œä¼šè¯¯ä»¥ä¸ºç­”æ¡ˆå°±æ˜¯ 579 ï¼›å¦‚æœæ˜¯å°çº¢æ¡åˆ°äº†ï¼Œå¥¹æ‹¿å‡ºå¯†é’¥è§£å¯†ï¼Œ579 - 456 = 123 ï¼Œå¾—åˆ°äº†æ­£ç¡®çš„ç­”æ¡ˆã€‚</p>
<p>è¿™å°±æ˜¯æ‰€è°“çš„å¯¹ç§°åŠ å¯†ï¼ŒåŠ è§£å¯†æ•ˆç‡é«˜ï¼Œé€Ÿåº¦å¿«ï¼Œä½†æ˜¯åŒæ–¹ä»»ä½•ä¸€æ–¹ä¸å°å¿ƒæ³„éœ²äº†å¯†é’¥ï¼Œé‚£ä¹ˆä»»ä½•äººéƒ½å¯ä»¥çŸ¥é“ä¼ è¾“å†…å®¹äº†ã€‚</p>
<p>è®²å®Œäº†å¯¹ç§°åŠ å¯†ï¼Œæˆ‘ä»¬çœ‹çœ‹å•¥æ˜¯éå¯¹ç§°åŠ å¯†ã€‚</p>
<p>éå¯¹ç§°åŠ å¯†å°±æ˜¯æœ‰ä¸¤æŠŠå¯†é’¥ï¼Œå…¬é’¥å’Œç§é’¥ã€‚ç§é’¥è‡ªå·±è—ç€ï¼Œä¸å‘Šè¯‰ä»»ä½•äººï¼›è€Œå…¬é’¥å¯ä»¥å…¬å¼€ç»™åˆ«äººã€‚</p>
<p>ç»è¿‡äº†ä¸Šæ¬¡ä½œå¼Šåï¼Œå°çº¢å‘ç°äº†å¯¹ç§°åŠ å¯†å¦‚æœå¯†é’¥æ³„éœ²æ˜¯ä¸€ä»¶å¯æ€•çš„äº‹æƒ…ã€‚æ‰€ä»¥å¥¹å’Œå°æ˜å†³å®šä½¿ç”¨éå¯¹ç§°åŠ å¯†ã€‚å°çº¢ç”Ÿæˆäº†ä¸€å¯¹å…¬é’¥å’Œç§é’¥ï¼Œç„¶åæŠŠå…¬é’¥å…¬å¼€ï¼Œå°æ˜å°±å¾—åˆ°äº†å…¬é’¥ã€‚å°æ˜æ‹¿åˆ°å…¬é’¥åï¼ŒæŠŠç­”æ¡ˆç»è¿‡å…¬é’¥åŠ å¯†ï¼Œç„¶åä¼ è¾“ç»™å°çº¢ï¼Œå°çº¢å†åˆ©ç”¨è‡ªå·±çš„ç§é’¥è¿›è¡Œè§£å¯†ï¼Œå¾—åˆ°ç­”æ¡ˆç»“æœã€‚å¦‚æœåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå…¶ä»–äººå¾—åˆ°ä¼ è¾“çš„å†…å®¹ï¼Œè€Œä»–ä»¬åªæœ‰å°çº¢å…¬é’¥ï¼Œæ˜¯æ²¡æœ‰åŠæ³•è¿›è¡Œè§£å¯†çš„ï¼Œæ‰€ä»¥ä¹Ÿå°±å¾—ä¸åˆ°ç­”æ¡ˆï¼Œåªæœ‰å°çº¢ä¸€ä¸ªäººå¯ä»¥è§£å¯†ã€‚</p>
<p>å› æ­¤ï¼Œç›¸æ¯”è¾ƒå¯¹ç§°åŠ å¯†è€Œè¨€ï¼Œéå¯¹ç§°åŠ å¯†å®‰å…¨æ€§æ›´é«˜ï¼Œä½†æ˜¯åŠ è§£å¯†è€—è´¹çš„æ—¶é—´æ›´é•¿ï¼Œé€Ÿåº¦æ…¢ã€‚</p>
<p>å¯¹ç§°åŠ å¯†å’Œéå¯¹ç§°åŠ å¯†çš„å…·ä½“åº”ç”¨æˆ‘è¿˜æ˜¯æ·±æœ‰ä½“ä¼šçš„ï¼Œå› ä¸ºæ‰€åœ¨çš„å…¬å¸æ˜¯åšé‡‘èæ”¯ä»˜æ–¹é¢çš„ï¼Œæ‰€ä»¥åŠ è§£å¯†åŸºæœ¬ä¸Šç®—æ˜¯å¤©å¤©è§äº†ã€‚</p>
<h2 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h2><p>è¯´å®ŒåŠ å¯†ç±»å‹åï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹ HTTPS ã€‚</p>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªå…¬å¼ï¼š</p>
<p>HTTPS = HTTP + SSL </p>
<p>ä»è¿™ä¸ªå…¬å¼ä¸­å¯ä»¥çœ‹å‡ºï¼ŒHTTPS å’Œ HTTP å°±å·®åœ¨äº† SSL ä¸Šã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥çŒœåˆ°ï¼ŒHTTPS çš„åŠ å¯†å°±æ˜¯åœ¨ SSL ä¸­å®Œæˆçš„ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬çš„ç›®çš„å°±æ˜¯è¦ææ‡‚åœ¨ SSL ä¸­ç©¶ç«Ÿå¹²äº†ä»€ä¹ˆè§ä¸å¾—äººçš„äº‹äº†ï¼Ÿ</p>
<p>è¿™å°±è¦ä» CA è¯ä¹¦è®²èµ·äº†ã€‚CA è¯ä¹¦å…¶å®å°±æ˜¯æ•°å­—è¯ä¹¦ï¼Œæ˜¯ç”± CA æœºæ„é¢å‘çš„ã€‚è‡³äº CA æœºæ„çš„æƒå¨æ€§ï¼Œé‚£ä¹ˆæ˜¯æ¯‹åº¸ç½®ç–‘çš„ï¼Œæ‰€æœ‰äººéƒ½æ˜¯ä¿¡ä»»å®ƒçš„ã€‚CA è¯ä¹¦å†…ä¸€èˆ¬ä¼šåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š</p>
<ul>
<li>è¯ä¹¦çš„é¢å‘æœºæ„ã€ç‰ˆæœ¬</li>
<li>è¯ä¹¦çš„ä½¿ç”¨è€…</li>
<li>è¯ä¹¦çš„å…¬é’¥</li>
<li>è¯ä¹¦çš„æœ‰æ•ˆæ—¶é—´</li>
<li>è¯ä¹¦çš„æ•°å­—ç­¾å Hash å€¼å’Œç­¾å Hash ç®—æ³•</li>
<li>â€¦</li>
</ul>
<p>æ­£å¥½æˆ‘ä»¬æŠŠå®¢æˆ·ç«¯å¦‚ä½•æ ¡éªŒ CA è¯ä¹¦çš„æ­¥éª¤è¯´ä¸‹å§ã€‚</p>
<p>CA è¯ä¹¦ä¸­çš„ Hash å€¼ï¼Œå…¶å®æ˜¯ç”¨è¯ä¹¦çš„ç§é’¥è¿›è¡ŒåŠ å¯†åçš„å€¼ï¼ˆè¯ä¹¦çš„ç§é’¥ä¸åœ¨ CA è¯ä¹¦ä¸­ï¼‰ã€‚ç„¶åå®¢æˆ·ç«¯å¾—åˆ°è¯ä¹¦åï¼Œåˆ©ç”¨è¯ä¹¦ä¸­çš„å…¬é’¥å»è§£å¯†è¯¥ Hash å€¼ï¼Œå¾—åˆ° Hash-a ï¼›ç„¶åå†åˆ©ç”¨è¯ä¹¦å†…çš„ç­¾å Hash ç®—æ³•å»ç”Ÿæˆä¸€ä¸ª Hash-b ã€‚æœ€åæ¯”è¾ƒ Hash-a å’Œ Hash-b è¿™ä¸¤ä¸ªçš„å€¼ã€‚å¦‚æœç›¸ç­‰ï¼Œé‚£ä¹ˆè¯æ˜äº†è¯¥è¯ä¹¦æ˜¯å¯¹çš„ï¼ŒæœåŠ¡ç«¯æ˜¯å¯ä»¥è¢«ä¿¡ä»»çš„ï¼›å¦‚æœä¸ç›¸ç­‰ï¼Œé‚£ä¹ˆå°±è¯´æ˜è¯¥è¯ä¹¦æ˜¯é”™è¯¯çš„ï¼Œå¯èƒ½è¢«ç¯¡æ”¹äº†ï¼Œæµè§ˆå™¨ä¼šç»™å‡ºç›¸å…³æç¤ºï¼Œæ— æ³•å»ºç«‹èµ· HTTPS è¿æ¥ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜ä¼šæ ¡éªŒ CA è¯ä¹¦çš„æœ‰æ•ˆæ—¶é—´å’ŒåŸŸååŒ¹é…ç­‰ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥è¯¦ç»†è®²ä¸€ä¸‹ HTTPS ä¸­çš„ SSL æ¡æ‰‹å»ºç«‹è¿‡ç¨‹ï¼Œå‡è®¾ç°åœ¨æœ‰å®¢æˆ·ç«¯ A å’ŒæœåŠ¡å™¨ B ï¼š</p>
<ol>
<li>é¦–å…ˆï¼Œå®¢æˆ·ç«¯ A è®¿é—®æœåŠ¡å™¨ B ï¼Œæ¯”å¦‚æˆ‘ä»¬ç”¨æµè§ˆå™¨æ‰“å¼€ä¸€ä¸ªç½‘é¡µ <a href="https://www.baidu.com" target="_blank" rel="external">https://www.baidu.com</a> ï¼Œè¿™æ—¶ï¼Œæµè§ˆå™¨å°±æ˜¯å®¢æˆ·ç«¯ A ï¼Œç™¾åº¦çš„æœåŠ¡å™¨å°±æ˜¯æœåŠ¡å™¨ B äº†ã€‚è¿™æ—¶å€™å®¢æˆ·ç«¯ A ä¼šç”Ÿæˆä¸€ä¸ªéšæœºæ•°1ï¼ŒæŠŠéšæœºæ•°1 ã€è‡ªå·±æ”¯æŒçš„ SSL ç‰ˆæœ¬å·ä»¥åŠåŠ å¯†ç®—æ³•ç­‰è¿™äº›ä¿¡æ¯å‘Šè¯‰æœåŠ¡å™¨ B ã€‚</li>
<li>æœåŠ¡å™¨ B çŸ¥é“è¿™äº›ä¿¡æ¯åï¼Œç„¶åç¡®è®¤ä¸€ä¸‹åŒæ–¹çš„åŠ å¯†ç®—æ³•ï¼Œç„¶åæœåŠ¡ç«¯ä¹Ÿç”Ÿæˆä¸€ä¸ªéšæœºæ•° B ï¼Œå¹¶å°†éšæœºæ•° B å’Œ CA é¢å‘ç»™è‡ªå·±çš„è¯ä¹¦ä¸€åŒè¿”å›ç»™å®¢æˆ·ç«¯ A ã€‚</li>
<li>å®¢æˆ·ç«¯ A å¾—åˆ° CA è¯ä¹¦åï¼Œä¼šå»æ ¡éªŒè¯¥ CA è¯ä¹¦çš„æœ‰æ•ˆæ€§ï¼Œæ ¡éªŒæ–¹æ³•åœ¨ä¸Šé¢å·²ç»è¯´è¿‡äº†ã€‚æ ¡éªŒé€šè¿‡åï¼Œå®¢æˆ·ç«¯ç”Ÿæˆä¸€ä¸ªéšæœºæ•°3 ï¼Œç„¶åç”¨è¯ä¹¦ä¸­çš„å…¬é’¥åŠ å¯†éšæœºæ•°3 å¹¶ä¼ è¾“ç»™æœåŠ¡ç«¯ B ã€‚</li>
<li>æœåŠ¡ç«¯ B å¾—åˆ°åŠ å¯†åçš„éšæœºæ•°3ï¼Œç„¶ååˆ©ç”¨ç§é’¥è¿›è¡Œè§£å¯†ï¼Œå¾—åˆ°çœŸæ­£çš„éšæœºæ•°3ã€‚</li>
<li>æœ€åï¼Œå®¢æˆ·ç«¯ A å’ŒæœåŠ¡ç«¯ B éƒ½æœ‰éšæœºæ•°1ã€éšæœºæ•°2ã€éšæœºæ•°3ï¼Œç„¶ååŒæ–¹åˆ©ç”¨è¿™ä¸‰ä¸ªéšæœºæ•°ç”Ÿæˆä¸€ä¸ªå¯¹è¯å¯†é’¥ã€‚ä¹‹åä¼ è¾“å†…å®¹å°±æ˜¯åˆ©ç”¨å¯¹è¯å¯†é’¥æ¥è¿›è¡ŒåŠ è§£å¯†äº†ã€‚è¿™æ—¶å°±æ˜¯åˆ©ç”¨äº†å¯¹ç§°åŠ å¯†ï¼Œä¸€èˆ¬ç”¨çš„éƒ½æ˜¯ AES ç®—æ³•ã€‚</li>
<li>å®¢æˆ·ç«¯ A é€šçŸ¥æœåŠ¡ç«¯ B ï¼ŒæŒ‡æ˜åé¢çš„é€šè®¯ç”¨å¯¹è¯å¯†é’¥æ¥å®Œæˆï¼ŒåŒæ—¶é€šçŸ¥æœåŠ¡å™¨ B å®¢æˆ·ç«¯ A çš„æ¡æ‰‹è¿‡ç¨‹ç»“æŸã€‚</li>
<li>æœåŠ¡ç«¯ B é€šçŸ¥å®¢æˆ·ç«¯ Aï¼ŒæŒ‡æ˜åé¢çš„é€šè®¯ç”¨å¯¹è¯å¯†é’¥æ¥å®Œæˆï¼ŒåŒæ—¶é€šçŸ¥å®¢æˆ·ç«¯ A æœåŠ¡å™¨ B çš„æ¡æ‰‹è¿‡ç¨‹ç»“æŸã€‚</li>
<li>SSL çš„æ¡æ‰‹éƒ¨åˆ†ç»“æŸï¼ŒSSL å®‰å…¨é€šé“çš„æ•°æ®é€šè®¯å¼€å§‹ï¼Œå®¢æˆ·ç«¯ A å’ŒæœåŠ¡å™¨ B å¼€å§‹ä½¿ç”¨ç›¸åŒçš„å¯¹è¯å¯†é’¥è¿›è¡Œæ•°æ®é€šè®¯ã€‚</li>
</ol>
<p>åˆ°æ­¤ï¼ŒSSL æ¡æ‰‹è¿‡ç¨‹å°±è®²å®Œäº†ã€‚å¯èƒ½ä¸Šé¢çš„æµç¨‹å¤ªè¿‡äºå¤æ‚ï¼Œæˆ‘ä»¬ç®€å•åœ°æ¥è®²ï¼š</p>
<ol>
<li>å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å»ºç«‹ SSL æ¡æ‰‹ï¼Œå®¢æˆ·ç«¯é€šè¿‡ CA è¯ä¹¦æ¥ç¡®è®¤æœåŠ¡ç«¯çš„èº«ä»½ï¼›</li>
<li>äº’ç›¸ä¼ é€’ä¸‰ä¸ªéšæœºæ•°ï¼Œä¹‹åé€šè¿‡è¿™éšæœºæ•°æ¥ç”Ÿæˆä¸€ä¸ªå¯†é’¥ï¼›</li>
<li>äº’ç›¸ç¡®è®¤å¯†é’¥ï¼Œç„¶åæ¡æ‰‹ç»“æŸï¼›</li>
<li>æ•°æ®é€šè®¯å¼€å§‹ï¼Œéƒ½ä½¿ç”¨åŒä¸€ä¸ªå¯¹è¯å¯†é’¥æ¥åŠ è§£å¯†ï¼›</li>
</ol>
<p>æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œåœ¨ HTTPS åŠ å¯†åŸç†çš„è¿‡ç¨‹ä¸­æŠŠå¯¹ç§°åŠ å¯†å’Œéå¯¹ç§°åŠ å¯†éƒ½åˆ©ç”¨äº†èµ·æ¥ã€‚å³åˆ©ç”¨äº†éå¯¹ç§°åŠ å¯†å®‰å…¨æ€§é«˜çš„ç‰¹ç‚¹ï¼Œåˆåˆ©ç”¨äº†å¯¹ç§°åŠ å¯†é€Ÿåº¦å¿«ï¼Œæ•ˆç‡é«˜çš„å¥½å¤„ã€‚çœŸçš„æ˜¯è®¾è®¡å¾—éå¸¸ç²¾å¦™ï¼Œä»¤äººèµä¸ç»å£ã€‚</p>
<h1 id="Footer"><a href="#Footer" class="headerlink" title="Footer"></a>Footer</h1><p>å¥½äº†ï¼ŒHTTPS åŠ å¯†åŸç†åˆ°è¿™å°±è®²çš„å·®ä¸å¤šäº†ï¼Œä¸çŸ¥é“ç”µè„‘å‰çš„ä½ æœ‰æ²¡æœ‰çœ‹æ‡‚å‘¢ï¼Ÿ</p>
<p>å¦‚æœæœ‰å“ªé‡Œä¸æ˜ç™½çš„åœ°æ–¹ï¼Œå¯ä»¥åœ¨åº•ä¸‹ç•™è¨€äº¤æµã€‚</p>
<p>bye ~~</p>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ul>
<li><a href="http://blog.damonare.cn/2017/12/29/SSL%E5%8D%8F%E8%AE%AE%E4%B9%8B%E6%95%B0%E6%8D%AE%E5%8A%A0%E5%AF%86%E8%BF%87%E7%A8%8B%E8%AF%A6%E8%A7%A3/" target="_blank" rel="external">SSLåè®®ä¹‹æ•°æ®åŠ å¯†è¿‡ç¨‹è¯¦è§£</a></li>
</ul>
]]></content>
    <summary type="html">
    <![CDATA[<h1 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h1><p>HTTPã€HTTPSåœ¨æˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­æ˜¯ç»å¸¸ä¼šæ¥è§¦åˆ°çš„ã€‚</p>
<p>æˆ‘ä»¬ä¹Ÿéƒ½çŸ¥é“ï¼Œä¸€èˆ¬ Android åº”]]>
    </summary>
    
      <category term="ç®—æ³•" scheme="http://yuqirong.me/tags/%E7%AE%97%E6%B3%95/"/>
    
      <category term="ç½‘ç»œ" scheme="http://yuqirong.me/tags/%E7%BD%91%E7%BB%9C/"/>
    
      <category term="ç®—æ³•" scheme="http://yuqirong.me/categories/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[LinkedListå†…éƒ¨åŸç†è§£æ]]></title>
    <link href="http://yuqirong.me/2018/01/31/LinkedList%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/"/>
    <id>http://yuqirong.me/2018/01/31/LinkedListå†…éƒ¨åŸç†è§£æ/</id>
    <published>2018-01-31T11:59:21.000Z</published>
    <updated>2018-02-03T09:58:26.492Z</updated>
    <content type="html"><![CDATA[<p>æ³¨ï¼šæœ¬æ–‡è§£æçš„ LinkedList æºä»£ç åŸºäº Java 1.8 ã€‚</p>
<h1 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h1><p>List é›†åˆä¸­ï¼Œä¹‹å‰åˆ†æäº† ArrayList ï¼Œè¿˜å‰©ä¸‹äº† LinkedList æ²¡æœ‰åˆ†æè¿‡ã€‚é‚£ä¹ˆè¶ç€ä»Šå¤©æœ‰ç©ºï¼Œå°±æŠŠ LinkedList çš„å†…éƒ¨åŸç†æ¥è®²è®²å§ã€‚</p>
<p>LinkedList æ˜¯æœ‰åºå¹¶ä¸”å¯ä»¥å…ƒç´ é‡å¤çš„é›†åˆï¼Œåº•å±‚æ˜¯åŸºäºåŒå‘é“¾è¡¨çš„ã€‚ä¹Ÿæ­£å› ä¸ºæ˜¯é“¾è¡¨ï¼Œæ‰€ä»¥ä¹Ÿå°±æ²¡æœ‰åŠ¨æ€æ‰©å®¹çš„æ­¥éª¤äº†ã€‚</p>
<h1 id="u6E90_u7801_u5206_u6790"><a href="#u6E90_u7801_u5206_u6790" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h1><h2 id="u6784_u9020_u65B9_u6CD5"><a href="#u6784_u9020_u65B9_u6CD5" class="headerlink" title="æ„é€ æ–¹æ³•"></a>æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedList</span><span class="params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>();</span><br><span class="line">    addAll(c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ„é€ æ–¹æ³•ä¸€ä¸ªæ˜¯é»˜è®¤çš„ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯ä¼ å…¥ä¸€ä¸ªé›†åˆï¼Œç„¶åè°ƒç”¨ addAll æ–¹æ³•æ·»åŠ é›†åˆæ‰€æœ‰çš„å…ƒç´ ã€‚</p>
<h2 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h2><p>LinkedList æ—¢ç„¶ä½œä¸ºé“¾è¡¨ï¼Œé‚£ä¹ˆè‚¯å®šä¼šæœ‰èŠ‚ç‚¹äº†ï¼Œæˆ‘ä»¬çœ‹ä¸‹èŠ‚ç‚¹çš„å®šä¹‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">    E item;</span><br><span class="line">    Node&lt;E&gt; next;</span><br><span class="line">    Node&lt;E&gt; prev;</span><br><span class="line"></span><br><span class="line">    Node(Node&lt;E&gt; prev, E element, Node&lt;E&gt; next) &#123;</span><br><span class="line">        <span class="keyword">this</span>.item = element;</span><br><span class="line">        <span class="keyword">this</span>.next = next;</span><br><span class="line">        <span class="keyword">this</span>.prev = prev;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¯ä¸ªèŠ‚ç‚¹éƒ½åŒ…å«äº†å‰ä¸€ä¸ªèŠ‚ç‚¹ prev ä»¥åŠåä¸€ä¸ªèŠ‚ç‚¹ next ï¼Œitem å°±æ˜¯è¦å½“å‰èŠ‚ç‚¹è¦å­˜å‚¨çš„å…ƒç´ ã€‚</p>
<h2 id="add_28E_e_29"><a href="#add_28E_e_29" class="headerlink" title="add(E e)"></a>add(E e)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ç›´æ¥å¾€é˜Ÿå°¾åŠ å…ƒç´ </span></span><br><span class="line">    linkLast(e);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">linkLast</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä¿å­˜åŸæ¥é“¾è¡¨å°¾éƒ¨èŠ‚ç‚¹ï¼Œlast æ˜¯å…¨å±€å˜é‡ï¼Œç”¨æ¥è¡¨ç¤ºé˜Ÿå°¾å…ƒç´ </span></span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; l = last;</span><br><span class="line">    <span class="comment">// ä¸ºè¯¥å…ƒç´  e æ–°å»ºä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; newNode = <span class="keyword">new</span> Node&lt;&gt;(l, e, <span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">// å°†æ–°èŠ‚ç‚¹è®¾ä¸ºé˜Ÿå°¾</span></span><br><span class="line">    last = newNode;</span><br><span class="line">    <span class="comment">// å¦‚æœåŸæ¥çš„é˜Ÿå°¾å…ƒç´ ä¸ºç©ºï¼Œé‚£ä¹ˆè¯´æ˜åŸæ¥çš„æ•´ä¸ªåˆ—è¡¨æ˜¯ç©ºçš„ï¼Œå°±æŠŠæ–°èŠ‚ç‚¹èµ‹å€¼ç»™å¤´ç»“ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (l == <span class="keyword">null</span>)</span><br><span class="line">        first = newNode;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    <span class="comment">// åŸæ¥å°¾ç»“ç‚¹çš„åé¢ä¸ºæ–°ç”Ÿæˆçš„ç»“ç‚¹</span></span><br><span class="line">        l.next = newNode;</span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹æ•° +1</span></span><br><span class="line">    size++;</span><br><span class="line">    modCount++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>linkLast(E e)</code> ä¸­ï¼Œå…ˆå»åˆ¤æ–­äº†åŸæ¥çš„å°¾èŠ‚ç‚¹æ˜¯å¦ä¸ºç©ºã€‚å¦‚æœå°¾èŠ‚ç‚¹æ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆå°±è¯´æ˜åŸæ¥çš„åˆ—è¡¨æ˜¯ç©ºçš„ã€‚ä¼šå°†å¤´èŠ‚ç‚¹ä¹ŸæŒ‡å‘è¯¥å…ƒç´ ï¼›å¦‚æœä¸ä¸ºç©ºï¼Œç›´æ¥åœ¨åé¢è¿½åŠ å³å¯ã€‚</p>
<p>å…¶å®åœ¨ first ä¹‹å‰ï¼Œè¿˜æœ‰ä¸€ä¸ªä¸º null çš„ head èŠ‚ç‚¹ã€‚head èŠ‚ç‚¹çš„ next æ‰æ˜¯ first èŠ‚ç‚¹ã€‚</p>
<h2 id="add_28int_index_2C_E_element_29"><a href="#add_28int_index_2C_E_element_29" class="headerlink" title="add(int index, E element)"></a>add(int index, E element)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> index, E element)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ£€æŸ¥ index æœ‰æ²¡æœ‰è¶…å‡ºç´¢å¼•èŒƒå›´</span></span><br><span class="line">    checkPositionIndex(index);</span><br><span class="line">    <span class="comment">// å¦‚æœè¿½åŠ åˆ°å°¾éƒ¨ï¼Œé‚£ä¹ˆå°±è·Ÿ add(E e) ä¸€æ ·äº†</span></span><br><span class="line">    <span class="keyword">if</span> (index == size)</span><br><span class="line">        linkLast(element);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    <span class="comment">// å¦åˆ™å°±æ˜¯æ’åœ¨å…¶ä»–ä½ç½®</span></span><br><span class="line">        linkBefore(element, node(index));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>add(int index, E element)</code> ä¸­ä¸»è¦å°±çœ‹ <code>linkBefore(element, node(index))</code> æ–¹æ³•äº†ã€‚æ³¨æ„åˆ°æœ‰ä¸€ä¸ª <code>node(index)</code> ï¼Œå¥½å¥‡ç©¶ç«Ÿåšäº†ä»€ä¹ˆæ“ä½œï¼Ÿ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Node&lt;E&gt; <span class="title">node</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// assert isElementIndex(index);</span></span><br><span class="line">    <span class="comment">// å¦‚æœ index åœ¨å‰åŠæ®µï¼Œä»å‰å¾€åéå†è·å– node</span></span><br><span class="line">    <span class="keyword">if</span> (index &lt; (size &gt;&gt; <span class="number">1</span>)) &#123;</span><br><span class="line">        Node&lt;E&gt; x = first;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; index; i++)</span><br><span class="line">            x = x.next;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœ index åœ¨ååŠæ®µï¼Œä»åå¾€å‰éå†è·å– node</span></span><br><span class="line">        Node&lt;E&gt; x = last;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = size - <span class="number">1</span>; i &gt; index; i--)</span><br><span class="line">            x = x.prev;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŸæ¥æ˜¯ä¸ºäº†ç´¢å¼•å¾—åˆ° index å¯¹åº”çš„èŠ‚ç‚¹ï¼Œåœ¨é€Ÿåº¦ä¸Šåšäº†ç®—æ³•ä¼˜åŒ–ã€‚</p>
<p>å¾—åˆ° Node åï¼Œå°±ä¼šå»è°ƒç”¨ <code>linkBefore(element, node)</code> ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">linkBefore</span><span class="params">(E e, Node&lt;E&gt; succ)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// assert succ != null;</span></span><br><span class="line">    <span class="comment">// ä¿å­˜ index èŠ‚ç‚¹çš„å‰èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; pred = succ.prev;</span><br><span class="line">    <span class="comment">// æ–°å»ºä¸€ä¸ªç›®æ ‡èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; newNode = <span class="keyword">new</span> Node&lt;&gt;(pred, e, succ);</span><br><span class="line">    succ.prev = newNode;</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯åœ¨å¼€å¤´å¤„æ’å…¥çš„è¯</span></span><br><span class="line">    <span class="keyword">if</span> (pred == <span class="keyword">null</span>)</span><br><span class="line">        first = newNode;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        pred.next = newNode;</span><br><span class="line">    size++;</span><br><span class="line">    modCount++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç å’Œä¹‹å‰çš„å¾ˆç±»ä¼¼ï¼Œäº†è§£é“¾è¡¨èŠ‚ç‚¹æ’å…¥çš„åŒå­¦å¯¹è¿™æ®µä»£ç åº”è¯¥å¾ˆ easy äº†ã€‚</p>
<h2 id="addAll_28Collection_26lt_3B_3F_extends_E_26gt_3B_c_29"><a href="#addAll_28Collection_26lt_3B_3F_extends_E_26gt_3B_c_29" class="headerlink" title="addAll(Collection&lt;? extends E&gt; c)"></a>addAll(Collection&lt;? extends E&gt; c)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">addAll</span><span class="params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> addAll(size, c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>addAll(Collection&lt;? extends E&gt; c)</code> å†…éƒ¨ç›´æ¥è°ƒç”¨çš„æ˜¯ <code>addAll(int index, Collection&lt;? extends E&gt; c)</code> ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">addAll</span><span class="params">(<span class="keyword">int</span> index, Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// index ç´¢å¼•èŒƒå›´åˆ¤æ–­</span></span><br><span class="line">    checkPositionIndex(index);</span><br><span class="line"></span><br><span class="line">    Object[] a = c.toArray();</span><br><span class="line">    <span class="keyword">int</span> numNew = a.length;</span><br><span class="line">    <span class="keyword">if</span> (numNew == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¿å­˜ä¹‹å‰çš„å‰èŠ‚ç‚¹å’ŒåèŠ‚ç‚¹</span></span><br><span class="line">    Node&lt;E&gt; pred, succ;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯åœ¨å°¾éƒ¨æ’å…¥è¿˜æ˜¯åœ¨å…¶ä»–ä½ç½®æ’å…¥</span></span><br><span class="line">    <span class="keyword">if</span> (index == size) &#123;</span><br><span class="line">        succ = <span class="keyword">null</span>;</span><br><span class="line">        pred = last;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        succ = node(index);</span><br><span class="line">        pred = succ.prev;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Object o : a) &#123;</span><br><span class="line">        <span class="annotation">@SuppressWarnings</span>(<span class="string">"unchecked"</span>) E e = (E) o;</span><br><span class="line">        Node&lt;E&gt; newNode = <span class="keyword">new</span> Node&lt;&gt;(pred, e, <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">// å¦‚æœå‰èŠ‚ç‚¹æ˜¯ç©ºçš„ï¼Œå°±è¯´æ˜æ˜¯åœ¨å¤´éƒ¨æ’å…¥äº†</span></span><br><span class="line">        <span class="keyword">if</span> (pred == <span class="keyword">null</span>)</span><br><span class="line">            first = newNode;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            pred.next = newNode;</span><br><span class="line">        pred = newNode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (succ == <span class="keyword">null</span>) &#123;</span><br><span class="line">        last = pred;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        pred.next = succ;</span><br><span class="line">        succ.prev = pred;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    size += numNew;</span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>addAll(int index, Collection&lt;? extends E&gt; c)</code> å…¶å®å°±æ˜¯ç›¸å½“äºå¤šæ¬¡è¿›è¡Œ <code>add(int index, E element)</code> æ“ä½œï¼Œåœ¨å†…éƒ¨å¾ªç¯æ·»åŠ åˆ°é“¾è¡¨ä¸Šã€‚</p>
<h2 id="get_28int_index_29"><a href="#get_28int_index_29" class="headerlink" title="get(int index)"></a>get(int index)</h2><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> E get(<span class="keyword">int</span> <span class="keyword">index</span>) &#123;</span><br><span class="line">    checkElementIndex(<span class="keyword">index</span>);</span><br><span class="line">    <span class="keyword">return</span> node(<span class="keyword">index</span>).item;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨å†…éƒ¨è°ƒç”¨äº† <code>node(index)</code> æ–¹æ³•ï¼Œè€Œ <code>node(index)</code> æ–¹æ³•åœ¨ä¸Šé¢å·²ç»åˆ†æè¿‡äº†ã€‚å°±æ˜¯åˆ¤æ–­åœ¨å‰åŠæ®µè¿˜æ˜¯åœ¨ååŠæ®µï¼Œç„¶åéå†å¾—åˆ°å³å¯ã€‚</p>
<h2 id="remove_28int_index_29"><a href="#remove_28int_index_29" class="headerlink" title="remove(int index)"></a>remove(int index)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">remove</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    checkElementIndex(index);</span><br><span class="line">    <span class="keyword">return</span> unlink(node(index));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>remove(int index)</code> ä¸­è°ƒç”¨äº† <code>unlink(Node&lt;E&gt; x)</code> æ–¹æ³•æ¥ç§»é™¤è¯¥èŠ‚ç‚¹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">E <span class="title">unlink</span><span class="params">(Node&lt;E&gt; x)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// assert x != null;</span></span><br><span class="line">    <span class="keyword">final</span> E element = x.item;</span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; next = x.next;</span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; prev = x.prev;</span><br><span class="line">    <span class="comment">// å¦‚æœè¦åˆ é™¤çš„æ˜¯å¤´èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè®¾ç½®å¤´èŠ‚ç‚¹ä¸ºä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (prev == <span class="keyword">null</span>) &#123;</span><br><span class="line">        first = next;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// è®¾ç½®è¯¥èŠ‚ç‚¹çš„å‰èŠ‚ç‚¹çš„ next ä¸ºè¯¥èŠ‚ç‚¹çš„ next</span></span><br><span class="line">        prev.next = next;</span><br><span class="line">        x.prev = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœè¦åˆ é™¤çš„æ˜¯å°¾èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè®¾ç½®å°¾èŠ‚ç‚¹ä¸ºä¸Šä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (next == <span class="keyword">null</span>) &#123;</span><br><span class="line">        last = prev;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// è®¾ç½®è¯¥èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„ prev ä¸ºè¯¥èŠ‚ç‚¹çš„ prev</span></span><br><span class="line">        next.prev = prev;</span><br><span class="line">        x.next = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è®¾ç½® null å€¼ï¼Œsize--</span></span><br><span class="line">    x.item = <span class="keyword">null</span>;</span><br><span class="line">    size--;</span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="keyword">return</span> element;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="remove_28Object_o_29"><a href="#remove_28Object_o_29" class="headerlink" title="remove(Object o)"></a>remove(Object o)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (o == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Node&lt;E&gt; x = first; x != <span class="keyword">null</span>; x = x.next) &#123;</span><br><span class="line">            <span class="keyword">if</span> (x.item == <span class="keyword">null</span>) &#123;</span><br><span class="line">                unlink(x);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Node&lt;E&gt; x = first; x != <span class="keyword">null</span>; x = x.next) &#123;</span><br><span class="line">            <span class="keyword">if</span> (o.equals(x.item)) &#123;</span><br><span class="line">                unlink(x);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>remove(Object o)</code> çš„ä»£ç å°±æ˜¯éå†é“¾è¡¨ï¼Œç„¶åå¾—åˆ°ç›¸ç­‰çš„å€¼å°±æŠŠå®ƒ <code>unlink(x)</code> äº†ã€‚è‡³äº <code>unlink(Node&lt;E&gt; x)</code> çš„ä»£ç ï¼Œä¸Šé¢å·²ç»åˆ†æè¿‡å•¦ã€‚</p>
<h2 id="set_28int_index_2C_E_element_29"><a href="#set_28int_index_2C_E_element_29" class="headerlink" title="set(int index, E element)"></a>set(int index, E element)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">set</span><span class="params">(<span class="keyword">int</span> index, E element)</span> </span>&#123;</span><br><span class="line">    checkElementIndex(index);</span><br><span class="line">    Node&lt;E&gt; x = node(index);</span><br><span class="line">    E oldVal = x.item;</span><br><span class="line">    <span class="comment">// è®¾ç½® x èŠ‚ç‚¹çš„å€¼ä¸ºæ–°å€¼ï¼Œç„¶åè¿”å›æ—§å€¼</span></span><br><span class="line">    x.item = element;</span><br><span class="line">    <span class="keyword">return</span> oldVal;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="clear_28_29"><a href="#clear_28_29" class="headerlink" title="clear()"></a>clear()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// éå†é“¾è¡¨ï¼Œç„¶åä¸€ä¸€åˆ é™¤ç½®ç©º</span></span><br><span class="line">    <span class="keyword">for</span> (Node&lt;E&gt; x = first; x != <span class="keyword">null</span>; ) &#123;</span><br><span class="line">        Node&lt;E&gt; next = x.next;</span><br><span class="line">        x.item = <span class="keyword">null</span>;</span><br><span class="line">        x.next = <span class="keyword">null</span>;</span><br><span class="line">        x.prev = <span class="keyword">null</span>;</span><br><span class="line">        x = next;</span><br><span class="line">    &#125;</span><br><span class="line">    first = last = <span class="keyword">null</span>;</span><br><span class="line">    size = <span class="number">0</span>;</span><br><span class="line">    modCount++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Footer"><a href="#Footer" class="headerlink" title="Footer"></a>Footer</h1><p>LinkedList ç›¸å¯¹äº ArrayList æ¥è¯´ï¼Œæºç ä¼šå¤æ‚ä¸€ç‚¹ã€‚å› ä¸ºæ¶‰åŠåˆ°äº†é“¾è¡¨ï¼Œæ‰€ä»¥ä¼šæœ‰ prev å’Œ next ä¹‹åˆ†ã€‚ä½†æ˜¯é™ä¸‹å¿ƒæ¥é˜…è¯»ï¼Œè¿˜æ˜¯å¯ä»¥çœ‹æ‡‚çš„ã€‚</p>
<p>åŸºç¡€é›†åˆç±»çš„æºç éƒ½çœ‹å¾—å·®ä¸å¤šäº†ï¼Œç›®å‰ä¸ºæ­¢ä¸€å…±åˆ†æäº† ArrayListã€LinkedListã€HashMap å’Œ HashSet å››ä¸ªç±»ã€‚</p>
<p>ä¹‹åæœ‰ç©ºçš„è¯è¿˜æœ‰æ›´å¤šçš„é›†åˆç±»ä¼šè¿›è¡Œæºç è§£æï¼Œé‚£ä¹ˆå¥½å¥½åŠªåŠ›å§ã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>æ³¨ï¼šæœ¬æ–‡è§£æçš„ LinkedList æºä»£ç åŸºäº Java 1.8 ã€‚</p>
<h1 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h1><p>List é›†åˆä¸­ï¼Œä¹‹å‰]]>
    </summary>
    
      <category term="Java" scheme="http://yuqirong.me/tags/Java/"/>
    
      <category term="æ•°æ®ç»“æ„" scheme="http://yuqirong.me/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
      <category term="æºç è§£æ" scheme="http://yuqirong.me/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    
      <category term="Java Blog" scheme="http://yuqirong.me/categories/Java-Blog/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[HashSetå†…éƒ¨åŸç†è§£æ]]></title>
    <link href="http://yuqirong.me/2018/01/28/HashSet%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/"/>
    <id>http://yuqirong.me/2018/01/28/HashSetå†…éƒ¨åŸç†è§£æ/</id>
    <published>2018-01-28T12:07:55.000Z</published>
    <updated>2018-01-29T15:26:03.561Z</updated>
    <content type="html"><![CDATA[<p>æ³¨ï¼šæœ¬æ–‡è§£æçš„ HashSet æºä»£ç åŸºäº Java 1.8 ã€‚</p>
<h1 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h1><p>HashSetæ˜¯ç”¨æ¥å­˜å‚¨æ²¡æœ‰é‡å¤å…ƒç´ çš„é›†åˆç±»ï¼Œå¹¶ä¸”å®ƒæ˜¯æ— åºçš„ã€‚</p>
<p>HashSet å†…éƒ¨å®ç°æ˜¯åŸºäº HashMap ï¼Œå®ç°äº† Set æ¥å£ã€‚</p>
<h1 id="u6E90_u7801_u89E3_u6790"><a href="#u6E90_u7801_u89E3_u6790" class="headerlink" title="æºç è§£æ"></a>æºç è§£æ</h1><h2 id="u6784_u9020_u65B9_u6CD5"><a href="#u6784_u9020_u65B9_u6CD5" class="headerlink" title="æ„é€ æ–¹æ³•"></a>æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashSet</span><span class="params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class="line">    map = <span class="keyword">new</span> HashMap&lt;&gt;(Math.max((<span class="keyword">int</span>) (c.size()/.<span class="number">75f</span>) + <span class="number">1</span>, <span class="number">16</span>));</span><br><span class="line">    addAll(c);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashSet</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span> </span>&#123;</span><br><span class="line">    map = <span class="keyword">new</span> HashMap&lt;&gt;(initialCapacity, loadFactor);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashSet</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">    map = <span class="keyword">new</span> HashMap&lt;&gt;(initialCapacity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">HashSet(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor, <span class="keyword">boolean</span> dummy) &#123;</span><br><span class="line">    map = <span class="keyword">new</span> LinkedHashMap&lt;&gt;(initialCapacity, loadFactor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å‘ç°ï¼Œé™¤äº†æœ€åä¸€ä¸ª HashSet çš„æ„é€ æ–¹æ³•å¤–ï¼Œå…¶ä»–æ‰€æœ‰å†…éƒ¨å°±æ˜¯å»åˆ›å»ºä¸€ä¸ª Hashap ã€‚æ²¡æœ‰å…¶ä»–çš„æ“ä½œã€‚è€Œæœ€åä¸€ä¸ªæ„é€ æ–¹æ³•ä¸æ˜¯ public çš„ï¼Œæ‰€ä»¥ä¸å¯¹å¤–å…¬å¼€ã€‚</p>
<h2 id="add"><a href="#add" class="headerlink" title="add"></a>add</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// PRESENT = new Object()</span></span><br><span class="line">    <span class="keyword">return</span> map.put(e, PRESENT)==<span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>add æ–¹æ³•å¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨ map ä¸­æ”¾å…¥ä¸€é”®å€¼å¯¹ã€‚ key å°±æ˜¯è¦å­˜å…¥çš„å…ƒç´ ï¼Œvalue æ˜¯ PRESENT ï¼Œå…¶å®å°±æ˜¯ new Object() ã€‚æ‰€ä»¥ï¼ŒHashSet æ˜¯ä¸èƒ½é‡å¤çš„ã€‚</p>
<h2 id="remove"><a href="#remove" class="headerlink" title="remove"></a>remove</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> map.remove(o)==PRESENT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç›¸åº”çš„ï¼Œremove å°±æ˜¯ä» map ä¸­ç§»é™¤ key ã€‚</p>
<h2 id="contains"><a href="#contains" class="headerlink" title="contains"></a>contains</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">contains</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> map.containsKey(o);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™äº›ä»£ç åº”è¯¥å¾ˆæ˜ç™½ï¼Œä¸éœ€è¦è®²äº†ã€‚</p>
<h2 id="iterator"><a href="#iterator" class="headerlink" title="iterator"></a>iterator</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Iterator&lt;E&gt; <span class="title">iterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> map.keySet().iterator();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å†…éƒ¨è°ƒç”¨çš„å°±æ˜¯ HashMap ä¸­ keySet çš„ iterator æ–¹æ³•ã€‚</p>
<h2 id="size"><a href="#size" class="headerlink" title="size"></a>size</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> map.size();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‰©ä¸‹çš„ HashSet æ–¹æ³•ä¹Ÿä¸å¤šï¼Œå†…éƒ¨ä¹Ÿéƒ½æ˜¯é€šè¿‡ HashMap å®ç°çš„ã€‚å°±ä¸è´´å‡ºæ¥äº†ï¼Œå¤§å®¶å›å»çœ‹ä¸€ä¸‹éƒ½ä¼šæ˜ç™½çš„ã€‚</p>
<h1 id="Footer"><a href="#Footer" class="headerlink" title="Footer"></a>Footer</h1><p>ä»ä¸Šçœ‹ä¸‹æ¥ï¼ŒHashSet çš„æºç æ˜¯æŒºç®€å•çš„ï¼Œå†…éƒ¨éƒ½æ˜¯ç”¨ HashMap æ¥å®ç°çš„ã€‚åˆ©ç”¨äº† HashMap çš„ key ä¸èƒ½é‡å¤è¿™ä¸ªåŸç†æ¥å®ç° HashSet ã€‚</p>
<p>å†…å®¹å¾ˆç®€çŸ­ï¼Œéƒ½è®²å®Œäº†ï¼Œå†è§ã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>æ³¨ï¼šæœ¬æ–‡è§£æçš„ HashSet æºä»£ç åŸºäº Java 1.8 ã€‚</p>
<h1 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h1><p>HashSetæ˜¯ç”¨æ¥å­˜å‚¨æ²¡æœ‰]]>
    </summary>
    
      <category term="Java" scheme="http://yuqirong.me/tags/Java/"/>
    
      <category term="æ•°æ®ç»“æ„" scheme="http://yuqirong.me/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
      <category term="æºç è§£æ" scheme="http://yuqirong.me/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    
      <category term="Java Blog" scheme="http://yuqirong.me/categories/Java-Blog/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[ArrayListå†…éƒ¨åŸç†è§£æ]]></title>
    <link href="http://yuqirong.me/2018/01/21/ArrayList%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/"/>
    <id>http://yuqirong.me/2018/01/21/ArrayListå†…éƒ¨åŸç†è§£æ/</id>
    <published>2018-01-21T10:12:10.000Z</published>
    <updated>2018-01-27T09:06:25.903Z</updated>
    <content type="html"><![CDATA[<p>æ³¨ï¼šæœ¬æ–‡è§£æçš„ ArrayList æºä»£ç åŸºäº Java 1.8 ã€‚</p>
<h1 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h1><p>ä¹‹å‰è®²äº† HashMap çš„åŸç†åï¼Œä»Šå¤©æ¥çœ‹ä¸€ä¸‹ ArrayList ã€‚</p>
<p>ArrayList ä¹Ÿæ˜¯éå¸¸å¸¸ç”¨çš„é›†åˆç±»ã€‚å®ƒæ˜¯æœ‰åºçš„å¹¶ä¸”å¯ä»¥å­˜å‚¨é‡å¤å…ƒç´ çš„ã€‚ ArrayList åº•å±‚å…¶å®å°±æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå¹¶ä¸”ä¼šåŠ¨æ€æ‰©å®¹çš„ã€‚</p>
<h1 id="u6E90_u7801_u5206_u6790"><a href="#u6E90_u7801_u5206_u6790" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h1><h2 id="u6784_u9020_u65B9_u6CD5"><a href="#u6784_u9020_u65B9_u6CD5" class="headerlink" title="æ„é€ æ–¹æ³•"></a>æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayList</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºåˆå§‹å®¹é‡çš„æ•°ç»„</span></span><br><span class="line">        <span class="keyword">this</span>.elementData = <span class="keyword">new</span> Object[initialCapacity];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (initialCapacity == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.elementData = EMPTY_ELEMENTDATA;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal Capacity: "</span>+</span><br><span class="line">                                           initialCapacity);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// é»˜è®¤ä¸ºç©ºæ•°ç»„</span></span><br><span class="line">    <span class="keyword">this</span>.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayList</span><span class="params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class="line">    elementData = c.toArray();</span><br><span class="line">    <span class="keyword">if</span> ((size = elementData.length) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// c.toArray might (incorrectly) not return Object[] (see 6260652)</span></span><br><span class="line">        <span class="comment">// å°†é›†åˆä¸­çš„å…ƒç´ å¤åˆ¶åˆ°æ•°ç»„ä¸­</span></span><br><span class="line">        <span class="keyword">if</span> (elementData.getClass() != Object[].class)</span><br><span class="line">            elementData = Arrays.copyOf(elementData, size, Object[].class);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// replace with empty array.</span></span><br><span class="line">        <span class="keyword">this</span>.elementData = EMPTY_ELEMENTDATA;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ„é€ æ–¹æ³•ä¸­çš„ä»£ç æ¯”è¾ƒç®€çŸ­ï¼Œå¤§å®¶éƒ½èƒ½ç†è§£çš„å§ã€‚</p>
<h2 id="add_28_29"><a href="#add_28_29" class="headerlink" title="add()"></a>add()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ç¡®ä¿æ•°ç»„çš„å®¹é‡ï¼Œä¿è¯å¯ä»¥æ·»åŠ è¯¥å…ƒç´ </span></span><br><span class="line">    ensureCapacityInternal(size + <span class="number">1</span>);  <span class="comment">// Increments modCount!!</span></span><br><span class="line">    <span class="comment">// å°†è¯¥å…ƒç´ æ”¾å…¥æ•°ç»„ä¸­</span></span><br><span class="line">    elementData[size++] = e;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‘ç°åœ¨ <code>add()</code> æ–¹æ³•ä¸­ï¼Œä»£ç å¾ˆç®€çŸ­ã€‚å¯ä»¥çœ‹å‡ºä¹‹å‰çš„é¢„æ“ä½œéƒ½æ”¾å…¥äº† <code>ensureCapacityInternal</code> æ–¹æ³•ä¸­ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šå»ç¡®ä¿è¯¥å…ƒç´ åœ¨æ•°ç»„ä¸­æœ‰ä½ç½®å¯ä»¥æ”¾å…¥ã€‚</p>
<p>é‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ensureCapacityInternal</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœæ•°ç»„æ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆä¼šåˆå§‹åŒ–è¯¥æ•°ç»„</span></span><br><span class="line">    <span class="keyword">if</span> (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA) &#123;</span><br><span class="line">        <span class="comment">// DEFAULT_CAPACITY ä¸º 10 ï¼Œæ‰€ä»¥è°ƒç”¨æ— å‚é»˜è®¤ ArrayList æ„é€ æ–¹æ³•åˆå§‹åŒ–çš„è¯ï¼Œé»˜è®¤çš„æ•°ç»„å®¹é‡ä¸º 10</span></span><br><span class="line">        minCapacity = Math.max(DEFAULT_CAPACITY, minCapacity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ensureExplicitCapacity(minCapacity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ensureExplicitCapacity</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">    modCount++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¡®ä¿æ•°ç»„çš„å®¹é‡ï¼Œå¦‚æœä¸å¤Ÿçš„è¯ï¼Œè°ƒç”¨ grow æ–¹æ³•æ‰©å®¹</span></span><br><span class="line">    <span class="keyword">if</span> (minCapacity - elementData.length &gt; <span class="number">0</span>)</span><br><span class="line">        grow(minCapacity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>çœ‹äº†åŠå¤©ï¼Œæ‰©å®¹æ˜¯åœ¨ grow æ–¹æ³•ä¸­å®Œæˆçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥ç€è·Ÿè¿›ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">grow</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å½“å‰æ•°ç»„çš„å®¹é‡</span></span><br><span class="line">    <span class="keyword">int</span> oldCapacity = elementData.length;</span><br><span class="line">    <span class="comment">// æ–°æ•°ç»„æ‰©å®¹ä¸ºåŸæ¥å®¹é‡çš„ 1.5 å€</span></span><br><span class="line">    <span class="keyword">int</span> newCapacity = oldCapacity + (oldCapacity &gt;&gt; <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// å¦‚æœæ–°æ•°ç»„æ‰©å®¹å®¹é‡è¿˜æ˜¯æ¯”æœ€å°‘éœ€è¦çš„å®¹é‡è¿˜è¦å°çš„è¯ï¼Œå°±è®¾ç½®æ‰©å……å®¹é‡ä¸ºæœ€å°éœ€è¦çš„å®¹é‡</span></span><br><span class="line">    <span class="keyword">if</span> (newCapacity - minCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        newCapacity = minCapacity;</span><br><span class="line">    <span class="comment">//åˆ¤æ–­æ–°æ•°ç»„å®¹é‡æ˜¯å¦å·²ç»è¶…å‡ºæœ€å¤§æ•°ç»„èŒƒå›´ï¼ŒMAX_ARRAY_SIZE = Integer.MAX_VALUE - 8</span></span><br><span class="line">    <span class="keyword">if</span> (newCapacity - MAX_ARRAY_SIZE &gt; <span class="number">0</span>)</span><br><span class="line">        newCapacity = hugeCapacity(minCapacity);</span><br><span class="line">    <span class="comment">// minCapacity is usually close to size, so this is a win:</span></span><br><span class="line">    <span class="comment">// å¤åˆ¶å…ƒç´ åˆ°æ–°çš„æ•°ç»„ä¸­</span></span><br><span class="line">    elementData = Arrays.copyOf(elementData, newCapacity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰©å®¹æ–¹æ³•å…¶å®å°±æ˜¯æ–°åˆ›å»ºä¸€ä¸ªæ•°ç»„ï¼Œç„¶åå°†æ—§æ•°ç»„çš„å…ƒç´ éƒ½å¤åˆ¶åˆ°æ–°æ•°ç»„é‡Œé¢ã€‚</p>
<p>å½“ç„¶ï¼Œadd è¿˜æœ‰ä¸€ä¸ªé‡è½½çš„æ–¹æ³• <code>add(int index, E element)</code> ï¼Œé¡ºä¾¿æˆ‘ä»¬ä¹Ÿæ¥çœ‹ä¸€ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> index, E element)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­ index æœ‰æ²¡æœ‰è¶…å‡ºç´¢å¼•çš„èŒƒå›´</span></span><br><span class="line">    rangeCheckForAdd(index);</span><br><span class="line">    <span class="comment">// å’Œä¹‹å‰çš„æ“ä½œæ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯ä¿è¯æ•°ç»„çš„å®¹é‡è¶³å¤Ÿ</span></span><br><span class="line">    ensureCapacityInternal(size + <span class="number">1</span>);  <span class="comment">// Increments modCount!!</span></span><br><span class="line">    <span class="comment">// å°†æŒ‡å®šä½ç½®åŠå…¶åé¢æ•°æ®å‘åç§»åŠ¨ä¸€ä½</span></span><br><span class="line">    System.arraycopy(elementData, index, elementData, index + <span class="number">1</span>,</span><br><span class="line">                     size - index);</span><br><span class="line">    <span class="comment">// å°†è¯¥å…ƒç´ æ·»åŠ åˆ°æŒ‡å®šçš„æ•°ç»„ä½ç½®</span></span><br><span class="line">    elementData[index] = element;</span><br><span class="line">    <span class="comment">// ArrayList çš„å¤§å°æ”¹å˜</span></span><br><span class="line">    size++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¥½äº†ï¼Œadd æ–¹æ³•çœ‹çš„å·®ä¸å¤šäº†ï¼Œå‰©ä¸‹è¿˜æœ‰ä¸€ä¸ª <code>addAll(Collection&lt;? extends E&gt; c)</code> æ–¹æ³•ä¹Ÿæ˜¯æ¢æ±¤ä¸æ¢è¯çš„ï¼Œå¯ä»¥è‡ªå·±å›å»çœ‹ä¸‹ï¼Œè¿™é‡Œå°±ä¸è®²äº†ã€‚</p>
<h2 id="get_28_29"><a href="#get_28_29" class="headerlink" title="get()"></a>get()</h2><p>get æ–¹æ³•å¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨æ•°ç»„ä¸­è¿”å›æŒ‡å®šä½ç½®çš„å…ƒç´ å³å¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">get</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ£€æŸ¥ index æœ‰æ²¡æœ‰è¶…å‡ºç´¢å¼•çš„èŒƒå›´</span></span><br><span class="line">    rangeCheck(index);</span><br><span class="line">    <span class="comment">// è¿”å›æŒ‡å®šä½ç½®çš„å…ƒç´ </span></span><br><span class="line">    <span class="keyword">return</span> elementData(index);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="remove_28_29"><a href="#remove_28_29" class="headerlink" title="remove()"></a>remove()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">remove</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ£€æŸ¥ index æœ‰æ²¡æœ‰è¶…å‡ºç´¢å¼•çš„èŒƒå›´</span></span><br><span class="line">    rangeCheck(index);</span><br><span class="line"></span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="comment">// ä¿å­˜ä¸€ä¸‹éœ€è¦åˆ é™¤çš„æ•°æ®</span></span><br><span class="line">    E oldValue = elementData(index);</span><br><span class="line">    <span class="comment">// è®©æŒ‡å®šåˆ é™¤çš„ä½ç½®åé¢çš„æ•°æ®ï¼Œå‘å‰ç§»åŠ¨ä¸€ä½</span></span><br><span class="line">    <span class="keyword">int</span> numMoved = size - index - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (numMoved &gt; <span class="number">0</span>)</span><br><span class="line">        System.arraycopy(elementData, index+<span class="number">1</span>, elementData, index,</span><br><span class="line">                         numMoved);</span><br><span class="line">    <span class="comment">// æ–¹ä¾¿ gc é‡Šæ”¾å†…å­˜</span></span><br><span class="line">    elementData[--size] = <span class="keyword">null</span>; <span class="comment">// clear to let GC do its work</span></span><br><span class="line">    <span class="comment">// è¿”å›æ—§å€¼</span></span><br><span class="line">    <span class="keyword">return</span> oldValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>remove ä¸­ä¸»è¦æ˜¯å°†ä¹‹åçš„å…ƒç´ éƒ½å‘å‰ä¸€ä½ç§»åŠ¨ï¼Œç„¶åå°†æœ€åä¸€ä½çš„å€¼è®¾ç½®ä¸ºç©ºã€‚æœ€åï¼Œè¿”å›å·²ç»åˆ é™¤çš„å€¼ã€‚</p>
<p>åŒæ ·ï¼Œremove è¿˜æœ‰ä¸€ä¸ªé‡è½½çš„æ–¹æ³• <code>remove(Object o)</code> ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (o == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœæœ‰å…ƒç´ çš„å€¼ä¸º null çš„è¯ï¼Œç§»é™¤è¯¥å…ƒç´ ï¼ŒfastRemove çš„æ“ä½œå’Œä¸Šé¢çš„ remove(int index) æ˜¯ç±»ä¼¼çš„</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; size; index++)</span><br><span class="line">            <span class="keyword">if</span> (elementData[index] == <span class="keyword">null</span>) &#123;</span><br><span class="line">                fastRemove(index);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœæœ‰å…ƒç´ çš„å€¼ç­‰äº o çš„è¯ï¼Œç§»é™¤è¯¥å…ƒç´ </span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; size; index++)</span><br><span class="line">            <span class="keyword">if</span> (o.equals(elementData[index])) &#123;</span><br><span class="line">                fastRemove(index);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="clear_28_29"><a href="#clear_28_29" class="headerlink" title="clear()"></a>clear()</h2><p>clear æ–¹æ³•æ— éå°±æ˜¯éå†æ•°ç»„ï¼Œç„¶åæŠŠæ‰€æœ‰çš„å€¼éƒ½ç½®ä¸º null ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    modCount++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// clear to let GC do its work</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">        elementData[i] = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    size = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Footer"><a href="#Footer" class="headerlink" title="Footer"></a>Footer</h1><p>è‡³æ­¤ï¼ŒArrayList ä¸»è¦çš„å‡ ä¸ªæ–¹æ³•å°±è®²å®Œäº†ã€‚ArrayList çš„æºç è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼ŒåŸºæœ¬ä¸Šéƒ½å¯ä»¥çœ‹å¾—æ˜ç™½ã€‚</p>
<p>æˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹ï¼š</p>
<ol>
<li>ArrayListåº•å±‚æ˜¯åŸºäºæ•°ç»„æ¥å®ç°çš„ï¼Œå› æ­¤åœ¨ get çš„æ—¶å€™æ•ˆç‡é«˜ï¼Œè€Œ add æˆ–è€… remove çš„æ—¶å€™ï¼Œæ•ˆç‡ä½ï¼›</li>
<li>è°ƒç”¨é»˜è®¤çš„ ArrayList æ— å‚æ„é€ æ–¹æ³•çš„è¯ï¼Œæ•°ç»„çš„åˆå§‹å®¹é‡ä¸º 10 ï¼›</li>
<li>ArrayList ä¼šè‡ªåŠ¨æ‰©å®¹ï¼Œæ‰©å®¹çš„æ—¶å€™ï¼Œä¼šå°†å®¹é‡æ‰©è‡³åŸæ¥çš„ 1.5 å€ï¼›</li>
<li>ArrayList ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼›</li>
</ol>
<p>é‚£ä¹ˆä»Šå¤©å°±è¿™æ ·äº†ï¼Œä¹‹åæœ‰ç©ºç»™å¤§å®¶è®²è®² LinkedList ã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>æ³¨ï¼šæœ¬æ–‡è§£æçš„ ArrayList æºä»£ç åŸºäº Java 1.8 ã€‚</p>
<h1 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h1><p>ä¹‹å‰è®²äº† HashMap]]>
    </summary>
    
      <category term="Java" scheme="http://yuqirong.me/tags/Java/"/>
    
      <category term="æ•°æ®ç»“æ„" scheme="http://yuqirong.me/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
      <category term="æºç è§£æ" scheme="http://yuqirong.me/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    
      <category term="Java Blog" scheme="http://yuqirong.me/categories/Java-Blog/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[HashMapå†…éƒ¨åŸç†è§£æ]]></title>
    <link href="http://yuqirong.me/2018/01/13/HashMap%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/"/>
    <id>http://yuqirong.me/2018/01/13/HashMapå†…éƒ¨åŸç†è§£æ/</id>
    <published>2018-01-13T10:14:31.000Z</published>
    <updated>2018-11-11T12:07:13.872Z</updated>
    <content type="html"><![CDATA[<p>æ³¨ï¼šæœ¬æ–‡è§£æçš„ HashMap æºä»£ç åŸºäº Java 1.7 ã€‚</p>
<h1 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h1><p>HashMap åœ¨å¹³æ—¶ Java/Android å¼€å‘ä¸­ï¼Œæ˜¯ç»å¤§å¤šæ•°å¼€å‘è€…éƒ½æ™®éä½¿ç”¨çš„é›†åˆç±»ã€‚</p>
<p>å®ƒå†…éƒ¨æ˜¯åŸºäºå“ˆå¸Œè¡¨å®ç°çš„é”®å€¼å¯¹å­˜å‚¨ï¼Œç»§æ‰¿ AbstractMap å¹¶ä¸”å®ç°äº† Map æ¥å£ã€‚</p>
<p>è€Œå¯¹äºå®ƒçš„ get/put ä½¿ç”¨æ–¹æ³•ç›¸ä¿¡å¤§å®¶éƒ½å·²ç»åˆ°äº†ç‚‰ç«çº¯é’çš„åœ°æ­¥ã€‚è™½ç„¶éƒ½ä¼šç”¨ï¼Œå´å¯èƒ½æ²¡æœ‰å¥½å¥½æ·±å…¥æ¢è®¨è¿‡ HashMap å†…éƒ¨çš„å®ç°åŸç†ã€‚æ­£å¥½è¶ç€æœ‰æ—¶é—´ï¼Œä»Šå¤©å°±ç»™å¤§å®¶ä¸€æ­¥æ­¥åœ°è§£æ HashMap çš„å†…éƒ¨å®ç°åŸç†ã€‚</p>
<p>åœ¨è¿™å°±åŸºäºäº† Java 1.7 çš„æºä»£ç æ¥è®²è§£äº†ï¼ŒJava 1.8 çš„ HashMap æºç ç›¸æ¯” Java 1.7 åšäº†ä¸€äº›æ”¹åŠ¨ã€‚å…·ä½“çš„æ”¹åŠ¨ç­‰åˆ°æˆ‘ä»¬æœ€åå†è¯´ã€‚</p>
<h1 id="HashMap__u5FC5_u77E5"><a href="#HashMap__u5FC5_u77E5" class="headerlink" title="HashMap å¿…çŸ¥"></a>HashMap å¿…çŸ¥</h1><p>ä»¥ä¸‹æ˜¯ HashMap æºç é‡Œé¢çš„ä¸€äº›å…³é”®æˆå‘˜å˜é‡ä»¥åŠçŸ¥è¯†ç‚¹ã€‚åœ¨åé¢çš„æºç è§£æä¸­ä¼šé‡åˆ°ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ‰å¿…è¦å…ˆäº†è§£ä¸‹ã€‚</p>
<ol>
<li>initialCapacityï¼šåˆå§‹å®¹é‡ã€‚æŒ‡çš„æ˜¯ HashMap é›†åˆåˆå§‹åŒ–çš„æ—¶å€™è‡ªèº«çš„å®¹é‡ã€‚å¯ä»¥åœ¨æ„é€ æ–¹æ³•ä¸­æŒ‡å®šï¼›å¦‚æœä¸æŒ‡å®šçš„è¯ï¼Œæ€»å®¹é‡é»˜è®¤å€¼æ˜¯ 16 ã€‚éœ€è¦æ³¨æ„çš„æ˜¯åˆå§‹å®¹é‡å¿…é¡»æ˜¯ 2 çš„å¹‚æ¬¡æ–¹ã€‚</li>
<li>sizeï¼šå½“å‰ HashMap ä¸­å·²ç»å­˜å‚¨ç€çš„é”®å€¼å¯¹æ•°é‡ï¼Œå³ <code>HashMap.size()</code> ã€‚</li>
<li>loadFactorï¼šåŠ è½½å› å­ã€‚æ‰€è°“çš„åŠ è½½å› å­å°±æ˜¯ HashMap (å½“å‰çš„å®¹é‡/æ€»å®¹é‡) åˆ°è¾¾ä¸€å®šå€¼çš„æ—¶å€™ï¼ŒHashMap ä¼šå®æ–½æ‰©å®¹ã€‚åŠ è½½å› å­ä¹Ÿå¯ä»¥é€šè¿‡æ„é€ æ–¹æ³•ä¸­æŒ‡å®šï¼Œé»˜è®¤çš„å€¼æ˜¯ 0.75 ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æœ‰ä¸€ä¸ª HashMap çš„åˆå§‹å®¹é‡ä¸º 16 ï¼Œé‚£ä¹ˆæ‰©å®¹çš„é˜€å€¼å°±æ˜¯ 0.75 * 16 = 12 ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ä½ æ‰“ç®—å­˜å…¥ç¬¬ 13 ä¸ªå€¼çš„æ—¶å€™ï¼ŒHashMap ä¼šå…ˆæ‰§è¡Œæ‰©å®¹ã€‚</li>
<li>thresholdï¼šæ‰©å®¹é˜€å€¼ã€‚å³ æ‰©å®¹é˜€å€¼ = HashMap æ€»å®¹é‡ * åŠ è½½å› å­ã€‚å½“å‰ HashMap çš„å®¹é‡å¤§äºæˆ–ç­‰äºæ‰©å®¹é˜€å€¼çš„æ—¶å€™å°±ä¼šå»æ‰§è¡Œæ‰©å®¹ã€‚æ‰©å®¹çš„å®¹é‡ä¸ºå½“å‰ HashMap æ€»å®¹é‡çš„ä¸¤å€ã€‚æ¯”å¦‚ï¼Œå½“å‰ HashMap çš„æ€»å®¹é‡ä¸º 16 ï¼Œé‚£ä¹ˆæ‰©å®¹ä¹‹åä¸º 32 ã€‚</li>
<li>tableï¼šEntry æ•°ç»„ã€‚æˆ‘ä»¬éƒ½çŸ¥é“ HashMap å†…éƒ¨å­˜å‚¨ key/value æ˜¯é€šè¿‡ Entry è¿™ä¸ªä»‹è´¨æ¥å®ç°çš„ã€‚è€Œ table å°±æ˜¯ Entry æ•°ç»„ã€‚</li>
<li>åœ¨ Java 1.7 ä¸­ï¼ŒHashMap çš„å®ç°æ–¹æ³•æ˜¯æ•°ç»„ + é“¾è¡¨çš„å½¢å¼ã€‚ä¸Šé¢çš„ table å°±æ˜¯æ•°ç»„ï¼Œè€Œæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ ï¼Œéƒ½æ˜¯é“¾è¡¨çš„ç¬¬ä¸€ä¸ªç»“ç‚¹ã€‚å³å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br> <img src="/uploads/20180114/20180114111559.png" alt="20180114111559"></li>
</ol>
<h1 id="u6E90_u7801_u5206_u6790"><a href="#u6E90_u7801_u5206_u6790" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h1><h2 id="u6784_u9020_u65B9_u6CD5"><a href="#u6784_u9020_u65B9_u6CD5" class="headerlink" title="æ„é€ æ–¹æ³•"></a>æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é»˜è®¤çš„æ„é€ æ–¹æ³•ä½¿ç”¨çš„éƒ½æ˜¯é»˜è®¤çš„åˆå§‹å®¹é‡å’ŒåŠ è½½å› å­</span></span><br><span class="line"><span class="comment">// DEFAULT_INITIAL_CAPACITY = 16ï¼ŒDEFAULT_LOAD_FACTOR = 0.75</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(DEFAULT_INITIAL_CAPACITY, DEFAULT_LOAD_FACTOR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯ä»¥æŒ‡å®šåˆå§‹å®¹é‡ï¼Œå¹¶ä¸”ä½¿ç”¨é»˜è®¤çš„åŠ è½½å› å­</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(initialCapacity, DEFAULT_LOAD_FACTOR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¯¹åˆå§‹å®¹é‡çš„å€¼åˆ¤æ–­</span></span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal initial capacity: "</span> +</span><br><span class="line">                                           initialCapacity);</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &gt; MAXIMUM_CAPACITY)</span><br><span class="line">        initialCapacity = MAXIMUM_CAPACITY;</span><br><span class="line">    <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal load factor: "</span> +</span><br><span class="line">                                           loadFactor);</span><br><span class="line">    <span class="comment">// è®¾ç½®åŠ è½½å› å­</span></span><br><span class="line">    <span class="keyword">this</span>.loadFactor = loadFactor;</span><br><span class="line">    threshold = initialCapacity;</span><br><span class="line">    <span class="comment">// ç©ºæ–¹æ³•</span></span><br><span class="line">    init();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>HashMap çš„æ‰€æœ‰æ„é€ æ–¹æ³•æœ€åéƒ½ä¼šå»è°ƒç”¨ <code>HashMap(int initialCapacity, float loadFactor)</code> ã€‚åœ¨å…¶å†…éƒ¨å»è®¾ç½®åˆå§‹å®¹é‡å’ŒåŠ è½½å› å­ã€‚è€Œæœ€åçš„ <code>init()</code> æ˜¯ç©ºæ–¹æ³•ã€‚</p>
<h2 id="put__u65B9_u6CD5"><a href="#put__u65B9_u6CD5" class="headerlink" title="put æ–¹æ³•"></a>put æ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœ table æ•°ç»„ä¸ºç©ºæ—¶å…ˆåˆ›å»ºæ•°ç»„ï¼Œå¹¶ä¸”è®¾ç½®æ‰©å®¹é˜€å€¼</span></span><br><span class="line">    <span class="keyword">if</span> (table == EMPTY_TABLE) &#123;</span><br><span class="line">        inflateTable(threshold);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœ key ä¸ºç©ºæ—¶ï¼Œè°ƒç”¨ putForNullKey æ–¹æ³•ç‰¹æ®Šå¤„ç†</span></span><br><span class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> putForNullKey(value);</span><br><span class="line">    <span class="comment">// è®¡ç®— key çš„å“ˆå¸Œå€¼</span></span><br><span class="line">    <span class="keyword">int</span> hash = hash(key);</span><br><span class="line">    <span class="comment">// æ ¹æ®è®¡ç®—å‡ºæ¥çš„å“ˆå¸Œå€¼å’Œå½“å‰æ•°ç»„çš„é•¿åº¦è®¡ç®—åœ¨æ•°ç»„ä¸­çš„ç´¢å¼•</span></span><br><span class="line">    <span class="keyword">int</span> i = indexFor(hash, table.length);</span><br><span class="line">    <span class="comment">// å…ˆéå†è¯¥æ•°ç»„ç´¢å¼•ä¸‹çš„æ•´æ¡é“¾è¡¨</span></span><br><span class="line">    <span class="comment">// å¦‚æœè¯¥ key ä¹‹å‰å·²ç»åœ¨ HashMap ä¸­å­˜å‚¨äº†çš„è¯ï¼Œç›´æ¥æ›¿æ¢å¯¹åº”çš„ value å€¼å³å¯</span></span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e = table[i]; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">        Object k;</span><br><span class="line">        <span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) &#123;</span><br><span class="line">            V oldValue = e.value;</span><br><span class="line">            e.value = value;</span><br><span class="line">            e.recordAccess(<span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="comment">// å¦‚æœè¯¥ key ä¹‹å‰æ²¡æœ‰è¢«å­˜å‚¨è¿‡ï¼Œé‚£ä¹ˆå°±è¿›å…¥ addEntry æ–¹æ³•</span></span><br><span class="line">    addEntry(hash, key, value, i);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>çœ‹äº†ä¸Šé¢ put æ–¹æ³•çš„ä»£ç ï¼Œå¤§è‡´åˆ†ä¸ºäº†ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>å¦‚æœ table æ•°ç»„ä¸ºç©ºæ—¶å…ˆåˆ›å»ºæ•°ç»„ï¼Œå¹¶ä¸”è®¾ç½®æ‰©å®¹é˜€å€¼ï¼›</li>
<li>å¦‚æœ key ä¸ºç©ºæ—¶ï¼Œè°ƒç”¨ putForNullKey æ–¹æ³•ç‰¹æ®Šå¤„ç†ï¼›</li>
<li>è®¡ç®— key çš„å“ˆå¸Œå€¼ï¼›</li>
<li>æ ¹æ®ç¬¬ä¸‰æ­¥è®¡ç®—å‡ºæ¥çš„å“ˆå¸Œå€¼å’Œå½“å‰æ•°ç»„çš„é•¿åº¦æ¥è®¡ç®—å¾—åˆ°è¯¥ key åœ¨æ•°ç»„ä¸­çš„ç´¢å¼•ï¼Œå…¶å®ç´¢å¼•æœ€åçš„å€¼å°±ç­‰äº <code>hash%table.length</code> ï¼›</li>
<li>éå†è¯¥æ•°ç»„ç´¢å¼•ä¸‹çš„æ•´æ¡é“¾è¡¨ï¼Œå¦‚æœä¹‹å‰å·²ç»æœ‰ä¸€æ ·çš„ key ï¼Œé‚£ä¹ˆç›´æ¥è¦†ç›– value ï¼›</li>
<li>å¦‚æœè¯¥ key ä¹‹å‰æ²¡æœ‰ï¼Œé‚£ä¹ˆå°±è¿›å…¥ addEntry æ–¹æ³•ã€‚</li>
</ol>
<p>ä¸‹é¢å°±æ¥çœ‹ä¸€ä¸‹ addEntry æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addEntry</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">int</span> bucketIndex)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å½“å‰å®¹é‡å¤§äºæˆ–ç­‰äºæ‰©å®¹é˜€å€¼çš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œæ‰©å®¹</span></span><br><span class="line">    <span class="keyword">if</span> ((size &gt;= threshold) &amp;&amp; (<span class="keyword">null</span> != table[bucketIndex])) &#123;</span><br><span class="line">        <span class="comment">// æ‰©å®¹ä¸ºåŸæ¥å®¹é‡çš„ä¸¤å€</span></span><br><span class="line">        resize(<span class="number">2</span> * table.length);</span><br><span class="line">        <span class="comment">// é‡æ–°è®¡ç®—å“ˆå¸Œå€¼</span></span><br><span class="line">        hash = (<span class="keyword">null</span> != key) ? hash(key) : <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// é‡æ–°å¾—åˆ°åœ¨æ–°æ•°ç»„ä¸­çš„ç´¢å¼•</span></span><br><span class="line">        bucketIndex = indexFor(hash, table.length);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ›å»ºèŠ‚ç‚¹</span></span><br><span class="line">    createEntry(hash, key, value, bucketIndex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ addEntry æ–¹æ³•ä¸­ï¼Œæœ‰ä¸¤ä¸ªæ³¨æ„ç‚¹éœ€è¦æˆ‘ä»¬å»çœ‹ï¼š</p>
<ol>
<li>å¦‚æœå½“å‰ HashMap çš„å­˜å‚¨å®¹é‡åˆ°è¾¾é˜€å€¼çš„æ—¶å€™ï¼Œä¼šå»è¿›è¡Œ <code>resize(int newCapacity)</code> æ‰©å®¹ï¼›</li>
<li>åœ¨ createEntry æ–¹æ³•ä¸­å¢åŠ æ–°çš„èŠ‚ç‚¹ã€‚</li>
</ol>
<p>æˆ‘ä»¬å…ˆå» resize æ–¹æ³•ä¸­çœ‹çœ‹æ˜¯æ€ä¹ˆæ‰©å®¹çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">resize</span><span class="params">(<span class="keyword">int</span> newCapacity)</span> </span>&#123;</span><br><span class="line">    Entry[] oldTable = table;</span><br><span class="line">    <span class="keyword">int</span> oldCapacity = oldTable.length;</span><br><span class="line">    <span class="keyword">if</span> (oldCapacity == MAXIMUM_CAPACITY) &#123;</span><br><span class="line">        threshold = Integer.MAX_VALUE;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ›å»ºæ–°çš„ entry æ•°ç»„</span></span><br><span class="line">    Entry[] newTable = <span class="keyword">new</span> Entry[newCapacity];</span><br><span class="line">    <span class="comment">// å°†æ—§ entry æ•°ç»„ä¸­çš„æ•°æ®å¤åˆ¶åˆ°æ–° entry æ•°ç»„ä¸­</span></span><br><span class="line">    transfer(newTable, initHashSeedAsNeeded(newCapacity));</span><br><span class="line">    <span class="comment">// å°†æ–°æ•°ç»„çš„å¼•ç”¨èµ‹ç»™ table</span></span><br><span class="line">    table = newTable;</span><br><span class="line">    <span class="comment">// è®¡ç®—æ–°çš„æ‰©å®¹é˜€å€¼</span></span><br><span class="line">    threshold = (<span class="keyword">int</span>)Math.min(newCapacity * loadFactor, MAXIMUM_CAPACITY + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ ¹æ®ä»£ç å¯ä»¥çŸ¥é“ï¼Œæ‰©å®¹å°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„æ•°ç»„ï¼Œç„¶åæŠŠæ•°æ®å…¨éƒ¨å¤åˆ¶è¿‡å»ï¼Œå†æŠŠæ–°æ•°ç»„çš„å¼•ç”¨èµ‹ç»™ table ã€‚</p>
<p>å‰©ä¸‹çš„è¿˜æœ‰ä¸€ä¸ª createEntry æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">createEntry</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">int</span> bucketIndex)</span> </span>&#123;</span><br><span class="line">    Entry&lt;K,V&gt; e = table[bucketIndex];</span><br><span class="line">    table[bucketIndex] = <span class="keyword">new</span> Entry&lt;&gt;(hash, key, value, e);</span><br><span class="line">    <span class="comment">// å½“å‰ HashMap çš„å®¹é‡åŠ  1</span></span><br><span class="line">    size++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºèŠ‚ç‚¹çš„æ–¹æ³•ä¸­ï¼Œå¦‚æœå‘ç° e æ˜¯ç©ºçš„ï¼Œä¹‹å‰æ²¡æœ‰å­˜å€¼ï¼Œé‚£ä¹ˆç›´æ¥æŠŠå€¼å­˜è¿›å»å°±è¡Œäº†ï¼›å¦‚æœæ˜¯ä¹‹å‰ e æœ‰å€¼çš„ï¼Œå³å‘ç”Ÿ hash ç¢°æ’çš„æƒ…å†µï¼Œå°±ä»¥å•é“¾è¡¨å¤´æ’å…¥çš„æ–¹å¼å­˜å‚¨ã€‚</p>
<h2 id="get__u65B9_u6CD5"><a href="#get__u65B9_u6CD5" class="headerlink" title="get æ–¹æ³•"></a>get æ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœ key æ˜¯ç©ºçš„ï¼Œå°±è°ƒç”¨ getForNullKey æ–¹æ³•ç‰¹æ®Šå¤„ç†</span></span><br><span class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> getForNullKey();</span><br><span class="line">    <span class="comment">// è·å– key ç›¸å¯¹åº”çš„ entry </span></span><br><span class="line">    Entry&lt;K,V&gt; entry = getEntry(key);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span> == entry ? <span class="keyword">null</span> : entry.getValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ get æ–¹æ³•ä¸­ï¼Œè·å– value ä¸»è¦æ­¥éª¤æ˜¯ <code>getEntry(key)</code> ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Entry&lt;K,V&gt; getEntry(Object key) &#123;</span><br><span class="line">    <span class="keyword">if</span> (size == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è®¡ç®— key çš„å“ˆå¸Œå€¼</span></span><br><span class="line">    <span class="keyword">int</span> hash = (key == <span class="keyword">null</span>) ? <span class="number">0</span> : hash(key);</span><br><span class="line">    <span class="comment">// å¾—åˆ°æ•°ç»„çš„ç´¢å¼•ï¼Œç„¶åéå†é“¾è¡¨ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰ç›¸åŒ key çš„ Entry</span></span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e = table[indexFor(hash, table.length)];</span><br><span class="line">         e != <span class="keyword">null</span>;</span><br><span class="line">         e = e.next) &#123;</span><br><span class="line">        Object k;</span><br><span class="line">        <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">            ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            <span class="keyword">return</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ²¡æœ‰çš„è¯ï¼Œè¿”å› null</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>getEntry(Object key)</code> æ–¹æ³•å¾ˆç®€å•ï¼Œå°±æ˜¯æ‰¾åˆ°å¯¹åº” key çš„æ•°ç»„ç´¢å¼•ï¼Œç„¶åéå†é“¾è¡¨æŸ¥æ‰¾å³å¯ã€‚</p>
<h1 id="Java_1-8__u4E2D_HashMap__u7684_u4E0D_u540C"><a href="#Java_1-8__u4E2D_HashMap__u7684_u4E0D_u540C" class="headerlink" title="Java 1.8 ä¸­ HashMap çš„ä¸åŒ"></a>Java 1.8 ä¸­ HashMap çš„ä¸åŒ</h1><ol>
<li>åœ¨ Java 1.8 ä¸­ï¼Œå¦‚æœé“¾è¡¨çš„é•¿åº¦è¶…è¿‡äº† 8 ï¼Œé‚£ä¹ˆé“¾è¡¨å°†è½¬åŒ–ä¸ºçº¢é»‘æ ‘ï¼›</li>
<li>å‘ç”Ÿ hash ç¢°æ’æ—¶ï¼ŒJava 1.7 ä¼šåœ¨é“¾è¡¨å¤´éƒ¨æ’å…¥ï¼Œè€Œ Java 1.8 ä¼šåœ¨é“¾è¡¨å°¾éƒ¨æ’å…¥ï¼›</li>
<li>åœ¨ Java 1.8 ä¸­ï¼ŒEntry è¢« Node ä»£æ›¿ï¼ˆæ¢äº†ä¸€ä¸ªé©¬ç”²ï¼‰ã€‚</li>
</ol>
<h1 id="Footer"><a href="#Footer" class="headerlink" title="Footer"></a>Footer</h1><p>è®²å®Œäº†ï¼Œç°åœ¨å¯¹ HashMap åº”è¯¥æœ‰æ›´æ·±ä¸€æ­¥çš„äº†è§£äº†å§ï¼Œå»ºè®®å¤§å®¶å›å»å†ç ”ç©¶ä¸‹ã€‚</p>
<p>å¦‚æœå“ªé‡Œæœ‰é—®é¢˜æˆ–è€…ä¸æ‡‚ï¼Œå¯ä»¥ç•™è¨€ã€‚</p>
<p>bye bye</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>æ³¨ï¼šæœ¬æ–‡è§£æçš„ HashMap æºä»£ç åŸºäº Java 1.7 ã€‚</p>
<h1 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h1><p>HashMap åœ¨å¹³æ—¶ Ja]]>
    </summary>
    
      <category term="Java" scheme="http://yuqirong.me/tags/Java/"/>
    
      <category term="æ•°æ®ç»“æ„" scheme="http://yuqirong.me/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
      <category term="æºç è§£æ" scheme="http://yuqirong.me/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    
      <category term="Java Blog" scheme="http://yuqirong.me/categories/Java-Blog/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Androidé€šè¿‡URIè·å–æ–‡ä»¶è·¯å¾„]]></title>
    <link href="http://yuqirong.me/2017/12/21/Android%E9%80%9A%E8%BF%87URI%E8%8E%B7%E5%8F%96%E6%96%87%E4%BB%B6%E8%B7%AF%E5%BE%84/"/>
    <id>http://yuqirong.me/2017/12/21/Androidé€šè¿‡URIè·å–æ–‡ä»¶è·¯å¾„/</id>
    <published>2017-12-21T13:30:16.000Z</published>
    <updated>2017-12-27T14:15:15.760Z</updated>
    <content type="html"><![CDATA[<p>ä¹‹å‰åœ¨å·¥ä½œçš„è¿‡ç¨‹ä¸­ï¼Œé‡åˆ°ä¸åŒ Android ç‰ˆæœ¬ä¸‹ URI é‡‡ç”¨ä¸åŒæ–¹å¼æ¥è·å–æ–‡ä»¶è·¯å¾„çš„é—®é¢˜ã€‚</p>
<p>å› ä¸ºéœ€æ±‚çš„åŸå› ï¼Œè¦æ±‚æ‹ç…§ä¸Šä¼ æˆ–è€…ä»ç›¸å†Œä¸­é€‰æ‹©å›¾ç‰‡ä¸Šä¼ ï¼Œè€Œä¸”å›¾ç‰‡æ˜¯éœ€è¦ç»è¿‡å‹ç¼©çš„ï¼Œå¤§å°ä¸èƒ½è¶…è¿‡2Mã€‚</p>
<p>å¾ˆå¿«ï¼Œæ‹ç…§çš„è¿™éƒ¨åˆ†å°±æå®šäº†ã€‚é‚£ä¹ˆç›¸å†Œä¸­é€‰æ‹©å›¾ç‰‡çš„ä¹Ÿæ˜¯ä¸€æ ·çš„é“ç†ï¼Œåº”è¯¥ä¹Ÿæ˜¯è½»æ¾è§£å†³äº†ã€‚</p>
<p>è‡³äºé€‰æ‹©å›¾ç‰‡çš„ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">intent = <span class="keyword">new</span> Intent(Intent.ACTION_GET_CONTENT);</span><br><span class="line">intent.addCategory(Intent.CATEGORY_OPENABLE);</span><br><span class="line">intent.setType(<span class="string">"image/*"</span>);</span><br><span class="line">startActivityForResult(intent, FILE_CHOOSER_RESULT_CODE);</span><br></pre></td></tr></table></figure>
<p>ä¹‹åå°±æ˜¯åœ¨ <code>onActivityResult(int requestCode, int resultCode, Intent data)</code> ä¸­è·å–åˆ° URI ã€‚</p>
<p>æœ€å…³é”®çš„æ¥äº†ï¼Œå¦‚æœé€šè¿‡ URI æ¥è·å–æ–‡ä»¶å‘¢ï¼Ÿ</p>
<p>æ¯”å¦‚ï¼Œç°åœ¨ URI ä¸º content://media/extenral/images/media/17766 ï¼Œè€Œæˆ‘ä»¬éœ€è¦å¾—åˆ°å¯¹åº”çš„æ–‡ä»¶è·¯å¾„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ContentResolver.SCHEME_CONTENT.equals(uri.getScheme())) &#123;</span><br><span class="line">    Cursor cursor = context.getContentResolver().query(uri, <span class="keyword">new</span> String[]&#123;MediaStore.Images.Media.DATA&#125;, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">if</span> (cursor != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cursor.moveToFirst()) &#123;</span><br><span class="line">            <span class="keyword">int</span> columnIndex = cursor.getColumnIndexOrThrow(MediaStore.Images.Media.DATA);</span><br><span class="line">            <span class="keyword">if</span> (columnIndex &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">                path = cursor.getString(columnIndex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        cursor.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> path;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŸä»¥ä¸ºä¸‡äº‹å¤§å‰ï¼Œä½†æ˜¯åœ¨ Android 4.4 åŠä»¥ä¸Šçš„æ‰‹æœºä¸Šä¸€è¯•ï¼Œå‘ç°æ ¹æœ¬ä¸è¡Œã€‚å› ä¸ºåœ¨ Android 4.4 åŠä»¥ä¸Šçš„æ‰‹æœºä¸Šï¼Œè·å–åˆ°çš„ URI å˜æˆäº† content://com.android.providers.media.documents/document/image%3A235700 ï¼Œå’Œä¹‹å‰æˆ‘ä»¬é¢„æœŸçš„ä¸æ˜¯åŒä¸€ç§ç±»å‹ã€‚</p>
<p>è¿™æ˜¯å› ä¸ºåœ¨ Android 4.4 åŠä»¥ä¸Šçš„æœºå‹ï¼Œä½¿ç”¨äº† DocumentUri æ¥ä»£è¡¨è·å–åˆ°æ–‡ä»¶çš„ URI ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬åˆè¦å¯¹äº DocumentUri è¿›è¡Œé€‚é…ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ContentResolver.SCHEME_CONTENT.equals(uri.getScheme())) &#123;</span><br><span class="line">       <span class="keyword">if</span> (DocumentsContract.isDocumentUri(context, uri)) &#123;</span><br><span class="line">           <span class="keyword">if</span> (isExternalStorageDocument(uri)) &#123;</span><br><span class="line">               <span class="comment">// ExternalStorageProvider</span></span><br><span class="line">               <span class="keyword">final</span> String docId = DocumentsContract.getDocumentId(uri);</span><br><span class="line">               <span class="keyword">final</span> String[] split = docId.split(<span class="string">":"</span>);</span><br><span class="line">               <span class="keyword">final</span> String type = split[<span class="number">0</span>];</span><br><span class="line">               <span class="keyword">if</span> (<span class="string">"primary"</span>.equalsIgnoreCase(type)) &#123;</span><br><span class="line">                   path = Environment.getExternalStorageDirectory() + <span class="string">"/"</span> + split[<span class="number">1</span>];</span><br><span class="line">                   <span class="keyword">return</span> path;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isDownloadsDocument(uri)) &#123;</span><br><span class="line">               <span class="comment">// DownloadsProvider</span></span><br><span class="line">               <span class="keyword">final</span> String id = DocumentsContract.getDocumentId(uri);</span><br><span class="line">               <span class="keyword">final</span> Uri contentUri = ContentUris.withAppendedId(Uri.parse(<span class="string">"content://downloads/public_downloads"</span>),</span><br><span class="line">                       Long.valueOf(id));</span><br><span class="line">               path = getDataColumn(context, contentUri, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">               <span class="keyword">return</span> path;</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isMediaDocument(uri)) &#123;</span><br><span class="line">               <span class="comment">// MediaProvider</span></span><br><span class="line">               <span class="keyword">final</span> String docId = DocumentsContract.getDocumentId(uri);</span><br><span class="line">               <span class="keyword">final</span> String[] split = docId.split(<span class="string">":"</span>);</span><br><span class="line">               <span class="keyword">final</span> String type = split[<span class="number">0</span>];</span><br><span class="line">               Uri contentUri = <span class="keyword">null</span>;</span><br><span class="line">               <span class="keyword">if</span> (<span class="string">"image"</span>.equals(type)) &#123;</span><br><span class="line">                   contentUri = MediaStore.Images.Media.EXTERNAL_CONTENT_URI;</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"video"</span>.equals(type)) &#123;</span><br><span class="line">                   contentUri = MediaStore.Video.Media.EXTERNAL_CONTENT_URI;</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"audio"</span>.equals(type)) &#123;</span><br><span class="line">                   contentUri = MediaStore.Audio.Media.EXTERNAL_CONTENT_URI;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">final</span> String selection = <span class="string">"_id=?"</span>;</span><br><span class="line">               <span class="keyword">final</span> String[] selectionArgs = <span class="keyword">new</span> String[]&#123;split[<span class="number">1</span>]&#125;;</span><br><span class="line">               path = getDataColumn(context, contentUri, selection, selectionArgs);</span><br><span class="line">               <span class="keyword">return</span> path;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getDataColumn</span><span class="params">(Context context, Uri uri, String selection, String[] selectionArgs)</span> </span>&#123;</span><br><span class="line">       Cursor cursor = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">final</span> String column = <span class="string">"_data"</span>;</span><br><span class="line">       <span class="keyword">final</span> String[] projection = &#123;column&#125;;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           cursor = context.getContentResolver().query(uri, projection, selection, selectionArgs, <span class="keyword">null</span>);</span><br><span class="line">           <span class="keyword">if</span> (cursor != <span class="keyword">null</span> &amp;&amp; cursor.moveToFirst()) &#123;</span><br><span class="line">               <span class="keyword">final</span> <span class="keyword">int</span> column_index = cursor.getColumnIndexOrThrow(column);</span><br><span class="line">               <span class="keyword">return</span> cursor.getString(column_index);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (cursor != <span class="keyword">null</span>)</span><br><span class="line">               cursor.close();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isExternalStorageDocument</span><span class="params">(Uri uri)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="string">"com.android.externalstorage.documents"</span>.equals(uri.getAuthority());</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isDownloadsDocument</span><span class="params">(Uri uri)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="string">"com.android.providers.downloads.documents"</span>.equals(uri.getAuthority());</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isMediaDocument</span><span class="params">(Uri uri)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="string">"com.android.providers.media.documents"</span>.equals(uri.getAuthority());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>å¥½äº†ï¼Œä¸Šé¢çš„ä»£ç è¿˜æ˜¯å®¹æ˜“çœ‹æ‡‚çš„ã€‚è¿™ä¸‹å°±è§£å†³äº†å¯¹äº Android 4.4 åŠä»¥ä¸Šçš„æœºå‹é€‚é…ã€‚é¡ºä¾¿æŠŠä»¥ file:// å¼€å¤´çš„ URI é€‚é…ä¹Ÿè¡¥ä¸Šï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ContentResolver.SCHEME_FILE.equals(uri.getScheme())) &#123;</span><br><span class="line">    path = uri.getPath();</span><br><span class="line">    <span class="keyword">return</span> path;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®Œç¾äº†ï¼Œä¸‹é¢å°±è´´å‡ºå®Œæ•´çš„ FileUtils ä»£ç ï¼Œæ‹¿å»ç”¨å§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FileUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getFilePathByUri</span><span class="params">(Context context, Uri uri)</span> </span>&#123;</span><br><span class="line">        String path = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// ä»¥ file:// å¼€å¤´çš„</span></span><br><span class="line">        <span class="keyword">if</span> (ContentResolver.SCHEME_FILE.equals(uri.getScheme())) &#123;</span><br><span class="line">            path = uri.getPath();</span><br><span class="line">            <span class="keyword">return</span> path;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ä»¥ content:// å¼€å¤´çš„ï¼Œæ¯”å¦‚ content://media/extenral/images/media/17766</span></span><br><span class="line">        <span class="keyword">if</span> (ContentResolver.SCHEME_CONTENT.equals(uri.getScheme()) &amp;&amp; Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.KITKAT) &#123;</span><br><span class="line">            Cursor cursor = context.getContentResolver().query(uri, <span class="keyword">new</span> String[]&#123;MediaStore.Images.Media.DATA&#125;, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (cursor != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (cursor.moveToFirst()) &#123;</span><br><span class="line">                    <span class="keyword">int</span> columnIndex = cursor.getColumnIndexOrThrow(MediaStore.Images.Media.DATA);</span><br><span class="line">                    <span class="keyword">if</span> (columnIndex &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">                        path = cursor.getString(columnIndex);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                cursor.close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> path;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 4.4åŠä¹‹åçš„ æ˜¯ä»¥ content:// å¼€å¤´çš„ï¼Œæ¯”å¦‚ content://com.android.providers.media.documents/document/image%3A235700</span></span><br><span class="line">        <span class="keyword">if</span> (ContentResolver.SCHEME_CONTENT.equals(uri.getScheme()) &amp;&amp; Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DocumentsContract.isDocumentUri(context, uri)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isExternalStorageDocument(uri)) &#123;</span><br><span class="line">                    <span class="comment">// ExternalStorageProvider</span></span><br><span class="line">                    <span class="keyword">final</span> String docId = DocumentsContract.getDocumentId(uri);</span><br><span class="line">                    <span class="keyword">final</span> String[] split = docId.split(<span class="string">":"</span>);</span><br><span class="line">                    <span class="keyword">final</span> String type = split[<span class="number">0</span>];</span><br><span class="line">                    <span class="keyword">if</span> (<span class="string">"primary"</span>.equalsIgnoreCase(type)) &#123;</span><br><span class="line">                        path = Environment.getExternalStorageDirectory() + <span class="string">"/"</span> + split[<span class="number">1</span>];</span><br><span class="line">                        <span class="keyword">return</span> path;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isDownloadsDocument(uri)) &#123;</span><br><span class="line">                    <span class="comment">// DownloadsProvider</span></span><br><span class="line">                    <span class="keyword">final</span> String id = DocumentsContract.getDocumentId(uri);</span><br><span class="line">                    <span class="keyword">final</span> Uri contentUri = ContentUris.withAppendedId(Uri.parse(<span class="string">"content://downloads/public_downloads"</span>),</span><br><span class="line">                            Long.valueOf(id));</span><br><span class="line">                    path = getDataColumn(context, contentUri, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                    <span class="keyword">return</span> path;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isMediaDocument(uri)) &#123;</span><br><span class="line">                    <span class="comment">// MediaProvider</span></span><br><span class="line">                    <span class="keyword">final</span> String docId = DocumentsContract.getDocumentId(uri);</span><br><span class="line">                    <span class="keyword">final</span> String[] split = docId.split(<span class="string">":"</span>);</span><br><span class="line">                    <span class="keyword">final</span> String type = split[<span class="number">0</span>];</span><br><span class="line">                    Uri contentUri = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="string">"image"</span>.equals(type)) &#123;</span><br><span class="line">                        contentUri = MediaStore.Images.Media.EXTERNAL_CONTENT_URI;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"video"</span>.equals(type)) &#123;</span><br><span class="line">                        contentUri = MediaStore.Video.Media.EXTERNAL_CONTENT_URI;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"audio"</span>.equals(type)) &#123;</span><br><span class="line">                        contentUri = MediaStore.Audio.Media.EXTERNAL_CONTENT_URI;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">final</span> String selection = <span class="string">"_id=?"</span>;</span><br><span class="line">                    <span class="keyword">final</span> String[] selectionArgs = <span class="keyword">new</span> String[]&#123;split[<span class="number">1</span>]&#125;;</span><br><span class="line">                    path = getDataColumn(context, contentUri, selection, selectionArgs);</span><br><span class="line">                    <span class="keyword">return</span> path;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getDataColumn</span><span class="params">(Context context, Uri uri, String selection, String[] selectionArgs)</span> </span>&#123;</span><br><span class="line">        Cursor cursor = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">final</span> String column = <span class="string">"_data"</span>;</span><br><span class="line">        <span class="keyword">final</span> String[] projection = &#123;column&#125;;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            cursor = context.getContentResolver().query(uri, projection, selection, selectionArgs, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (cursor != <span class="keyword">null</span> &amp;&amp; cursor.moveToFirst()) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> column_index = cursor.getColumnIndexOrThrow(column);</span><br><span class="line">                <span class="keyword">return</span> cursor.getString(column_index);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (cursor != <span class="keyword">null</span>)</span><br><span class="line">                cursor.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isExternalStorageDocument</span><span class="params">(Uri uri)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"com.android.externalstorage.documents"</span>.equals(uri.getAuthority());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isDownloadsDocument</span><span class="params">(Uri uri)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"com.android.providers.downloads.documents"</span>.equals(uri.getAuthority());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isMediaDocument</span><span class="params">(Uri uri)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"com.android.providers.media.documents"</span>.equals(uri.getAuthority());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è®²å®Œäº†ï¼Œè®²å®Œäº†ã€‚</p>
<p>å†è§ï¼</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>ä¹‹å‰åœ¨å·¥ä½œçš„è¿‡ç¨‹ä¸­ï¼Œé‡åˆ°ä¸åŒ Android ç‰ˆæœ¬ä¸‹ URI é‡‡ç”¨ä¸åŒæ–¹å¼æ¥è·å–æ–‡ä»¶è·¯å¾„çš„é—®é¢˜ã€‚</p>
<p>å› ä¸ºéœ€æ±‚çš„åŸå› ï¼Œè¦æ±‚æ‹ç…§ä¸Šä¼ æˆ–è€…ä»ç›¸å†Œä¸­é€‰æ‹©å›¾ç‰‡ä¸Šä¼ ï¼Œè€Œä¸”å›¾ç‰‡æ˜¯éœ€è¦ç»è¿‡å‹ç¼©çš„ï¼Œå¤§å°ä¸èƒ½è¶…è¿‡2Mã€‚</p>
<p>å¾ˆå¿«ï¼Œæ‹ç…§çš„è¿™éƒ¨åˆ†å°±æå®šäº†ã€‚é‚£ä¹ˆç›¸å†Œä¸­é€‰æ‹©å›¾ç‰‡çš„]]>
    </summary>
    
      <category term="Android" scheme="http://yuqirong.me/tags/Android/"/>
    
      <category term="Android Blog" scheme="http://yuqirong.me/categories/Android-Blog/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Vue.jsæ¨¡æ¿æ–¹æ³•]]></title>
    <link href="http://yuqirong.me/2017/12/02/Vue.js%E6%A8%A1%E6%9D%BF%E6%96%B9%E6%B3%95/"/>
    <id>http://yuqirong.me/2017/12/02/Vue.jsæ¨¡æ¿æ–¹æ³•/</id>
    <published>2017-12-02T12:36:02.000Z</published>
    <updated>2017-12-02T12:47:33.047Z</updated>
    <content type="html"><![CDATA[<h2 id="v-html"><a href="#v-html" class="headerlink" title="v-html"></a>v-html</h2><p>å°† html çš„ä»£ç è¾“å‡º</p>
<pre><code>&lt;div id=&quot;app&quot;&gt;
    &lt;div v-html=&quot;message&quot;&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;script&gt;
new Vue({
  el: &apos;#app&apos;,
  data: {
    message: &apos;&lt;h1&gt;Hello World&lt;/h1&gt;&lt;img src=&quot;https://www.baidu.com/img/bd_logo1.png&quot; /&gt;&apos;
  }
})
&lt;/script&gt;
</code></pre><h2 id="v-bind"><a href="#v-bind" class="headerlink" title="v-bind"></a>v-bind</h2><p>ä½¿ç”¨ v-bind æŒ‡ä»¤èµ‹å€¼ç»™ HTML å±æ€§</p>
<pre><code>&lt;div id=&quot;app&quot;&gt;
    &lt;img v-bind:src=&quot;imgurl&quot; /&gt;
    &lt;h1 v-bind:class=&quot;{&apos;img_class&apos;: useClass}&quot;&gt;Hello&lt;/h1&gt;
&lt;/div&gt;

&lt;script&gt;
new Vue({
  el: &apos;#app&apos;,
  data: {
    imgurl: &apos;https://www.baidu.com/img/bd_logo1.png&apos;,
    useClass: true
  }
})
&lt;/script&gt;

&lt;style&gt;
.img_class {
  background: #444;
}
&lt;/style&gt;
</code></pre><h2 id="v-if"><a href="#v-if" class="headerlink" title="v-if"></a>v-if</h2><p>ç”¨äºåˆ¤æ–­æ¡ä»¶</p>
<pre><code>&lt;img id=&quot;app&quot; src=&quot;https://www.baidu.com/img/bd_logo1.png&quot; v-if=&quot;visible&quot;/&gt;

&lt;script&gt;
new Vue({
    el: &apos;#app&apos;,
    data: {
        visible: true
    }
})
&lt;/script&gt;
</code></pre><h2 id="v-else-if/v-else"><a href="#v-else-if/v-else" class="headerlink" title="v-else-if/v-else"></a>v-else-if/v-else</h2><p>ç”¨äºåˆ¤æ–­æ¡ä»¶</p>
<pre><code>&lt;div id=&quot;app&quot;&gt;
    &lt;div v-if=&quot;type === &apos;A&apos;&quot;&gt;
      A
    &lt;/div&gt;
    &lt;div v-else-if=&quot;type === &apos;B&apos;&quot;&gt;
      B
    &lt;/div&gt;
    &lt;div v-else-if=&quot;type === &apos;C&apos;&quot;&gt;
      C
    &lt;/div&gt;
    &lt;div v-else&gt;
      Not A/B/C
    &lt;/div&gt;
&lt;/div&gt;

&lt;script&gt;
new Vue({
  el: &apos;#app&apos;,
  type: &apos;C&apos;
})
&lt;/script&gt;
</code></pre><h2 id="v-show"><a href="#v-show" class="headerlink" title="v-show"></a>v-show</h2><p>å¯ä»¥ä½¿ç”¨ v-show æŒ‡ä»¤æ¥æ ¹æ®æ¡ä»¶å±•ç¤ºå…ƒç´ ï¼Œ</p>
<p>ç”¨æ³•ä¸Šå’Œ v-if å·®ä¸å¤šï¼Œä½†æ˜¯ v-if æ˜¯åŠ¨æ€çš„å‘ DOM æ ‘å†…æ·»åŠ æˆ–è€…åˆ é™¤ DOM å…ƒç´ ã€‚ è€Œ v-show æ˜¯é€šè¿‡è®¾ç½® DOM å…ƒç´ çš„ display æ ·å¼å±æ€§æ§åˆ¶æ˜¾éšã€‚</p>
<p>å…³äº v-show å’Œ v-if çš„åŒºåˆ«ï¼Œè¯¦è§ <a href="http://blog.csdn.net/ning0_o/article/details/56006528" target="_blank" rel="external">v-if å’Œ v-showçš„åŒºåˆ«</a> ã€‚</p>
<pre><code>&lt;div id=&quot;app&quot;&gt;
    &lt;h1 v-show=&quot;ok&quot;&gt;Hello!&lt;/h1&gt;
&lt;/div&gt;

&lt;script&gt;
new Vue({
  el: &apos;#app&apos;,
  data: {
    ok: true
  }
})
&lt;/script&gt;
</code></pre><h2 id="v-model"><a href="#v-model" class="headerlink" title="v-model"></a>v-model</h2><p>v-model æŒ‡ä»¤æ¥å®ç°åŒå‘æ•°æ®ç»‘å®šã€‚</p>
<pre><code>&lt;div id=&quot;app&quot;&gt;
    &lt;p&gt;&lt;/p&gt;
    &lt;input v-model=&quot;message&quot;&gt;
&lt;/div&gt;

&lt;script&gt;
new Vue({
  el: &apos;#app&apos;,
  data: {
    message: &apos;Hello World&apos;
  }
})
&lt;/script&gt;
</code></pre><h2 id="v-on"><a href="#v-on" class="headerlink" title="v-on"></a>v-on</h2><p>ä½¿ç”¨ v-on ç›‘å¬äº‹ä»¶</p>
<pre><code>&lt;div id=&quot;app&quot;&gt;
    &lt;button v-on:click=&quot;onclick&quot;&gt;&lt;/button&gt;
&lt;/div&gt;

&lt;script&gt;
new Vue({
  el: &apos;#app&apos;,
  data: {
    message: &apos;Click Me&apos;
  },
  methods: {
    onclick: function(){
        alert(&quot;Hello&quot;)
    }
  }
})
&lt;/script&gt;
</code></pre><h2 id="v-for"><a href="#v-for" class="headerlink" title="v-for"></a>v-for</h2><p>å¾ªç¯éå†</p>
<pre><code>&lt;div id=&quot;app&quot;&gt;
  &lt;ol&gt;
    &lt;li v-for=&quot;site in sites&quot;&gt;
      
    &lt;/li&gt;
  &lt;/ol&gt;
&lt;/div&gt;

&lt;script&gt;
new Vue({
  el: &apos;#app&apos;,
  data: {
    sites: [
      { name: &apos;Apple&apos; },
      { name: &apos;Google&apos; },
      { name: &apos;Taobao&apos; }
    ]
  }
})
&lt;/script&gt;
</code></pre><p>æˆ–è€…</p>
<pre><code>&lt;div id=&quot;app&quot;&gt;
  &lt;ul&gt;
    &lt;li v-for=&quot;(key,value, index) in object&quot;&gt;
     .  : 
    &lt;/li&gt;
  &lt;/ul&gt;
&lt;/div&gt;

&lt;script&gt;
new Vue({
  el: &apos;#app&apos;,
  data: {
    object: {
      name: &apos;Hello&apos;,
      url: &apos;World&apos;,
      slogan: &apos;Vue.js&apos;
    }
  }
})
&lt;/script&gt;
</code></pre><h2 id="u7F29_u5199"><a href="#u7F29_u5199" class="headerlink" title="ç¼©å†™"></a>ç¼©å†™</h2><ul>
<li><p>v-bind ç¼©å†™</p>
<pre><code>&lt;!-- å®Œæ•´è¯­æ³• --&gt;
&lt;a v-bind:href=&quot;url&quot;&gt;&lt;/a&gt;
&lt;!-- ç¼©å†™ --&gt;
&lt;a :href=&quot;url&quot;&gt;&lt;/a&gt;
</code></pre></li>
<li><p>v-on ç¼©å†™</p>
<pre><code>&lt;!-- å®Œæ•´è¯­æ³• --&gt;
&lt;a v-on:click=&quot;doSomething&quot;&gt;&lt;/a&gt;
&lt;!-- ç¼©å†™ --&gt;
&lt;a @click=&quot;doSomething&quot;&gt;&lt;/a&gt;
</code></pre></li>
</ul>
]]></content>
    <summary type="html">
    <![CDATA[<h2 id="v-html"><a href="#v-html" class="headerlink" title="v-html"></a>v-html</h2><p>å°† html çš„ä»£ç è¾“å‡º</p>
<pre><code>&lt;div id=&quot;app&quot;]]>
    </summary>
    
      <category term="Vue.js" scheme="http://yuqirong.me/tags/Vue-js/"/>
    
      <category term="Vue.js" scheme="http://yuqirong.me/categories/Vue-js/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Vue.jså®‰è£…æ•™ç¨‹]]></title>
    <link href="http://yuqirong.me/2017/12/01/Vue.js%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B/"/>
    <id>http://yuqirong.me/2017/12/01/Vue.jså®‰è£…æ•™ç¨‹/</id>
    <published>2017-11-30T16:29:14.000Z</published>
    <updated>2018-11-11T12:07:19.969Z</updated>
    <content type="html"><![CDATA[<h1 id="u5B89_u88C5_u6B65_u9AA4"><a href="#u5B89_u88C5_u6B65_u9AA4" class="headerlink" title="å®‰è£…æ­¥éª¤"></a>å®‰è£…æ­¥éª¤</h1><ol>
<li><p>å®‰è£… node.js (ç½‘å€ï¼š<a href="https://nodejs.org/en/" target="_blank" rel="external">https://nodejs.org/en/</a>)ã€‚</p>
</li>
<li><p>åŸºäº node.js ,åˆ©ç”¨æ·˜å® npm é•œåƒå®‰è£…ç›¸å…³ä¾èµ–ã€‚åœ¨ cmd é‡Œç›´æ¥è¾“å…¥ï¼š<code>npm install -g cnpm â€“registry=https://registry.npm.taobao.org</code>ï¼Œå›è½¦ï¼Œç­‰å¾…å®‰è£…ã€‚</p>
</li>
<li><p>å®‰è£…å…¨å±€ vue-cli è„šæ‰‹æ¶,ç”¨äºå¸®åŠ©æ­å»ºæ‰€éœ€çš„æ¨¡æ¿æ¡†æ¶ï¼Œåœ¨ cmd é‡Œ </p>
<ol>
<li><p>è¾“å…¥ï¼š<code>cnpm install -g vue-cli</code>ï¼Œå›è½¦ï¼Œç­‰å¾…å®‰è£…ï¼›</p>
</li>
<li><p>è¾“å…¥ï¼š vue ï¼Œå›è½¦ï¼Œè‹¥å‡ºç° vue ä¿¡æ¯è¯´æ˜è¡¨ç¤ºæˆåŠŸã€‚</p>
</li>
</ol>
</li>
<li><p>åˆ›å»ºé¡¹ç›®ï¼Œåœ¨ cmd é‡Œè¾“å…¥ï¼š<code>vue init webpack vue_test(é¡¹ç›®æ–‡ä»¶å¤¹å)</code> ï¼Œå›è½¦ï¼Œç­‰å¾…ä¸€å°ä¼šå„¿ï¼Œä¾æ¬¡å‡ºç°ä¸‹åˆ—é€‰é¡¹ï¼Œè¾“å…¥ååˆ›å»ºæˆåŠŸã€‚</p>
<p> <img src="/uploads/20171201/20171201223625.jpg" alt="create vue project"></p>
</li>
<li><p>å®‰è£…ä¾èµ–ï¼Œåœ¨ cmd é‡Œ </p>
<ol>
<li><p>è¾“å…¥ï¼š<code>cd vue_test</code> ï¼Œå›è½¦ï¼Œè¿›å…¥åˆ°å…·ä½“é¡¹ç›®æ–‡ä»¶å¤¹</p>
</li>
<li><p>è¾“å…¥ï¼š<code>npm install</code>ï¼Œå›è½¦ï¼Œç­‰å¾…ä¸€å°ä¼šå„¿ï¼Œå®‰è£…ä¾èµ–ã€‚</p>
</li>
</ol>
</li>
<li><p>æµ‹è¯•ç¯å¢ƒæ˜¯å¦æ­å»ºæˆåŠŸ</p>
<ol>
<li><p>åœ¨ cmd é‡Œè¾“å…¥ï¼š<code>npm run dev</code></p>
</li>
<li><p>åœ¨æµè§ˆé‡Œè¾“å…¥ï¼šlocalhost:8080(é»˜è®¤ç«¯å£ä¸º8080)</p>
<p>è¿è¡Œèµ·æ¥åçš„æ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="/uploads/20171201/20171201223752.jpg" alt="Vue running"></p>
</li>
</ol>
</li>
</ol>
<h1 id="u5B89_u88C5_u4E2D_u9047_u5230_u7684_u95EE_u9898"><a href="#u5B89_u88C5_u4E2D_u9047_u5230_u7684_u95EE_u9898" class="headerlink" title="å®‰è£…ä¸­é‡åˆ°çš„é—®é¢˜"></a>å®‰è£…ä¸­é‡åˆ°çš„é—®é¢˜</h1><h2 id="vue_init_webpack_vue_test"><a href="#vue_init_webpack_vue_test" class="headerlink" title="vue init webpack vue_test"></a>vue init webpack vue_test</h2><pre><code>C:\Users\h\Desktop&gt;vue init webpack vue_test
C:\Users\h\AppData\Roaming\npm\node_modules\vue-cli\bin\vue-init:60
let template = program.args[0]
^^^

SyntaxError: Block-scoped declarations (let, const, function, class) not yet sup
ported outside strict mode
    at exports.runInThisContext (vm.js:54:16)
    at Module._compile (module.js:375:25)
    at Object.Module._extensions..js (module.js:406:10)
    at Module.load (module.js:345:32)
    at Function.Module._load (module.js:302:12)
    at Function.Module.runMain (module.js:431:10)
    at startup (node.js:141:18)
    at node.js:977:3
</code></pre><p>nodejsç‰ˆæœ¬å¤ªä½ï¼Œå»å®˜ç½‘æ›´æ–°å³å¯ã€‚</p>
<h2 id="npm_install"><a href="#npm_install" class="headerlink" title="npm install"></a>npm install</h2><pre><code>C:\Users\h\Desktop\vue_test&gt;npm install

&gt; chromedriver@2.33.2 install C:\Users\h\Desktop\vue_test\node_modules\chromedri
ver
&gt; node install.js

Downloading https://chromedriver.storage.googleapis.com/2.33/chromedriver_win32.
zip
Saving to C:\Users\h\AppData\Local\Temp\chromedriver\chromedriver_win32.zip
ChromeDriver installation failed Error with http(s) request: Error: connect ETIM
EDOUT 172.217.160.112:443
npm WARN optional SKIPPING OPTIONAL DEPENDENCY: fsevents@1.1.3 (node_modules\fse
vents):
npm WARN notsup SKIPPING OPTIONAL DEPENDENCY: Unsupported platform for fsevents@
1.1.3: wanted {&quot;os&quot;:&quot;darwin&quot;,&quot;arch&quot;:&quot;any&quot;} (current: {&quot;os&quot;:&quot;win32&quot;,&quot;arch&quot;:&quot;x64&quot;}
)

npm ERR! code ELIFECYCLE
npm ERR! errno 1
npm ERR! chromedriver@2.33.2 install: `node install.js`
npm ERR! Exit status 1
npm ERR!
npm ERR! Failed at the chromedriver@2.33.2 install script.
npm ERR! This is probably not a problem with npm. There is likely additional log
ging output above.

npm ERR! A complete log of this run can be found in:
npm ERR!     C:\Users\h\AppData\Roaming\npm-cache\_logs\2017-11-25T07_25_19_228Z
-debug.log
</code></pre><p>å› ä¸º chromedriver è¢«å¢™äº†ï¼Œæ‰€ä»¥éœ€è¦è¾“å…¥å‘½ä»¤ <code>cnpm install chromedriver</code> ï¼Œå®‰è£… chromedriver ã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<h1 id="u5B89_u88C5_u6B65_u9AA4"><a href="#u5B89_u88C5_u6B65_u9AA4" class="headerlink" title="å®‰è£…æ­¥éª¤"></a>å®‰è£…æ­¥éª¤</h1><ol>
<li><p>å®‰è£… node.js (ç½‘å€ï¼š]]>
    </summary>
    
      <category term="Vue.js" scheme="http://yuqirong.me/tags/Vue-js/"/>
    
      <category term="Vue.js" scheme="http://yuqirong.me/categories/Vue-js/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[VirtualAPKæºç è§£æ]]></title>
    <link href="http://yuqirong.me/2017/11/12/VirtualAPK%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <id>http://yuqirong.me/2017/11/12/VirtualAPKæºç è§£æ/</id>
    <published>2017-11-12T14:03:58.000Z</published>
    <updated>2017-11-12T15:34:52.817Z</updated>
    <content type="html"><![CDATA[<h1 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h1><p>VirtualAPK æ˜¯æ»´æ»´å¼€æºçš„ä¸€æ¬¾ Android æ’ä»¶åŒ–çš„æ¡†æ¶ã€‚</p>
<p>ç°åœ¨å¸‚é¢ä¸Šï¼Œæˆç†Ÿçš„æ’ä»¶åŒ–æ¡†æ¶å·²ç»æŒºå¤šäº†ï¼Œé‚£ä¸ºä»€ä¹ˆè¿˜è¦é‡æ–°å¼€å‘ä¸€æ¬¾è½®å­å‘¢ï¼Ÿ</p>
<ol>
<li>å¤§éƒ¨åˆ†å¼€æºæ¡†æ¶æ‰€æ”¯æŒçš„åŠŸèƒ½è¿˜ä¸å¤Ÿå…¨é¢</li>
<li>å…¼å®¹æ€§é—®é¢˜ä¸¥é‡ï¼Œå¤§éƒ¨åˆ†å¼€æºæ–¹æ¡ˆä¸å¤Ÿå¥å£®</li>
<li>å·²æœ‰çš„å¼€æºæ–¹æ¡ˆä¸é€‚åˆæ»´æ»´çš„ä¸šåŠ¡åœºæ™¯</li>
</ol>
<p>åœ¨åŠ è½½è€¦åˆæ’ä»¶æ–¹é¢ï¼ŒVirtualAPKæ˜¯å¼€æºæ–¹æ¡ˆçš„é¦–é€‰ã€‚</p>
<p>ä»¥ä¸Šæ˜¯æ»´æ»´ç»™å‡ºçš„å®˜æ–¹è§£é‡Šã€‚</p>
<p>å¯¹äºæˆ‘ä»¬å¼€å‘è€…æ¥è¯´ï¼Œè¿™ç§å½“ç„¶æ˜¯å¥½äº‹ã€‚ç¬¬ä¸€ï¼Œæˆ‘ä»¬é€‰æ‹©æ’ä»¶åŒ–æ¡†æ¶çš„ä½™åœ°å˜å¤šäº†ï¼›ç¬¬äºŒï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å¤šå­¦ä¹ å­¦ä¹ æ¡†æ¶å†…éƒ¨å®ç°çš„åŸç†ï¼Œä¸€ä¸¾ä¸¤å¾—ã€‚</p>
<p>é‚£å°±ä¸è¯´åºŸè¯äº†ï¼Œä¸€èµ·æ¥çœ‹ã€‚</p>
<h1 id="u4F7F_u7528_u65B9_u6CD5"><a href="#u4F7F_u7528_u65B9_u6CD5" class="headerlink" title="ä½¿ç”¨æ–¹æ³•"></a>ä½¿ç”¨æ–¹æ³•</h1><p>ä½¿ç”¨æ–¹æ³•ç›´æ¥æŠ„ GitHub ä¸Šçš„ï¼Œå°±å°†å°±ç€çœ‹å§ã€‚</p>
<ul>
<li><p>ç¬¬ä¸€æ­¥ï¼š åˆå§‹åŒ–æ’ä»¶å¼•æ“</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">attachBaseContext</span><span class="params">(Context base)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.attachBaseContext(base);</span><br><span class="line">    PluginManager.getInstance(base).init();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ç¬¬äºŒæ­¥ï¼šåŠ è½½æ’ä»¶</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PluginManager</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadPlugin</span><span class="params">(File apk)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  å½“æ’ä»¶å…¥å£è¢«è°ƒç”¨åï¼Œæ’ä»¶çš„åç»­é€»è¾‘å‡ä¸éœ€è¦å®¿ä¸»å¹²é¢„ï¼Œå‡èµ°åŸç”Ÿçš„Androidæµç¨‹ã€‚ æ¯”å¦‚ï¼Œåœ¨æ’ä»¶å†…éƒ¨ï¼Œå¦‚ä¸‹ä»£ç å°†æ­£ç¡®æ‰§è¡Œï¼š</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_book_manager);</span><br><span class="line">    LinearLayout holder = (LinearLayout)findViewById(R.id.holder);</span><br><span class="line">    TextView imei = (TextView)findViewById(R.id.imei);</span><br><span class="line">    imei.setText(IDUtil.getUUID(<span class="keyword">this</span>));</span><br><span class="line">     </span><br><span class="line">    <span class="comment">// bind service in plugin</span></span><br><span class="line">    Intent service = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, BookManagerService.class);</span><br><span class="line">    bindService(service, mConnection, Context.BIND_AUTO_CREATE);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// start activity in plugin</span></span><br><span class="line">    Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, TCPClientActivity.class);</span><br><span class="line">    startActivity(intent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="u6E90_u7801_u89E3_u6790"><a href="#u6E90_u7801_u89E3_u6790" class="headerlink" title="æºç è§£æ"></a>æºç è§£æ</h1><p>ä½¿ç”¨æ–¹æ³•å¾ˆç®€å•ï¼Œä¸‹é¢å°±é¡ºç€ä¸Šé¢çš„ä»£ç ä¸€æ­¥æ­¥å»æ¢ç©¶å®ç°åŸç†ã€‚</p>
<h2 id="u521D_u59CB_u5316_u63D2_u4EF6_u6846_u67B6"><a href="#u521D_u59CB_u5316_u63D2_u4EF6_u6846_u67B6" class="headerlink" title="åˆå§‹åŒ–æ’ä»¶æ¡†æ¶"></a>åˆå§‹åŒ–æ’ä»¶æ¡†æ¶</h2><p>ç¬¬ä¸€æ­¥å°±æ˜¯åˆå§‹åŒ–æ¡†æ¶ï¼š<code>PluginManager.getInstance(base).init();</code></p>
<h3 id="PluginManager-getInstance_28Context_base_29"><a href="#PluginManager-getInstance_28Context_base_29" class="headerlink" title="PluginManager.getInstance(Context base)"></a>PluginManager.getInstance(Context base)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PluginManager <span class="title">getInstance</span><span class="params">(Context base)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (PluginManager.class) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sInstance == <span class="keyword">null</span>)</span><br><span class="line">                sInstance = <span class="keyword">new</span> PluginManager(base);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sInstance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">PluginManager</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    Context app = context.getApplicationContext();</span><br><span class="line">    <span class="keyword">if</span> (app == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.mContext = context;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.mContext = ((Application)app).getBaseContext();</span><br><span class="line">    &#125;</span><br><span class="line">    prepare();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PluginManager è®¾è®¡ä¸ºäº†å•ä¾‹æ¨¡å¼ï¼Œè´Ÿè´£ç®¡ç†æ’ä»¶çš„ä¸€äº›æ“ä½œã€‚</p>
<p>åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œå¾—åˆ°å…¨å±€ Context ï¼Œä»¥é˜²å‡ºç°å†…å­˜æ³„æ¼çš„æƒ…å†µã€‚</p>
<p>ä¹‹åè°ƒç”¨äº† <code>prepare()</code> æ–¹æ³•ï¼Œåšä¸€äº›é¢„å¤‡æ“ä½œã€‚</p>
<h3 id="prepare_28_29"><a href="#prepare_28_29" class="headerlink" title="prepare()"></a>prepare()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">// host base context</span></span><br><span class="line">      Systems.sHostContext = getHostContext();</span><br><span class="line"><span class="comment">// hook instrumentation</span></span><br><span class="line">      <span class="keyword">this</span>.hookInstrumentationAndHandler();</span><br><span class="line">      <span class="keyword">this</span>.hookSystemServices();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>prepare()</code> ä¸­ï¼Œå°†å®¿ä¸» Context èµ‹å€¼ç»™äº† Systems.sHostContext ã€‚è¿™æ ·ï¼Œåœ¨ä¹‹åçš„ä»£ç ä¸­å¯ä»¥æ–¹ä¾¿åœ°è®¿é—®åˆ°å®¿ä¸» Context ã€‚</p>
<p>ç„¶ååˆ†ä¸ºäº†ä¸¤æ­¥æ“ä½œï¼ŒhookInstrumentationAndHandler å’Œ hookSystemServices ã€‚ä¸ºè¿è¡Œæ’ä»¶åšä¸€äº›å¿…è¦çš„ hook æ“ä½œã€‚</p>
<h3 id="hookInstrumentationAndHandler_28_29"><a href="#hookInstrumentationAndHandler_28_29" class="headerlink" title="hookInstrumentationAndHandler()"></a>hookInstrumentationAndHandler()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">hookInstrumentationAndHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Instrumentation baseInstrumentation = ReflectUtil.getInstrumentation(<span class="keyword">this</span>.mContext);</span><br><span class="line">        <span class="keyword">if</span> (baseInstrumentation.getClass().getName().contains(<span class="string">"lbe"</span>)) &#123;</span><br><span class="line">            <span class="comment">// reject executing in paralell space, for example, lbe.</span></span><br><span class="line">            System.exit(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åˆ›å»ºæ’ä»¶çš„ instrumentation</span></span><br><span class="line">        <span class="keyword">final</span> VAInstrumentation instrumentation = <span class="keyword">new</span> VAInstrumentation(<span class="keyword">this</span>, baseInstrumentation);</span><br><span class="line">        Object activityThread = ReflectUtil.getActivityThread(<span class="keyword">this</span>.mContext);</span><br><span class="line">        <span class="comment">// å°†æ’ä»¶çš„ instrumentation è®¾ç½®åˆ°å½“å‰çš„ activityThread ä¸­</span></span><br><span class="line">        ReflectUtil.setInstrumentation(activityThread, instrumentation);</span><br><span class="line">        <span class="comment">// ç»™ mainThreadHandler è®¾ç½® callback</span></span><br><span class="line">        ReflectUtil.setHandlerCallback(<span class="keyword">this</span>.mContext, instrumentation);</span><br><span class="line">        <span class="keyword">this</span>.mInstrumentation = instrumentation;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="hookSystemServices_28_29"><a href="#hookSystemServices_28_29" class="headerlink" title="hookSystemServices()"></a>hookSystemServices()</h2><pre><code>private void hookSystemServices() {
    try {
        // å¾—åˆ°å½“å‰ç³»ç»Ÿä¸­çš„ ActivityManager å•ä¾‹
        Singleton&lt;IActivityManager&gt; defaultSingleton = (Singleton&lt;IActivityManager&gt;) ReflectUtil.getField(ActivityManagerNative.class, null, &quot;gDefault&quot;);
        // åˆ›å»º ActivityManager çš„åŠ¨æ€ä»£ç† 
        IActivityManager activityManagerProxy = ActivityManagerProxy.newInstance(this, defaultSingleton.get());

        // Hook IActivityManager from ActivityManagerNative  åˆ©ç”¨åå°„å°†ç³»ç»Ÿçš„ ActivityManager å•ä¾‹æ›¿æ¢ä¸º activityManagerProxy 
        ReflectUtil.setField(defaultSingleton.getClass().getSuperclass(), defaultSingleton, &quot;mInstance&quot;, activityManagerProxy);

        if (defaultSingleton.get() == activityManagerProxy) {
            this.mActivityManager = activityManagerProxy;
        }
    } catch (Exception e) {
        e.printStackTrace();
    }
}
</code></pre><h2 id="init_28_29"><a href="#init_28_29" class="headerlink" title="init()"></a>init()</h2><pre><code>public void init() {
    // ComponentsHandler æ„Ÿè§‰åƒæ˜¯æ’ä»¶ä¸­å››å¤§ç»„ä»¶çš„ç®¡ç†è€…
    mComponentsHandler = new ComponentsHandler(this);
    // ç”¨çš„æ˜¯ asynctask çš„çº¿ç¨‹æ± 
    RunUtil.getThreadPool().execute(new Runnable() {
        @Override
        public void run() {
            // ç©ºæ–¹æ³•ï¼Œç»™ä¹‹åçš„ä¸œè¥¿ï¼Œä¸‡ä¸€æœ‰ä»€ä¹ˆéœ€è¦åˆå§‹åŒ–çš„
            doInWorkThread();
        }
    });
}

private void doInWorkThread() {
}
</code></pre><h1 id="u52A0_u8F7D_u63D2_u4EF6"><a href="#u52A0_u8F7D_u63D2_u4EF6" class="headerlink" title="åŠ è½½æ’ä»¶"></a>åŠ è½½æ’ä»¶</h1><p>load plugin apk ï¼š</p>
<pre><code>PluginManager.getInstance(base).loadPlugin(apk);
</code></pre><h2 id="loadPlugin_28File_apk_29"><a href="#loadPlugin_28File_apk_29" class="headerlink" title="loadPlugin(File apk)"></a>loadPlugin(File apk)</h2><pre><code>public void loadPlugin(File apk) throws Exception {
    if (null == apk) {
        throw new IllegalArgumentException(&quot;error : apk is null.&quot;);
    }

    if (!apk.exists()) {
        throw new FileNotFoundException(apk.getAbsolutePath());
    }

    LoadedPlugin plugin = LoadedPlugin.create(this, this.mContext, apk);
    if (null != plugin) {
        this.mPlugins.put(plugin.getPackageName(), plugin);
        // åˆ›å»ºæ’ä»¶ä¸­çš„ application
        plugin.invokeApplication();
    } else {
        throw  new RuntimeException(&quot;Can&apos;t load plugin which is invalid: &quot; + apk.getAbsolutePath());
    }
}
</code></pre><h2 id="LoadedPlugin"><a href="#LoadedPlugin" class="headerlink" title="LoadedPlugin"></a>LoadedPlugin</h2><h3 id="PackageParserCompat-parsePackage"><a href="#PackageParserCompat-parsePackage" class="headerlink" title="PackageParserCompat.parsePackage"></a>PackageParserCompat.parsePackage</h3><pre><code>public static final PackageParser.Package parsePackage(final Context context, final File apk, final int flags) throws PackageParser.PackageParserException {
    if (Build.VERSION.SDK_INT &gt;= 24) {
        return PackageParserV24.parsePackage(context, apk, flags);
    } else if (Build.VERSION.SDK_INT &gt;= 21) {
        return PackageParserLollipop.parsePackage(context, apk, flags);
    } else {
        return PackageParserLegacy.parsePackage(context, apk, flags);
    }
}
</code></pre><h3 id="new_PackageInfo_28_29"><a href="#new_PackageInfo_28_29" class="headerlink" title="new PackageInfo()"></a>new PackageInfo()</h3><pre><code>this.mPackageInfo = new PackageInfo();
this.mPackageInfo.applicationInfo = this.mPackage.applicationInfo;
this.mPackageInfo.applicationInfo.sourceDir = apk.getAbsolutePath();
this.mPackageInfo.signatures = this.mPackage.mSignatures;
this.mPackageInfo.packageName = this.mPackage.packageName;
if (pluginManager.getLoadedPlugin(mPackageInfo.packageName) != null) {
    throw new RuntimeException(&quot;plugin has already been loaded : &quot; + mPackageInfo.packageName);
}
this.mPackageInfo.versionCode = this.mPackage.mVersionCode;
this.mPackageInfo.versionName = this.mPackage.mVersionName;
this.mPackageInfo.permissions = new PermissionInfo[0];
</code></pre><h3 id="createResources_28context_2C_apk_29"><a href="#createResources_28context_2C_apk_29" class="headerlink" title="createResources(context, apk)"></a>createResources(context, apk)</h3><pre><code>@WorkerThread
private static Resources createResources(Context context, File apk) {
    if (Constants.COMBINE_RESOURCES) {
        //å¦‚æœæ’ä»¶èµ„æºåˆå¹¶åˆ°å®¿ä¸»é‡Œé¢å»çš„æƒ…å†µï¼Œæ’ä»¶å¯ä»¥è®¿é—®å®¿ä¸»çš„èµ„æº
        Resources resources = new ResourcesManager().createResources(context, apk.getAbsolutePath());
        // hook resource
        ResourcesManager.hookResources(context, resources);
        return resources;
    } else {
        //æ’ä»¶ä½¿ç”¨ç‹¬ç«‹çš„Resourcesï¼Œä¸ä¸å®¿ä¸»æœ‰å…³ç³»ï¼Œæ— æ³•è®¿é—®åˆ°å®¿ä¸»çš„èµ„æº
        Resources hostResources = context.getResources();
        // åˆ©ç”¨ addAssetPath æ¥åˆ›å»º assetManager
        AssetManager assetManager = createAssetManager(context, apk);
        // åˆ›å»º Resources
        return new Resources(assetManager, hostResources.getDisplayMetrics(), hostResources.getConfiguration());
    }
}
</code></pre><h2 id="createResources_28Context_hostContext_2C_String_apk_29"><a href="#createResources_28Context_hostContext_2C_String_apk_29" class="headerlink" title="createResources(Context hostContext, String apk)"></a>createResources(Context hostContext, String apk)</h2><pre><code>public static synchronized Resources createResources(Context hostContext, String apk) {
    Resources hostResources = hostContext.getResources();
    Resources newResources = null;
    AssetManager assetManager;
    try {
        if (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.LOLLIPOP) {
            // åœ¨Android 5.0 ä¹‹å‰ï¼ŒaddAssetPath åªæ˜¯æŠŠ apk è·¯å¾„åŠ å…¥åˆ°èµ„æºè·¯å¾„åˆ—è¡¨é‡Œ
            // ä½†æ˜¯èµ„æºçš„è§£æå…¶å®æ˜¯åœ¨å¾ˆæ—©çš„æ—¶å€™å°±å·²ç»æ‰§è¡Œå®Œäº†
            // æ‰€ä»¥é‡æ–°æ„é€ ä¸€ä¸ªæ–°çš„ AssetManagerï¼Œå† hook resource æ›¿æ¢ç³»ç»Ÿçš„ mResource
            assetManager = AssetManager.class.newInstance();
            ReflectUtil.invoke(AssetManager.class, assetManager, &quot;addAssetPath&quot;, hostContext.getApplicationInfo().sourceDir);
        } else {
            // Android 5.0 èµ„æºåšè¿‡åˆ†åŒºï¼Œç›´æ¥è·å–å®¿ä¸»çš„ assetManager
            assetManager = hostResources.getAssets();
        }
        // å°†å½“å‰æ’ä»¶çš„èµ„æºè·¯å¾„åŠ å…¥åˆ° assetManager ä¸­
        ReflectUtil.invoke(AssetManager.class, assetManager, &quot;addAssetPath&quot;, apk);
        // è·å–ä¹‹å‰åŠ è½½å®Œæ¯•çš„æ’ä»¶ï¼Œå¾—åˆ°å®ƒä»¬çš„ apk è·¯å¾„å†é‡æ–°æ·»åŠ åˆ° assetManager ä¸­
        // æ˜¯å¦åœ¨ Android 5.0 åŠä»¥ä¸Šä¸éœ€è¦æ­¤æ­¥éª¤ï¼Ÿ
        List&lt;LoadedPlugin&gt; pluginList = PluginManager.getInstance(hostContext).getAllLoadedPlugins();
        for (LoadedPlugin plugin : pluginList) {
            ReflectUtil.invoke(AssetManager.class, assetManager, &quot;addAssetPath&quot;, plugin.getLocation());
        }
        // å¯¹ä¸€äº›å®‰å“å‚å•†åšå…¼å®¹æ€§å¤„ç†ï¼ŒResources çš„ç±»åå„ä¸åŒ
        // åˆ›å»º resource
        if (isMiUi(hostResources)) {
            newResources = MiUiResourcesCompat.createResources(hostResources, assetManager);
        } else if (isVivo(hostResources)) {
            newResources = VivoResourcesCompat.createResources(hostContext, hostResources, assetManager);
        } else if (isNubia(hostResources)) {
            newResources = NubiaResourcesCompat.createResources(hostResources, assetManager);
        } else if (isNotRawResources(hostResources)) {
            newResources = AdaptationResourcesCompat.createResources(hostResources, assetManager);
        } else {
            // is raw android resources
            newResources = new Resources(assetManager, hostResources.getDisplayMetrics(), hostResources.getConfiguration());
        }
    } catch (Exception e) {
        e.printStackTrace();
    }
    return newResources;
}
</code></pre><h2 id="hookResources_28Context_base_2C_Resources_resources_29"><a href="#hookResources_28Context_base_2C_Resources_resources_29" class="headerlink" title="hookResources(Context base, Resources resources)"></a>hookResources(Context base, Resources resources)</h2><pre><code>public static void hookResources(Context base, Resources resources) {
    if (Build.VERSION.SDK_INT &gt;= 24) {
        return;
    }

    try {
        // æ›¿æ¢ hostContext ä¸­çš„ mResources
        ReflectUtil.setField(base.getClass(), base, &quot;mResources&quot;, resources);
        // æ›¿æ¢ packageInfo ä¸­çš„ mResources
        Object loadedApk = ReflectUtil.getPackageInfo(base);
        ReflectUtil.setField(loadedApk.getClass(), loadedApk, &quot;mResources&quot;, resources);
        // å°† resource æ”¾å…¥ mActiveResources ä¸­
        Object activityThread = ReflectUtil.getActivityThread(base);
        Object resManager = ReflectUtil.getField(activityThread.getClass(), activityThread, &quot;mResourcesManager&quot;);
        Map&lt;Object, WeakReference&lt;Resources&gt;&gt; map = (Map&lt;Object, WeakReference&lt;Resources&gt;&gt;) ReflectUtil.getField(resManager.getClass(), resManager, &quot;mActiveResources&quot;);
        Object key = map.keySet().iterator().next();
        map.put(key, new WeakReference&lt;&gt;(resources));
    } catch (Exception e) {
        e.printStackTrace();
    }
}
</code></pre><h3 id="createClassLoader_28Context_context_2C_File_apk_2C_File_libsDir_2C_ClassLoader_parent_29"><a href="#createClassLoader_28Context_context_2C_File_apk_2C_File_libsDir_2C_ClassLoader_parent_29" class="headerlink" title="createClassLoader(Context context, File apk, File libsDir, ClassLoader parent)"></a>createClassLoader(Context context, File apk, File libsDir, ClassLoader parent)</h3><pre><code>private static ClassLoader createClassLoader(Context context, File apk, File libsDir, ClassLoader parent) {
    // create classloader
    File dexOutputDir = context.getDir(Constants.OPTIMIZE_DIR, Context.MODE_PRIVATE);
    String dexOutputPath = dexOutputDir.getAbsolutePath();
    DexClassLoader loader = new DexClassLoader(apk.getAbsolutePath(), dexOutputPath, libsDir.getAbsolutePath(), parent);
    // å¦‚æœåˆå¹¶ï¼Œå°±ä¼šæŠŠå®¿ä¸»çš„ classloader ä¸­çš„ dex åŠ å…¥åˆ°æ’ä»¶ä¸­çš„ classloader
    if (Constants.COMBINE_CLASSLOADER) {
        try {
            DexUtil.insertDex(loader);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    return loader;
}
</code></pre><h3 id="tryToCopyNativeLib_28apk_29_3B"><a href="#tryToCopyNativeLib_28apk_29_3B" class="headerlink" title="tryToCopyNativeLib(apk);"></a>tryToCopyNativeLib(apk);</h3><p>å¤åˆ¶ .so æ–‡ä»¶</p>
<h3 id="Cache_instrumentations"><a href="#Cache_instrumentations" class="headerlink" title="Cache instrumentations"></a>Cache instrumentations</h3><pre><code>Map&lt;ComponentName, InstrumentationInfo&gt; instrumentations = new HashMap&lt;ComponentName, InstrumentationInfo&gt;();
for (PackageParser.Instrumentation instrumentation : this.mPackage.instrumentation) {
    instrumentations.put(instrumentation.getComponentName(), instrumentation.info);
}
this.mInstrumentationInfos = Collections.unmodifiableMap(instrumentations);
this.mPackageInfo.instrumentation = instrumentations.values().toArray(new InstrumentationInfo[instrumentations.size()]);
</code></pre><h3 id="Cache_activities"><a href="#Cache_activities" class="headerlink" title="Cache activities"></a>Cache activities</h3><pre><code>Map&lt;ComponentName, ActivityInfo&gt; activityInfos = new HashMap&lt;ComponentName, ActivityInfo&gt;();
for (PackageParser.Activity activity : this.mPackage.activities) {
    activityInfos.put(activity.getComponentName(), activity.info);
}
this.mActivityInfos = Collections.unmodifiableMap(activityInfos);
this.mPackageInfo.activities = activityInfos.values().toArray(new ActivityInfo[activityInfos.size()]);
</code></pre><h3 id="Cache_providers"><a href="#Cache_providers" class="headerlink" title="Cache providers"></a>Cache providers</h3><pre><code>Map&lt;String, ProviderInfo&gt; providers = new HashMap&lt;String, ProviderInfo&gt;();
Map&lt;ComponentName, ProviderInfo&gt; providerInfos = new HashMap&lt;ComponentName, ProviderInfo&gt;();
for (PackageParser.Provider provider : this.mPackage.providers) {
    providers.put(provider.info.authority, provider.info);
    providerInfos.put(provider.getComponentName(), provider.info);
}
this.mProviders = Collections.unmodifiableMap(providers);
this.mProviderInfos = Collections.unmodifiableMap(providerInfos);
this.mPackageInfo.providers = providerInfos.values().toArray(new ProviderInfo[providerInfos.size()]);
</code></pre><h3 id="Register_broadcast_receivers_dynamically"><a href="#Register_broadcast_receivers_dynamically" class="headerlink" title="Register broadcast receivers dynamically"></a>Register broadcast receivers dynamically</h3><pre><code>Map&lt;ComponentName, ActivityInfo&gt; receivers = new HashMap&lt;ComponentName, ActivityInfo&gt;();
for (PackageParser.Activity receiver : this.mPackage.receivers) {
    receivers.put(receiver.getComponentName(), receiver.info);

    try {
        // å¾—åˆ°æ’ä»¶ä¸­çš„ BroadcastReceiver çš„å®ä¾‹
        BroadcastReceiver br = BroadcastReceiver.class.cast(getClassLoader().loadClass(receiver.getComponentName().getClassName()).newInstance());
        // æ³¨å†Œå¹¿æ’­
        for (PackageParser.ActivityIntentInfo aii : receiver.intents) {
            this.mHostContext.registerReceiver(br, aii);
        }
    } catch (Exception e) {
        e.printStackTrace();
    }
}
this.mReceiverInfos = Collections.unmodifiableMap(receivers);
this.mPackageInfo.receivers = receivers.values().toArray(new ActivityInfo[receivers.size()]);
</code></pre><h1 id="u63D2_u4EF6Activity_u52A0_u8F7D_u8FC7_u7A0B"><a href="#u63D2_u4EF6Activity_u52A0_u8F7D_u8FC7_u7A0B" class="headerlink" title="æ’ä»¶ActivityåŠ è½½è¿‡ç¨‹"></a>æ’ä»¶ActivityåŠ è½½è¿‡ç¨‹</h1><h1 id="VAInstrumentation"><a href="#VAInstrumentation" class="headerlink" title="VAInstrumentation"></a>VAInstrumentation</h1><h2 id="execStartActivity"><a href="#execStartActivity" class="headerlink" title="execStartActivity"></a>execStartActivity</h2><pre><code>public ActivityResult execStartActivity(
        Context who, IBinder contextThread, IBinder token, Activity target,
        Intent intent, int requestCode, Bundle options) {
    // è¿™ä¸ªä¸»è¦æ˜¯å½“componentä¸ºnullæ—¶ï¼Œæ ¹æ®å¯åŠ¨Activityæ—¶ï¼Œé…ç½®çš„actionï¼Œdata,categoryç­‰å»å·²åŠ è½½çš„pluginä¸­åŒ¹é…åˆ°ç¡®å®šçš„Activityçš„ã€‚
    mPluginManager.getComponentsHandler().transformIntentToExplicitAsNeeded(intent);
    // null component is an implicitly intent
    if (intent.getComponent() != null) {
        Log.i(TAG, String.format(&quot;execStartActivity[%s : %s]&quot;, intent.getComponent().getPackageName(),
                intent.getComponent().getClassName()));
        // å…ˆå°† intent ä¸­çš„ packagename å’Œ classname æ›¿æ¢ä¸º Stub Activity
        this.mPluginManager.getComponentsHandler().markIntentIfNeeded(intent);
    }
    // åˆ©ç”¨åå°„å»æ‰§è¡ŒåŸæ¥çš„ execStartActivity æ–¹æ³•
    ActivityResult result = realExecStartActivity(who, contextThread, token, target,
                intent, requestCode, options);

    return result;

}
</code></pre><h2 id="ComponentsHandler"><a href="#ComponentsHandler" class="headerlink" title="ComponentsHandler"></a>ComponentsHandler</h2><h2 id="transformIntentToExplicitAsNeeded"><a href="#transformIntentToExplicitAsNeeded" class="headerlink" title="transformIntentToExplicitAsNeeded"></a>transformIntentToExplicitAsNeeded</h2><pre><code>public Intent transformIntentToExplicitAsNeeded(Intent intent) {
    ComponentName component = intent.getComponent();
    if (component == null) {
        ResolveInfo info = mPluginManager.resolveActivity(intent);
        if (info != null &amp;&amp; info.activityInfo != null) {
            component = new ComponentName(info.activityInfo.packageName, info.activityInfo.name);
            intent.setComponent(component);
        }
    }

    return intent;
}
</code></pre><h2 id="markIntentIfNeeded"><a href="#markIntentIfNeeded" class="headerlink" title="markIntentIfNeeded"></a>markIntentIfNeeded</h2><pre><code>public void markIntentIfNeeded(Intent intent) {
    if (intent.getComponent() == null) {
        return;
    }
    String targetPackageName = intent.getComponent().getPackageName();
    String targetClassName = intent.getComponent().getClassName();
    // search map and return specific launchmode stub activity
    // å…ˆå°†ç›®æ ‡çš„ packagename å’Œ classname ä¿å­˜å¥½ï¼Œä¹‹åä»¥ä¾¿æ¢å¤çš„
    if (!targetPackageName.equals(mContext.getPackageName()) &amp;&amp; mPluginManager.getLoadedPlugin(targetPackageName) != null) {
        intent.putExtra(Constants.KEY_IS_PLUGIN, true);
        intent.putExtra(Constants.KEY_TARGET_PACKAGE, targetPackageName);
        intent.putExtra(Constants.KEY_TARGET_ACTIVITY, targetClassName);
        // æ ¹æ® launchMode ã€theme æŸ¥æ‰¾å¯¹åº”ç±»å‹çš„ stub activity
        // å¹¶å°† intent ä¸­çš„ç›®æ ‡ activity æ›¿æ¢ä¸º stub activity
        dispatchStubActivity(intent);
    }
}
</code></pre><h1 id="VAInstrumentation-1"><a href="#VAInstrumentation-1" class="headerlink" title="VAInstrumentation"></a>VAInstrumentation</h1><h2 id="newActivity"><a href="#newActivity" class="headerlink" title="newActivity"></a>newActivity</h2><pre><code>@Override
public Activity newActivity(ClassLoader cl, String className, Intent intent) throws InstantiationException, IllegalAccessException, ClassNotFoundException {
    try {
        cl.loadClass(className);
    } catch (ClassNotFoundException e) {
        // è‹¥å‡ºé”™åˆ™è¯´æ˜è¦å¯åŠ¨çš„æ˜¯æ’ä»¶é‡Œé¢çš„classname
        LoadedPlugin plugin = this.mPluginManager.getLoadedPlugin(intent);
        String targetClassName = PluginUtil.getTargetActivity(intent);

        Log.i(TAG, String.format(&quot;newActivity[%s : %s]&quot;, className, targetClassName));

        if (targetClassName != null) {
            Activity activity = mBase.newActivity(plugin.getClassLoader(), targetClassName, intent);
            activity.setIntent(intent);

            try {
                // for 4.1+  è®¾ç½®å¥½ resource
                ReflectUtil.setField(ContextThemeWrapper.class, activity, &quot;mResources&quot;, plugin.getResources());
            } catch (Exception ignored) {
                // ignored.
            }

            return activity;
        }
    }
    // å¯åŠ¨çš„ä¸æ˜¯æ’ä»¶ä¸­çš„activityå°±ä½¿ç”¨åŸæ¥çš„
    return mBase.newActivity(cl, className, intent);
}
</code></pre><h2 id="callActivityOnCreate"><a href="#callActivityOnCreate" class="headerlink" title="callActivityOnCreate"></a>callActivityOnCreate</h2><pre><code>@Override
public void callActivityOnCreate(Activity activity, Bundle icicle) {
    final Intent intent = activity.getIntent();
    // æ ¹æ® KEY_IS_PLUGIN æ¥åˆ¤æ–­æ˜¯å¦æ˜¯å¯åŠ¨æ’ä»¶ activity
    if (PluginUtil.isIntentFromPlugin(intent)) {
        Context base = activity.getBaseContext();
        try {
            // å°†åˆ›å»ºå‡ºæ¥çš„æ’ä»¶ activity ä¸­ mResources mBase mApplication è¿›è¡Œæ›¿æ¢
            LoadedPlugin plugin = this.mPluginManager.getLoadedPlugin(intent);
            ReflectUtil.setField(base.getClass(), base, &quot;mResources&quot;, plugin.getResources());
            ReflectUtil.setField(ContextWrapper.class, activity, &quot;mBase&quot;, plugin.getPluginContext());
            ReflectUtil.setField(Activity.class, activity, &quot;mApplication&quot;, plugin.getApplication());
            ReflectUtil.setFieldNoException(ContextThemeWrapper.class, activity, &quot;mBase&quot;, plugin.getPluginContext());

            // set screenOrientation è®¾ç½®å±å¹•æ–¹å‘
            ActivityInfo activityInfo = plugin.getActivityInfo(PluginUtil.getComponent(intent));
            if (activityInfo.screenOrientation != ActivityInfo.SCREEN_ORIENTATION_UNSPECIFIED) {
                activity.setRequestedOrientation(activityInfo.screenOrientation);
            }
        } catch (Exception e) {
            e.printStackTrace();
        }

    }

    mBase.callActivityOnCreate(activity, icicle);
}
</code></pre><h1 id="u63D2_u4EF6Service_u52A0_u8F7D_u8FC7_u7A0B"><a href="#u63D2_u4EF6Service_u52A0_u8F7D_u8FC7_u7A0B" class="headerlink" title="æ’ä»¶ServiceåŠ è½½è¿‡ç¨‹"></a>æ’ä»¶ServiceåŠ è½½è¿‡ç¨‹</h1><h1 id="ActivityManagerProxy"><a href="#ActivityManagerProxy" class="headerlink" title="ActivityManagerProxy"></a>ActivityManagerProxy</h1><h2 id="invoke"><a href="#invoke" class="headerlink" title="invoke"></a>invoke</h2><pre><code>@Override
public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
    if (&quot;startService&quot;.equals(method.getName())) {
        try {
            return startService(proxy, method, args);
        } catch (Throwable e) {
            Log.e(TAG, &quot;Start service error&quot;, e);
        }
    } 
    ...
}
</code></pre><h2 id="startService"><a href="#startService" class="headerlink" title="startService"></a>startService</h2><pre><code>private Object startService(Object proxy, Method method, Object[] args) throws Throwable {
    IApplicationThread appThread = (IApplicationThread) args[0];
    Intent target = (Intent) args[1];
    ResolveInfo resolveInfo = this.mPluginManager.resolveService(target, 0);
    if (null == resolveInfo || null == resolveInfo.serviceInfo) {
        // å¦‚æœä¸ºç©ºçš„è¯ï¼Œä¸æ˜¯å¯åŠ¨çš„æ’ä»¶service
        return method.invoke(this.mActivityManager, args);
    }
    // 
    return startDelegateServiceForTarget(target, resolveInfo.serviceInfo, null, RemoteService.EXTRA_COMMAND_START_SERVICE);
}
</code></pre><h2 id="startDelegateServiceForTarget"><a href="#startDelegateServiceForTarget" class="headerlink" title="startDelegateServiceForTarget"></a>startDelegateServiceForTarget</h2><pre><code>private ComponentName startDelegateServiceForTarget(Intent target, ServiceInfo serviceInfo, Bundle extras, int command) {
    Intent wrapperIntent = wrapperTargetIntent(target, serviceInfo, extras, command);
    return mPluginManager.getHostContext().startService(wrapperIntent);
}
</code></pre><h2 id="wrapperTargetIntent"><a href="#wrapperTargetIntent" class="headerlink" title="wrapperTargetIntent"></a>wrapperTargetIntent</h2><pre><code>private Intent wrapperTargetIntent(Intent target, ServiceInfo serviceInfo, Bundle extras, int command) {
    // fill in service with ComponentName
    target.setComponent(new ComponentName(serviceInfo.packageName, serviceInfo.name));
    String pluginLocation = mPluginManager.getLoadedPlugin(target.getComponent()).getLocation();

    // start delegate service to run plugin service inside
    // æ£€æŸ¥æ’ä»¶ service æ˜¯å¦æ˜¯æœ¬åœ°è¿˜æ˜¯è¿œç¨‹ï¼Œå†é€‰æ‹©ç›¸å¯¹åº”çš„ delegate service
    boolean local = PluginUtil.isLocalService(serviceInfo);
    Class&lt;? extends Service&gt; delegate = local ? LocalService.class : RemoteService.class;
    // åˆ›å»ºæ–°çš„ intent ï¼Œç”¨æ¥å¯åŠ¨ delegate serviceã€‚intent ä¸­ä¼šä¿å­˜æ’ä»¶ service çš„ç›¸å…³ä¿¡æ¯
    Intent intent = new Intent();
    // è®¾ç½® class ä¸ºå¯¹åº”çš„ delegate service classname
    intent.setClass(mPluginManager.getHostContext(), delegate);
    intent.putExtra(RemoteService.EXTRA_TARGET, target);
    intent.putExtra(RemoteService.EXTRA_COMMAND, command);
    intent.putExtra(RemoteService.EXTRA_PLUGIN_LOCATION, pluginLocation);
    if (extras != null) {
        intent.putExtras(extras);
    }

    return intent;
}
</code></pre><h1 id="LocalService"><a href="#LocalService" class="headerlink" title="LocalService"></a>LocalService</h1><h2 id="onStartCommand"><a href="#onStartCommand" class="headerlink" title="onStartCommand"></a>onStartCommand</h2><pre><code>@Override
public int onStartCommand(Intent intent, int flags, int startId) {
    if (null == intent || !intent.hasExtra(EXTRA_TARGET) || !intent.hasExtra(EXTRA_COMMAND)) {
        return START_STICKY;
    }

    Intent target = intent.getParcelableExtra(EXTRA_TARGET);
    int command = intent.getIntExtra(EXTRA_COMMAND, 0);
    if (null == target || command &lt;= 0) {
        return START_STICKY;
    }

    ComponentName component = target.getComponent();
    LoadedPlugin plugin = mPluginManager.getLoadedPlugin(component);

    switch (command) {
        case EXTRA_COMMAND_START_SERVICE: {
            ActivityThread mainThread = (ActivityThread) ReflectUtil.getActivityThread(getBaseContext());
            IApplicationThread appThread = mainThread.getApplicationThread();
            Service service;
            // åˆ¤æ–­è¯¥æ’ä»¶çš„ service æ˜¯å¦å·²ç»åˆ›å»ºè¿‡
            if (this.mPluginManager.getComponentsHandler().isServiceAvailable(component)) {
                // ç›´æ¥ä»å·²å¯åŠ¨æœåŠ¡ map ä¸­å–å‡ºè¯¥æ’ä»¶çš„ service
                service = this.mPluginManager.getComponentsHandler().getService(component);
            } else {
                try {
                    // åˆ›å»ºæ’ä»¶ service å¯¹è±¡
                    service = (Service) plugin.getClassLoader().loadClass(component.getClassName()).newInstance();

                    // éœ€è¦è°ƒç”¨ attach
                    Application app = plugin.getApplication();
                    IBinder token = appThread.asBinder();
                    Method attach = service.getClass().getMethod(&quot;attach&quot;, Context.class, ActivityThread.class, String.class, IBinder.class, Application.class, Object.class);
                    IActivityManager am = mPluginManager.getActivityManager();
                    attach.invoke(service, plugin.getPluginContext(), mainThread, component.getClassName(), token, app, am);
                    // oncreate
                    service.onCreate();
                    // æ”¾å…¥å·²å¯åŠ¨æœåŠ¡ map ä¸­
                    this.mPluginManager.getComponentsHandler().rememberService(component, service);
                } catch (Throwable t) {
                    return START_STICKY;
                }
            }
            // è°ƒç”¨ onStartCommand
            service.onStartCommand(target, 0, this.mPluginManager.getComponentsHandler().getServiceCounter(service).getAndIncrement());
            break;
        }
    ...
}
</code></pre><h1 id="u63D2_u4EF6BroadcastReceiver_u52A0_u8F7D_u8FC7_u7A0B"><a href="#u63D2_u4EF6BroadcastReceiver_u52A0_u8F7D_u8FC7_u7A0B" class="headerlink" title="æ’ä»¶BroadcastReceiveråŠ è½½è¿‡ç¨‹"></a>æ’ä»¶BroadcastReceiveråŠ è½½è¿‡ç¨‹</h1><h1 id="LoadedPlugin-1"><a href="#LoadedPlugin-1" class="headerlink" title="LoadedPlugin"></a>LoadedPlugin</h1><pre><code>Map&lt;ComponentName, ActivityInfo&gt; receivers = new HashMap&lt;ComponentName, ActivityInfo&gt;();
for (PackageParser.Activity receiver : this.mPackage.receivers) {
    receivers.put(receiver.getComponentName(), receiver.info);

    try {
        // å¾—åˆ°æ’ä»¶ä¸­çš„ BroadcastReceiver çš„å®ä¾‹
        BroadcastReceiver br = BroadcastReceiver.class.cast(getClassLoader().loadClass(receiver.getComponentName().getClassName()).newInstance());
        // æ³¨å†Œå¹¿æ’­
        for (PackageParser.ActivityIntentInfo aii : receiver.intents) {
            this.mHostContext.registerReceiver(br, aii);
        }
    } catch (Exception e) {
        e.printStackTrace();
    }
}
</code></pre><h1 id="u63D2_u4EF6ContentProvider_u52A0_u8F7D_u8FC7_u7A0B"><a href="#u63D2_u4EF6ContentProvider_u52A0_u8F7D_u8FC7_u7A0B" class="headerlink" title="æ’ä»¶ContentProvideråŠ è½½è¿‡ç¨‹"></a>æ’ä»¶ContentProvideråŠ è½½è¿‡ç¨‹</h1><h1 id="PluginContext"><a href="#PluginContext" class="headerlink" title="PluginContext"></a>PluginContext</h1><pre><code>@Override
public ContentResolver getContentResolver() {
    return new PluginContentResolver(getHostContext());
}
</code></pre><h1 id="PluginContentResolver"><a href="#PluginContentResolver" class="headerlink" title="PluginContentResolver"></a>PluginContentResolver</h1><pre><code>public PluginContentResolver(Context context) {
    super(context);
    mBase = context.getContentResolver();
    mPluginManager = PluginManager.getInstance(context);
}
</code></pre><h2 id="acquireProvider"><a href="#acquireProvider" class="headerlink" title="acquireProvider"></a>acquireProvider</h2><pre><code>protected IContentProvider acquireProvider(Context context, String auth) {
    try {
        if (mPluginManager.resolveContentProvider(auth, 0) != null) {
            return mPluginManager.getIContentProvider();
        }

        return (IContentProvider) sAcquireProvider.invoke(mBase, context, auth);
    } catch (Exception e) {
        e.printStackTrace();
    }

    return null;
}
</code></pre><h1 id="PluginManager"><a href="#PluginManager" class="headerlink" title="PluginManager"></a>PluginManager</h1><h2 id="getIContentProvider"><a href="#getIContentProvider" class="headerlink" title="getIContentProvider"></a>getIContentProvider</h2><pre><code>public synchronized IContentProvider getIContentProvider() {
    if (mIContentProvider == null) {
        hookIContentProviderAsNeeded();
    }

    return mIContentProvider;
}
</code></pre><h2 id="hookIContentProviderAsNeeded"><a href="#hookIContentProviderAsNeeded" class="headerlink" title="hookIContentProviderAsNeeded"></a>hookIContentProviderAsNeeded</h2><pre><code>private void hookIContentProviderAsNeeded() {
    Uri uri = Uri.parse(PluginContentResolver.getUri(mContext));
    mContext.getContentResolver().call(uri, &quot;wakeup&quot;, null, null);
    try {
        Field authority = null;
        Field mProvider = null;
        ActivityThread activityThread = (ActivityThread) ReflectUtil.getActivityThread(mContext);
        Map mProviderMap = (Map) ReflectUtil.getField(activityThread.getClass(), activityThread, &quot;mProviderMap&quot;);
        Iterator iter = mProviderMap.entrySet().iterator();
        while (iter.hasNext()) {
            Map.Entry entry = (Map.Entry) iter.next();
            Object key = entry.getKey();
            Object val = entry.getValue();
            String auth;
            if (key instanceof String) {
                auth = (String) key;
            } else {
                if (authority == null) {
                    authority = key.getClass().getDeclaredField(&quot;authority&quot;);
                    authority.setAccessible(true);
                }
                auth = (String) authority.get(key);
            }
            if (auth.equals(PluginContentResolver.getAuthority(mContext))) {
                if (mProvider == null) {
                    mProvider = val.getClass().getDeclaredField(&quot;mProvider&quot;);
                    mProvider.setAccessible(true);
                }
                IContentProvider rawProvider = (IContentProvider) mProvider.get(val);
                IContentProvider proxy = IContentProviderProxy.newInstance(mContext, rawProvider);
                mIContentProvider = proxy;
                Log.d(TAG, &quot;hookIContentProvider succeed : &quot; + mIContentProvider);
                break;
            }
        }
    } catch (Exception e) {
        e.printStackTrace();
    }
}
</code></pre>]]></content>
    <summary type="html">
    <![CDATA[<h1 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h1><p>VirtualAPK æ˜¯æ»´æ»´å¼€æºçš„ä¸€æ¬¾ Android æ’ä»¶åŒ–çš„æ¡†æ¶ã€‚</p>
<p>ç°åœ¨å¸‚é¢ä¸Šï¼Œæˆç†Ÿçš„æ’ä»¶]]>
    </summary>
    
      <category term="Android" scheme="http://yuqirong.me/tags/Android/"/>
    
      <category term="å¼€æºæ¡†æ¶" scheme="http://yuqirong.me/tags/%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/"/>
    
      <category term="æ’ä»¶åŒ–" scheme="http://yuqirong.me/tags/%E6%8F%92%E4%BB%B6%E5%8C%96/"/>
    
      <category term="æºç è§£æ" scheme="http://yuqirong.me/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    
      <category term="Android Blog" scheme="http://yuqirong.me/categories/Android-Blog/"/>
    
  </entry>
  
</feed>
